<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Fundamentals</title>

  <meta name="description" content="Fundamentos necesarios antes de explotar en modo kernel">
  <meta name="author" content="xchg2pwn">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Fundamentals">
  <meta name="twitter:description" content="Fundamentos necesarios antes de explotar en modo kernel">
  <meta name="twitter:creator" content="xchg2pwn">  
  <meta name="twitter:image" content="/exploit-development/windows-kernel/fundamentals/image.png" />

  <meta property="og:site_name" content="xchg2pwn" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Fundamentals">
  <meta property="og:description" content="Fundamentos necesarios antes de explotar en modo kernel">
  <meta property="og:image" content="/exploit-development/windows-kernel/fundamentals/image.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/exploit-development/windows-kernel/fundamentals/image.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Fundamentals" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="xchg2pwn">
          <h1 class="panel-cover__title panel-title scale-up-center">xchg2pwn</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/exploit-development/windows-kernel" title="xchg2pwn" class="blog-button">Windows Kernel Mode</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/xchg2pwn" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://linkedin.com/in/enrique-de-los-santos-694863233" title="Linkedin" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">Linkedin</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/xchg2pwn" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/xchg2pwn" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@xchg2pwn" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:xchg2pwn@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#rings">Drivers & Rings</a></li>
        <li><a href="#integrity">Integrity Levels</a></li>
        <li><a href="#configuration">Configuration</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/exploit-development/windows-kernel/fundamentals/image.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Fundamentals</h2><br>
  </header>

<p class="plain-text">Antes de iniciar es necesario aprender algunos conceptos más de explotación en modo kernel, además se llevara a cabo la configuración de un entorno que se utilizará en explotaciones posteriores en el <code class="language-plaintext highlighter-rouge">kernel</code> de windows, además como demostración para proximas explotaciones donde se omita la instalación de otros drivers se instalara un driver cargandolo como servicio usando <code class="language-plaintext highlighter-rouge">sc.exe</code> en lugar de instalar la aplicación.</p>

<section class="post" id="rings">
<br><h3 class="post-title">Drivers & Rings</h3><br>

<p class="plain-text">Sabemos que un driver es un software que actúa como intermediario entre los dispositivos de hardware, en windows operan en diferentes niveles de privilegio o acceso, estos son conocidos cono <code class="language-plaintext highlighter-rouge">rings</code>, en Windows existen <code class="language-plaintext highlighter-rouge">4</code> niveles de rings:</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">0</code> (Kernel Mode): Es el privilegio más alto en el sistema, en este modo se tiene acceso total a los recursos y se puede ejecutar cualquier instrucción.</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">1</code> y <code class="language-plaintext highlighter-rouge">2</code> (intermediate): Los rings 1 y 2 son niveles de privilegio intermedios, aunque en su mayoría solo existen teóricamente pero windows no casi no utiliza estos niveles, requieren mas privilegios que el modo usuario pero menos que el modo kernel</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">3</code> (User Mode): Corresponde al nivel más bajo, el código tiene acceso limitado a los recursos del sistema y para interactucar con el kernel requiere utilizar syscalls</p>

</section>

<section class="post" id="integrity">
<br><h3 class="post-title">Integrity Levels</h3><br>

<p class="plain-text">El control de integridad proporciona un mecanismo para controlar el acceso a objetos protegibles que evalua el acceso antes de evaluar las comprobaciones de acceso en la lista <code class="language-plaintext highlighter-rouge">DACL</code> de un objeto, a los procesos se les asignan niveles de integridad que determinan sus niveles de protección, Windows define <code class="language-plaintext highlighter-rouge">4</code> niveles de integridad:</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">Low</code>: Asignado a procesos que requieren un aislamiento adicional, por ejemplo navegadores web en modo protegido.</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">Medium</code>: Es el nivel asignado por defecto a los procesos de usuarios estándar.</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">High</code>: Usado en procesos que requieren privilegios elevados, como aquellos ejecutados por un administrador en modo elevado.</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">System</code>: Es el nivél más alto, reservado para procesos críticos del sistema operativo.</p>

</section>
<section class="post" id="configuration">
<br><h3 class="post-title">Configuration</h3><br>   

<p class="plain-text">A diferencia de la explotación en modo usuario, para modo kernel ya que una máquina depura el kernel de la otra necesitaremos 2 máquinas virtuales:</p>

<p class="plain-text">• <code class="language-plaintext highlighter-rouge">Debugger</code>: Esta máquina será un Windows 10 x64 por defecto que se utilizará para depurar el kernel de la máquina depurada y así desarrollar el exploit.</li><br>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">Debuggee</code>: Esta máquina también será un Windows 10 x64 por defecto que se utilizará para depurar y explotar las vulnerabilidades en el driver.</li><br>

<a href="/exploit-development/windows-kernel/fundamentals/1.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/fundamentals/1.png"></p></div></a>

<p class="plain-text">Luego de instalar ambos windows deberiamos tener 2 máquinas, en este caso estan conectadas mediante un adaptador NAT y sus ips son:</p>
<p class="plain-text">• Debugger: <code class="language-plaintext highlighter-rouge">192.168.100.5</code></li><br>
<p class="plain-text">• Debuggee: <code class="language-plaintext highlighter-rouge">192.168.100.10</code></li><br>

<p class="plain-text">Iniciemos con  esta tendra instalado de primeras <code class="language-plaintext highlighter-rouge">WinDbgX</code> que se puede instalar desde la Microsoft Store sin problemas, como herramientas adicionales podriamos incluiir <code class="language-plaintext highlighter-rouge">IDA Free</code> para reversear el driver y <code class="language-plaintext highlighter-rouge">Visual Studio</code> para desarrollar el exploit, sin embargo lo que mas nos interesa es el debugger</p>
<a href="/exploit-development/windows-kernel/fundamentals/2.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/fundamentals/2.png"></p></div></a>

<p class="plain-text">En la máquina que se va a depurar habilitaremos el modo debug y en los ajustes haremos que se conecte al debugger por el puerto <code class="language-plaintext highlighter-rouge">50000</code> con la key <code class="language-plaintext highlighter-rouge">1.1.1.1</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Windows\system32> </span><span class="am">bcdedit</span><span class="p"> /debug on  
La operación se completó correctamente.

C:\Windows\system32> </span><span class="am">bcdedit</span><span class="p"> /dbgsettings net hostip:192.168.100.5 port:50000 key:1.1.1.1  
Key=1.1.1.1

C:\Windows\system32></span>
</code></pre></div></div><br>

<p class="plain-text">En la máquina debugger ejecutaremos WinDbg y en la pestaña <code class="language-plaintext highlighter-rouge">Attach to kernel</code>, añadimos el puerto y la key que especificamos antes en la máquina a depurar</p>
<a href="/exploit-development/windows-kernel/fundamentals/3.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/fundamentals/3.png"></p></div></a>

<p class="plain-text">Finalmente solo necesitamos reiniciar la máquina a depurar y automáticamente se conectara al debugger, podemos ejecutar <code class="language-plaintext highlighter-rouge">g</code> para dejar que arranque con normalidad</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Connected to target 192.168.100.5 on port 50000 on local IP 192.168.100.5.
You can get the target MAC address by running .kdtargetmac command.
Connected to Windows 10 19041 x64 target, ptr64 TRUE
Kernel Debugger connection established.

************* Path validation summary **************
Response                         Time (ms)     Location
Deferred                                       SRV*c:\symbols*http://msdl.microsoft.com/download/symbols  
Symbol search path is: SRV*c:\symbols*http://msdl.microsoft.com/download/symbols
Executable search path is: 
Windows 10 Kernel Version 19041 MP (1 procs) Free x64
Edition build lab: 19041.1.amd64fre.vb_release.191206-1406
Kernel base = 0xfffff804`32c00000 PsLoadedModuleList = 0xfffff804`3382a3e0
nt!DbgBreakPointWithStatus:
fffff804`330082b0 cc              int     3

</span><span class="ro">kd> </span><span class="p">g</span>
</code></pre></div></div><br>

<p class="plain-text">Para finalizar solo nos queda instalar el driver, para ello usaremos <code class="language-plaintext highlighter-rouge">sc</code> que creará un servicio que cargará el driver <code class="language-plaintext highlighter-rouge">.sys</code>, indicamos que el tipo es kernel y que queremos que inicie con el sistema, luego de crearlo iniciamos el servicio asi cargándolo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\driver> </span><span class="am">sc</span><span class="p"> create Custom binPath=C:\driver\custom.sys type=kernel start=system  
[SC] CreateService CORRECTO

C:\driver> </span><span class="am">sc</span><span class="p"> start Custom

NOMBRE_SERVICIO: Custom
        TIPO               : 1  KERNEL_DRIVER
        ESTADO             : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        CÓD_SALIDA_WIN32   : 0  (0x0)
        CÓD_SALIDA_SERVICIO: 0  (0x0)
        PUNTO_COMPROB.     : 0x0
        INDICACIÓN_INICIO  : 0x0
        PID                : 0
        MARCAS         :

C:\driver></span>
</code></pre></div></div><br>

<p class="plain-text">Con esta configuración tendriamos listo el entorno con ambas máquinas para explotar el driver, pero eso será en el siguiente post donde lo analizaremos poco a poco</p>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - xchg2pwn</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
