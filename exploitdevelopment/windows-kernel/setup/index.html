<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Setup Enviroment</title>

  <meta name="description" content="Configuración del entorno windows para explotar en modo kernel">
  <meta name="author" content="xchg2pwn">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Setup Enviroment">
  <meta name="twitter:description" content="Configuración del entorno windows para explotar en modo kernel">
  <meta name="twitter:creator" content="xchg2pwn">  
  <meta name="twitter:image" content="/exploitdevelopment/windows-kernel/setup/image.png" />

  <meta property="og:site_name" content="xchg2pwn" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Setup Enviroment">
  <meta property="og:description" content="Configuración del entorno windows para explotar en modo kernel">
  <meta property="og:image" content="/exploitdevelopment/windows-kernel/setup/image.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/exploitdevelopment/windows-kernel/setup/image.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Setup Enviroment" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="xchg2pwn">
          <h1 class="panel-cover__title panel-title scale-up-center">xchg2pwn</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/exploitdevelopment/windows-kernel" title="xchg2pwn" class="blog-button">Windows Kernel Mode</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/xchg2pwn" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/xchg2pwn" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/xchg2pwn" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@xchg2pwn" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:xchg2pwn@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#vms">Virtual Machines</a></li>
        <li><a href="#debugger">Debugger</a></li>
        <li><a href="#driver">Driver</a></li>
        <li><a href="#symbols">Symbols</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/exploitdevelopment/windows-kernel/setup/image.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Setup Enviroment</h2><br>
  </header>

<p class="plain-text">En el presente post se llevara a cabo la configuración de un entorno que se utilizará en explotaciones posteriores en el kernel de windows, además como demostración para proximas explotaciones donde se omita la instalación de otros drivers se instalara el driver <code class="language-plaintext highlighter-rouge">HEVD</code> o <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver">HackSys Extreme Vulnerable Driver</a> que además se utilizará como objetivo en otros posts para explicar técnicas de explotación en modo kernel.</p>

<section class="post" id="vms">
<br><h3 class="post-title">Virtual Machines</h3><br>    

<p class="plain-text">A diferencia de la explotación en modo usuario, para modo kernel ya que una máquina depura el kernel de la otra necesitaremos 2 máquinas virtuales:</p>

<p class="plain-text">• Debugger: Esta máquina será un Windows 10 x64 por defecto que se utilizará para depurar el kernel de la máquina depurada y así desarrollar el exploit.</li><br>
<p class="plain-text">• Debuggee: Esta máquina también será un Windows 10 x64 por defecto que se utilizará para depurar y explotar las vulnerabilidades en el driver.</li><br>

<a href="/exploitdevelopment/windows-kernel/setup/1.png" target="_blank"><div><p><img src="/exploitdevelopment/windows-kernel/setup/1.png"></p></div></a>

<p class="plain-text">Luego de instalar ambos windows deberiamos tener 2 máquinas, en este caso estan conectadas mediante un adaptador NAT y sus ips son:</p>
<p class="plain-text">• Debugger: 192.168.100.5</li><br>
<p class="plain-text">• Debuggee: 192.168.100.92</li><br>

</section>
<section class="post" id="debugger">
<br><h3 class="post-title">Debugger</h3><br>

<p class="plain-text">Iniciemos con la máquina debugger, esta tendra instalado de primeras <code class="language-plaintext highlighter-rouge">WinDbgX</code> que se puede instalar desde la Microsoft Store sin problemas, como herramientas adicionales podriamos incluiir <code class="language-plaintext highlighter-rouge">IDA Free</code> para reversear el driver y <code class="language-plaintext highlighter-rouge">Visual Studio</code> para desarrollar el exploit, sin embargo lo que mas nos interesa es el debugger</p>
<a href="/exploitdevelopment/windows-kernel/setup/2.png" target="_blank"><div><p><img src="/exploitdevelopment/windows-kernel/setup/2.png"></p></div></a>

<p class="plain-text">En la máquina que se va a depurar habilitaremos el modo debug y en los ajustes haremos que se conecte al debugger por el puerto <code class="language-plaintext highlighter-rouge">50000</code> con la key <code class="language-plaintext highlighter-rouge">1.1.1.1</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Windows\system32> </span><span class="am">bcdedit</span><span class="p"> /debug on  
La operación se completó correctamente.

C:\Windows\system32> </span><span class="am">bcdedit</span><span class="p"> /dbgsettings net hostip:192.168.100.5 port:50000 key:1.1.1.1  
Key=1.1.1.1

C:\Windows\system32></span>
</code></pre></div></div><br>

<p class="plain-text">En la máquina debugger ejecutaremos WinDbg y en la pestaña <code class="language-plaintext highlighter-rouge">Attach to kernel</code>, añadimos el puerto y la key que especificamos antes en la máquina a depurar</p>
<a href="/exploitdevelopment/windows-kernel/setup/3.png" target="_blank"><div><p><img src="/exploitdevelopment/windows-kernel/setup/3.png"></p></div></a>

<p class="plain-text">Finalmente solo necesitamos reiniciar la máquina a depurar y automáticamente se conectara al debugger, podemos ejecutar <code class="language-plaintext highlighter-rouge">g</code> para dejar que arranque con normalidad</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">Connected to target 192.168.100.5 on port 50000 on local IP 192.168.100.5.
You can get the target MAC address by running .kdtargetmac command.
Connected to Windows 10 19041 x64 target
Kernel Debugger connection established.

************* Path validation summary **************
Response                         Time (ms)     Location
Deferred                                       SRV*c:\symbols*http://msdl.microsoft.com/download/symbols  
Symbol search path is: SRV*c:\symbols*http://msdl.microsoft.com/download/symbols
Executable search path is: 
Windows 10 Kernel Version 19041 MP (1 procs) Free x64
Edition build lab: 19041.1.amd64fre.vb_release.191206-1406
Kernel base = 0xfffff806`55800000 PsLoadedModuleList = 0xfffff806`5642a790
nt!DebugService2+0x5:
fffff806`55c07445 cc              int     3

</span><span class="ro">kd> </span><span class="p">g</span>
</code></pre></div></div><br>

</section>
<section class="post" id="driver">
<br><h3 class="post-title">Driver</h3><br>

<p class="plain-text">Para finalizar solo nos queda instalar el driver de <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver">HEVD</a>, para ello usaremos <a href="https://www.osronline.com/article.cfm%5Earticle=157.htm">OsrLoader</a>, que se encuentra en la ruta <code class="language-plaintext highlighter-rouge">kit\WNET\AMD64\FRE\</code> y una vez ahi seleccionamos el driver <code class="language-plaintext highlighter-rouge">HEVD.sys</code> que encontramos en la ruta <code class="language-plaintext highlighter-rouge">driver\vulnerable\x64\</code> del archivo zip, basta con hacer clic en los botones Register Service y Start Service para instalarlo</p>
<a href="/exploitdevelopment/windows-kernel/setup/4.png" target="_blank"><div><p><img src="/exploitdevelopment/windows-kernel/setup/4.png"></p></div></a>

<p class="plain-text">Ahora solo verificamos que el driver se haya instalado conrrectamente y configuramos el servicio <code class="language-plaintext highlighter-rouge">HEVD</code> para que inicie automaticamente con el sistema</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">C:\Windows\system32> </span><span class="am">driverquery</span><span class="p"> | </span><span class="am">findstr </span><span class="p">HEVD
HEVD         HEVD                   Kernel        02/07/2019 14:18:56  

C:\Windows\system32> </span><span class="am">sc </span><span class="p">config HEVD start=system
[SC] ChangeServiceConfig CORRECTO

C:\Windows\system32></span>
</code></pre></div></div><br>

</section>
<section class="post" id="symbols">
<br><h3 class="post-title">Symbols</h3><br>

<p class="plain-text">De primeras en el debugger no tenemos cargados los simbolos del driver y son bastante importantes a la hora de explotarlo, para ello copiamos el archivo <code class="language-plaintext highlighter-rouge">pdb</code> en la ruta que se muestra a continuación (<code class="language-plaintext highlighter-rouge">C:\projects\hevd\...\x64\HEVD.pdb</code>)</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0: kd></span><span class="p"> lm m HEVD
Browse full module list
start             end                 module name
fffff806`7e150000 fffff806`7e1dc000   HEVD       (private pdb symbols)  C:\projects\hevd\build\driver\vulnerable\x64\HEVD\HEVD.pdb  

</span><span class="ro">0: kd></span><span class="p"> x HEVD!Trigger*
fffff806`7e1d6f04 HEVD!TriggerMemoryDisclosureNonPagedPoolNx (void *, unsigned int64)
fffff806`7e1d681c HEVD!TriggerDoubleFetch (struct _DOUBLE_FETCH *)
fffff806`7e1d713c HEVD!TriggerNullPointerDereference (void *)
fffff806`7e1d618c HEVD!TriggerBufferOverflowNonPagedPoolNx (void *, unsigned int64)
fffff806`7e1d756c HEVD!TriggerUninitializedMemoryPagedPool (void *)
fffff806`7e1d695c HEVD!TriggerInsecureKernelFileAccess (void)
fffff806`7e1d5e74 HEVD!TriggerArbitraryWrite (struct _WRITE_WHAT_WHERE *)
fffff806`7e1d7314 HEVD!TriggerTypeConfusion (struct _USER_TYPE_CONFUSION_OBJECT *)
fffff806`7e1d8194 HEVD!TriggerWriteNULL (void *)
fffff806`7e1d66e0 HEVD!TriggerBufferOverflowStackGS (void *, unsigned int64)
fffff806`7e1d63a0 HEVD!TriggerBufferOverflowPagedPoolSession (void *, unsigned int64)
fffff806`7e1d6ce4 HEVD!TriggerMemoryDisclosureNonPagedPool (void *, unsigned int64)
fffff806`7e1d776c HEVD!TriggerUninitializedMemoryStack (void *)
fffff806`7e1d6b74 HEVD!TriggerIntegerOverflow (void *, unsigned int64)
fffff806`7e1d65b4 HEVD!TriggerBufferOverflowStack (void *, unsigned int64)
fffff806`7e1d5f7c HEVD!TriggerBufferOverflowNonPagedPool (void *, unsigned int64)</span>
</code></pre></div></div><br>

<p class="plain-text">Con esta configuración tendriamos listo el entorno con ambas máquinas para explotar el driver, pero eso será en el siguiente post donde lo analizaremos poco a poco</p>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - xchg2pwn</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
