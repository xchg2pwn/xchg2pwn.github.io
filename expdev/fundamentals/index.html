<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>1.0 - Fundamentos</title>

  <meta name="description" content="Fundamentos de Buffer Overflow">
  <meta name="author" content="GatoGamer1155">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="1.0 - Fundamentos">
  <meta name="twitter:description" content="Fundamentos de Buffer Overflow">
  <meta name="twitter:creator" content="GatoGamer1155">  
  <meta name="twitter:image" content="/expdev/fundamentals/4.png" />

  <meta property="og:site_name" content="GatoGamer1155" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="1.0 - Fundamentos">
  <meta property="og:description" content="Fundamentos de Buffer Overflow">
  <meta property="og:image" content="/expdev/fundamentals/4.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/expdev/fundamentals/4.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="1.0 - Fundamentos" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="GatoGamer1155">
          <h1 class="panel-cover__title panel-title scale-up-center">GatoGamer1155</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del Hacking y CTFs</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/expdev" title="GatoGamer1155" class="blog-button">Exploit Development</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/gatogamer1155" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/gatogamer1155" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/gatogamer1155" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@gatogamer1155" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:gatogamer1155@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#memory">1.1 - Memory</a></li>
        <li><a href="#stack">1.2 - Stack</a></li>
        <li><a href="#conventions">1.3 - Conventions</a></li>
        <li><a href="#registers">1.4 - Registers</a></li>
        <li><a href="#endianness">1.5 - Endianness</a></li>
        <li><a href="#example">1.6 - Example</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/expdev/fundamentals/4.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">1.0 - Fundamentos</h2><br>
  </header>

<section class="post" id="memory">
<br><h3 class="post-title">1.1 - Memory</h3><br>

<p class="plain-text">Cuando se ejecuta un programa en Windows a este se le asigna memoria, desde la dirección mas baja <code class="language-plaintext highlighter-rouge">0x00000000</code> hasta la mas alta <code class="language-plaintext highlighter-rouge">0x7fffffff</code> entra dentro del rango de "user-mode" y de la dirección <code class="language-plaintext highlighter-rouge">0x80000000</code> hasta <code class="language-plaintext highlighter-rouge">0xffffffff</code> en "kernel-mode".</p>
<p class="plain-text">Al crearse un proceso se crean con el las estructuras PEB y TEB:</p>

<p class="plain-text">• PEB: Contiene los parametros de "user-mode" en el proceso actual, como lo son la dirección al ejecutable o el puntero a el loader asi como información sobre el heap.</li><br>
<p class="plain-text">• TEB: Contiene información sobre el hilo, como lo puede ser la dirección de la estructura PEB, ubicación a la pila del hilo actual o el puntero hacia la  estructura SEH.</li><br>

<a href="/expdev/fundamentals/1.png" target="_blank"><div><p><img src="/expdev/fundamentals/1.png"></p></div></a>

</section>
<section class="post" id="stack">
<br><h3 class="post-title">1.2 - Stack</h3><br>

<p class="plain-text">Cuando se crea un hilo, este ejecuta codigo desde el programa o librerías, este hilo requiere un área de acceso rápido para funciones, variables e información del programa, esto se conoce como pila, cada hilo crea su propio stack o pila.</p>
<p class="plain-text">El stack trabaja bajo una estructura <code class="language-plaintext highlighter-rouge">LIFO</code> (Last-In-First-Out), esto significa que los últimos datos que han sido empujados usando la instrucción <code class="language-plaintext highlighter-rouge">push</code>, serán también los primeros en eliminarse cuando se ejecute una instrucción <code class="language-plaintext highlighter-rouge">pop</code> para eliminar datos.</p>
<p class="plain-text">Cuando se crea una pila el puntero a ella apunta a la parte superior, esto significa que al introducir información en la pila este puntero disminuye, lo que quiere decir que la pila crece al revés, desde la dirección mas alta hasta la dirección mas baja.</p>

</section>
<section class="post" id="conventions">
<br><h3 class="post-title">1.3 - Calling Conventions</h3><br>

<p class="plain-text">Las convenciones de llamada se refieren a la forma en que las funciones reciben los parámetros y el valor de la dirección de retorno en cada arquitectura, en <code class="language-plaintext highlighter-rouge">x86</code> los argumentos se empujan a la pila junto con la dirección de retorno y esta se limpia después de hacer la llamada a la función para poder utilizarse después.</p>
<p class="plain-text">Cuando se llama a una función esta necesita saber a donde apuntar cuando finaliza su ejecución asi que antes de realizar la llamada se guarda la dirección de la siguiente instrucción en el stack y cuando esta llegue al final y ejecute la instrucción <code class="language-plaintext highlighter-rouge">ret</code> tomará la dirección guardada en el stack y volverá ahí para ejecutar lo que esta en ella.</p>

<a href="/expdev/fundamentals/2.png" target="_blank"><div><p><img src="/expdev/fundamentals/2.png"></p></div></a>

</section>
<section class="post" id="registers">
<br><h3 class="post-title">1.4 - Registers</h3><br>

<p class="plain-text">Para ser eficientes al ejecutar un codigo la <code class="language-plaintext highlighter-rouge">CPU</code> utiliza 9 registros de <code class="language-plaintext highlighter-rouge">32</code> bits, los registros son pequeñas ubicaciones donde los datos se pueden leer y/o modificar eficientemente, algo a tener en cuenta es que cada registro se puede dividir en subregistros de <code class="language-plaintext highlighter-rouge">16</code> y/o <code class="language-plaintext highlighter-rouge">8</code> bits como se muestra en la siguiente tabla.</p>
<a href="/expdev/fundamentals/3.png" target="_blank"><div><p><img src="/expdev/fundamentals/3.png"></p></div></a>

<p class="plain-text">En el caso del registro de 32 bits (<code class="language-plaintext highlighter-rouge">EAX</code>) se divide en un subregistro de 16 bits (<code class="language-plaintext highlighter-rouge">AX</code>) que a su vez se puede dividir en 2 subregistros de 8 bits (<code class="language-plaintext highlighter-rouge">AH</code>) y (<code class="language-plaintext highlighter-rouge">AL</code>) respectivamente</p>
<a href="/expdev/fundamentals/4.png" target="_blank"><div><p><img src="/expdev/fundamentals/4.png"></p></div></a>

<p class="plain-text">Varios de los registros se usan como registros de propósito general para almacenar datos temporales, algunos de los propositos de cada uno son:</p>
<p class="plain-text">• EAX (Accumulator): Instrucciones aritméticas y lógicas.
<br>• EBX (Base): Puntero base para direcciones de memoria.
<br>• ECX (Counter): Puntero usado como contador.
<br>• EDX (Data): Direccionamiento, multiplicación y división.
<br>• ESI (Source Index): Puntero a la fuente en operaciones de cadenas.
<br>• EDI (Destination Index): Puntero al destino en operaciones de cadenas.</p>

<p class="plain-text">Otros registros bastante importantes que almacenan punteros son:</p>

<p class="plain-text">• ESP (Stack Pointer): Almacena el puntero a la parte superior del stack.
<br>• EBP (Base Pointer): Puntero a la parte superior de la pila cuando se llama a la función.
<br>• EIP (Instruction Pointer): Apunta a la dirección de la siguiente instrucción a ejecutar.</p>

</section>
<section class="post" id="endianness">
<br><h3 class="post-title">1.5 - Endianness</h3><br>

<p class="plain-text">Hay diferentes formas de representar los valores en memoria, las mas comunes son:</p>
<p class="plain-text">• Big Endian: Adoptado por Motorola y otros, consiste en representar los bytes en el orden natural, por lo que el valor hexadecimal <code class="language-plaintext highlighter-rouge">0x01020304</code> se guardaría en memoria con los bytes ordenados como <code class="language-plaintext highlighter-rouge">01 02 03 04</code> por lo que no sufriria cambios.</br>
<br>• Little Endian: Adoptado por Intel, el mismo valor <code class="language-plaintext highlighter-rouge">0x01020304</code> se guardaría en orden inverso con los bytes <code class="language-plaintext highlighter-rouge">04 03 02 01</code> de manera que se hace más intuitivo el acceso a datos, porque se efectúa fácilmente de forma incremental de menos a más relevante.</p>

</section>
<section class="post" id="example">
<br><h3 class="post-title">1.6 - Example</h3><br>

<p class="plain-text">Un ejemplo de codigo vulnerable seria el siguiente, este llama a la función <code class="language-plaintext highlighter-rouge">vuln()</code> pasándole la string del primer argumento, esta función copia la string hacia la variable <code class="language-plaintext highlighter-rouge">dest</code> con solo un buffer de 64 bytes, asi que... ¿que pasa si se envian más bytes?</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">#include </span><span class="s">&ltstring.h>
</span><span class="o">#include </span><span class="s">&ltstdio.h>

</span><span class="no">void </span><span class="na">vuln</span><span class="p">(</span><span class="no">char </span><span class="o">*</span><span class="am">src</span><span class="p">)
{
    </span><span class="no">char </span><span class="p">dest[</span><span class="mi">64</span><span class="p">];
    </span><span class="no">strcpy</span><span class="p">(dest, src);
}

</span><span class="no">int </span><span class="na">main</span><span class="p">(</span><span class="no">int </span><span class="am">argc</span><span class="p">, </span><span class="no">char </span><span class="o">*</span><span class="am">argv</span><span class="p">[])
{
    </span><span class="o">if</span><span class="p"> (argc</span><span class="o"> != </span><span class="mi">2</span><span class="p">)
    {
        </span><span class="no">printf</span><span class="p">(</span><span class="s">"Usage: </span><span class="mi">%s</span><span class="s"> &ltstring></span><span class="mi">\n</span><span class="s">"</span><span class="p">, argv[</span><span class="mi">0</span><span class="p">]);  
        </span><span class="o">return </span><span class="mi">1</span><span class="p">;
    }

    vuln(argv[</span><span class="mi">1</span><span class="p">]);
    </span><span class="o">return </span><span class="mi">0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ i686-w64-mingw32-gcc </span><span class="p">code.c -no-pie -o file.exe  </span>
</code></pre></div></div><br>

<p class="plain-text">Luego de compilarlo podemos pasarlo a un desensamblador como <code class="language-plaintext highlighter-rouge">IDA</code> donde vemos que el puntero donde guardará los datos copiados apunta a <code class="language-plaintext highlighter-rouge">ebp - 72</code></p>
<a href="/expdev/fundamentals/5.png" target="_blank"><div><p><img src="/expdev/fundamentals/5.png"></p></div></a>

<p class="plain-text">Usaremos como argumento una cadena de <code class="language-plaintext highlighter-rouge">72 A's</code> que se escribiran antes de ebp, <code class="language-plaintext highlighter-rouge">4 B's</code> que sobrescribiran ebp, <code class="language-plaintext highlighter-rouge">4 C's</code> que se escribirán el stack como las <code class="language-plaintext highlighter-rouge">20 D's</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3</span><span class="p"> -q
>>> ("A" * 72) + ("B" * 4) + ("C" * 4) + ("D" * 20)
'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCCDDDDDDDDDDDDDDDDDDDD'  
>>></span>
</code></pre></div></div><br>

<p class="plain-text">Para analizar el programa necesitamos un debugger, en este caso usaremos <code class="language-plaintext highlighter-rouge">WinDbg</code></p>
<a href="/expdev/fundamentals/6.png" target="_blank"><div><p><img src="/expdev/fundamentals/6.png"></p></div></a>

<p class="plain-text">Si nos detenemos con un breakpoint en el <code class="language-plaintext highlighter-rouge">ret</code> podemos ver que escribimos <code class="language-plaintext highlighter-rouge">A's</code> hasta antes de sobrescribir ebp que ahora vale <code class="language-plaintext highlighter-rouge">0x42424242</code> (valor de <code class="language-plaintext highlighter-rouge">BBBB</code> en hexadecimal) y las <code class="language-plaintext highlighter-rouge">C's</code> y <code class="language-plaintext highlighter-rouge">D's</code> se guardan justo después de esto en el stack</p>
<a href="/expdev/fundamentals/7.png" target="_blank"><div><p><img src="/expdev/fundamentals/7.png"></p></div></a>

<p class="plain-text">Al ejecutar el <code class="language-plaintext highlighter-rouge">ret</code> intentara apuntar a la dirección de memoria guardada en la parte superior del stack pero como esa dirección la hemos sobrescrito con <code class="language-plaintext highlighter-rouge">CCCC</code> intentara apuntar a <code class="language-plaintext highlighter-rouge">0x43434343</code> y al no encontrar esa dirección el programa corrompe</p>
<a href="/expdev/fundamentals/8.png" target="_blank"><div><p><img src="/expdev/fundamentals/8.png"></p></div></a>

<p class="plain-text">Resumiendo, el Buffer Overflow mas conocido generalmente ocurre cuando no se controla la cantidad de datos que se escriben y al sobrescribir la dirección de retorno esta apuntará a un valor que el atacante introduce por lo que puede tomar control</p>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2023 - GatoGamer1155</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
